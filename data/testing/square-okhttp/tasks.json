[ {
  "instance_id" : "square-okhttp-PR-9269",
  "repo" : "square/okhttp",
  "base_commit" : "bb420b201d9f01c01d493b82a7b4cd9efd38ec41",
  "patch" : "diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml\nindex 8a7b46e4baa3..b5731a035d4b 100644\n--- a/.github/workflows/build.yml\n+++ b/.github/workflows/build.yml\n@@ -563,26 +563,19 @@ jobs:\n         env:\n           API_LEVEL: ${{ matrix.api-level }}\n \n-      - name: Run Release Tests\n-        uses: reactivecircus/android-emulator-runner@v2\n-        with:\n-          api-level: ${{ matrix.api-level }}\n-          arch: ${{ matrix.api-level == '34' && 'x86_64' || 'x86' }}\n-          script: ./gradlew :android-test-app:connectedCheck\n-        env:\n-          API_LEVEL: ${{ matrix.api-level }}\n-\n       - name: Build Release App\n         run: ./gradlew android-test-app:lint android-test-app:assembleRelease\n \n-      - name: Run Release Tests\n-        uses: reactivecircus/android-emulator-runner@v2\n-        with:\n-          api-level: ${{ matrix.api-level }}\n-          arch: ${{ matrix.api-level == '34' && 'x86_64' || 'x86' }}\n-          script: ./gradlew :android-test-app:connectedReleaseAndroidTest\n-        env:\n-          API_LEVEL: ${{ matrix.api-level }}\n+#  Can't run with AGP 9\n+#  java.lang.NoClassDefFoundError: Failed resolution of: Landroidx/tracing/Trace;\n+#      - name: Run Release Tests\n+#        uses: reactivecircus/android-emulator-runner@v2\n+#        with:\n+#          api-level: ${{ matrix.api-level }}\n+#          arch: ${{ matrix.api-level == '34' && 'x86_64' || 'x86' }}\n+#          script: ./gradlew :android-test-app:connectedReleaseAndroidTest\n+#        env:\n+#          API_LEVEL: ${{ matrix.api-level }}\n \n   testloom:\n     runs-on: ubuntu-latest\ndiff --git a/android-test/src/androidTest/README.md b/android-test/src/androidDeviceTest/README.md\nsimilarity index 100%\nrename from android-test/src/androidTest/README.md\nrename to android-test/src/androidDeviceTest/README.md\ndiff --git a/gradle.properties b/gradle.properties\nindex 1b38621e438b..5ee973826ad9 100644\n--- a/gradle.properties\n+++ b/gradle.properties\n@@ -13,6 +13,6 @@ okhttpDokka=false\n \n org.gradle.jvmargs='-Dfile.encoding=UTF-8'\n \n-# AGP 9.0 Workarounds\n-android.builtInKotlin=false\n-android.newDsl=false\n+# AGP 9.0 Settings\n+android.builtInKotlin=true\n+android.newDsl=true\ndiff --git a/okhttp/build.gradle.kts b/okhttp/build.gradle.kts\nindex ba9e1bdcdff1..83353a6b7038 100644\n--- a/okhttp/build.gradle.kts\n+++ b/okhttp/build.gradle.kts\n@@ -2,7 +2,6 @@\n \n import com.vanniktech.maven.publish.JavadocJar\n import com.vanniktech.maven.publish.KotlinMultiplatform\n-import org.jetbrains.kotlin.gradle.dsl.JvmTarget\n import org.jetbrains.kotlin.gradle.tasks.KotlinCompile\n import org.jetbrains.kotlin.gradle.tasks.KotlinJvmCompile\n import ru.vyarus.gradle.plugin.animalsniffer.AnimalSniffer\n@@ -10,7 +9,7 @@ import ru.vyarus.gradle.plugin.animalsniffer.AnimalSnifferExtension\n \n plugins {\n   kotlin(\"multiplatform\")\n-  id(\"com.android.library\")\n+  id(\"com.android.kotlin.multiplatform.library\")\n   kotlin(\"plugin.serialization\")\n   id(\"com.vanniktech.maven.publish.base\")\n   id(\"binary-compatibility-validator\")\n@@ -54,9 +53,32 @@ kotlin {\n   jvm {\n   }\n \n-  androidTarget {\n-    compilerOptions {\n-      jvmTarget.set(JvmTarget.JVM_17)\n+  androidLibrary {\n+    namespace = \"okhttp.okhttp3\"\n+    compileSdk = 35\n+    minSdk = 21\n+\n+    androidResources {\n+      enable = true\n+    }\n+\n+    optimization {\n+      consumerKeepRules.publish = true\n+      consumerKeepRules.files.add(file(\"okhttp3.pro\"))\n+    }\n+\n+    withDeviceTest {\n+      instrumentationRunner = \"androidx.test.runner.AndroidJUnitRunner\"\n+      execution = \"HOST\"\n+    }\n+\n+    // SDK 35 needs 17, for now avoid trying to run on\n+    // multiple robolectric versions, since device tests\n+    // do that\n+    if (testJavaVersion >= 17) {\n+      withHostTest {\n+        isIncludeAndroidResources = true\n+      }\n     }\n   }\n \n@@ -157,17 +179,19 @@ kotlin {\n       }\n     }\n \n-    val androidUnitTest by getting {\n-      dependencies {\n-        implementation(libs.assertk)\n-        implementation(libs.kotlin.test.annotations)\n-        implementation(libs.kotlin.test.common)\n-        implementation(libs.androidx.junit)\n+    if (testJavaVersion >= 17) {\n+      val androidHostTest by getting {\n+        dependencies {\n+          implementation(libs.assertk)\n+          implementation(libs.kotlin.test.annotations)\n+          implementation(libs.kotlin.test.common)\n+          implementation(libs.androidx.junit)\n \n-        implementation(libs.junit.jupiter.engine)\n-        implementation(libs.junit.vintage.engine)\n+          implementation(libs.junit.jupiter.engine)\n+          implementation(libs.junit.vintage.engine)\n \n-        implementation(libs.robolectric)\n+          implementation(libs.robolectric)\n+        }\n       }\n     }\n   }\n@@ -186,30 +210,7 @@ if (platform == \"jdk8alpn\") {\n   }\n }\n \n-android {\n-  compileSdk = 35\n \n-  namespace = \"okhttp.okhttp3\"\n-\n-  defaultConfig {\n-    minSdk = 21\n-\n-    consumerProguardFiles(\"okhttp3.pro\")\n-  }\n-\n-  testOptions {\n-    unitTests {\n-      isIncludeAndroidResources = true\n-    }\n-  }\n-\n-  sourceSets {\n-    named(\"main\") {\n-      manifest.srcFile(\"src/androidMain/AndroidManifest.xml\")\n-      assets.srcDir(\"src/androidMain/assets\")\n-    }\n-  }\n-}\n \n // From https://github.com/Kotlin/kotlinx-atomicfu/blob/master/atomicfu/build.gradle.kts\n val compileJavaModuleInfo by tasks.registering(JavaCompile::class) {\n@@ -346,13 +347,6 @@ afterEvaluate {\n       // https://cs.android.com/android-studio/platform/tools/base/+/mirror-goog-studio-main:build-system/gradle-core/src/main/java/com/android/build/gradle/tasks/factory/AndroidUnitTest.java;l=339\n       allJvmArgs = allJvmArgs.filter { !it.startsWith(\"--add-opens\") }\n     }\n-    if (name.matches(\"test.*UnitTest\".toRegex()) && javaLauncher.get().metadata.languageVersion.asInt() < 17) {\n-      // Work around robolectric requirements and limitations\n-      // https://github.com/robolectric/robolectric/issues/10419\n-      filter {\n-        excludeTest(\"okhttp3.internal.publicsuffix.PublicSuffixDatabaseTest\", null)\n-      }\n-    }\n   }\n }\n \n@@ -368,5 +362,5 @@ tasks.withType<KotlinCompile> {\n apply(plugin = \"io.github.usefulness.maven-sympathy\")\n \n mavenPublishing {\n-  configure(KotlinMultiplatform(javadocJar = JavadocJar.Empty(), androidVariantsToPublish = listOf(\"release\")))\n+  configure(KotlinMultiplatform(javadocJar = JavadocJar.Empty()))\n }\ndiff --git a/okhttp/src/androidUnitTest/kotlin/okhttp3/internal/publicsuffix/PublicSuffixTesting.android.kt b/okhttp/src/androidHostTest/kotlin/okhttp3/internal/publicsuffix/PublicSuffixTesting.android.kt\nsimilarity index 100%\nrename from okhttp/src/androidUnitTest/kotlin/okhttp3/internal/publicsuffix/PublicSuffixTesting.android.kt\nrename to okhttp/src/androidHostTest/kotlin/okhttp3/internal/publicsuffix/PublicSuffixTesting.android.kt\n",
  "test_patch" : "diff --git a/android-test/src/androidTest/java/okhttp/android/test/OkHttpTest.kt b/android-test/src/androidDeviceTest/java/okhttp/android/test/OkHttpTest.kt\nsimilarity index 100%\nrename from android-test/src/androidTest/java/okhttp/android/test/OkHttpTest.kt\nrename to android-test/src/androidDeviceTest/java/okhttp/android/test/OkHttpTest.kt\ndiff --git a/android-test/src/androidTest/java/okhttp/android/test/SingleAndroidTest.kt b/android-test/src/androidDeviceTest/java/okhttp/android/test/SingleAndroidTest.kt\nsimilarity index 100%\nrename from android-test/src/androidTest/java/okhttp/android/test/SingleAndroidTest.kt\nrename to android-test/src/androidDeviceTest/java/okhttp/android/test/SingleAndroidTest.kt\ndiff --git a/android-test/src/androidTest/java/okhttp/android/test/StrictModeTest.kt b/android-test/src/androidDeviceTest/java/okhttp/android/test/StrictModeTest.kt\nsimilarity index 100%\nrename from android-test/src/androidTest/java/okhttp/android/test/StrictModeTest.kt\nrename to android-test/src/androidDeviceTest/java/okhttp/android/test/StrictModeTest.kt\ndiff --git a/android-test/src/androidTest/java/okhttp/android/test/alpn/AlpnOverrideTest.kt b/android-test/src/androidDeviceTest/java/okhttp/android/test/alpn/AlpnOverrideTest.kt\nsimilarity index 100%\nrename from android-test/src/androidTest/java/okhttp/android/test/alpn/AlpnOverrideTest.kt\nrename to android-test/src/androidDeviceTest/java/okhttp/android/test/alpn/AlpnOverrideTest.kt\ndiff --git a/android-test/src/androidTest/java/okhttp/android/test/letsencrypt/LetsEncryptClientTest.kt b/android-test/src/androidDeviceTest/java/okhttp/android/test/letsencrypt/LetsEncryptClientTest.kt\nsimilarity index 100%\nrename from android-test/src/androidTest/java/okhttp/android/test/letsencrypt/LetsEncryptClientTest.kt\nrename to android-test/src/androidDeviceTest/java/okhttp/android/test/letsencrypt/LetsEncryptClientTest.kt\ndiff --git a/android-test/src/androidTest/java/okhttp/android/test/sni/SniOverrideTest.kt b/android-test/src/androidDeviceTest/java/okhttp/android/test/sni/SniOverrideTest.kt\nsimilarity index 100%\nrename from android-test/src/androidTest/java/okhttp/android/test/sni/SniOverrideTest.kt\nrename to android-test/src/androidDeviceTest/java/okhttp/android/test/sni/SniOverrideTest.kt\n",
  "problem_statement" : "Enable AGP newDsl\n\nUses the new multiplatform plugin and AGP androidLibrary.",
  "hints_text" : null,
  "created_at" : "Sun Jan 25 17:27:39 CET 2026",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 9269,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-9268",
  "repo" : "square/okhttp",
  "base_commit" : "2b1b18d8981e694439239d465fe5ad98a2cf9275",
  "patch" : "diff --git a/build.gradle.kts b/build.gradle.kts\nindex d5ae20871d97..3d1c8f748615 100644\n--- a/build.gradle.kts\n+++ b/build.gradle.kts\n@@ -52,7 +52,12 @@ configure<SpotlessExtension> {\n   kotlin {\n     target(\"**/*.kt\")\n     targetExclude(\"**/kotlinTemplates/**/*.kt\")\n+    targetExclude(\"**/generated-sources/**/*.kt\")\n     ktlint()\n+    suppressLintsFor {\n+      step = \"ktlint\"\n+      shortCode = \"standard:mixed-condition-operators\"\n+    }\n   }\n }\n \ndiff --git a/gradle/libs.versions.toml b/gradle/libs.versions.toml\nindex 98927e9a6f96..c859a1fa4dec 100644\n--- a/gradle/libs.versions.toml\n+++ b/gradle/libs.versions.toml\n@@ -63,7 +63,7 @@ gradlePlugin-mavenPublish = \"com.vanniktech:gradle-maven-publish-plugin:0.36.0\"\n gradlePlugin-mavenSympathy = \"io.github.usefulness.maven-sympathy:io.github.usefulness.maven-sympathy.gradle.plugin:0.3.0\"\n gradlePlugin-mrjar = \"me.champeau.mrjar:me.champeau.mrjar.gradle.plugin:0.1.1\"\n gradlePlugin-shadow = \"com.gradleup.shadow:shadow-gradle-plugin:9.3.1\"\n-gradlePlugin-spotless = \"com.diffplug.spotless:spotless-plugin-gradle:8.1.0\"\n+gradlePlugin-spotless = \"com.diffplug.spotless:spotless-plugin-gradle:8.2.0\"\n hamcrestLibrary = \"org.hamcrest:hamcrest-library:3.0\"\n httpClient5 = \"org.apache.httpcomponents.client5:httpclient5:5.5.2\"\n #noinspection NewerVersionAvailable\ndiff --git a/mockwebserver-deprecated/src/main/kotlin/okhttp3/mockwebserver/DeprecationBridge.kt b/mockwebserver-deprecated/src/main/kotlin/okhttp3/mockwebserver/DeprecationBridge.kt\nindex 0d14c2837666..695f33b40be9 100644\n--- a/mockwebserver-deprecated/src/main/kotlin/okhttp3/mockwebserver/DeprecationBridge.kt\n+++ b/mockwebserver-deprecated/src/main/kotlin/okhttp3/mockwebserver/DeprecationBridge.kt\n@@ -58,34 +58,79 @@ internal fun MockResponse.wrap(): mockwebserver3.MockResponse {\n   result.trailers(trailers)\n \n   when (socketPolicy) {\n-    SocketPolicy.EXPECT_CONTINUE, SocketPolicy.CONTINUE_ALWAYS -> result.add100Continue()\n-    SocketPolicy.UPGRADE_TO_SSL_AT_END -> result.inTunnel()\n-    SocketPolicy.SHUTDOWN_SERVER_AFTER_RESPONSE -> result.shutdownServer(true)\n-    SocketPolicy.KEEP_OPEN -> Unit\n-    SocketPolicy.DISCONNECT_AT_END -> result.onResponseEnd(ShutdownConnection)\n-    SocketPolicy.DISCONNECT_AT_START -> result.onRequestStart(CloseSocket())\n-    SocketPolicy.DISCONNECT_AFTER_REQUEST -> result.onResponseStart(CloseSocket())\n-    SocketPolicy.DISCONNECT_DURING_REQUEST_BODY -> result.onRequestBody(CloseSocket())\n-    SocketPolicy.DISCONNECT_DURING_RESPONSE_BODY -> result.onResponseBody(CloseSocket())\n-    SocketPolicy.DO_NOT_READ_REQUEST_BODY -> result.doNotReadRequestBody()\n-    SocketPolicy.FAIL_HANDSHAKE -> result.failHandshake()\n-    SocketPolicy.SHUTDOWN_INPUT_AT_END ->\n+    SocketPolicy.EXPECT_CONTINUE, SocketPolicy.CONTINUE_ALWAYS -> {\n+      result.add100Continue()\n+    }\n+\n+    SocketPolicy.UPGRADE_TO_SSL_AT_END -> {\n+      result.inTunnel()\n+    }\n+\n+    SocketPolicy.SHUTDOWN_SERVER_AFTER_RESPONSE -> {\n+      result.shutdownServer(true)\n+    }\n+\n+    SocketPolicy.KEEP_OPEN -> {\n+      Unit\n+    }\n+\n+    SocketPolicy.DISCONNECT_AT_END -> {\n+      result.onResponseEnd(ShutdownConnection)\n+    }\n+\n+    SocketPolicy.DISCONNECT_AT_START -> {\n+      result.onRequestStart(CloseSocket())\n+    }\n+\n+    SocketPolicy.DISCONNECT_AFTER_REQUEST -> {\n+      result.onResponseStart(CloseSocket())\n+    }\n+\n+    SocketPolicy.DISCONNECT_DURING_REQUEST_BODY -> {\n+      result.onRequestBody(CloseSocket())\n+    }\n+\n+    SocketPolicy.DISCONNECT_DURING_RESPONSE_BODY -> {\n+      result.onResponseBody(CloseSocket())\n+    }\n+\n+    SocketPolicy.DO_NOT_READ_REQUEST_BODY -> {\n+      result.doNotReadRequestBody()\n+    }\n+\n+    SocketPolicy.FAIL_HANDSHAKE -> {\n+      result.failHandshake()\n+    }\n+\n+    SocketPolicy.SHUTDOWN_INPUT_AT_END -> {\n       result.onResponseEnd(\n         CloseSocket(\n           closeSocket = false,\n           shutdownInput = true,\n         ),\n       )\n-    SocketPolicy.SHUTDOWN_OUTPUT_AT_END ->\n+    }\n+\n+    SocketPolicy.SHUTDOWN_OUTPUT_AT_END -> {\n       result.onResponseEnd(\n         CloseSocket(\n           closeSocket = false,\n           shutdownOutput = true,\n         ),\n       )\n-    SocketPolicy.STALL_SOCKET_AT_START -> result.onRequestStart(SocketEffect.Stall)\n-    SocketPolicy.NO_RESPONSE -> result.onResponseStart(SocketEffect.Stall)\n-    SocketPolicy.RESET_STREAM_AT_START -> result.onRequestStart(CloseStream(http2ErrorCode))\n+    }\n+\n+    SocketPolicy.STALL_SOCKET_AT_START -> {\n+      result.onRequestStart(SocketEffect.Stall)\n+    }\n+\n+    SocketPolicy.NO_RESPONSE -> {\n+      result.onResponseStart(SocketEffect.Stall)\n+    }\n+\n+    SocketPolicy.RESET_STREAM_AT_START -> {\n+      result.onRequestStart(CloseStream(http2ErrorCode))\n+    }\n   }\n \n   result.throttleBody(throttleBytesPerPeriod, getThrottlePeriod(MILLISECONDS), MILLISECONDS)\ndiff --git a/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt b/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt\nindex 71b5d952a0c3..60b0d28034e1 100644\n--- a/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt\n+++ b/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt\n@@ -494,6 +494,7 @@ public class MockWebServer : Closeable {\n           }\n           openClientSockets.remove(raw)\n         }\n+\n         else -> {\n           protocol =\n             when {\ndiff --git a/okhttp-idna-mapping-table/src/main/kotlin/okhttp3/internal/idn/MappingTables.kt b/okhttp-idna-mapping-table/src/main/kotlin/okhttp3/internal/idn/MappingTables.kt\nindex a3613656bd4f..1dddecaaf7bd 100644\n--- a/okhttp-idna-mapping-table/src/main/kotlin/okhttp3/internal/idn/MappingTables.kt\n+++ b/okhttp-idna-mapping-table/src/main/kotlin/okhttp3/internal/idn/MappingTables.kt\n@@ -56,21 +56,25 @@ fun buildIdnaMappingTableData(table: SimpleIdnaMappingTable): IdnaMappingTableDa\n           rangesBuffer.writeByte('-'.code)\n           rangesBuffer.writeByte('-'.code)\n         }\n+\n         is MappedRange.Inline1 -> {\n           rangesBuffer.writeByte(range.b1)\n           rangesBuffer.writeByte(range.b2)\n           rangesBuffer.writeByte('-'.code)\n         }\n+\n         is MappedRange.Inline2 -> {\n           rangesBuffer.writeByte(range.b1)\n           rangesBuffer.writeByte(range.b2)\n           rangesBuffer.writeByte(range.b3)\n         }\n+\n         is MappedRange.InlineDelta -> {\n           rangesBuffer.writeByte(range.b1)\n           rangesBuffer.writeByte(range.b2)\n           rangesBuffer.writeByte(range.b3)\n         }\n+\n         is MappedRange.External -> {\n           // Write the mapping.\n           val mappingOffset: Int\n@@ -141,7 +145,7 @@ internal fun sections(mappings: List<Mapping>): Map<Int, List<MappedRange>> {\n \n     sectionList +=\n       when (mapping.type) {\n-        TYPE_MAPPED ->\n+        TYPE_MAPPED -> {\n           run {\n             val deltaMapping = inlineDeltaOrNull(mapping)\n             if (deltaMapping != null) {\n@@ -154,12 +158,15 @@ internal fun sections(mappings: List<Mapping>): Map<Int, List<MappedRange>> {\n               else -> MappedRange.External(rangeStart, mapping.mappedTo)\n             }\n           }\n+        }\n \n         TYPE_IGNORED, TYPE_VALID, TYPE_DISALLOWED -> {\n           MappedRange.Constant(rangeStart, mapping.type)\n         }\n \n-        else -> error(\"unexpected mapping type: ${mapping.type}\")\n+        else -> {\n+          error(\"unexpected mapping type: ${mapping.type}\")\n+        }\n       }\n   }\n \ndiff --git a/okhttp-idna-mapping-table/src/main/kotlin/okhttp3/internal/idn/SimpleIdnaMappingTable.kt b/okhttp-idna-mapping-table/src/main/kotlin/okhttp3/internal/idn/SimpleIdnaMappingTable.kt\nindex ed284136cc1f..1f5c9498efba 100644\n--- a/okhttp-idna-mapping-table/src/main/kotlin/okhttp3/internal/idn/SimpleIdnaMappingTable.kt\n+++ b/okhttp-idna-mapping-table/src/main/kotlin/okhttp3/internal/idn/SimpleIdnaMappingTable.kt\n@@ -62,7 +62,10 @@ class SimpleIdnaMappingTable internal constructor(\n     var result = true\n \n     when (mapping.type) {\n-      TYPE_IGNORED -> Unit\n+      TYPE_IGNORED -> {\n+        Unit\n+      }\n+\n       TYPE_MAPPED, TYPE_DISALLOWED_STD3_MAPPED -> {\n         sink.write(mapping.mappedTo)\n       }\n@@ -142,7 +145,9 @@ private fun BufferedSource.skipWhitespace() {\n \n private fun BufferedSource.skipRestOfLine() {\n   when (val newline = indexOf('\\n'.code.toByte())) {\n-    -1L -> skip(buffer.size) // Exhaust this source.\n+    -1L -> skip(buffer.size)\n+\n+    // Exhaust this source.\n     else -> skip(newline + 1)\n   }\n }\n@@ -195,7 +200,9 @@ fun BufferedSource.readPlainTextIdnaMappingTable(): SimpleIdnaMappingTable {\n           readHexadecimalUnsignedLong()\n         }\n \n-        else -> sourceCodePoint0\n+        else -> {\n+          sourceCodePoint0\n+        }\n       }\n \n     skipWhitespace()\n@@ -228,9 +235,13 @@ fun BufferedSource.readPlainTextIdnaMappingTable(): SimpleIdnaMappingTable {\n         }\n       }\n \n-      TYPE_DISALLOWED, TYPE_DISALLOWED_STD3_VALID, TYPE_IGNORED, TYPE_VALID -> Unit\n+      TYPE_DISALLOWED, TYPE_DISALLOWED_STD3_VALID, TYPE_IGNORED, TYPE_VALID -> {\n+        Unit\n+      }\n \n-      else -> throw IOException(\"unexpected type\")\n+      else -> {\n+        throw IOException(\"unexpected type\")\n+      }\n     }\n \n     skipRestOfLine()\ndiff --git a/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/ServerSentEventReader.kt b/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/ServerSentEventReader.kt\nindex c4933eb23378..2482641b3922 100644\n--- a/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/ServerSentEventReader.kt\n+++ b/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/ServerSentEventReader.kt\n@@ -100,7 +100,9 @@ class ServerSentEventReader(\n           }\n         }\n \n-        else -> throw AssertionError()\n+        else -> {\n+          throw AssertionError()\n+        }\n       }\n     }\n   }\ndiff --git a/okhttp-testing-support/src/main/kotlin/okhttp3/EventRecorder.kt b/okhttp-testing-support/src/main/kotlin/okhttp3/EventRecorder.kt\nindex 2be9b6f83076..adaa50f994a4 100644\n--- a/okhttp-testing-support/src/main/kotlin/okhttp3/EventRecorder.kt\n+++ b/okhttp-testing-support/src/main/kotlin/okhttp3/EventRecorder.kt\n@@ -139,8 +139,12 @@ open class EventRecorder(\n     } else {\n       eventsForMatching.forEach loop@{\n         when (e.closes(it)) {\n-          null -> return // no open event\n-          true -> return // found open event\n+          null -> return\n+\n+          // no open event\n+          true -> return\n+\n+          // found open event\n           false -> return@loop // this is not the open event so continue\n         }\n       }\ndiff --git a/okhttp-testing-support/src/main/kotlin/okhttp3/JsseDebugLogging.kt b/okhttp-testing-support/src/main/kotlin/okhttp3/JsseDebugLogging.kt\nindex e5d2e13ea01e..5d3452df1012 100644\n--- a/okhttp-testing-support/src/main/kotlin/okhttp3/JsseDebugLogging.kt\n+++ b/okhttp-testing-support/src/main/kotlin/okhttp3/JsseDebugLogging.kt\n@@ -67,7 +67,10 @@ object JsseDebugLogging {\n       JsseDebugMessage.Type.Setup, JsseDebugMessage.Type.Encrypted, JsseDebugMessage.Type.Plaintext -> {\n         println(message.message + \" (skipped output)\")\n       }\n-      else -> println(message)\n+\n+      else -> {\n+        println(message)\n+      }\n     }\n   }\n \ndiff --git a/okhttp-testing-support/src/main/kotlin/okhttp3/RecordingConnectionListener.kt b/okhttp-testing-support/src/main/kotlin/okhttp3/RecordingConnectionListener.kt\nindex 3f5ce36c3378..e4aa31c52997 100644\n--- a/okhttp-testing-support/src/main/kotlin/okhttp3/RecordingConnectionListener.kt\n+++ b/okhttp-testing-support/src/main/kotlin/okhttp3/RecordingConnectionListener.kt\n@@ -134,8 +134,12 @@ internal open class RecordingConnectionListener(\n     } else {\n       eventSequence.forEach loop@{\n         when (e.closes(it)) {\n-          null -> return // no open event\n-          true -> return // found open event\n+          null -> return\n+\n+          // no open event\n+          true -> return\n+\n+          // found open event\n           false -> return@loop // this is not the open event so continue\n         }\n       }\ndiff --git a/okhttp-testing-support/src/main/kotlin/okhttp3/testing/Flaky.kt b/okhttp-testing-support/src/main/kotlin/okhttp3/testing/Flaky.kt\nindex f3b04d8809b6..1e911de0f554 100644\n--- a/okhttp-testing-support/src/main/kotlin/okhttp3/testing/Flaky.kt\n+++ b/okhttp-testing-support/src/main/kotlin/okhttp3/testing/Flaky.kt\n@@ -15,10 +15,10 @@\n  */\n package okhttp3.testing\n \n-@Target(AnnotationTarget.CLASS, AnnotationTarget.FUNCTION)\n-@Retention(AnnotationRetention.RUNTIME)\n /**\n  * Annotation marking a test as flaky, and requires extra logging and linking against\n  * a known github issue.  This does not ignore the failure.\n  */\n+@Target(AnnotationTarget.CLASS, AnnotationTarget.FUNCTION)\n+@Retention(AnnotationRetention.RUNTIME)\n annotation class Flaky\ndiff --git a/okhttp-testing-support/src/main/kotlin/okhttp3/testing/PlatformRule.kt b/okhttp-testing-support/src/main/kotlin/okhttp3/testing/PlatformRule.kt\nindex 55e0b40d7db2..ce18eee54d7a 100644\n--- a/okhttp-testing-support/src/main/kotlin/okhttp3/testing/PlatformRule.kt\n+++ b/okhttp-testing-support/src/main/kotlin/okhttp3/testing/PlatformRule.kt\n@@ -442,13 +442,25 @@ open class PlatformRule\n         if (property == null) {\n           property =\n             when (Platform.get()) {\n-              is ConscryptPlatform -> CONSCRYPT_PROPERTY\n-              is OpenJSSEPlatform -> OPENJSSE_PROPERTY\n-              is Jdk8WithJettyBootPlatform -> CONSCRYPT_PROPERTY\n+              is ConscryptPlatform -> {\n+                CONSCRYPT_PROPERTY\n+              }\n+\n+              is OpenJSSEPlatform -> {\n+                OPENJSSE_PROPERTY\n+              }\n+\n+              is Jdk8WithJettyBootPlatform -> {\n+                CONSCRYPT_PROPERTY\n+              }\n+\n               is Jdk9Platform -> {\n                 if (isCorrettoInstalled) CORRETTO_PROPERTY else JDK9_PROPERTY\n               }\n-              else -> JDK8_PROPERTY\n+\n+              else -> {\n+                JDK8_PROPERTY\n+              }\n             }\n         }\n \ndiff --git a/okhttp-tls/src/main/kotlin/okhttp3/tls/HeldCertificate.kt b/okhttp-tls/src/main/kotlin/okhttp3/tls/HeldCertificate.kt\nindex b3a1a1cf97fa..a7257ff178d5 100644\n--- a/okhttp-tls/src/main/kotlin/okhttp3/tls/HeldCertificate.kt\n+++ b/okhttp-tls/src/main/kotlin/okhttp3/tls/HeldCertificate.kt\n@@ -462,6 +462,7 @@ class HeldCertificate(\n               it.canParseAsIpAddress() -> {\n                 generalNameIpAddress to InetAddress.getByName(it).address.toByteString()\n               }\n+\n               else -> {\n                 generalNameDnsName to it\n               }\n@@ -480,16 +481,19 @@ class HeldCertificate(\n \n     private fun signatureAlgorithm(signedByKeyPair: KeyPair): AlgorithmIdentifier =\n       when (signedByKeyPair.private) {\n-        is RSAPrivateKey ->\n+        is RSAPrivateKey -> {\n           AlgorithmIdentifier(\n             algorithm = SHA256_WITH_RSA_ENCRYPTION,\n             parameters = null,\n           )\n-        else ->\n+        }\n+\n+        else -> {\n           AlgorithmIdentifier(\n             algorithm = SHA256_WITH_ECDSA,\n             parameters = ByteString.EMPTY,\n           )\n+        }\n       }\n \n     private fun generateKeyPair(): KeyPair =\n@@ -548,10 +552,12 @@ class HeldCertificate(\n             require(certificatePem == null) { \"string includes multiple certificates\" }\n             certificatePem = match.groups[0]!!.value // Keep --BEGIN-- and --END-- for certificates.\n           }\n+\n           \"PRIVATE KEY\" -> {\n             require(pkcs8Base64 == null) { \"string includes multiple private keys\" }\n             pkcs8Base64 = match.groups[2]!!.value // Include the contents only for PKCS8.\n           }\n+\n           else -> {\n             throw IllegalArgumentException(\"unexpected type: $label\")\n           }\ndiff --git a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/CertificateAdapters.kt b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/CertificateAdapters.kt\nindex db11214d2368..ad06500b3883 100644\n--- a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/CertificateAdapters.kt\n+++ b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/CertificateAdapters.kt\n@@ -54,11 +54,15 @@ internal object CertificateAdapters {\n             peekHeader.tag == Adapters.UTC_TIME.tag -> {\n             Adapters.UTC_TIME.fromDer(reader)\n           }\n+\n           peekHeader.tagClass == Adapters.GENERALIZED_TIME.tagClass &&\n             peekHeader.tag == Adapters.GENERALIZED_TIME.tag -> {\n             Adapters.GENERALIZED_TIME.fromDer(reader)\n           }\n-          else -> throw ProtocolException(\"expected time but was $peekHeader at $reader\")\n+\n+          else -> {\n+            throw ProtocolException(\"expected time but was $peekHeader at $reader\")\n+          }\n         }\n       }\n \n@@ -110,8 +114,11 @@ internal object CertificateAdapters {\n         // when it is present, and for others we must omit it!\n         // https://tools.ietf.org/html/rfc4055#section-2.1\n         ObjectIdentifiers.SHA256_WITH_RSA_ENCRYPTION -> Adapters.NULL\n+\n         ObjectIdentifiers.RSA_ENCRYPTION -> Adapters.NULL\n+\n         ObjectIdentifiers.EC_PUBLIC_KEY -> Adapters.OBJECT_IDENTIFIER\n+\n         else -> null\n       }\n     }\ndiff --git a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerReader.kt b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerReader.kt\nindex 63d29b1895cd..0844a962d78a 100644\n--- a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerReader.kt\n+++ b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerReader.kt\n@@ -127,6 +127,7 @@ internal class DerReader(\n         length0 == 0b1000_0000 -> {\n           throw ProtocolException(\"indefinite length not permitted for DER\")\n         }\n+\n         (length0 and 0b1000_0000) == 0b1000_0000 -> {\n           // Length specified over multiple bytes.\n           val lengthBytes = length0 and 0b0111_1111\n@@ -148,6 +149,7 @@ internal class DerReader(\n \n           lengthBits\n         }\n+\n         else -> {\n           // Length is 127 or fewer bytes.\n           (length0 and 0b0111_1111).toLong()\n@@ -269,11 +271,13 @@ internal class DerReader(\n         result.writeByte(dot)\n         result.writeDecimalLong(xy)\n       }\n+\n       in 40L until 80L -> {\n         result.writeDecimalLong(1)\n         result.writeByte(dot)\n         result.writeDecimalLong(xy - 40L)\n       }\n+\n       else -> {\n         result.writeDecimalLong(2)\n         result.writeByte(dot)\ndiff --git a/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/android/ConscryptSocketAdapter.kt b/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/android/ConscryptSocketAdapter.kt\nindex 29b53b8d7f8f..006e593b7bcf 100644\n--- a/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/android/ConscryptSocketAdapter.kt\n+++ b/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/android/ConscryptSocketAdapter.kt\n@@ -67,6 +67,7 @@ class ConscryptSocketAdapter : SocketAdapter {\n         when {\n           // Bump this version if we ever have a binary incompatibility\n           Conscrypt.isAvailable() && atLeastVersion(2, 1, 0) -> true\n+\n           else -> false\n         }\n       } catch (e: NoClassDefFoundError) {\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/CertificatePinner.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/CertificatePinner.kt\nindex 801d51e41c8f..925502aceacb 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/CertificatePinner.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/CertificatePinner.kt\n@@ -174,11 +174,15 @@ class CertificatePinner internal constructor(\n             if (sha256 == null) sha256 = peerCertificate.sha256Hash()\n             if (pin.hash == sha256) return // Success!\n           }\n+\n           \"sha1\" -> {\n             if (sha1 == null) sha1 = peerCertificate.sha1Hash()\n             if (pin.hash == sha1) return // Success!\n           }\n-          else -> throw AssertionError(\"unsupported hashAlgorithm: ${pin.hashAlgorithm}\")\n+\n+          else -> {\n+            throw AssertionError(\"unsupported hashAlgorithm: ${pin.hashAlgorithm}\")\n+          }\n         }\n       }\n     }\n@@ -274,11 +278,15 @@ class CertificatePinner internal constructor(\n           this.hashAlgorithm = \"sha1\"\n           this.hash = pin.substring(\"sha1/\".length).decodeBase64() ?: throw IllegalArgumentException(\"Invalid pin hash: $pin\")\n         }\n+\n         pin.startsWith(\"sha256/\") -> {\n           this.hashAlgorithm = \"sha256\"\n           this.hash = pin.substring(\"sha256/\".length).decodeBase64() ?: throw IllegalArgumentException(\"Invalid pin hash: $pin\")\n         }\n-        else -> throw IllegalArgumentException(\"pins must start with 'sha256/' or 'sha1/': $pin\")\n+\n+        else -> {\n+          throw IllegalArgumentException(\"pins must start with 'sha256/' or 'sha1/': $pin\")\n+        }\n       }\n     }\n \n@@ -291,6 +299,7 @@ class CertificatePinner internal constructor(\n           hostname.regionMatches(hostname.length - suffixLength, pattern, 3, suffixLength) &&\n             (prefixLength == 0 || hostname[prefixLength - 1] == '.')\n         }\n+\n         pattern.startsWith(\"*.\") -> {\n           // With * there must be a prefix so include the dot in regionMatches().\n           val suffixLength = pattern.length - 1\n@@ -298,7 +307,10 @@ class CertificatePinner internal constructor(\n           hostname.regionMatches(hostname.length - suffixLength, pattern, 1, suffixLength) &&\n             hostname.lastIndexOf('.', prefixLength - 1) == -1\n         }\n-        else -> hostname == pattern\n+\n+        else -> {\n+          hostname == pattern\n+        }\n       }\n \n     fun matchesCertificate(certificate: X509Certificate): Boolean =\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Cookie.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Cookie.kt\nindex 13094f6b8bf7..0b36b3f908c0 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Cookie.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Cookie.kt\n@@ -496,6 +496,7 @@ class Cookie private constructor(\n               // Ignore this attribute, it isn't recognizable as a date.\n             }\n           }\n+\n           attributeName.equals(\"max-age\", ignoreCase = true) -> {\n             try {\n               deltaSeconds = parseMaxAge(attributeValue)\n@@ -504,6 +505,7 @@ class Cookie private constructor(\n               // Ignore this attribute, it isn't recognizable as a max age.\n             }\n           }\n+\n           attributeName.equals(\"domain\", ignoreCase = true) -> {\n             try {\n               domain = parseDomain(attributeValue)\n@@ -512,15 +514,19 @@ class Cookie private constructor(\n               // Ignore this attribute, it isn't recognizable as a domain.\n             }\n           }\n+\n           attributeName.equals(\"path\", ignoreCase = true) -> {\n             path = attributeValue\n           }\n+\n           attributeName.equals(\"secure\", ignoreCase = true) -> {\n             secureOnly = true\n           }\n+\n           attributeName.equals(\"httponly\", ignoreCase = true) -> {\n             httpOnly = true\n           }\n+\n           attributeName.equals(\"samesite\", ignoreCase = true) -> {\n             sameSite = attributeValue\n           }\n@@ -610,13 +616,16 @@ class Cookie private constructor(\n             minute = matcher.group(2).toInt()\n             second = matcher.group(3).toInt()\n           }\n+\n           dayOfMonth == -1 && matcher.usePattern(DAY_OF_MONTH_PATTERN).matches() -> {\n             dayOfMonth = matcher.group(1).toInt()\n           }\n+\n           month == -1 && matcher.usePattern(MONTH_PATTERN).matches() -> {\n             val monthString = matcher.group(1).lowercase(Locale.US)\n             month = MONTH_PATTERN.pattern().indexOf(monthString) / 4 // Sneaky! jan=1, dec=12.\n           }\n+\n           year == -1 && matcher.usePattern(YEAR_PATTERN).matches() -> {\n             year = matcher.group(1).toInt()\n           }\n@@ -663,15 +672,14 @@ class Cookie private constructor(\n     ): Int {\n       for (i in pos until limit) {\n         val c = input[i].code\n-        val dateCharacter = (\n-          c < ' '.code &&\n-            c != '\\t'.code ||\n-            c >= '\\u007f'.code ||\n-            c in '0'.code..'9'.code ||\n-            c in 'a'.code..'z'.code ||\n-            c in 'A'.code..'Z'.code ||\n-            c == ':'.code\n-        )\n+        val dateCharacter =\n+          (\n+            (\n+              ((c < ' '.code) && (c != '\\t'.code)) || (c >= '\\u007f'.code) || (c in ('0'.code..'9'.code)) || (c in ('a'.code..'z'.code)) ||\n+                (c in ('A'.code..'Z'.code)) ||\n+                (c == ':'.code)\n+            )\n+          )\n         if (dateCharacter == !invert) return i\n       }\n       return limit\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Handshake.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Handshake.kt\nindex 50c776372c53..4c61fc4b7bf6 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Handshake.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Handshake.kt\n@@ -154,7 +154,9 @@ class Handshake internal constructor(\n             throw IOException(\"cipherSuite == $cipherSuiteString\")\n           }\n \n-          else -> CipherSuite.forJavaName(cipherSuiteString)\n+          else -> {\n+            CipherSuite.forJavaName(cipherSuiteString)\n+          }\n         }\n \n       val tlsVersionString = checkNotNull(protocol) { \"tlsVersion == null\" }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Headers.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Headers.kt\nindex 155aec37c584..20acbb5d96ee 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Headers.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Headers.kt\n@@ -215,11 +215,13 @@ class Headers internal constructor(\n           index != -1 -> {\n             addLenient(line.substring(0, index), line.substring(index + 1))\n           }\n+\n           line[0] == ':' -> {\n             // Work around empty header names and header names that start with a colon (created by old\n             // broken SPDY versions of the response cache).\n             addLenient(\"\", line.substring(1)) // Empty header name.\n           }\n+\n           else -> {\n             // No header name.\n             addLenient(\"\", line)\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/HttpUrl.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/HttpUrl.kt\nindex 65501a571a40..646c698437e2 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/HttpUrl.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/HttpUrl.kt\n@@ -1344,14 +1344,18 @@ class HttpUrl private constructor(\n             this.scheme = \"https\"\n             pos += \"https:\".length\n           }\n+\n           input.startsWith(\"http:\", ignoreCase = true, startIndex = pos) -> {\n             this.scheme = \"http\"\n             pos += \"http:\".length\n           }\n-          else -> throw IllegalArgumentException(\n-            \"Expected URL scheme 'http' or 'https' but was '\" +\n-              input.substring(0, schemeDelimiterOffset) + \"'\",\n-          )\n+\n+          else -> {\n+            throw IllegalArgumentException(\n+              \"Expected URL scheme 'http' or 'https' but was '\" +\n+                input.substring(0, schemeDelimiterOffset) + \"'\",\n+            )\n+          }\n         }\n       } else if (base != null) {\n         this.scheme = base.scheme\n@@ -1678,7 +1682,10 @@ class HttpUrl private constructor(\n               if (input[i] == ']') break\n             }\n           }\n-          ':' -> return i\n+\n+          ':' -> {\n+            return i\n+          }\n         }\n         i++\n       }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/MediaType.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/MediaType.kt\nindex 411fb3dde174..313fa70ccde5 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/MediaType.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/MediaType.kt\n@@ -130,11 +130,15 @@ class MediaType internal constructor(\n               // Value is \"double-quoted\". That's valid and our regex group already strips the quotes.\n               parameter.groups[3]!!.value\n             }\n+\n             token.startsWith('\\'') && token.endsWith('\\'') && token.length > 2 -> {\n               // If the token is 'single-quoted' it's invalid! But we're lenient and strip the quotes.\n               token.substring(1, token.length - 1)\n             }\n-            else -> token\n+\n+            else -> {\n+              token\n+            }\n           }\n \n         parameterNamesAndValues += name\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/MultipartReader.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/MultipartReader.kt\nindex 54713befaf4a..790c3a2ef19e 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/MultipartReader.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/MultipartReader.kt\n@@ -137,7 +137,9 @@ class MultipartReader\n             continue@afterBoundaryLoop\n           }\n \n-          -1 -> throw ProtocolException(\"unexpected characters after boundary\")\n+          -1 -> {\n+            throw ProtocolException(\"unexpected characters after boundary\")\n+          }\n         }\n       }\n \n@@ -167,7 +169,9 @@ class MultipartReader\n \n         return source.timeout().intersectWith(timeout) {\n           when (val limit = currentPartBytesRemaining(maxByteCount = byteCount)) {\n-            0L -> -1L // No more bytes in this part.\n+            0L -> -1L\n+\n+            // No more bytes in this part.\n             else -> source.read(sink, limit)\n           }\n         }\n@@ -190,8 +194,12 @@ class MultipartReader\n           toIndex = toIndex,\n         )\n       return when {\n-        boundaryIndex != -1L -> boundaryIndex // We found the boundary.\n-        source.buffer.size >= toIndex -> minOf(toIndex, maxByteCount) // No boundary before toIndex.\n+        boundaryIndex != -1L -> boundaryIndex\n+\n+        // We found the boundary.\n+        source.buffer.size >= toIndex -> minOf(toIndex, maxByteCount)\n+\n+        // No boundary before toIndex.\n         else -> throw EOFException() // We ran out of data before we found the required boundary.\n       }\n     }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/OkHttpClient.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/OkHttpClient.kt\nindex ebdcafad3fe9..7ceb5da755f5 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/OkHttpClient.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/OkHttpClient.kt\n@@ -191,6 +191,7 @@ open class OkHttpClient internal constructor(\n     when {\n       // Defer calls to ProxySelector.getDefault() because it can throw a SecurityException.\n       builder.proxy != null -> NullProxySelector\n+\n       else -> builder.proxySelector ?: ProxySelector.getDefault() ?: NullProxySelector\n     }\n \ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Protocol.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Protocol.kt\nindex cc7f4e7033be..a3e290cfe2d8 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Protocol.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Protocol.kt\n@@ -117,12 +117,30 @@ enum class Protocol(\n       // Unroll the loop over values() to save an allocation.\n       @Suppress(\"DEPRECATION\")\n       return when (protocol) {\n-        HTTP_1_0.protocol -> HTTP_1_0\n-        HTTP_1_1.protocol -> HTTP_1_1\n-        H2_PRIOR_KNOWLEDGE.protocol -> H2_PRIOR_KNOWLEDGE\n-        HTTP_2.protocol -> HTTP_2\n-        SPDY_3.protocol -> SPDY_3\n-        QUIC.protocol -> QUIC\n+        HTTP_1_0.protocol -> {\n+          HTTP_1_0\n+        }\n+\n+        HTTP_1_1.protocol -> {\n+          HTTP_1_1\n+        }\n+\n+        H2_PRIOR_KNOWLEDGE.protocol -> {\n+          H2_PRIOR_KNOWLEDGE\n+        }\n+\n+        HTTP_2.protocol -> {\n+          HTTP_2\n+        }\n+\n+        SPDY_3.protocol -> {\n+          SPDY_3\n+        }\n+\n+        QUIC.protocol -> {\n+          QUIC\n+        }\n+\n         else -> {\n           // Support HTTP3 draft like h3-29\n           if (protocol.startsWith(HTTP_3.protocol)) HTTP_3 else throw IOException(\"Unexpected protocol: $protocol\")\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/-CacheControlCommon.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/-CacheControlCommon.kt\nindex a0b6ea9d1a00..5ccb68fd3c96 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/-CacheControlCommon.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/-CacheControlCommon.kt\n@@ -137,10 +137,12 @@ internal fun CacheControl.Companion.commonParse(headers: Headers): CacheControl\n           headerValue = value\n         }\n       }\n+\n       name.equals(\"Pragma\", ignoreCase = true) -> {\n         // Might specify additional cache-control params. We invalidate just in case.\n         canUseHeaderValue = false\n       }\n+\n       else -> {\n         continue@loop\n       }\n@@ -179,36 +181,47 @@ internal fun CacheControl.Companion.commonParse(headers: Headers): CacheControl\n         \"no-cache\".equals(directive, ignoreCase = true) -> {\n           noCache = true\n         }\n+\n         \"no-store\".equals(directive, ignoreCase = true) -> {\n           noStore = true\n         }\n+\n         \"max-age\".equals(directive, ignoreCase = true) -> {\n           maxAgeSeconds = parameter.toNonNegativeInt(-1)\n         }\n+\n         \"s-maxage\".equals(directive, ignoreCase = true) -> {\n           sMaxAgeSeconds = parameter.toNonNegativeInt(-1)\n         }\n+\n         \"private\".equals(directive, ignoreCase = true) -> {\n           isPrivate = true\n         }\n+\n         \"public\".equals(directive, ignoreCase = true) -> {\n           isPublic = true\n         }\n+\n         \"must-revalidate\".equals(directive, ignoreCase = true) -> {\n           mustRevalidate = true\n         }\n+\n         \"max-stale\".equals(directive, ignoreCase = true) -> {\n           maxStaleSeconds = parameter.toNonNegativeInt(Int.MAX_VALUE)\n         }\n+\n         \"min-fresh\".equals(directive, ignoreCase = true) -> {\n           minFreshSeconds = parameter.toNonNegativeInt(-1)\n         }\n+\n         \"only-if-cached\".equals(directive, ignoreCase = true) -> {\n           onlyIfCached = true\n         }\n+\n         \"no-transform\".equals(directive, ignoreCase = true) -> {\n           noTransform = true\n         }\n+\n         \"immutable\".equals(directive, ignoreCase = true) -> {\n           immutable = true\n         }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/-UtilJvm.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/-UtilJvm.kt\nindex c79cd212060f..90718e37904f 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/-UtilJvm.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/-UtilJvm.kt\n@@ -88,11 +88,17 @@ internal fun BufferedSource.readBomAsCharset(default: Charset): Charset =\n   when (select(UNICODE_BOMS)) {\n     // a mapping from the index of encoding methods in UNICODE_BOMS to its corresponding encoding method\n     0 -> UTF_8\n+\n     1 -> UTF_16BE\n+\n     2 -> UTF_32LE\n+\n     3 -> UTF_16LE\n+\n     4 -> UTF_32BE\n+\n     -1 -> default\n+\n     else -> throw AssertionError()\n   }\n \n@@ -254,7 +260,9 @@ internal inline fun <K, V> Map<K, V>.unmodifiable(): Map<K, V> = Collections.unm\n internal fun <T> List<T>.toImmutableList(): List<T> =\n   when {\n     this.isEmpty() -> emptyList()\n+\n     this.size == 1 -> Collections.singletonList(this[0])\n+\n     // Collection.toArray returns Object[] (covariant).\n     // It is faster than creating real T[] via reflection (Arrays.copyOf).\n     else -> (this as java.util.Collection<*>).toArray().asList().unmodifiable() as List<T>\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/Tags.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/Tags.kt\nindex 2f88c9fa51f2..e087fc13b542 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/Tags.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/Tags.kt\n@@ -74,12 +74,18 @@ private class LinkedTags<K : Any>(\n     // Create a copy of this `LinkedTags` that doesn't have a mapping for `key`.\n     val thisMinusKey =\n       when {\n-        key == this.key -> next // Subtract this!\n+        key == this.key -> {\n+          next\n+        }\n+\n+        // Subtract this!\n \n         else -> {\n           val nextMinusKey = next.plus(key, null)\n           when {\n-            nextMinusKey === next -> this // Same as the following line, but with fewer allocations.\n+            nextMinusKey === next -> this\n+\n+            // Same as the following line, but with fewer allocations.\n             else -> LinkedTags(this.key, this.value, nextMinusKey)\n           }\n         }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/cache/CacheStrategy.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/cache/CacheStrategy.kt\nindex 34de9fddd560..17872e011304 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/cache/CacheStrategy.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/cache/CacheStrategy.kt\n@@ -105,16 +105,20 @@ class CacheStrategy internal constructor(\n               servedDate = value.toHttpDateOrNull()\n               servedDateString = value\n             }\n+\n             fieldName.equals(\"Expires\", ignoreCase = true) -> {\n               expires = value.toHttpDateOrNull()\n             }\n+\n             fieldName.equals(\"Last-Modified\", ignoreCase = true) -> {\n               lastModified = value.toHttpDateOrNull()\n               lastModifiedString = value\n             }\n+\n             fieldName.equals(\"ETag\", ignoreCase = true) -> {\n               etag = value\n             }\n+\n             fieldName.equals(\"Age\", ignoreCase = true) -> {\n               ageSeconds = value.toNonNegativeInt(-1)\n             }\n@@ -210,7 +214,9 @@ class CacheStrategy internal constructor(\n           conditionValue = servedDateString\n         }\n \n-        else -> return CacheStrategy(request, null) // No condition! Make a regular request.\n+        else -> {\n+          return CacheStrategy(request, null)\n+        } // No condition! Make a regular request.\n       }\n \n       val conditionalRequestHeaders = request.headers.newBuilder()\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/cache/DiskLruCache.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/cache/DiskLruCache.kt\nindex e540aef65d96..dbf022e26d19 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/cache/DiskLruCache.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/cache/DiskLruCache.kt\n@@ -370,7 +370,9 @@ class DiskLruCache(\n         // This work was already done by calling lruEntries.get().\n       }\n \n-      else -> throw IOException(\"unexpected journal line: $line\")\n+      else -> {\n+        throw IOException(\"unexpected journal line: $line\")\n+      }\n     }\n   }\n \ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/ConnectPlan.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/ConnectPlan.kt\nindex a83bb35590d5..e90421ccdc44 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/ConnectPlan.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/ConnectPlan.kt\n@@ -323,6 +323,7 @@ class ConnectPlan internal constructor(\n             ),\n         )\n       }\n+\n       else -> {\n         val failure =\n           ProtocolException(\n@@ -442,7 +443,9 @@ class ConnectPlan internal constructor(\n       tunnelCodec.skipConnectBody(response)\n \n       when (response.code) {\n-        HttpURLConnection.HTTP_OK -> return null\n+        HttpURLConnection.HTTP_OK -> {\n+          return null\n+        }\n \n         HttpURLConnection.HTTP_PROXY_AUTH -> {\n           nextRequest = route.address.proxyAuthenticator.authenticate(route, response)\n@@ -453,7 +456,9 @@ class ConnectPlan internal constructor(\n           }\n         }\n \n-        else -> throw IOException(\"Unexpected response code for CONNECT: ${response.code}\")\n+        else -> {\n+          throw IOException(\"Unexpected response code for CONNECT: ${response.code}\")\n+        }\n       }\n     }\n   }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/FastFallbackExchangeFinder.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/FastFallbackExchangeFinder.kt\nindex 74154b99c441..928fc24cd6a8 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/FastFallbackExchangeFinder.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/FastFallbackExchangeFinder.kt\n@@ -121,7 +121,10 @@ internal class FastFallbackExchangeFinder(\n             FailedPlan(e)\n           }\n         }\n-        else -> return null // Nothing further to try.\n+\n+        else -> {\n+          return null\n+        } // Nothing further to try.\n       }\n \n     // Already connected. Return it immediately.\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/RealConnectionPool.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/RealConnectionPool.kt\nindex 85b334cd6bf1..2bf7da124c50 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/RealConnectionPool.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/RealConnectionPool.kt\n@@ -91,8 +91,14 @@ class RealConnectionPool internal constructor(\n       val acquired =\n         connection.withLock {\n           when {\n-            requireMultiplexed && !connection.isMultiplexed -> false\n-            !connection.isEligible(address, routes) -> false\n+            requireMultiplexed && !connection.isMultiplexed -> {\n+              false\n+            }\n+\n+            !connection.isEligible(address, routes) -> {\n+              false\n+            }\n+\n             else -> {\n               call.acquireConnectionNoEvents(connection)\n               true\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/RealRoutePlanner.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/RealRoutePlanner.kt\nindex 5b6e6ddcb229..598e072b024a 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/RealRoutePlanner.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/connection/RealRoutePlanner.kt\n@@ -104,10 +104,14 @@ class RealRoutePlanner internal constructor(\n             candidate.noNewExchanges = true\n             call.releaseConnectionNoEvents()\n           }\n+\n           candidate.noNewExchanges || !sameHostAndPort(candidate.route().address.url) -> {\n             call.releaseConnectionNoEvents()\n           }\n-          else -> null\n+\n+          else -> {\n+            null\n+          }\n         }\n       }\n \ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http/HttpHeaders.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http/HttpHeaders.kt\nindex 4df249a2dd49..64b6e90feac4 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http/HttpHeaders.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http/HttpHeaders.kt\n@@ -152,7 +152,9 @@ private fun Buffer.skipCommasAndWhitespace(): Boolean {\n         // Consume space or tab.\n       }\n \n-      else -> break@loop\n+      else -> {\n+        break@loop\n+      }\n     }\n   }\n   return commaFound\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http/RetryAndFollowUpInterceptor.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http/RetryAndFollowUpInterceptor.kt\nindex a28ea5bf6fed..458c3eaad396 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http/RetryAndFollowUpInterceptor.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http/RetryAndFollowUpInterceptor.kt\n@@ -221,7 +221,9 @@ class RetryAndFollowUpInterceptor : Interceptor {\n         return chain.proxyAuthenticator.authenticate(route, userResponse)\n       }\n \n-      HTTP_UNAUTHORIZED -> return chain.authenticator.authenticate(route, userResponse)\n+      HTTP_UNAUTHORIZED -> {\n+        return chain.authenticator.authenticate(route, userResponse)\n+      }\n \n       HTTP_PERM_REDIRECT, HTTP_TEMP_REDIRECT, HTTP_MULT_CHOICE, HTTP_MOVED_PERM, HTTP_MOVED_TEMP, HTTP_SEE_OTHER -> {\n         return buildRedirectRequest(userResponse, method, chain)\n@@ -285,7 +287,9 @@ class RetryAndFollowUpInterceptor : Interceptor {\n         return userResponse.request\n       }\n \n-      else -> return null\n+      else -> {\n+        return null\n+      }\n     }\n   }\n \ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http1/Http1ExchangeCodec.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http1/Http1ExchangeCodec.kt\nindex 36e94d563d51..f1a176c0299d 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http1/Http1ExchangeCodec.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http1/Http1ExchangeCodec.kt\n@@ -95,15 +95,28 @@ class Http1ExchangeCodec(\n     contentLength: Long,\n   ): Sink =\n     when {\n-      request.body?.isDuplex() == true -> throw ProtocolException(\n-        \"Duplex connections are not supported for HTTP/1\",\n-      )\n-      request.isChunked -> newChunkedSink() // Stream a request body of unknown length.\n-      contentLength != -1L -> newKnownLengthSink() // Stream a request body of a known length.\n-      else -> // Stream a request body of a known length.\n+      request.body?.isDuplex() == true -> {\n+        throw ProtocolException(\n+          \"Duplex connections are not supported for HTTP/1\",\n+        )\n+      }\n+\n+      request.isChunked -> {\n+        newChunkedSink()\n+      }\n+\n+      // Stream a request body of unknown length.\n+      contentLength != -1L -> {\n+        newKnownLengthSink()\n+      }\n+\n+      // Stream a request body of a known length.\n+      else -> {\n+        // Stream a request body of a known length.\n         throw IllegalStateException(\n           \"Cannot stream a request body without chunked encoding or a known content length!\",\n         )\n+      }\n     }\n \n   override fun cancel() {\n@@ -134,8 +147,14 @@ class Http1ExchangeCodec(\n \n   override fun openResponseBodySource(response: Response): Source =\n     when {\n-      !response.promisesBody() -> newFixedLengthSource(response.request.url, 0)\n-      response.isChunked -> newChunkedSource(response.request.url)\n+      !response.promisesBody() -> {\n+        newFixedLengthSource(response.request.url, 0)\n+      }\n+\n+      response.isChunked -> {\n+        newChunkedSource(response.request.url)\n+      }\n+\n       else -> {\n         val contentLength = response.headersContentLength()\n         if (contentLength != -1L) {\n@@ -207,16 +226,19 @@ class Http1ExchangeCodec(\n         expectContinue && statusLine.code == HTTP_CONTINUE -> {\n           null\n         }\n+\n         statusLine.code == HTTP_CONTINUE -> {\n           state = STATE_READ_RESPONSE_HEADERS\n           responseBuilder\n         }\n+\n         statusLine.code in (102 until 200) -> {\n           // Processing and Early Hints will mean a second headers are coming.\n           // Treat others the same for now\n           state = STATE_READ_RESPONSE_HEADERS\n           responseBuilder\n         }\n+\n         else -> {\n           state = STATE_OPEN_RESPONSE_BODY\n           responseBuilder\n@@ -484,7 +506,7 @@ class Http1ExchangeCodec(\n       try {\n         bytesRemainingInChunk = socket.source.readHexadecimalUnsignedLong()\n         val extensions = socket.source.readUtf8LineStrict().trim()\n-        if (bytesRemainingInChunk < 0L || extensions.isNotEmpty() && !extensions.startsWith(\";\")) {\n+        if ((bytesRemainingInChunk < 0L) || (extensions.isNotEmpty() && !extensions.startsWith(\";\"))) {\n           throw ProtocolException(\n             \"expected chunk size and optional extensions\" +\n               \" but was \\\"$bytesRemainingInChunk$extensions\\\"\",\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Hpack.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Hpack.kt\nindex 19f2949d7ba8..454c66f1f9bb 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Hpack.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Hpack.kt\n@@ -207,20 +207,24 @@ object Hpack {\n               // 10000000\n               throw IOException(\"index == 0\")\n             }\n+\n             b and 0x80 == 0x80 -> {\n               // 1NNNNNNN\n               val index = readInt(b, PREFIX_7_BITS)\n               readIndexedHeader(index - 1)\n             }\n+\n             b == 0x40 -> {\n               // 01000000\n               readLiteralHeaderWithIncrementalIndexingNewName()\n             }\n+\n             b and 0x40 == 0x40 -> {\n               // 01NNNNNN\n               val index = readInt(b, PREFIX_6_BITS)\n               readLiteralHeaderWithIncrementalIndexingIndexedName(index - 1)\n             }\n+\n             b and 0x20 == 0x20 -> {\n               // 001NNNNN\n               maxDynamicTableByteCount = readInt(b, PREFIX_5_BITS)\n@@ -229,10 +233,12 @@ object Hpack {\n               }\n               adjustDynamicTableByteCount()\n             }\n+\n             b == 0x10 || b == 0 -> {\n               // 000?0000 - Ignore never indexed bit.\n               readLiteralHeaderWithoutIndexingNewName()\n             }\n+\n             else -> {\n               // 000?NNNN - Ignore never indexed bit.\n               val index = readInt(b, PREFIX_4_BITS)\n@@ -541,6 +547,7 @@ object Hpack {\n               // Indexed Header Field.\n               writeInt(headerIndex, PREFIX_7_BITS, 0x80)\n             }\n+\n             headerNameIndex == -1 -> {\n               // Literal Header Field with Incremental Indexing - New Name.\n               out.writeByte(0x40)\n@@ -548,12 +555,14 @@ object Hpack {\n               writeByteString(value)\n               insertIntoDynamicTable(header)\n             }\n+\n             name.startsWith(Header.PSEUDO_PREFIX) && TARGET_AUTHORITY != name -> {\n               // Follow Chromes lead - only include the :authority pseudo header, but exclude all other\n               // pseudo headers. Literal Header Field without Indexing - Indexed Name.\n               writeInt(headerNameIndex, PREFIX_4_BITS, 0)\n               writeByteString(value)\n             }\n+\n             else -> {\n               // Literal Header Field with Incremental Indexing - Indexed Name.\n               writeInt(headerNameIndex, PREFIX_6_BITS, 0x40)\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2.kt\nindex 5cc30f8bba48..409e3c1fe9e0 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2.kt\n@@ -171,6 +171,7 @@ object Http2 {\n     when (type) {\n       // Special case types that have 0 or 1 flag.\n       TYPE_SETTINGS, TYPE_PING -> return if (flags == FLAG_ACK) \"ACK\" else BINARY[flags]\n+\n       TYPE_PRIORITY, TYPE_RST_STREAM, TYPE_GOAWAY, TYPE_WINDOW_UPDATE -> return BINARY[flags]\n     }\n     val result = if (flags < FLAGS.size) FLAGS[flags]!! else BINARY[flags]\n@@ -179,10 +180,14 @@ object Http2 {\n       type == TYPE_PUSH_PROMISE && flags and FLAG_END_PUSH_PROMISE != 0 -> {\n         result.replace(\"HEADERS\", \"PUSH_PROMISE\") // TODO: Avoid allocation.\n       }\n+\n       type == TYPE_DATA && flags and FLAG_COMPRESSED != 0 -> {\n         result.replace(\"PRIORITY\", \"COMPRESSED\") // TODO: Avoid allocation.\n       }\n-      else -> result\n+\n+      else -> {\n+        result\n+      }\n     }\n   }\n }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2Connection.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2Connection.kt\nindex c293d5740a7d..b79401a79f64 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2Connection.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2Connection.kt\n@@ -771,7 +771,9 @@ class Http2Connection internal constructor(\n           delta = peerInitialWindowSize - previousPeerSettings.initialWindowSize.toLong()\n           streamsToNotify =\n             when {\n-              delta == 0L || streams.isEmpty() -> null // No adjustment is necessary.\n+              delta == 0L || streams.isEmpty() -> null\n+\n+              // No adjustment is necessary.\n               else -> streams.values.toTypedArray()\n             }\n \n@@ -811,13 +813,16 @@ class Http2Connection internal constructor(\n             INTERVAL_PING -> {\n               intervalPongsReceived++\n             }\n+\n             DEGRADED_PING -> {\n               degradedPongsReceived++\n             }\n+\n             AWAIT_PING -> {\n               awaitPongsReceived++\n               notifyAll()\n             }\n+\n             else -> {\n               // Ignore an unexpected pong.\n             }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/idn/IdnaMappingTable.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/idn/IdnaMappingTable.kt\nindex b4c0852d8634..e22a8ed6d325 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/idn/IdnaMappingTable.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/idn/IdnaMappingTable.kt\n@@ -135,6 +135,7 @@ internal class IdnaMappingTable internal constructor(\n         val beginIndex = ranges.read14BitInt(rangesIndex + 2)\n         sink.writeUtf8(mappings, beginIndex, beginIndex + b1)\n       }\n+\n       in 64..79 -> {\n         // Mapped inline as codePoint delta to subtract\n         val b2 = ranges[rangesIndex + 2].code\n@@ -143,6 +144,7 @@ internal class IdnaMappingTable internal constructor(\n         val codepointDelta = (b1 and 0xF shl 14) or (b2 shl 7) or b3\n         sink.writeUtf8CodePoint(codePoint - codepointDelta)\n       }\n+\n       in 80..95 -> {\n         // Mapped inline as codePoint delta to add\n         val b2 = ranges[rangesIndex + 2].code\n@@ -151,47 +153,59 @@ internal class IdnaMappingTable internal constructor(\n         val codepointDelta = (b1 and 0xF shl 14) or (b2 shl 7) or b3\n         sink.writeUtf8CodePoint(codePoint + codepointDelta)\n       }\n+\n       119 -> {\n         // Ignored.\n       }\n+\n       120 -> {\n         // Valid.\n         sink.writeUtf8CodePoint(codePoint)\n       }\n+\n       121 -> {\n         // Disallowed.\n         sink.writeUtf8CodePoint(codePoint)\n         return false\n       }\n+\n       122 -> {\n         // Mapped inline to the sequence: [b2].\n         sink.writeByte(ranges[rangesIndex + 2].code)\n       }\n+\n       123 -> {\n         // Mapped inline to the sequence: [b2a].\n         sink.writeByte(ranges[rangesIndex + 2].code or 0x80)\n       }\n+\n       124 -> {\n         // Mapped inline to the sequence: [b2, b3].\n         sink.writeByte(ranges[rangesIndex + 2].code)\n         sink.writeByte(ranges[rangesIndex + 3].code)\n       }\n+\n       125 -> {\n         // Mapped inline to the sequence: [b2a, b3].\n         sink.writeByte(ranges[rangesIndex + 2].code or 0x80)\n         sink.writeByte(ranges[rangesIndex + 3].code)\n       }\n+\n       126 -> {\n         // Mapped inline to the sequence: [b2, b3a].\n         sink.writeByte(ranges[rangesIndex + 2].code)\n         sink.writeByte(ranges[rangesIndex + 3].code or 0x80)\n       }\n+\n       127 -> {\n         // Mapped inline to the sequence: [b2a, b3a].\n         sink.writeByte(ranges[rangesIndex + 2].code or 0x80)\n         sink.writeByte(ranges[rangesIndex + 3].code or 0x80)\n       }\n-      else -> error(\"unexpected rangesIndex for $codePoint\")\n+\n+      else -> {\n+        error(\"unexpected rangesIndex for $codePoint\")\n+      }\n     }\n \n     return true\n@@ -216,7 +230,9 @@ internal class IdnaMappingTable internal constructor(\n       }\n \n     return when {\n-      offset >= 0 -> offset * 4 // This section was found by binary search.\n+      offset >= 0 -> offset * 4\n+\n+      // This section was found by binary search.\n       else -> (-offset - 2) * 4 // Not found? Use the preceding element.\n     }\n   }\n@@ -244,7 +260,9 @@ internal class IdnaMappingTable internal constructor(\n       }\n \n     return when {\n-      offset >= 0 -> offset * 4 // This entry was found by binary search.\n+      offset >= 0 -> offset * 4\n+\n+      // This entry was found by binary search.\n       else -> (-offset - 2) * 4 // Not found? Use the preceding element.\n     }\n   }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/idn/Punycode.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/idn/Punycode.kt\nindex da60d074c811..a2959cce170c 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/idn/Punycode.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/idn/Punycode.kt\n@@ -204,7 +204,10 @@ object Punycode {\n           in 'a'..'z', in 'A'..'Z', in '0'..'9', '-' -> {\n             codePoints += codePoint.code\n           }\n-          else -> return false // Malformed.\n+\n+          else -> {\n+            return false\n+          } // Malformed.\n         }\n       }\n       pos++ // Consume '-'.\n@@ -311,7 +314,9 @@ object Punycode {\n             }\n           }\n \n-          else -> c.code\n+          else -> {\n+            c.code\n+          }\n         }\n       i++\n     }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/internal.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/internal.kt\nindex 5a87df07ff14..4a31b17be342 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/internal.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/internal.kt\n@@ -14,12 +14,13 @@\n  * limitations under the License.\n  */\n \n-/** Exposes Kotlin-internal APIs to Java test code and code in other modules. */\n @file:JvmName(\"Internal\")\n @file:Suppress(\"ktlint:standard:filename\")\n \n package okhttp3.internal\n \n+// Exposes Kotlin-internal APIs to Java test code and code in other modules.\n+\n import java.nio.charset.Charset\n import javax.net.ssl.SSLSocket\n import okhttp3.Cache\n@@ -38,6 +39,8 @@ import okhttp3.internal.concurrent.TaskRunner\n import okhttp3.internal.connection.ConnectionListener\n import okhttp3.internal.connection.RealConnection\n \n+// Exposes Kotlin-internal APIs to Java test code and code in other modules.\n+\n internal fun parseCookie(\n   currentTimeMillis: Long,\n   url: HttpUrl,\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/platform/Jdk9Platform.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/platform/Jdk9Platform.kt\nindex a0245aebca67..ce605b6ea6d5 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/platform/Jdk9Platform.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/platform/Jdk9Platform.kt\n@@ -70,9 +70,11 @@ open class Jdk9Platform : Platform() {\n \n   override fun newSSLContext(): SSLContext =\n     when {\n-      majorVersion != null && majorVersion >= 9 ->\n+      majorVersion != null && majorVersion >= 9 -> {\n         SSLContext.getInstance(\"TLS\")\n-      else ->\n+      }\n+\n+      else -> {\n         try {\n           // Based on SSLSocket.getApplicationProtocol check we should\n           // have TLSv1.3 if we request it.\n@@ -81,6 +83,7 @@ open class Jdk9Platform : Platform() {\n         } catch (nsae: NoSuchAlgorithmException) {\n           SSLContext.getInstance(\"TLS\")\n         }\n+      }\n     }\n \n   companion object {\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/platform/Platform.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/platform/Platform.kt\nindex 564640d1c995..08fa6f8e7123 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/platform/Platform.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/platform/Platform.kt\n@@ -166,7 +166,9 @@ open class Platform {\n    */\n   open fun getStackTraceForCloseable(closer: String): Any? =\n     when {\n-      logger.isLoggable(Level.FINE) -> Throwable(closer) // These are expensive to allocate.\n+      logger.isLoggable(Level.FINE) -> Throwable(closer)\n+\n+      // These are expensive to allocate.\n       else -> null\n     }\n \ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/tls/OkHostnameVerifier.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/tls/OkHostnameVerifier.kt\nindex d70e0959c3a8..0431b28e3ba4 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/tls/OkHostnameVerifier.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/tls/OkHostnameVerifier.kt\n@@ -89,7 +89,9 @@ object OkHostnameVerifier : HostnameVerifier {\n    */\n   private fun String.asciiToLowercase(): String =\n     when {\n-      isAscii() -> lowercase(Locale.US) // This is an ASCII string.\n+      isAscii() -> lowercase(Locale.US)\n+\n+      // This is an ASCII string.\n       else -> this\n     }\n \ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/ws/WebSocketExtensions.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/ws/WebSocketExtensions.kt\nindex 83c2e896ae44..f48f6415daaa 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/ws/WebSocketExtensions.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/ws/WebSocketExtensions.kt\n@@ -135,21 +135,25 @@ data class WebSocketExtensions(\n                     clientMaxWindowBits = value?.toIntOrNull()\n                     if (clientMaxWindowBits == null) unexpectedValues = true // Not an int!\n                   }\n+\n                   name.equals(\"client_no_context_takeover\", ignoreCase = true) -> {\n                     if (clientNoContextTakeover) unexpectedValues = true // Repeated parameter!\n                     if (value != null) unexpectedValues = true // Unexpected value!\n                     clientNoContextTakeover = true\n                   }\n+\n                   name.equals(\"server_max_window_bits\", ignoreCase = true) -> {\n                     if (serverMaxWindowBits != null) unexpectedValues = true // Repeated parameter!\n                     serverMaxWindowBits = value?.toIntOrNull()\n                     if (serverMaxWindowBits == null) unexpectedValues = true // Not an int!\n                   }\n+\n                   name.equals(\"server_no_context_takeover\", ignoreCase = true) -> {\n                     if (serverNoContextTakeover) unexpectedValues = true // Repeated parameter!\n                     if (value != null) unexpectedValues = true // Unexpected value!\n                     serverNoContextTakeover = true\n                   }\n+\n                   else -> {\n                     unexpectedValues = true // Unexpected parameter.\n                   }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/ws/WebSocketReader.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/ws/WebSocketReader.kt\nindex 3c7bd0f6d586..a80d366d1479 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/ws/WebSocketReader.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/ws/WebSocketReader.kt\n@@ -150,6 +150,7 @@ class WebSocketReader(\n             false\n           }\n       }\n+\n       else -> {\n         if (reservedFlag1) throw ProtocolException(\"Unexpected rsv1 flag\")\n       }\n@@ -215,9 +216,11 @@ class WebSocketReader(\n       OPCODE_CONTROL_PING -> {\n         frameCallback.onReadPing(controlFrameBuffer.readByteString())\n       }\n+\n       OPCODE_CONTROL_PONG -> {\n         frameCallback.onReadPong(controlFrameBuffer.readByteString())\n       }\n+\n       OPCODE_CONTROL_CLOSE -> {\n         var code = CLOSE_NO_STATUS_CODE\n         var reason = \"\"\n@@ -233,6 +236,7 @@ class WebSocketReader(\n         frameCallback.onReadClose(code, reason)\n         receivedCloseFrame = true\n       }\n+\n       else -> {\n         throw ProtocolException(\"Unknown control opcode: \" + opcode.toHexString())\n       }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/ws/WebSocketWriter.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/ws/WebSocketWriter.kt\nindex 3416bc1ddad4..171afd2db151 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/ws/WebSocketWriter.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/ws/WebSocketWriter.kt\n@@ -179,11 +179,13 @@ class WebSocketWriter(\n         b1 = b1 or dataSize.toInt()\n         sinkBuffer.writeByte(b1)\n       }\n+\n       dataSize <= PAYLOAD_SHORT_MAX -> {\n         b1 = b1 or PAYLOAD_SHORT\n         sinkBuffer.writeByte(b1)\n         sinkBuffer.writeShort(dataSize.toInt())\n       }\n+\n       else -> {\n         b1 = b1 or PAYLOAD_LONG\n         sinkBuffer.writeByte(b1)\ndiff --git a/okhttp/src/jvmMain/kotlin/okhttp3/internal/platform/BouncyCastlePlatform.kt b/okhttp/src/jvmMain/kotlin/okhttp3/internal/platform/BouncyCastlePlatform.kt\nindex 037f34143170..83e2e57ee61b 100644\n--- a/okhttp/src/jvmMain/kotlin/okhttp3/internal/platform/BouncyCastlePlatform.kt\n+++ b/okhttp/src/jvmMain/kotlin/okhttp3/internal/platform/BouncyCastlePlatform.kt\n@@ -78,6 +78,7 @@ class BouncyCastlePlatform private constructor() : Platform() {\n       when (val protocol = (sslSocket as BCSSLSocket).applicationProtocol) {\n         // Handles both un-configured and none selected.\n         null, \"\" -> null\n+\n         else -> protocol\n       }\n     } else {\ndiff --git a/okhttp/src/jvmMain/kotlin/okhttp3/internal/platform/ConscryptPlatform.kt b/okhttp/src/jvmMain/kotlin/okhttp3/internal/platform/ConscryptPlatform.kt\nindex 76cc3330948d..51ef4ca4b3c2 100644\n--- a/okhttp/src/jvmMain/kotlin/okhttp3/internal/platform/ConscryptPlatform.kt\n+++ b/okhttp/src/jvmMain/kotlin/okhttp3/internal/platform/ConscryptPlatform.kt\n@@ -113,6 +113,7 @@ class ConscryptPlatform private constructor() : Platform() {\n         when {\n           // Bump this version if we ever have a binary incompatibility\n           Conscrypt.isAvailable() && atLeastVersion(2, 1, 0) -> true\n+\n           else -> false\n         }\n       } catch (e: NoClassDefFoundError) {\ndiff --git a/okhttp/src/jvmMain/kotlin/okhttp3/internal/platform/OpenJSSEPlatform.kt b/okhttp/src/jvmMain/kotlin/okhttp3/internal/platform/OpenJSSEPlatform.kt\nindex de01a147ce0b..e4d50a391144 100644\n--- a/okhttp/src/jvmMain/kotlin/okhttp3/internal/platform/OpenJSSEPlatform.kt\n+++ b/okhttp/src/jvmMain/kotlin/okhttp3/internal/platform/OpenJSSEPlatform.kt\n@@ -84,6 +84,7 @@ class OpenJSSEPlatform private constructor() : Platform() {\n       when (val protocol = sslSocket.applicationProtocol) {\n         // Handles both un-configured and none selected.\n         null, \"\" -> null\n+\n         else -> protocol\n       }\n     } else {\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/CallTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/CallTest.kt\nindex 542cc3b7b8fa..4d7d51433fcd 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/CallTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/CallTest.kt\n@@ -1470,15 +1470,20 @@ open class CallTest {\n         is SSLProtocolException -> {\n           // RI response to the FAIL_HANDSHAKE\n         }\n+\n         is SSLHandshakeException -> {\n           // Android's response to the FAIL_HANDSHAKE\n         }\n+\n         is SSLException -> {\n           // JDK 11 response to the FAIL_HANDSHAKE\n           val jvmVersion = System.getProperty(\"java.specification.version\")\n           assertThat(jvmVersion).isEqualTo(\"11\")\n         }\n-        else -> throw expected\n+\n+        else -> {\n+          throw expected\n+        }\n       }\n     }\n   }\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/ConnectionReuseTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/ConnectionReuseTest.kt\nindex 7162f1d0580b..24fe58bbe60a 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/ConnectionReuseTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/ConnectionReuseTest.kt\n@@ -260,7 +260,10 @@ class ConnectionReuseTest {\n     }.also { expected ->\n       when (expected) {\n         is SSLException, is TlsFatalAlert -> {}\n-        else -> throw expected\n+\n+        else -> {\n+          throw expected\n+        }\n       }\n     }\n   }\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/EventListenerTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/EventListenerTest.kt\nindex 4c3cd481c0af..a0e976bf49a4 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/EventListenerTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/EventListenerTest.kt\n@@ -501,18 +501,21 @@ class EventListenerTest(\n       )\n     expectedEventTypes +=\n       when {\n-        emptyBody ->\n+        emptyBody -> {\n           listOf(\n             ResponseBodyStart::class,\n             ResponseBodyEnd::class,\n             FollowUpDecision::class,\n           )\n-        else ->\n+        }\n+\n+        else -> {\n           listOf(\n             FollowUpDecision::class,\n             ResponseBodyStart::class,\n             ResponseBodyEnd::class,\n           )\n+        }\n       }\n     expectedEventTypes +=\n       listOf(\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/FakeRoutePlanner.kt b/okhttp/src/jvmTest/kotlin/okhttp3/FakeRoutePlanner.kt\nindex 19c474b1c00b..f086e3d49f8b 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/FakeRoutePlanner.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/FakeRoutePlanner.kt\n@@ -145,14 +145,17 @@ class FakeRoutePlanner(\n           events += \"plan $id TCP connect failed\"\n           ConnectResult(this, nextPlan = connectTcpNextPlan, throwable = tcpConnectThrowable)\n         }\n+\n         canceled -> {\n           events += \"plan $id TCP connect canceled\"\n           ConnectResult(this, nextPlan = connectTcpNextPlan, throwable = IOException(\"canceled\"))\n         }\n+\n         connectTcpNextPlan != null -> {\n           events += \"plan $id needs follow-up\"\n           ConnectResult(this, nextPlan = connectTcpNextPlan)\n         }\n+\n         else -> {\n           events += \"plan $id TCP connected\"\n           connectState = ConnectState.TCP_CONNECTED\n@@ -172,14 +175,17 @@ class FakeRoutePlanner(\n           events += \"plan $id TLS connect failed\"\n           ConnectResult(this, nextPlan = connectTlsNextPlan, throwable = tlsConnectThrowable)\n         }\n+\n         canceled -> {\n           events += \"plan $id TLS connect canceled\"\n           ConnectResult(this, nextPlan = connectTlsNextPlan, throwable = IOException(\"canceled\"))\n         }\n+\n         connectTlsNextPlan != null -> {\n           events += \"plan $id needs follow-up\"\n           ConnectResult(this, nextPlan = connectTlsNextPlan)\n         }\n+\n         else -> {\n           events += \"plan $id TLS connected\"\n           connectState = ConnectState.TLS_CONNECTED\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/JSSETest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/JSSETest.kt\nindex 098cc7870b8c..a71602189e81 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/JSSETest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/JSSETest.kt\n@@ -100,29 +100,36 @@ class JSSETest {\n     val s = factory.createSocket() as SSLSocket\n \n     when {\n-      PlatformVersion.majorVersion > 11 ->\n+      PlatformVersion.majorVersion > 11 -> {\n         assertThat(s.enabledProtocols.toList()).containsExactly(\n           \"TLSv1.3\",\n           \"TLSv1.2\",\n         )\n+      }\n+\n       // Not much we can guarantee on JDK 11.\n-      PlatformVersion.majorVersion == 11 ->\n+      PlatformVersion.majorVersion == 11 -> {\n         assertThat(s.enabledProtocols.toList()).contains(\n           \"TLSv1.2\",\n         )\n+      }\n+\n       // JDK 8 291 removed older versions\n       // See https://java.com/en/jre-jdk-cryptoroadmap.html\n-      PlatformVersion.majorVersion == 8 ->\n+      PlatformVersion.majorVersion == 8 -> {\n         assertThat(s.enabledProtocols.toList()).contains(\n           \"TLSv1.2\",\n         )\n-      else ->\n+      }\n+\n+      else -> {\n         assertThat(s.enabledProtocols.toList()).containsExactly(\n           \"TLSv1.3\",\n           \"TLSv1.2\",\n           \"TLSv1.1\",\n           \"TLSv1\",\n         )\n+      }\n     }\n   }\n \ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/SocksProxy.kt b/okhttp/src/jvmTest/kotlin/okhttp3/SocksProxy.kt\nindex 108b7a46907c..4e2f79b1d613 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/SocksProxy.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/SocksProxy.kt\n@@ -129,7 +129,10 @@ class SocksProxy {\n         fromSink.writeByte(selectedMethod)\n         fromSink.emit()\n       }\n-      else -> throw ProtocolException(\"unsupported method: $selectedMethod\")\n+\n+      else -> {\n+        throw ProtocolException(\"unsupported method: $selectedMethod\")\n+      }\n     }\n   }\n \n@@ -162,11 +165,16 @@ class SocksProxy {\n             domainName.equals(HOSTNAME_THAT_ONLY_THE_PROXY_KNOWS, ignoreCase = true) -> {\n               InetAddress.getByName(\"localhost\")\n             }\n-            else -> InetAddress.getByName(domainName)\n+\n+            else -> {\n+              InetAddress.getByName(domainName)\n+            }\n           }\n         }\n \n-        else -> throw ProtocolException(\"unsupported address type: $addressType\")\n+        else -> {\n+          throw ProtocolException(\"unsupported address type: $addressType\")\n+        }\n       }\n \n     val port = fromSource.readShort() and 0xffff\n@@ -197,7 +205,9 @@ class SocksProxy {\n         transfer(fromAddress, toAddress, toSource, fromSink)\n       }\n \n-      else -> throw ProtocolException(\"unexpected command: $command\")\n+      else -> {\n+        throw ProtocolException(\"unexpected command: $command\")\n+      }\n     }\n   }\n \ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/TrailersTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/TrailersTest.kt\nindex e41124d5414c..3cf790a2d658 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/TrailersTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/TrailersTest.kt\n@@ -643,7 +643,9 @@ open class TrailersTest {\n     body: String,\n   ) = apply {\n     when (protocol) {\n-      Protocol.HTTP_1_1 -> chunkedBody(body, 1024) // Force multiple chunks.\n+      Protocol.HTTP_1_1 -> chunkedBody(body, 1024)\n+\n+      // Force multiple chunks.\n       else -> body(body)\n     }\n   }\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/URLConnectionTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/URLConnectionTest.kt\nindex 24c1aab1a4a5..5b85f6384bba 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/URLConnectionTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/URLConnectionTest.kt\n@@ -641,7 +641,10 @@ class URLConnectionTest {\n     }.also { expected ->\n       when (expected) {\n         is SSLException, is TlsFatalAlert -> {}\n-        else -> throw expected\n+\n+        else -> {\n+          throw expected\n+        }\n       }\n     }\n   }\n@@ -762,8 +765,12 @@ class URLConnectionTest {\n             assertThat(expected.cause!!).isInstanceOf<CertificateException>()\n           }\n         }\n+\n         is TlsFatalAlert -> {}\n-        else -> throw expected\n+\n+        else -> {\n+          throw expected\n+        }\n       }\n     }\n     assertThat(server.requestCount).isEqualTo(0)\n@@ -4080,17 +4087,23 @@ class URLConnectionTest {\n         is SSLProtocolException -> {\n           // RI response to the FAIL_HANDSHAKE\n         }\n+\n         is SSLHandshakeException -> {\n           // Android's response to the FAIL_HANDSHAKE\n         }\n+\n         is SSLException -> {\n           // JDK 1.9 response to the FAIL_HANDSHAKE\n           // javax.net.ssl.SSLException: Unexpected handshake message: client_hello\n         }\n+\n         is SocketException -> {\n           // Conscrypt's response to the FAIL_HANDSHAKE\n         }\n-        else -> throw expected\n+\n+        else -> {\n+          throw expected\n+        }\n       }\n     }\n   }\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/UrlComponentEncodingTester.kt b/okhttp/src/jvmTest/kotlin/okhttp3/UrlComponentEncodingTester.kt\nindex f120eddef1c1..956dbd97afd1 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/UrlComponentEncodingTester.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/UrlComponentEncodingTester.kt\n@@ -51,35 +51,35 @@ class UrlComponentEncodingTester private constructor() {\n \n   fun nonPrintableAscii(encoding: Encoding) =\n     apply {\n-      encodings[ 0x0] = encoding // Null character\n-      encodings[ 0x1] = encoding // Start of Header\n-      encodings[ 0x2] = encoding // Start of Text\n-      encodings[ 0x3] = encoding // End of Text\n-      encodings[ 0x4] = encoding // End of Transmission\n-      encodings[ 0x5] = encoding // Enquiry\n-      encodings[ 0x6] = encoding // Acknowledgment\n-      encodings[ 0x7] = encoding // Bell\n+      encodings[0x0] = encoding // Null character\n+      encodings[0x1] = encoding // Start of Header\n+      encodings[0x2] = encoding // Start of Text\n+      encodings[0x3] = encoding // End of Text\n+      encodings[0x4] = encoding // End of Transmission\n+      encodings[0x5] = encoding // Enquiry\n+      encodings[0x6] = encoding // Acknowledgment\n+      encodings[0x7] = encoding // Bell\n       encodings['\\b'.code] = encoding // Backspace\n-      encodings[ 0xb] = encoding // Vertical Tab\n-      encodings[ 0xe] = encoding // Shift Out\n-      encodings[ 0xf] = encoding // Shift In\n-      encodings[ 0x10] = encoding // Data Link Escape\n-      encodings[ 0x11] = encoding // Device Control 1 (oft. XON)\n-      encodings[ 0x12] = encoding // Device Control 2\n-      encodings[ 0x13] = encoding // Device Control 3 (oft. XOFF)\n-      encodings[ 0x14] = encoding // Device Control 4\n-      encodings[ 0x15] = encoding // Negative Acknowledgment\n-      encodings[ 0x16] = encoding // Synchronous idle\n-      encodings[ 0x17] = encoding // End of Transmission Block\n-      encodings[ 0x18] = encoding // Cancel\n-      encodings[ 0x19] = encoding // End of Medium\n-      encodings[ 0x1a] = encoding // Substitute\n-      encodings[ 0x1b] = encoding // Escape\n-      encodings[ 0x1c] = encoding // File Separator\n-      encodings[ 0x1d] = encoding // Group Separator\n-      encodings[ 0x1e] = encoding // Record Separator\n-      encodings[ 0x1f] = encoding // Unit Separator\n-      encodings[ 0x7f] = encoding // Delete\n+      encodings[0xb] = encoding // Vertical Tab\n+      encodings[0xe] = encoding // Shift Out\n+      encodings[0xf] = encoding // Shift In\n+      encodings[0x10] = encoding // Data Link Escape\n+      encodings[0x11] = encoding // Device Control 1 (oft. XON)\n+      encodings[0x12] = encoding // Device Control 2\n+      encodings[0x13] = encoding // Device Control 3 (oft. XOFF)\n+      encodings[0x14] = encoding // Device Control 4\n+      encodings[0x15] = encoding // Negative Acknowledgment\n+      encodings[0x16] = encoding // Synchronous idle\n+      encodings[0x17] = encoding // End of Transmission Block\n+      encodings[0x18] = encoding // Cancel\n+      encodings[0x19] = encoding // End of Medium\n+      encodings[0x1a] = encoding // Substitute\n+      encodings[0x1b] = encoding // Escape\n+      encodings[0x1c] = encoding // File Separator\n+      encodings[0x1d] = encoding // Group Separator\n+      encodings[0x1e] = encoding // Record Separator\n+      encodings[0x1f] = encoding // Unit Separator\n+      encodings[0x7f] = encoding // Delete\n     }\n \n   fun nonAscii(encoding: Encoding) =\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/UrlComponentEncodingTesterJvm.kt b/okhttp/src/jvmTest/kotlin/okhttp3/UrlComponentEncodingTesterJvm.kt\nindex 790dae522f1c..64a4fe35d279 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/UrlComponentEncodingTesterJvm.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/UrlComponentEncodingTesterJvm.kt\n@@ -22,15 +22,17 @@ import okhttp3.UrlComponentEncodingTester.Component\n \n fun urlComponentEncodingTesterJvmPlatform(component: Component): UrlComponentEncodingTester.Platform =\n   when (component) {\n-    Component.USER ->\n+    Component.USER -> {\n       UrlComponentEncodingTesterJvmPlatform()\n         .escapeForUri('%'.code)\n+    }\n \n-    Component.PASSWORD ->\n+    Component.PASSWORD -> {\n       UrlComponentEncodingTesterJvmPlatform()\n         .escapeForUri('%'.code)\n+    }\n \n-    Component.HOST ->\n+    Component.HOST -> {\n       UrlComponentEncodingTesterJvmPlatform()\n         .stripForUri(\n           '\\\"'.code,\n@@ -42,16 +44,18 @@ fun urlComponentEncodingTesterJvmPlatform(component: Component): UrlComponentEnc\n           '|'.code,\n           '}'.code,\n         )\n+    }\n \n-    Component.PATH ->\n+    Component.PATH -> {\n       UrlComponentEncodingTesterJvmPlatform()\n         .escapeForUri(\n           '%'.code,\n           '['.code,\n           ']'.code,\n         )\n+    }\n \n-    Component.QUERY ->\n+    Component.QUERY -> {\n       UrlComponentEncodingTesterJvmPlatform()\n         .escapeForUri(\n           '%'.code,\n@@ -62,8 +66,9 @@ fun urlComponentEncodingTesterJvmPlatform(component: Component): UrlComponentEnc\n           '|'.code,\n           '}'.code,\n         )\n+    }\n \n-    Component.QUERY_VALUE ->\n+    Component.QUERY_VALUE -> {\n       UrlComponentEncodingTesterJvmPlatform()\n         .escapeForUri(\n           '%'.code,\n@@ -74,8 +79,9 @@ fun urlComponentEncodingTesterJvmPlatform(component: Component): UrlComponentEnc\n           '|'.code,\n           '}'.code,\n         )\n+    }\n \n-    Component.FRAGMENT ->\n+    Component.FRAGMENT -> {\n       UrlComponentEncodingTesterJvmPlatform()\n         .escapeForUri(\n           '%'.code,\n@@ -91,6 +97,7 @@ fun urlComponentEncodingTesterJvmPlatform(component: Component): UrlComponentEnc\n           '|'.code,\n           '}'.code,\n         )\n+    }\n   }\n \n private class UrlComponentEncodingTesterJvmPlatform : UrlComponentEncodingTester.Platform() {\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/internal/http2/HttpOverHttp2Test.kt b/okhttp/src/jvmTest/kotlin/okhttp3/internal/http2/HttpOverHttp2Test.kt\nindex 174d5a18b986..aa9119bd78b3 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/internal/http2/HttpOverHttp2Test.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/internal/http2/HttpOverHttp2Test.kt\n@@ -1552,7 +1552,10 @@ class HttpOverHttp2Test(\n     }.also { expected ->\n       when (expected) {\n         is SocketTimeoutException, is SSLException -> {}\n-        else -> throw expected\n+\n+        else -> {\n+          throw expected\n+        }\n       }\n     }\n \ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/internal/tls/CertificatePinnerChainValidationTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/internal/tls/CertificatePinnerChainValidationTest.kt\nindex f9b01cec856a..99da0f748797 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/internal/tls/CertificatePinnerChainValidationTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/internal/tls/CertificatePinnerChainValidationTest.kt\n@@ -439,11 +439,15 @@ class CertificatePinnerChainValidationTest {\n           // On Android, the handshake fails before the certificate pinner runs.\n           assertThat(expected.message!!).contains(\"Could not validate certificate\")\n         }\n+\n         is SSLPeerUnverifiedException -> {\n           // On OpenJDK, the handshake succeeds but the certificate pinner fails.\n           assertThat(expected.message!!).startsWith(\"Certificate pinning failure!\")\n         }\n-        else -> throw expected\n+\n+        else -> {\n+          throw expected\n+        }\n       }\n     }\n   }\n@@ -599,11 +603,15 @@ class CertificatePinnerChainValidationTest {\n           // Certificate pinning fails!\n           assertThat(expected.message!!).startsWith(\"Certificate pinning failure!\")\n         }\n+\n         is SSLHandshakeException -> {\n           // We didn't have the opportunity to do certificate pinning because the handshake failed.\n           assertThat(expected.message!!).contains(\"this is not a CA certificate\")\n         }\n-        else -> throw expected\n+\n+        else -> {\n+          throw expected\n+        }\n       }\n     }\n   }\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/internal/tls/ClientAuthTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/internal/tls/ClientAuthTest.kt\nindex c30d73545151..2d96d4839946 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/internal/tls/ClientAuthTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/internal/tls/ClientAuthTest.kt\n@@ -240,12 +240,15 @@ class ClientAuthTest {\n         is SSLHandshakeException -> {\n           // JDK 11+\n         }\n+\n         is SSLException -> {\n           // javax.net.ssl.SSLException: readRecord\n         }\n+\n         is SocketException -> {\n           // Conscrypt, JDK 8 (>= 292), JDK 9\n         }\n+\n         else -> {\n           assertThat(expected.message).isEqualTo(\"exhausted all routes\")\n         }\n@@ -295,15 +298,19 @@ class ClientAuthTest {\n         is SSLHandshakeException -> {\n           // JDK 11+\n         }\n+\n         is SSLException -> {\n           // javax.net.ssl.SSLException: readRecord\n         }\n+\n         is SocketException -> {\n           // Conscrypt, JDK 8 (>= 292), JDK 9\n         }\n+\n         is ConnectionShutdownException -> {\n           // It didn't fail until it reached the application layer.\n         }\n+\n         else -> {\n           assertThat(expected.message).isEqualTo(\"exhausted all routes\")\n         }\ndiff --git a/samples/guide/src/main/java/okhttp3/recipes/kt/WiresharkExample.kt b/samples/guide/src/main/java/okhttp3/recipes/kt/WiresharkExample.kt\nindex 90f4ec6668f5..f44e00883d6f 100644\n--- a/samples/guide/src/main/java/okhttp3/recipes/kt/WiresharkExample.kt\n+++ b/samples/guide/src/main/java/okhttp3/recipes/kt/WiresharkExample.kt\n@@ -86,6 +86,7 @@ class WireSharkListenerFactory(\n           Thread.sleep(10000)\n         }\n       }\n+\n       CommandLine -> {\n         return ProcessBuilder(\n           \"tshark\",\n@@ -102,6 +103,7 @@ class WireSharkListenerFactory(\n           .redirectError(Redirect.INHERIT)\n           .start()\n       }\n+\n       Gui -> {\n         return ProcessBuilder(\n           \"nohup\",\n",
  "test_patch" : "diff --git a/android-test/src/androidDeviceTest/java/okhttp/android/test/OkHttpTest.kt b/android-test/src/androidDeviceTest/java/okhttp/android/test/OkHttpTest.kt\nindex b960cf3be026..8eaf809ef98c 100644\n--- a/android-test/src/androidDeviceTest/java/okhttp/android/test/OkHttpTest.kt\n+++ b/android-test/src/androidDeviceTest/java/okhttp/android/test/OkHttpTest.kt\n@@ -248,9 +248,11 @@ class OkHttpTest {\n             // Conscrypt 2.5+ defaults to SSLEngine-based SSLSocket\n             assertEquals(\"org.conscrypt.Java8EngineSocket\", socketClass)\n           }\n+\n           Build.VERSION.SDK_INT < 22 -> {\n             assertEquals(\"org.conscrypt.KitKatPlatformOpenSSLSocketImplAdapter\", socketClass)\n           }\n+\n           else -> {\n             assertEquals(\"org.conscrypt.ConscryptFileDescriptorSocket\", socketClass)\n           }\n@@ -856,6 +858,7 @@ class OkHttpTest {\n         is IllegalArgumentException -> {\n           assertEquals(\"Android internal error\", ioe.message)\n         }\n+\n         is CertificateException -> {\n           assertTrue(ioe.cause?.cause is IllegalArgumentException)\n           assertEquals(\n@@ -866,7 +869,10 @@ class OkHttpTest {\n               ?.startsWith(\"Invalid input to toASCII\"),\n           )\n         }\n-        else -> throw ioe\n+\n+        else -> {\n+          throw ioe\n+        }\n       }\n     }\n   }\ndiff --git a/samples/guide/src/test/kotlin/okhttp3/AllMainsTest.kt b/samples/guide/src/test/kotlin/okhttp3/AllMainsTest.kt\nindex a4da8ae695a9..2340118f6508 100644\n--- a/samples/guide/src/test/kotlin/okhttp3/AllMainsTest.kt\n+++ b/samples/guide/src/test/kotlin/okhttp3/AllMainsTest.kt\n@@ -91,8 +91,12 @@ class AllMainsTest {\n     cause: Throwable,\n   ): Boolean =\n     when (className) {\n-      \"okhttp3.recipes.CheckHandshake\" -> true // by design\n-      \"okhttp3.recipes.RequestBodyCompression\" -> true // expired token\n+      \"okhttp3.recipes.CheckHandshake\" -> true\n+\n+      // by design\n+      \"okhttp3.recipes.RequestBodyCompression\" -> true\n+\n+      // expired token\n       else -> false\n     }\n }\n",
  "problem_statement" : "Update dependency com.diffplug.spotless:spotless-plugin-gradle to v8.2.0\n\nThis PR contains the following updates:\n\n| Package | Change | [Age](https://docs.renovatebot.com/merge-confidence/) | [Confidence](https://docs.renovatebot.com/merge-confidence/) |\n|---|---|---|---|\n| [com.diffplug.spotless:spotless-plugin-gradle](https://redirect.github.com/diffplug/spotless) | `8.1.0`  `8.2.0` | ![age](https://developer.mend.io/api/mc/badges/age/maven/com.diffplug.spotless:spotless-plugin-gradle/8.2.0?slim=true) | ![confidence](https://developer.mend.io/api/mc/badges/confidence/maven/com.diffplug.spotless:spotless-plugin-gradle/8.1.0/8.2.0?slim=true) |\n\n---\n\n### Configuration\n\n\uD83D\uDCC5 **Schedule**: Branch creation - At any time (no schedule defined), Automerge - At any time (no schedule defined).\n\n\uD83D\uDEA6 **Automerge**: Disabled by config. Please merge this manually once you are satisfied.\n\n **Rebasing**: Whenever PR becomes conflicted, or you tick the rebase/retry checkbox.\n\n\uD83D\uDD15 **Ignore**: Close this PR and you won't be reminded about this update again.\n\n---\n\n - [ ] <!-- rebase-check -->If you want to rebase/retry this PR, check this box\n\n---\n\nThis PR was generated by [Mend Renovate](https://mend.io/renovate/). View the [repository job log](https://developer.mend.io/github/square/okhttp).\n<!--renovate-debug:eyJjcmVhdGVkSW5WZXIiOiI0Mi45Mi4xIiwidXBkYXRlZEluVmVyIjoiNDIuOTIuMSIsInRhcmdldEJyYW5jaCI6Im1hc3RlciIsImxhYmVscyI6WyJyZW5vdmF0ZSJdfQ==-->\n",
  "hints_text" : null,
  "created_at" : "Sun Jan 25 17:14:30 CET 2026",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 9268,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-9207",
  "repo" : "square/okhttp",
  "base_commit" : "5b23df713244f82f76cb05e8164d6320b6dc1379",
  "patch" : "diff --git a/android-test/build.gradle.kts b/android-test/build.gradle.kts\nindex 60e705263d64..e704ee806d08 100644\n--- a/android-test/build.gradle.kts\n+++ b/android-test/build.gradle.kts\n@@ -111,3 +111,9 @@ dependencies {\n   androidTestImplementation(libs.junit5android.core)\n   androidTestRuntimeOnly(libs.junit5android.runner)\n }\n+\n+junitPlatform {\n+  filters {\n+    excludeTags(\"Remote\")\n+  }\n+}\n",
  "test_patch" : "diff --git a/android-test/src/androidTest/java/okhttp/android/test/SingleAndroidTest.kt b/android-test/src/androidTest/java/okhttp/android/test/SingleAndroidTest.kt\nindex 2697f5cbfaae..3844948b197f 100644\n--- a/android-test/src/androidTest/java/okhttp/android/test/SingleAndroidTest.kt\n+++ b/android-test/src/androidTest/java/okhttp/android/test/SingleAndroidTest.kt\n@@ -23,7 +23,7 @@ import okhttp3.ConnectionPool\n import okhttp3.OkHttpClient\n import okhttp3.Request\n import okhttp3.tls.internal.TlsUtil.localhost\n-import org.junit.Test\n+import org.junit.jupiter.api.Test\n \n /**\n  * This single Junit 4 test is our Android test suite on API 21-25.\ndiff --git a/android-test/src/androidTest/java/okhttp/android/test/StrictModeTest.kt b/android-test/src/androidTest/java/okhttp/android/test/StrictModeTest.kt\nindex 83317b9f021e..b75225373bcf 100644\n--- a/android-test/src/androidTest/java/okhttp/android/test/StrictModeTest.kt\n+++ b/android-test/src/androidTest/java/okhttp/android/test/StrictModeTest.kt\n@@ -27,8 +27,8 @@ import okhttp3.HttpUrl.Companion.toHttpUrl\n import okhttp3.OkHttpClient\n import okhttp3.Request\n import okhttp3.internal.platform.Platform\n-import org.junit.After\n-import org.junit.Test\n+import org.junit.jupiter.api.AfterEach\n+import org.junit.jupiter.api.Test\n import org.junit.jupiter.api.parallel.Isolated\n \n @Isolated\n@@ -36,7 +36,7 @@ import org.junit.jupiter.api.parallel.Isolated\n class StrictModeTest {\n   private val violations = mutableListOf<Violation>()\n \n-  @After\n+  @AfterEach\n   fun cleanup() {\n     StrictMode.setThreadPolicy(\n       ThreadPolicy\n",
  "problem_statement" : "Don't run remote tests in CI",
  "hints_text" : null,
  "created_at" : "Thu Nov 20 19:39:59 CET 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 9207,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-9129",
  "repo" : "square/okhttp",
  "base_commit" : "2f3491c0fbc2b1d02c7e1ca8e5de9202a8251bea",
  "patch" : "diff --git a/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/AndroidPlatform.kt b/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/AndroidPlatform.kt\nindex 3172491a404f..4f94d192b034 100644\n--- a/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/AndroidPlatform.kt\n+++ b/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/AndroidPlatform.kt\n@@ -132,8 +132,8 @@ class AndroidPlatform :\n     }\n \n   override fun getHandshakeServerNames(sslSocket: SSLSocket): List<String> {\n-    // The superclass implementation requires APIs not available until API 24+.\n-    if (Build.VERSION.SDK_INT < 24) return listOf()\n+    // The superclass implementation requires APIs not available until API 25+.\n+    if (Build.VERSION.SDK_INT <= 24) return listOf()\n     return super.getHandshakeServerNames(sslSocket)\n   }\n \n",
  "test_patch" : "diff --git a/android-test/src/androidTest/java/okhttp/android/test/SingleAndroidTest.kt b/android-test/src/androidTest/java/okhttp/android/test/SingleAndroidTest.kt\nnew file mode 100644\nindex 000000000000..0da3ccee050a\n--- /dev/null\n+++ b/android-test/src/androidTest/java/okhttp/android/test/SingleAndroidTest.kt\n@@ -0,0 +1,72 @@\n+/*\n+ * Copyright (C) 2025 Block, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package okhttp.android.test\n+\n+import kotlin.test.assertEquals\n+import mockwebserver3.MockResponse\n+import mockwebserver3.MockWebServer\n+import okhttp3.OkHttpClient\n+import okhttp3.Request\n+import okhttp3.tls.internal.TlsUtil.localhost\n+import org.junit.Test\n+\n+/**\n+ * This single Junit 4 test is our Android test suite on API 21-25.\n+ */\n+class SingleAndroidTest {\n+  private val handshakeCertificates = localhost()\n+\n+  private var client: OkHttpClient =\n+    OkHttpClient\n+      .Builder()\n+      .sslSocketFactory(\n+        handshakeCertificates.sslSocketFactory(),\n+        handshakeCertificates.trustManager,\n+      ).build()\n+\n+  private val server =\n+    MockWebServer()\n+\n+  @Test\n+  fun testHttpsRequest() {\n+    server.useHttps(handshakeCertificates.sslSocketFactory())\n+\n+    server.enqueue(MockResponse())\n+    server.start()\n+\n+    val request = Request.Builder().url(server.url(\"/\")).build()\n+\n+    val response = client.newCall(request).execute()\n+\n+    response.use {\n+      assertEquals(200, response.code)\n+    }\n+  }\n+\n+  @Test\n+  fun testHttpRequest() {\n+    server.enqueue(MockResponse())\n+    server.start()\n+\n+    val request = Request.Builder().url(server.url(\"/\")).build()\n+\n+    val response = client.newCall(request).execute()\n+\n+    response.use {\n+      assertEquals(200, response.code)\n+    }\n+  }\n+}\n",
  "problem_statement" : "Fix SSL Handshake issue affecting MockWebserver on Android 24\n\nOnly called in MWS, but fails on API 24 when called. Adds a single Junit 4 test to run on Android 21-25.\r\n\r\nAdd a test since Junit 5 wasn't running on older devices.",
  "hints_text" : null,
  "created_at" : "Thu Oct 09 23:19:29 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 9129,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-9118",
  "repo" : "square/okhttp",
  "base_commit" : "8eca8a834b9d8ed756a0328ec94b30bb78200503",
  "patch" : "diff --git a/okhttp-testing-support/src/main/kotlin/okhttp3/RecordingEventListener.kt b/okhttp-testing-support/src/main/kotlin/okhttp3/RecordingEventListener.kt\nindex 76e40f4e4b50..08b0a00a9d00 100644\n--- a/okhttp-testing-support/src/main/kotlin/okhttp3/RecordingEventListener.kt\n+++ b/okhttp-testing-support/src/main/kotlin/okhttp3/RecordingEventListener.kt\n@@ -138,7 +138,7 @@ open class RecordingEventListener(\n     return result\n   }\n \n-  fun recordedEventTypes() = eventSequence.map { it.name }\n+  fun recordedEventTypes() = eventSequence.map { it::class }\n \n   fun clearAllEvents() {\n     while (eventSequence.isNotEmpty()) {\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/CallTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/CallTest.kt\nindex 8927363bf027..00dccd080284 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/CallTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/CallTest.kt\n@@ -76,10 +76,26 @@ import mockwebserver3.SocketEffect.ShutdownConnection\n import mockwebserver3.SocketEffect.Stall\n import mockwebserver3.junit5.StartStop\n import okhttp3.CallEvent.CallEnd\n+import okhttp3.CallEvent.CallFailed\n+import okhttp3.CallEvent.CallStart\n+import okhttp3.CallEvent.ConnectEnd\n import okhttp3.CallEvent.ConnectStart\n import okhttp3.CallEvent.ConnectionAcquired\n import okhttp3.CallEvent.ConnectionReleased\n+import okhttp3.CallEvent.DnsEnd\n+import okhttp3.CallEvent.DnsStart\n+import okhttp3.CallEvent.FollowUpDecision\n+import okhttp3.CallEvent.ProxySelectEnd\n+import okhttp3.CallEvent.ProxySelectStart\n+import okhttp3.CallEvent.RequestBodyEnd\n+import okhttp3.CallEvent.RequestBodyStart\n+import okhttp3.CallEvent.RequestHeadersEnd\n+import okhttp3.CallEvent.RequestHeadersStart\n+import okhttp3.CallEvent.ResponseBodyEnd\n+import okhttp3.CallEvent.ResponseBodyStart\n import okhttp3.CallEvent.ResponseFailed\n+import okhttp3.CallEvent.ResponseHeadersEnd\n+import okhttp3.CallEvent.ResponseHeadersStart\n import okhttp3.CallEvent.RetryDecision\n import okhttp3.CertificatePinner.Companion.pin\n import okhttp3.Credentials.basic\n@@ -1716,16 +1732,16 @@ open class CallTest {\n     }\n \n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"RequestBodyStart\",\n-      \"RequestBodyEnd\",\n-      \"ResponseFailed\",\n-      \"RetryDecision\",\n-      \"ConnectionReleased\",\n-      \"CallFailed\",\n+      CallStart::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      RequestBodyStart::class,\n+      RequestBodyEnd::class,\n+      ResponseFailed::class,\n+      RetryDecision::class,\n+      ConnectionReleased::class,\n+      CallFailed::class,\n     )\n     assertThat(listener.findEvent<RetryDecision>()).all {\n       prop(RetryDecision::retry).isFalse()\n@@ -1736,23 +1752,23 @@ open class CallTest {\n     assertThat(response3.body.string()).isEqualTo(\"abc\")\n \n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"FollowUpDecision\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      FollowUpDecision::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n \n     val get = server.takeRequest()\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/DispatcherTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/DispatcherTest.kt\nindex d2955bb48b2d..3a74cde50563 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/DispatcherTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/DispatcherTest.kt\n@@ -31,6 +31,8 @@ import java.util.concurrent.CountDownLatch\n import java.util.concurrent.TimeUnit\n import java.util.concurrent.atomic.AtomicBoolean\n import kotlin.test.assertFailsWith\n+import okhttp3.CallEvent.CallFailed\n+import okhttp3.CallEvent.CallStart\n import okhttp3.CallEvent.DispatcherQueueEnd\n import okhttp3.CallEvent.DispatcherQueueStart\n import okhttp3.HttpUrl.Companion.toHttpUrl\n@@ -356,7 +358,7 @@ class DispatcherTest {\n     client.newCall(request).enqueue(callback)\n     callback.await(request.url).assertFailure(InterruptedIOException::class.java)\n     assertThat(listener.recordedEventTypes())\n-      .containsExactly(\"CallStart\", \"CallFailed\")\n+      .containsExactly(CallStart::class, CallFailed::class)\n   }\n \n   @Test\n@@ -370,7 +372,7 @@ class DispatcherTest {\n     dispatcher.maxRequests = 2 // Trigger promotion.\n     callback.await(request2.url).assertFailure(InterruptedIOException::class.java)\n     assertThat(listener.recordedEventTypes())\n-      .containsExactly(\"CallStart\", \"CallStart\", \"CallFailed\")\n+      .containsExactly(CallStart::class, CallStart::class, CallFailed::class)\n   }\n \n   @Test\n@@ -384,7 +386,7 @@ class DispatcherTest {\n     dispatcher.maxRequestsPerHost = 2 // Trigger promotion.\n     callback.await(request2.url).assertFailure(InterruptedIOException::class.java)\n     assertThat(listener.recordedEventTypes())\n-      .containsExactly(\"CallStart\", \"CallStart\", \"CallFailed\")\n+      .containsExactly(CallStart::class, CallStart::class, CallFailed::class)\n   }\n \n   @Test\n@@ -398,7 +400,7 @@ class DispatcherTest {\n     executor.finishJob(\"http://a/1\") // Trigger promotion.\n     callback.await(request2.url).assertFailure(InterruptedIOException::class.java)\n     assertThat(listener.recordedEventTypes())\n-      .containsExactly(\"CallStart\", \"CallStart\", \"CallFailed\")\n+      .containsExactly(CallStart::class, CallStart::class, CallFailed::class)\n   }\n \n   private fun makeSynchronousCall(call: Call): Thread {\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/DuplexTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/DuplexTest.kt\nindex 2fe2dd7b0cba..b8855a5f9c28 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/DuplexTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/DuplexTest.kt\n@@ -36,7 +36,28 @@ import kotlin.test.assertFailsWith\n import mockwebserver3.MockResponse\n import mockwebserver3.MockWebServer\n import mockwebserver3.junit5.StartStop\n+import okhttp3.CallEvent.CallEnd\n+import okhttp3.CallEvent.CallStart\n+import okhttp3.CallEvent.ConnectEnd\n+import okhttp3.CallEvent.ConnectStart\n+import okhttp3.CallEvent.ConnectionAcquired\n+import okhttp3.CallEvent.ConnectionReleased\n+import okhttp3.CallEvent.DnsEnd\n+import okhttp3.CallEvent.DnsStart\n import okhttp3.CallEvent.FollowUpDecision\n+import okhttp3.CallEvent.ProxySelectEnd\n+import okhttp3.CallEvent.ProxySelectStart\n+import okhttp3.CallEvent.RequestBodyEnd\n+import okhttp3.CallEvent.RequestBodyStart\n+import okhttp3.CallEvent.RequestFailed\n+import okhttp3.CallEvent.RequestHeadersEnd\n+import okhttp3.CallEvent.RequestHeadersStart\n+import okhttp3.CallEvent.ResponseBodyEnd\n+import okhttp3.CallEvent.ResponseBodyStart\n+import okhttp3.CallEvent.ResponseHeadersEnd\n+import okhttp3.CallEvent.ResponseHeadersStart\n+import okhttp3.CallEvent.SecureConnectEnd\n+import okhttp3.CallEvent.SecureConnectStart\n import okhttp3.Credentials.basic\n import okhttp3.Headers.Companion.headersOf\n import okhttp3.RequestBody.Companion.toRequestBody\n@@ -303,27 +324,27 @@ class DuplexTest {\n     }\n     body.awaitSuccess()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"SecureConnectStart\",\n-      \"SecureConnectEnd\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"RequestBodyStart\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"FollowUpDecision\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"RequestBodyEnd\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      SecureConnectStart::class,\n+      SecureConnectEnd::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      RequestBodyStart::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      FollowUpDecision::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      RequestBodyEnd::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n@@ -438,34 +459,34 @@ class DuplexTest {\n     }\n     body.awaitSuccess()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"SecureConnectStart\",\n-      \"SecureConnectEnd\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"RequestBodyStart\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"FollowUpDecision\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"FollowUpDecision\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n-      \"RequestFailed\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      SecureConnectStart::class,\n+      SecureConnectEnd::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      RequestBodyStart::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      FollowUpDecision::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      FollowUpDecision::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n+      RequestFailed::class,\n     )\n     assertThat(listener.findEvent<FollowUpDecision>()).all {\n       prop(FollowUpDecision::nextRequest).isNotNull()\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/EventListenerTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/EventListenerTest.kt\nindex 5ad9aba784cc..b99c1da798bd 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/EventListenerTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/EventListenerTest.kt\n@@ -45,16 +45,25 @@ import mockwebserver3.MockResponse\n import mockwebserver3.MockWebServer\n import mockwebserver3.SocketEffect.CloseSocket\n import mockwebserver3.junit5.StartStop\n+import okhttp3.CallEvent.CacheConditionalHit\n+import okhttp3.CallEvent.CacheHit\n+import okhttp3.CallEvent.CacheMiss\n import okhttp3.CallEvent.CallEnd\n import okhttp3.CallEvent.CallFailed\n import okhttp3.CallEvent.CallStart\n+import okhttp3.CallEvent.Canceled\n+import okhttp3.CallEvent.ConnectEnd\n import okhttp3.CallEvent.ConnectStart\n import okhttp3.CallEvent.ConnectionAcquired\n+import okhttp3.CallEvent.ConnectionReleased\n import okhttp3.CallEvent.DnsEnd\n import okhttp3.CallEvent.DnsStart\n import okhttp3.CallEvent.FollowUpDecision\n+import okhttp3.CallEvent.ProxySelectEnd\n+import okhttp3.CallEvent.ProxySelectStart\n import okhttp3.CallEvent.RequestBodyEnd\n import okhttp3.CallEvent.RequestBodyStart\n+import okhttp3.CallEvent.RequestFailed\n import okhttp3.CallEvent.RequestHeadersEnd\n import okhttp3.CallEvent.RequestHeadersStart\n import okhttp3.CallEvent.ResponseBodyEnd\n@@ -63,6 +72,7 @@ import okhttp3.CallEvent.ResponseFailed\n import okhttp3.CallEvent.ResponseHeadersEnd\n import okhttp3.CallEvent.ResponseHeadersStart\n import okhttp3.CallEvent.RetryDecision\n+import okhttp3.CallEvent.SatisfactionFailure\n import okhttp3.CallEvent.SecureConnectEnd\n import okhttp3.CallEvent.SecureConnectStart\n import okhttp3.MediaType.Companion.toMediaType\n@@ -81,7 +91,7 @@ import org.hamcrest.CoreMatchers\n import org.hamcrest.Description\n import org.hamcrest.Matcher\n import org.hamcrest.MatcherAssert\n-import org.junit.Assume\n+import org.junit.Assume.assumeThat\n import org.junit.jupiter.api.AfterEach\n import org.junit.jupiter.api.BeforeEach\n import org.junit.jupiter.api.Tag\n@@ -149,23 +159,23 @@ class EventListenerTest {\n     assertThat(response.body.string()).isEqualTo(\"abc\")\n     response.body.close()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"FollowUpDecision\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      FollowUpDecision::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n@@ -195,21 +205,21 @@ class EventListenerTest {\n     assertThat(response.body.string()).isEqualTo(\"abc\")\n     response.body.close()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"FollowUpDecision\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      FollowUpDecision::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n@@ -249,23 +259,23 @@ class EventListenerTest {\n     call.enqueue(callback)\n     completionLatch.await()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"FollowUpDecision\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      FollowUpDecision::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n@@ -295,20 +305,20 @@ class EventListenerTest {\n       assertThat(expected.message).isIn(\"timeout\", \"Read timed out\")\n     }\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseFailed\",\n-      \"RetryDecision\",\n-      \"ConnectionReleased\",\n-      \"CallFailed\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseFailed::class,\n+      RetryDecision::class,\n+      ConnectionReleased::class,\n+      CallFailed::class,\n     )\n     assertThat(listener.findEvent<RetryDecision>()).all {\n       prop(RetryDecision::retry).isFalse()\n@@ -345,23 +355,23 @@ class EventListenerTest {\n       assertThat(expected.message).isEqualTo(\"unexpected end of stream\")\n     }\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"FollowUpDecision\",\n-      \"ResponseBodyStart\",\n-      \"ResponseFailed\",\n-      \"ConnectionReleased\",\n-      \"CallFailed\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      FollowUpDecision::class,\n+      ResponseBodyStart::class,\n+      ResponseFailed::class,\n+      ConnectionReleased::class,\n+      CallFailed::class,\n     )\n     val responseFailed = listener.removeUpToEvent<ResponseFailed>()\n     assertThat(responseFailed.ioe.message).isEqualTo(\"unexpected end of stream\")\n@@ -383,9 +393,9 @@ class EventListenerTest {\n       assertThat(expected.message).isEqualTo(\"Canceled\")\n     }\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"Canceled\",\n-      \"CallStart\",\n-      \"CallFailed\",\n+      Canceled::class,\n+      CallStart::class,\n+      CallFailed::class,\n     )\n   }\n \n@@ -421,7 +431,7 @@ class EventListenerTest {\n       },\n     )\n     call.cancel()\n-    assertThat(listener.recordedEventTypes()).contains(\"Canceled\")\n+    assertThat(listener.recordedEventTypes()).contains(Canceled::class)\n   }\n \n   @Test\n@@ -441,7 +451,7 @@ class EventListenerTest {\n       )\n     call.cancel()\n     call.cancel()\n-    assertThat(listener.recordedEventTypes()).containsExactly(\"Canceled\")\n+    assertThat(listener.recordedEventTypes()).containsExactly(Canceled::class)\n   }\n \n   private fun assertSuccessfulEventOrder(\n@@ -459,43 +469,43 @@ class EventListenerTest {\n     assertThat(response.code).isEqualTo(200)\n     response.body.string()\n     response.body.close()\n-    Assume.assumeThat(response, responseMatcher)\n+    assumeThat(response, responseMatcher)\n     var expectedEventTypes =\n       listOf(\n-        \"CallStart\",\n-        \"ProxySelectStart\",\n-        \"ProxySelectEnd\",\n-        \"DnsStart\",\n-        \"DnsEnd\",\n-        \"ConnectStart\",\n-        \"SecureConnectStart\",\n-        \"SecureConnectEnd\",\n-        \"ConnectEnd\",\n-        \"ConnectionAcquired\",\n-        \"RequestHeadersStart\",\n-        \"RequestHeadersEnd\",\n-        \"ResponseHeadersStart\",\n-        \"ResponseHeadersEnd\",\n+        CallStart::class,\n+        ProxySelectStart::class,\n+        ProxySelectEnd::class,\n+        DnsStart::class,\n+        DnsEnd::class,\n+        ConnectStart::class,\n+        SecureConnectStart::class,\n+        SecureConnectEnd::class,\n+        ConnectEnd::class,\n+        ConnectionAcquired::class,\n+        RequestHeadersStart::class,\n+        RequestHeadersEnd::class,\n+        ResponseHeadersStart::class,\n+        ResponseHeadersEnd::class,\n       )\n     expectedEventTypes +=\n       when {\n         emptyBody ->\n           listOf(\n-            \"ResponseBodyStart\",\n-            \"ResponseBodyEnd\",\n-            \"FollowUpDecision\",\n+            ResponseBodyStart::class,\n+            ResponseBodyEnd::class,\n+            FollowUpDecision::class,\n           )\n         else ->\n           listOf(\n-            \"FollowUpDecision\",\n-            \"ResponseBodyStart\",\n-            \"ResponseBodyEnd\",\n+            FollowUpDecision::class,\n+            ResponseBodyStart::class,\n+            ResponseBodyEnd::class,\n           )\n       }\n     expectedEventTypes +=\n       listOf(\n-        \"ConnectionReleased\",\n-        \"CallEnd\",\n+        ConnectionReleased::class,\n+        CallEnd::class,\n       )\n     assertThat(listener.recordedEventTypes()).isEqualTo(expectedEventTypes)\n   }\n@@ -525,17 +535,17 @@ class EventListenerTest {\n     val response = call.execute()\n     response.close()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"FollowUpDecision\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      FollowUpDecision::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n@@ -555,7 +565,7 @@ class EventListenerTest {\n       )\n     } else {\n       assertThat(listener.recordedEventTypes())\n-        .doesNotContain(\"RequestHeadersEnd\")\n+        .doesNotContain(RequestHeadersEnd::class)\n     }\n     if (requestBodyBytes != null) {\n       val responseBodyEnd: RequestBodyEnd = listener.removeUpToEvent<RequestBodyEnd>()\n@@ -565,7 +575,7 @@ class EventListenerTest {\n         requestBodyBytes,\n       )\n     } else {\n-      assertThat(listener.recordedEventTypes()).doesNotContain(\"RequestBodyEnd\")\n+      assertThat(listener.recordedEventTypes()).doesNotContain(RequestBodyEnd::class)\n     }\n     if (responseHeaderLength != null) {\n       val responseHeadersEnd: ResponseHeadersEnd =\n@@ -577,7 +587,7 @@ class EventListenerTest {\n       )\n     } else {\n       assertThat(listener.recordedEventTypes())\n-        .doesNotContain(\"ResponseHeadersEnd\")\n+        .doesNotContain(ResponseHeadersEnd::class)\n     }\n     if (responseBodyBytes != null) {\n       val responseBodyEnd: ResponseBodyEnd = listener.removeUpToEvent<ResponseBodyEnd>()\n@@ -587,7 +597,7 @@ class EventListenerTest {\n         responseBodyBytes,\n       )\n     } else {\n-      assertThat(listener.recordedEventTypes()).doesNotContain(\"ResponseBodyEnd\")\n+      assertThat(listener.recordedEventTypes()).doesNotContain(ResponseBodyEnd::class)\n     }\n   }\n \n@@ -735,9 +745,9 @@ class EventListenerTest {\n     val response2 = call2.execute()\n     assertThat(response2.code).isEqualTo(200)\n     response2.body.close()\n-    val recordedEvents: List<String> = listener.recordedEventTypes()\n-    assertThat(recordedEvents).doesNotContain(\"DnsStart\")\n-    assertThat(recordedEvents).doesNotContain(\"DnsEnd\")\n+    val recordedEvents = listener.recordedEventTypes()\n+    assertThat(recordedEvents).doesNotContain(DnsStart::class)\n+    assertThat(recordedEvents).doesNotContain(DnsEnd::class)\n   }\n \n   @Test\n@@ -1165,9 +1175,9 @@ class EventListenerTest {\n     val response2 = call2.execute()\n     assertThat(response2.code).isEqualTo(200)\n     response2.body.close()\n-    val recordedEvents: List<String> = listener.recordedEventTypes()\n-    assertThat(recordedEvents).doesNotContain(\"SecureConnectStart\")\n-    assertThat(recordedEvents).doesNotContain(\"SecureConnectEnd\")\n+    val recordedEvents = listener.recordedEventTypes()\n+    assertThat(recordedEvents).doesNotContain(SecureConnectStart::class)\n+    assertThat(recordedEvents).doesNotContain(SecureConnectEnd::class)\n   }\n \n   @Test\n@@ -1214,7 +1224,7 @@ class EventListenerTest {\n     assertThat(response.body.string()).isEqualTo(\"ABC\")\n     listener.removeUpToEvent<ConnectionAcquired>()\n     val remainingEvents = listener.recordedEventTypes()\n-    assertThat(remainingEvents).doesNotContain(\"ConnectionAcquired\")\n+    assertThat(remainingEvents).doesNotContain(ConnectionAcquired::class)\n   }\n \n   @Test\n@@ -1320,7 +1330,7 @@ class EventListenerTest {\n     val response = call.execute()\n     if (expectedProtocol == Protocol.HTTP_2) {\n       // soft failure since client may not support depending on Platform\n-      Assume.assumeThat(response, matchesProtocol(Protocol.HTTP_2))\n+      assumeThat(response, matchesProtocol(Protocol.HTTP_2))\n     }\n     assertThat(response.protocol).isEqualTo(expectedProtocol)\n     assertFailsWith<IOException> {\n@@ -1350,23 +1360,23 @@ class EventListenerTest {\n     val response = call.execute()\n     response.body.close()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"FollowUpDecision\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      FollowUpDecision::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n@@ -1389,23 +1399,23 @@ class EventListenerTest {\n     val response = call.execute()\n     response.body.close()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"FollowUpDecision\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      FollowUpDecision::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n@@ -1429,23 +1439,23 @@ class EventListenerTest {\n     val response = call.execute()\n     response.body.close()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"FollowUpDecision\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      FollowUpDecision::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n@@ -1562,22 +1572,22 @@ class EventListenerTest {\n       call.execute()\n     }\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"RequestBodyStart\",\n-      \"RequestFailed\",\n-      \"ResponseFailed\",\n-      \"RetryDecision\",\n-      \"ConnectionReleased\",\n-      \"CallFailed\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      RequestBodyStart::class,\n+      RequestFailed::class,\n+      ResponseFailed::class,\n+      RetryDecision::class,\n+      ConnectionReleased::class,\n+      CallFailed::class,\n     )\n   }\n \n@@ -1663,23 +1673,23 @@ class EventListenerTest {\n     assertThat(response.body.string()).isEqualTo(\"abc\")\n     response.body.close()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"FollowUpDecision\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      FollowUpDecision::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n@@ -1858,30 +1868,30 @@ class EventListenerTest {\n     val call = client.newCall(Request.Builder().url(server.url(\"/\")).build())\n     call.execute()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"FollowUpDecision\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"FollowUpDecision\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      FollowUpDecision::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      FollowUpDecision::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n     assertThat(listener.findEvent<FollowUpDecision>()).all {\n       prop(FollowUpDecision::nextRequest).isNotNull()\n@@ -1903,38 +1913,38 @@ class EventListenerTest {\n     val call = client.newCall(Request.Builder().url(server.url(\"/\")).build())\n     call.execute()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"FollowUpDecision\",\n-      \"ConnectionReleased\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"FollowUpDecision\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      FollowUpDecision::class,\n+      ConnectionReleased::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      FollowUpDecision::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n     assertThat(listener.findEvent<FollowUpDecision>()).all {\n       prop(FollowUpDecision::nextRequest).isNotNull()\n@@ -1961,30 +1971,30 @@ class EventListenerTest {\n     val response = call.execute()\n     assertThat(response.body.string()).isEqualTo(\"b\")\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"FollowUpDecision\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"FollowUpDecision\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      FollowUpDecision::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      FollowUpDecision::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n     assertThat(server.takeRequest().exchangeIndex).isEqualTo(0)\n     assertThat(server.takeRequest().exchangeIndex).isEqualTo(1)\n@@ -2011,7 +2021,7 @@ class EventListenerTest {\n     val response = call.execute()\n     assertThat(response.body.string()).isEqualTo(\"a\")\n     assertThat(listener.recordedEventTypes())\n-      .containsExactly(\"CallStart\", \"CallEnd\")\n+      .containsExactly(CallStart::class, CallEnd::class)\n   }\n \n   /** Response headers start, then the entire request body, then response headers end.  */\n@@ -2033,25 +2043,25 @@ class EventListenerTest {\n     val call = client.newCall(request)\n     call.execute()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"RequestBodyStart\",\n-      \"RequestBodyEnd\",\n-      \"ResponseHeadersEnd\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"FollowUpDecision\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      RequestBodyStart::class,\n+      RequestBodyEnd::class,\n+      ResponseHeadersEnd::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      FollowUpDecision::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n@@ -2103,24 +2113,24 @@ class EventListenerTest {\n     assertThat(response.body.string()).isEqualTo(\"abc\")\n     response.close()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"CacheMiss\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"FollowUpDecision\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      CacheMiss::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      FollowUpDecision::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n@@ -2157,19 +2167,19 @@ class EventListenerTest {\n     assertThat(response.body.string()).isEqualTo(\"abc\")\n     response.close()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"CacheConditionalHit\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"CacheHit\",\n-      \"FollowUpDecision\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      CacheConditionalHit::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      CacheHit::class,\n+      FollowUpDecision::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n@@ -2208,19 +2218,19 @@ class EventListenerTest {\n     assertThat(response.body.string()).isEqualTo(\"abd\")\n     response.close()\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"CacheConditionalHit\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"CacheMiss\",\n-      \"FollowUpDecision\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      CacheConditionalHit::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      CacheMiss::class,\n+      FollowUpDecision::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n@@ -2239,7 +2249,12 @@ class EventListenerTest {\n     assertThat(response.code).isEqualTo(504)\n     response.close()\n     assertThat(listener.recordedEventTypes())\n-      .containsExactly(\"CallStart\", \"SatisfactionFailure\", \"FollowUpDecision\", \"CallEnd\")\n+      .containsExactly(\n+        CallStart::class,\n+        SatisfactionFailure::class,\n+        FollowUpDecision::class,\n+        CallEnd::class,\n+      )\n     assertThat(listener.findEvent<FollowUpDecision>()).all {\n       prop(FollowUpDecision::nextRequest).isNull()\n     }\n@@ -2273,7 +2288,12 @@ class EventListenerTest {\n     assertThat(response.body.string()).isEqualTo(\"abc\")\n     response.close()\n     assertThat(listener.recordedEventTypes())\n-      .containsExactly(\"CallStart\", \"CacheHit\", \"FollowUpDecision\", \"CallEnd\")\n+      .containsExactly(\n+        CallStart::class,\n+        CacheHit::class,\n+        FollowUpDecision::class,\n+        CallEnd::class,\n+      )\n   }\n \n   private fun enableCache(): Cache? {\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/FastFallbackTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/FastFallbackTest.kt\nindex 92e6171c2ef1..e50aa9820a21 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/FastFallbackTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/FastFallbackTest.kt\n@@ -31,6 +31,9 @@ import kotlin.test.assertFailsWith\n import mockwebserver3.MockResponse\n import mockwebserver3.MockWebServer\n import mockwebserver3.SocketEffect.CloseStream\n+import okhttp3.CallEvent.ConnectEnd\n+import okhttp3.CallEvent.ConnectFailed\n+import okhttp3.CallEvent.ConnectStart\n import okhttp3.internal.http2.ErrorCode\n import okhttp3.testing.Flaky\n import org.junit.jupiter.api.AfterEach\n@@ -133,8 +136,8 @@ class FastFallbackTest {\n     assertThat(response.body.string()).isEqualTo(\"hello from IPv6\")\n \n     // In the process we made one successful connection attempt.\n-    assertThat(listener.recordedEventTypes().filter { it == \"ConnectStart\" }).hasSize(1)\n-    assertThat(listener.recordedEventTypes().filter { it == \"ConnectFailed\" }).hasSize(0)\n+    assertThat(listener.recordedEventTypes().filter { it == ConnectStart::class }).hasSize(1)\n+    assertThat(listener.recordedEventTypes().filter { it == ConnectFailed::class }).hasSize(0)\n   }\n \n   @Test\n@@ -157,8 +160,8 @@ class FastFallbackTest {\n     assertThat(response.body.string()).isEqualTo(\"hello from IPv6\")\n \n     // In the process we made one successful connection attempt.\n-    assertThat(listener.recordedEventTypes().filter { it == \"ConnectStart\" }).hasSize(1)\n-    assertThat(listener.recordedEventTypes().filter { it == \"ConnectFailed\" }).hasSize(0)\n+    assertThat(listener.recordedEventTypes().filter { it == ConnectStart::class }).hasSize(1)\n+    assertThat(listener.recordedEventTypes().filter { it == ConnectFailed::class }).hasSize(0)\n   }\n \n   @Test\n@@ -173,9 +176,9 @@ class FastFallbackTest {\n     assertThat(response.body.string()).isEqualTo(\"hello from IPv4\")\n \n     // In the process we made one successful connection attempt.\n-    assertThat(listener.recordedEventTypes().filter { it == \"ConnectStart\" }).hasSize(2)\n-    assertThat(listener.recordedEventTypes().filter { it == \"ConnectFailed\" }).hasSize(1)\n-    assertThat(listener.recordedEventTypes().filter { it == \"ConnectEnd\" }).hasSize(1)\n+    assertThat(listener.recordedEventTypes().filter { it == ConnectStart::class }).hasSize(2)\n+    assertThat(listener.recordedEventTypes().filter { it == ConnectFailed::class }).hasSize(1)\n+    assertThat(listener.recordedEventTypes().filter { it == ConnectEnd::class }).hasSize(1)\n   }\n \n   @Test\n@@ -190,9 +193,9 @@ class FastFallbackTest {\n     assertThat(response.body.string()).isEqualTo(\"hello from IPv6\")\n \n     // In the process we made two connection attempts including one failure.\n-    assertThat(listener.recordedEventTypes().filter { it == \"ConnectStart\" }).hasSize(1)\n-    assertThat(listener.recordedEventTypes().filter { it == \"ConnectEnd\" }).hasSize(1)\n-    assertThat(listener.recordedEventTypes().filter { it == \"ConnectFailed\" }).hasSize(0)\n+    assertThat(listener.recordedEventTypes().filter { it == ConnectStart::class }).hasSize(1)\n+    assertThat(listener.recordedEventTypes().filter { it == ConnectEnd::class }).hasSize(1)\n+    assertThat(listener.recordedEventTypes().filter { it == ConnectFailed::class }).hasSize(0)\n   }\n \n   @Test\n@@ -206,8 +209,8 @@ class FastFallbackTest {\n     }\n \n     // In the process we made two unsuccessful connection attempts.\n-    assertThat(listener.recordedEventTypes().filter { it == \"ConnectStart\" }).hasSize(2)\n-    assertThat(listener.recordedEventTypes().filter { it == \"ConnectFailed\" }).hasSize(2)\n+    assertThat(listener.recordedEventTypes().filter { it == ConnectStart::class }).hasSize(2)\n+    assertThat(listener.recordedEventTypes().filter { it == ConnectFailed::class }).hasSize(2)\n   }\n \n   @RetryingTest(5)\n@@ -228,8 +231,8 @@ class FastFallbackTest {\n     assertThat(response.body.string()).isEqualTo(\"hello from IPv4\")\n \n     // In the process we made two connection attempts including one failure.\n-    assertThat(listener.recordedEventTypes().filter { it == \"ConnectStart\" }).hasSize(2)\n-    assertThat(listener.recordedEventTypes().filter { it == \"ConnectFailed\" }).hasSize(1)\n+    assertThat(listener.recordedEventTypes().filter { it == ConnectStart::class }).hasSize(2)\n+    assertThat(listener.recordedEventTypes().filter { it == ConnectFailed::class }).hasSize(1)\n   }\n \n   @Test\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/ServerTruncatesRequestTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/ServerTruncatesRequestTest.kt\nindex 723a30293707..88973010314c 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/ServerTruncatesRequestTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/ServerTruncatesRequestTest.kt\n@@ -21,10 +21,32 @@ import assertk.assertions.isEqualTo\n import assertk.assertions.isNotNull\n import assertk.fail\n import javax.net.ssl.SSLSocket\n+import kotlin.reflect.KClass\n import kotlin.test.assertFailsWith\n import mockwebserver3.MockResponse\n import mockwebserver3.MockWebServer\n import mockwebserver3.junit5.StartStop\n+import okhttp3.CallEvent.CallEnd\n+import okhttp3.CallEvent.CallStart\n+import okhttp3.CallEvent.ConnectEnd\n+import okhttp3.CallEvent.ConnectStart\n+import okhttp3.CallEvent.ConnectionAcquired\n+import okhttp3.CallEvent.ConnectionReleased\n+import okhttp3.CallEvent.DnsEnd\n+import okhttp3.CallEvent.DnsStart\n+import okhttp3.CallEvent.FollowUpDecision\n+import okhttp3.CallEvent.ProxySelectEnd\n+import okhttp3.CallEvent.ProxySelectStart\n+import okhttp3.CallEvent.RequestBodyStart\n+import okhttp3.CallEvent.RequestFailed\n+import okhttp3.CallEvent.RequestHeadersEnd\n+import okhttp3.CallEvent.RequestHeadersStart\n+import okhttp3.CallEvent.ResponseBodyEnd\n+import okhttp3.CallEvent.ResponseBodyStart\n+import okhttp3.CallEvent.ResponseHeadersEnd\n+import okhttp3.CallEvent.ResponseHeadersStart\n+import okhttp3.CallEvent.SecureConnectEnd\n+import okhttp3.CallEvent.SecureConnectStart\n import okhttp3.Headers.Companion.headersOf\n import okhttp3.internal.duplex.AsyncRequestBody\n import okhttp3.testing.PlatformRule\n@@ -99,32 +121,32 @@ class ServerTruncatesRequestTest {\n       assertThat(response.body.string()).isEqualTo(\"abc\")\n     }\n \n-    val expectedEvents = mutableListOf<String>()\n+    val expectedEvents = mutableListOf<KClass<out CallEvent>>()\n     // Start out with standard events...\n-    expectedEvents += \"CallStart\"\n-    expectedEvents += \"ProxySelectStart\"\n-    expectedEvents += \"ProxySelectEnd\"\n-    expectedEvents += \"DnsStart\"\n-    expectedEvents += \"DnsEnd\"\n-    expectedEvents += \"ConnectStart\"\n+    expectedEvents += CallStart::class\n+    expectedEvents += ProxySelectStart::class\n+    expectedEvents += ProxySelectEnd::class\n+    expectedEvents += DnsStart::class\n+    expectedEvents += DnsEnd::class\n+    expectedEvents += ConnectStart::class\n     if (https) {\n-      expectedEvents += \"SecureConnectStart\"\n-      expectedEvents += \"SecureConnectEnd\"\n+      expectedEvents += SecureConnectStart::class\n+      expectedEvents += SecureConnectEnd::class\n     }\n-    expectedEvents += \"ConnectEnd\"\n-    expectedEvents += \"ConnectionAcquired\"\n-    expectedEvents += \"RequestHeadersStart\"\n-    expectedEvents += \"RequestHeadersEnd\"\n-    expectedEvents += \"RequestBodyStart\"\n+    expectedEvents += ConnectEnd::class\n+    expectedEvents += ConnectionAcquired::class\n+    expectedEvents += RequestHeadersStart::class\n+    expectedEvents += RequestHeadersEnd::class\n+    expectedEvents += RequestBodyStart::class\n     // ... but we can read the response even after writing the request fails.\n-    expectedEvents += \"RequestFailed\"\n-    expectedEvents += \"ResponseHeadersStart\"\n-    expectedEvents += \"ResponseHeadersEnd\"\n-    expectedEvents += \"FollowUpDecision\"\n-    expectedEvents += \"ResponseBodyStart\"\n-    expectedEvents += \"ResponseBodyEnd\"\n-    expectedEvents += \"ConnectionReleased\"\n-    expectedEvents += \"CallEnd\"\n+    expectedEvents += RequestFailed::class\n+    expectedEvents += ResponseHeadersStart::class\n+    expectedEvents += ResponseHeadersEnd::class\n+    expectedEvents += FollowUpDecision::class\n+    expectedEvents += ResponseBodyStart::class\n+    expectedEvents += ResponseBodyEnd::class\n+    expectedEvents += ConnectionReleased::class\n+    expectedEvents += CallEnd::class\n     assertThat(listener.recordedEventTypes()).isEqualTo(expectedEvents)\n \n     // Confirm that the connection pool was not corrupted by making another call.\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/internal/http/HttpUpgradesTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/internal/http/HttpUpgradesTest.kt\nindex 9fc7b69fe9b4..57af599eca79 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/internal/http/HttpUpgradesTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/internal/http/HttpUpgradesTest.kt\n@@ -25,6 +25,25 @@ import kotlin.test.assertFailsWith\n import mockwebserver3.MockResponse\n import mockwebserver3.MockWebServer\n import mockwebserver3.junit5.StartStop\n+import okhttp3.CallEvent.CallEnd\n+import okhttp3.CallEvent.CallStart\n+import okhttp3.CallEvent.ConnectEnd\n+import okhttp3.CallEvent.ConnectStart\n+import okhttp3.CallEvent.ConnectionAcquired\n+import okhttp3.CallEvent.ConnectionReleased\n+import okhttp3.CallEvent.DnsEnd\n+import okhttp3.CallEvent.DnsStart\n+import okhttp3.CallEvent.FollowUpDecision\n+import okhttp3.CallEvent.ProxySelectEnd\n+import okhttp3.CallEvent.ProxySelectStart\n+import okhttp3.CallEvent.RequestBodyEnd\n+import okhttp3.CallEvent.RequestBodyStart\n+import okhttp3.CallEvent.RequestHeadersEnd\n+import okhttp3.CallEvent.RequestHeadersStart\n+import okhttp3.CallEvent.ResponseBodyEnd\n+import okhttp3.CallEvent.ResponseBodyStart\n+import okhttp3.CallEvent.ResponseHeadersEnd\n+import okhttp3.CallEvent.ResponseHeadersStart\n import okhttp3.Headers.Companion.headersOf\n import okhttp3.OkHttpClientTestRule\n import okhttp3.Protocol\n@@ -129,23 +148,23 @@ class HttpUpgradesTest {\n     }\n     // Confirm there's no RequestBodyStart/RequestBodyEnd on failed upgrades.\n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"FollowUpDecision\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      FollowUpDecision::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n@@ -196,25 +215,25 @@ class HttpUpgradesTest {\n     upgrade()\n \n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"FollowUpDecision\",\n-      \"RequestBodyStart\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"RequestBodyEnd\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      FollowUpDecision::class,\n+      RequestBodyStart::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      RequestBodyEnd::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n@@ -223,25 +242,25 @@ class HttpUpgradesTest {\n     upgradeWithRequestBody()\n \n     assertThat(listener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"FollowUpDecision\",\n-      \"RequestBodyStart\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"RequestBodyEnd\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      FollowUpDecision::class,\n+      RequestBodyStart::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      RequestBodyEnd::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/internal/tls/ClientAuthTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/internal/tls/ClientAuthTest.kt\nindex aecf7606bf3b..d78fd43e1e77 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/internal/tls/ClientAuthTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/internal/tls/ClientAuthTest.kt\n@@ -38,6 +38,13 @@ import kotlin.test.assertFailsWith\n import mockwebserver3.MockResponse\n import mockwebserver3.MockWebServer\n import mockwebserver3.junit5.StartStop\n+import okhttp3.CallEvent.CallStart\n+import okhttp3.CallEvent.ConnectStart\n+import okhttp3.CallEvent.DnsEnd\n+import okhttp3.CallEvent.DnsStart\n+import okhttp3.CallEvent.ProxySelectEnd\n+import okhttp3.CallEvent.ProxySelectStart\n+import okhttp3.CallEvent.SecureConnectStart\n import okhttp3.OkHttpClient\n import okhttp3.OkHttpClientTestRule\n import okhttp3.RecordingEventListener\n@@ -348,13 +355,13 @@ class ClientAuthTest {\n     // SecureConnectEnd, ConnectFailed, CallFailed\n     val recordedEventTypes = listener.recordedEventTypes()\n     assertThat(recordedEventTypes).startsWith(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"SecureConnectStart\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      SecureConnectStart::class,\n     )\n     assertThat(recordedEventTypes).endsWith(\"CallFailed\")\n   }\n",
  "test_patch" : "diff --git a/android-test/src/androidTest/java/okhttp/android/test/OkHttpTest.kt b/android-test/src/androidTest/java/okhttp/android/test/OkHttpTest.kt\nindex 734d38d17bd6..af26b57ad61e 100644\n--- a/android-test/src/androidTest/java/okhttp/android/test/OkHttpTest.kt\n+++ b/android-test/src/androidTest/java/okhttp/android/test/OkHttpTest.kt\n@@ -47,6 +47,25 @@ import mockwebserver3.MockWebServer\n import mockwebserver3.junit5.StartStop\n import okhttp3.Cache\n import okhttp3.Call\n+import okhttp3.CallEvent.CallEnd\n+import okhttp3.CallEvent.CallStart\n+import okhttp3.CallEvent.ConnectEnd\n+import okhttp3.CallEvent.ConnectStart\n+import okhttp3.CallEvent.ConnectionAcquired\n+import okhttp3.CallEvent.ConnectionReleased\n+import okhttp3.CallEvent.DnsEnd\n+import okhttp3.CallEvent.DnsStart\n+import okhttp3.CallEvent.FollowUpDecision\n+import okhttp3.CallEvent.ProxySelectEnd\n+import okhttp3.CallEvent.ProxySelectStart\n+import okhttp3.CallEvent.RequestHeadersEnd\n+import okhttp3.CallEvent.RequestHeadersStart\n+import okhttp3.CallEvent.ResponseBodyEnd\n+import okhttp3.CallEvent.ResponseBodyStart\n+import okhttp3.CallEvent.ResponseHeadersEnd\n+import okhttp3.CallEvent.ResponseHeadersStart\n+import okhttp3.CallEvent.SecureConnectEnd\n+import okhttp3.CallEvent.SecureConnectStart\n import okhttp3.CertificatePinner\n import okhttp3.CompressionInterceptor\n import okhttp3.Connection\n@@ -572,25 +591,25 @@ class OkHttpTest {\n \n     assertEquals(\n       listOf(\n-        \"CallStart\",\n-        \"ProxySelectStart\",\n-        \"ProxySelectEnd\",\n-        \"DnsStart\",\n-        \"DnsEnd\",\n-        \"ConnectStart\",\n-        \"SecureConnectStart\",\n-        \"SecureConnectEnd\",\n-        \"ConnectEnd\",\n-        \"ConnectionAcquired\",\n-        \"RequestHeadersStart\",\n-        \"RequestHeadersEnd\",\n-        \"ResponseHeadersStart\",\n-        \"ResponseHeadersEnd\",\n-        \"FollowUpDecision\",\n-        \"ResponseBodyStart\",\n-        \"ResponseBodyEnd\",\n-        \"ConnectionReleased\",\n-        \"CallEnd\",\n+        CallStart::class,\n+        ProxySelectStart::class,\n+        ProxySelectEnd::class,\n+        DnsStart::class,\n+        DnsEnd::class,\n+        ConnectStart::class,\n+        SecureConnectStart::class,\n+        SecureConnectEnd::class,\n+        ConnectEnd::class,\n+        ConnectionAcquired::class,\n+        RequestHeadersStart::class,\n+        RequestHeadersEnd::class,\n+        ResponseHeadersStart::class,\n+        ResponseHeadersEnd::class,\n+        FollowUpDecision::class,\n+        ResponseBodyStart::class,\n+        ResponseBodyEnd::class,\n+        ConnectionReleased::class,\n+        CallEnd::class,\n       ),\n       eventListener.recordedEventTypes(),\n     )\n@@ -603,17 +622,17 @@ class OkHttpTest {\n \n     assertEquals(\n       listOf(\n-        \"CallStart\",\n-        \"ConnectionAcquired\",\n-        \"RequestHeadersStart\",\n-        \"RequestHeadersEnd\",\n-        \"ResponseHeadersStart\",\n-        \"ResponseHeadersEnd\",\n-        \"FollowUpDecision\",\n-        \"ResponseBodyStart\",\n-        \"ResponseBodyEnd\",\n-        \"ConnectionReleased\",\n-        \"CallEnd\",\n+        CallStart::class,\n+        ConnectionAcquired::class,\n+        RequestHeadersStart::class,\n+        RequestHeadersEnd::class,\n+        ResponseHeadersStart::class,\n+        ResponseHeadersEnd::class,\n+        FollowUpDecision::class,\n+        ResponseBodyStart::class,\n+        ResponseBodyEnd::class,\n+        ConnectionReleased::class,\n+        CallEnd::class,\n       ),\n       eventListener.recordedEventTypes(),\n     )\ndiff --git a/okhttp-dnsoverhttps/src/test/java/okhttp3/dnsoverhttps/DnsOverHttpsTest.kt b/okhttp-dnsoverhttps/src/test/java/okhttp3/dnsoverhttps/DnsOverHttpsTest.kt\nindex 65104d77fe99..501b0962a1b9 100644\n--- a/okhttp-dnsoverhttps/src/test/java/okhttp3/dnsoverhttps/DnsOverHttpsTest.kt\n+++ b/okhttp-dnsoverhttps/src/test/java/okhttp3/dnsoverhttps/DnsOverHttpsTest.kt\n@@ -29,10 +29,14 @@ import java.io.IOException\n import java.net.InetAddress\n import java.net.UnknownHostException\n import java.util.concurrent.TimeUnit\n+import kotlin.reflect.KClass\n import mockwebserver3.MockResponse\n import mockwebserver3.MockWebServer\n import mockwebserver3.junit5.StartStop\n import okhttp3.Cache\n+import okhttp3.CallEvent\n+import okhttp3.CallEvent.CacheHit\n+import okhttp3.CallEvent.CacheMiss\n import okhttp3.Dns\n import okhttp3.OkHttpClient\n import okhttp3.Protocol\n@@ -200,13 +204,13 @@ class DnsOverHttpsTest {\n     assertThat(recordedRequest.url.encodedQuery)\n       .isEqualTo(\"ct&dns=AAABAAABAAAAAAAABmdvb2dsZQNjb20AAAEAAQ\")\n \n-    assertThat(cacheEvents()).containsExactly(\"CacheMiss\")\n+    assertThat(cacheEvents()).containsExactly(CacheMiss::class)\n \n     result = cachedDns.lookup(\"google.com\")\n     assertThat(server.takeRequest(1, TimeUnit.MILLISECONDS)).isNull()\n     assertThat(result).isEqualTo(listOf(address(\"157.240.1.18\")))\n \n-    assertThat(cacheEvents()).containsExactly(\"CacheHit\")\n+    assertThat(cacheEvents()).containsExactly(CacheHit::class)\n \n     result = cachedDns.lookup(\"www.google.com\")\n     assertThat(result).containsExactly(address(\"157.240.1.18\"))\n@@ -215,7 +219,7 @@ class DnsOverHttpsTest {\n     assertThat(recordedRequest.url.encodedQuery)\n       .isEqualTo(\"ct&dns=AAABAAABAAAAAAAAA3d3dwZnb29nbGUDY29tAAABAAE\")\n \n-    assertThat(cacheEvents()).containsExactly(\"CacheMiss\")\n+    assertThat(cacheEvents()).containsExactly(CacheMiss::class)\n   }\n \n   @Test\n@@ -242,13 +246,13 @@ class DnsOverHttpsTest {\n     assertThat(recordedRequest.url.encodedQuery)\n       .isEqualTo(\"ct\")\n \n-    assertThat(cacheEvents()).containsExactly(\"CacheMiss\")\n+    assertThat(cacheEvents()).containsExactly(CacheMiss::class)\n \n     result = cachedDns.lookup(\"google.com\")\n     assertThat(server.takeRequest(0, TimeUnit.MILLISECONDS)).isNull()\n     assertThat(result).isEqualTo(listOf(address(\"157.240.1.18\")))\n \n-    assertThat(cacheEvents()).containsExactly(\"CacheHit\")\n+    assertThat(cacheEvents()).containsExactly(CacheHit::class)\n \n     result = cachedDns.lookup(\"www.google.com\")\n     assertThat(result).containsExactly(address(\"157.240.1.18\"))\n@@ -257,7 +261,7 @@ class DnsOverHttpsTest {\n     assertThat(recordedRequest.url.encodedQuery)\n       .isEqualTo(\"ct\")\n \n-    assertThat(cacheEvents()).containsExactly(\"CacheMiss\")\n+    assertThat(cacheEvents()).containsExactly(CacheMiss::class)\n   }\n \n   @Test\n@@ -282,7 +286,7 @@ class DnsOverHttpsTest {\n       \"ct&dns=AAABAAABAAAAAAAABmdvb2dsZQNjb20AAAEAAQ\",\n     )\n \n-    assertThat(cacheEvents()).containsExactly(\"CacheMiss\")\n+    assertThat(cacheEvents()).containsExactly(CacheMiss::class)\n \n     Thread.sleep(2000)\n     server.enqueue(\n@@ -301,13 +305,14 @@ class DnsOverHttpsTest {\n     assertThat(recordedRequest.url.encodedQuery)\n       .isEqualTo(\"ct&dns=AAABAAABAAAAAAAABmdvb2dsZQNjb20AAAEAAQ\")\n \n-    assertThat(cacheEvents()).containsExactly(\"CacheMiss\")\n+    assertThat(cacheEvents()).containsExactly(CacheMiss::class)\n   }\n \n-  private fun cacheEvents(): List<String> =\n-    eventListener.recordedEventTypes().filter { it.contains(\"Cache\") }.also {\n-      eventListener.clearAllEvents()\n-    }\n+  private fun cacheEvents(): List<KClass<out CallEvent>> =\n+    eventListener\n+      .recordedEventTypes()\n+      .filter { \"Cache\" in it.simpleName!! }\n+      .also { eventListener.clearAllEvents() }\n \n   private fun dnsResponse(s: String): MockResponse =\n     MockResponse\ndiff --git a/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceHttpTest.kt b/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceHttpTest.kt\nindex 4e714dae0968..d39c9eb9e64d 100644\n--- a/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceHttpTest.kt\n+++ b/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceHttpTest.kt\n@@ -22,6 +22,23 @@ import java.util.concurrent.TimeUnit\n import mockwebserver3.MockResponse\n import mockwebserver3.MockWebServer\n import mockwebserver3.junit5.StartStop\n+import okhttp3.CallEvent.CallEnd\n+import okhttp3.CallEvent.CallStart\n+import okhttp3.CallEvent.ConnectEnd\n+import okhttp3.CallEvent.ConnectStart\n+import okhttp3.CallEvent.ConnectionAcquired\n+import okhttp3.CallEvent.ConnectionReleased\n+import okhttp3.CallEvent.DnsEnd\n+import okhttp3.CallEvent.DnsStart\n+import okhttp3.CallEvent.FollowUpDecision\n+import okhttp3.CallEvent.ProxySelectEnd\n+import okhttp3.CallEvent.ProxySelectStart\n+import okhttp3.CallEvent.RequestHeadersEnd\n+import okhttp3.CallEvent.RequestHeadersStart\n+import okhttp3.CallEvent.ResponseBodyEnd\n+import okhttp3.CallEvent.ResponseBodyStart\n+import okhttp3.CallEvent.ResponseHeadersEnd\n+import okhttp3.CallEvent.ResponseHeadersStart\n import okhttp3.Headers\n import okhttp3.OkHttpClientTestRule\n import okhttp3.RecordingEventListener\n@@ -240,23 +257,23 @@ class EventSourceHttpTest {\n     listener.assertEvent(null, null, \"hey\")\n     listener.assertClose()\n     assertThat(eventListener.recordedEventTypes()).containsExactly(\n-      \"CallStart\",\n-      \"ProxySelectStart\",\n-      \"ProxySelectEnd\",\n-      \"DnsStart\",\n-      \"DnsEnd\",\n-      \"ConnectStart\",\n-      \"ConnectEnd\",\n-      \"ConnectionAcquired\",\n-      \"RequestHeadersStart\",\n-      \"RequestHeadersEnd\",\n-      \"ResponseHeadersStart\",\n-      \"ResponseHeadersEnd\",\n-      \"FollowUpDecision\",\n-      \"ResponseBodyStart\",\n-      \"ResponseBodyEnd\",\n-      \"ConnectionReleased\",\n-      \"CallEnd\",\n+      CallStart::class,\n+      ProxySelectStart::class,\n+      ProxySelectEnd::class,\n+      DnsStart::class,\n+      DnsEnd::class,\n+      ConnectStart::class,\n+      ConnectEnd::class,\n+      ConnectionAcquired::class,\n+      RequestHeadersStart::class,\n+      RequestHeadersEnd::class,\n+      ResponseHeadersStart::class,\n+      ResponseHeadersEnd::class,\n+      FollowUpDecision::class,\n+      ResponseBodyStart::class,\n+      ResponseBodyEnd::class,\n+      ConnectionReleased::class,\n+      CallEnd::class,\n     )\n   }\n \n",
  "problem_statement" : "Fewer strings in EventListener asserts",
  "hints_text" : null,
  "created_at" : "Tue Oct 07 19:23:38 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 9118,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-9115",
  "repo" : "square/okhttp",
  "base_commit" : "d4a5be134ef9083a88a80a2e135ec6a730b49673",
  "patch" : "diff --git a/okhttp-logging-interceptor/api/logging-interceptor.api b/okhttp-logging-interceptor/api/logging-interceptor.api\nindex 23abc3e5a72e..43b6f3f6be6b 100644\n--- a/okhttp-logging-interceptor/api/logging-interceptor.api\n+++ b/okhttp-logging-interceptor/api/logging-interceptor.api\n@@ -5,30 +5,21 @@ public final class okhttp3/logging/HttpLoggingInterceptor : okhttp3/Interceptor\n \tpublic fun <init> (Lokhttp3/logging/HttpLoggingInterceptor$Logger;)V\n \tpublic synthetic fun <init> (Lokhttp3/logging/HttpLoggingInterceptor$Logger;ILkotlin/jvm/internal/DefaultConstructorMarker;)V\n \tpublic final fun getLevel ()Lokhttp3/logging/HttpLoggingInterceptor$Level;\n-\tpublic final fun getRequestLevel ()Lkotlin/jvm/functions/Function1;\n \tpublic fun intercept (Lokhttp3/Interceptor$Chain;)Lokhttp3/Response;\n \tpublic final fun level (Lokhttp3/logging/HttpLoggingInterceptor$Level;)V\n \tpublic final fun redactHeader (Ljava/lang/String;)V\n \tpublic final fun redactQueryParams ([Ljava/lang/String;)V\n \tpublic final fun setLevel (Lokhttp3/logging/HttpLoggingInterceptor$Level;)Lokhttp3/logging/HttpLoggingInterceptor;\n-\tpublic final fun setRequestLevel (Lkotlin/jvm/functions/Function1;)V\n }\n \n public final class okhttp3/logging/HttpLoggingInterceptor$Companion {\n }\n \n-public final class okhttp3/logging/HttpLoggingInterceptor$Identity : okhttp3/CompressionInterceptor$DecompressionAlgorithm {\n-\tpublic static final field INSTANCE Lokhttp3/logging/HttpLoggingInterceptor$Identity;\n-\tpublic fun decompress (Lokio/BufferedSource;)Lokio/Source;\n-\tpublic fun getEncoding ()Ljava/lang/String;\n-}\n-\n public final class okhttp3/logging/HttpLoggingInterceptor$Level : java/lang/Enum {\n \tpublic static final field BASIC Lokhttp3/logging/HttpLoggingInterceptor$Level;\n \tpublic static final field BODY Lokhttp3/logging/HttpLoggingInterceptor$Level;\n \tpublic static final field HEADERS Lokhttp3/logging/HttpLoggingInterceptor$Level;\n \tpublic static final field NONE Lokhttp3/logging/HttpLoggingInterceptor$Level;\n-\tpublic static final field STREAMING Lokhttp3/logging/HttpLoggingInterceptor$Level;\n \tpublic static fun getEntries ()Lkotlin/enums/EnumEntries;\n \tpublic static fun valueOf (Ljava/lang/String;)Lokhttp3/logging/HttpLoggingInterceptor$Level;\n \tpublic static fun values ()[Lokhttp3/logging/HttpLoggingInterceptor$Level;\ndiff --git a/okhttp-logging-interceptor/src/main/kotlin/okhttp3/logging/HttpLoggingInterceptor.kt b/okhttp-logging-interceptor/src/main/kotlin/okhttp3/logging/HttpLoggingInterceptor.kt\nindex ed4d5c618650..045284e2af06 100644\n--- a/okhttp-logging-interceptor/src/main/kotlin/okhttp3/logging/HttpLoggingInterceptor.kt\n+++ b/okhttp-logging-interceptor/src/main/kotlin/okhttp3/logging/HttpLoggingInterceptor.kt\n@@ -20,31 +20,17 @@ import java.io.IOException\n import java.nio.charset.Charset\n import java.util.TreeSet\n import java.util.concurrent.TimeUnit\n-import okhttp3.CompressionInterceptor\n-import okhttp3.CompressionInterceptor.DecompressionAlgorithm\n-import okhttp3.Gzip\n import okhttp3.Headers\n import okhttp3.HttpUrl\n import okhttp3.Interceptor\n-import okhttp3.MediaType\n import okhttp3.OkHttpClient\n-import okhttp3.Request\n-import okhttp3.RequestBody\n import okhttp3.Response\n-import okhttp3.ResponseBody\n import okhttp3.internal.charsetOrUtf8\n-import okhttp3.internal.connection.RealCall\n import okhttp3.internal.http.promisesBody\n import okhttp3.internal.isProbablyUtf8\n import okhttp3.internal.platform.Platform\n import okio.Buffer\n-import okio.BufferedSink\n-import okio.BufferedSource\n-import okio.ForwardingSink\n-import okio.ForwardingSource\n import okio.GzipSource\n-import okio.Source\n-import okio.buffer\n \n /**\n  * An OkHttp interceptor which logs request and response information. Can be applied as an\n@@ -66,8 +52,6 @@ class HttpLoggingInterceptor\n     @Volatile\n     var level = Level.NONE\n \n-    var requestLevel: (Request) -> Level = { level }\n-\n     enum class Level {\n       /** No logs. */\n       NONE,\n@@ -125,27 +109,6 @@ class HttpLoggingInterceptor\n        * ```\n        */\n       BODY,\n-\n-      /**\n-       * Logs streaming request and response lines.\n-       *\n-       * Example:\n-       * ```\n-       * --> POST /greeting http/1.1\n-       * <-- 200 OK (22ms, unknown-length body)\n-       * > request A\n-       *\n-       * < response B\n-       *\n-       * > request C\n-       *\n-       * < response D\n-       *\n-       * --> END POST\n-       * <-- END HTTP\n-       * ```\n-       */\n-      STREAMING,\n     }\n \n     fun interface Logger {\n@@ -200,90 +163,29 @@ class HttpLoggingInterceptor\n \n     @Throws(IOException::class)\n     override fun intercept(chain: Interceptor.Chain): Response {\n-      var request = chain.request()\n-\n-      val level = this.requestLevel(request)\n+      val level = this.level\n \n+      val request = chain.request()\n       if (level == Level.NONE) {\n         return chain.proceed(request)\n       }\n \n-      val logHeaders = level == Level.BODY || level == Level.HEADERS\n+      val logBody = level == Level.BODY\n+      val logHeaders = logBody || level == Level.HEADERS\n \n-      val decompressionAlgorithms = findCompressionAlgorithms(chain)\n+      val requestBody = request.body\n \n       val connection = chain.connection()\n-\n-      val requestBody = request.body\n       var requestStartMessage =\n         (\"--> ${request.method} ${redactUrl(request.url)}${if (connection != null) \" \" + connection.protocol() else \"\"}\")\n-      if (!logHeaders && level != Level.STREAMING && requestBody != null) {\n+      if (!logHeaders && requestBody != null) {\n         requestStartMessage += \" (${requestBody.contentLength()}-byte body)\"\n       }\n       logger.log(requestStartMessage)\n \n-      if (level != Level.BASIC) {\n-        request = logRequest(request, level, decompressionAlgorithms)\n-      }\n-\n-      val startNs = System.nanoTime()\n-      val response: Response\n-      try {\n-        response = chain.proceed(request)\n-      } catch (e: Exception) {\n-        val tookMs = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startNs)\n-        logger.log(\n-          buildString {\n-            append(\"<-- HTTP FAILED: $e.\")\n-            append(\" ${redactUrl(request.url)} (${tookMs}ms)\")\n-          },\n-        )\n-        throw e\n-      }\n-\n-      val tookMs = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startNs)\n-\n-      val responseBody = response.body\n-      val contentLength = responseBody.contentLength()\n-      val bodySize = if (contentLength != -1L) \"$contentLength-byte\" else \"unknown-length\"\n-      logger.log(\n-        buildString {\n-          append(\"<-- ${response.code}\")\n-          if (response.message.isNotEmpty()) append(\" ${response.message}\")\n-          append(\" ${redactUrl(response.request.url)} (${tookMs}ms\")\n-          if (!logHeaders) append(\", $bodySize body\")\n-          append(\")\")\n-        },\n-      )\n-\n-      return if (level != Level.BASIC) {\n-        logResponse(\n-          response,\n-          decompressionAlgorithms,\n-          startNs,\n-          contentLength,\n-        )\n-      } else {\n-        response\n-      }\n-    }\n-\n-    private fun findCompressionAlgorithms(chain: Interceptor.Chain): List<DecompressionAlgorithm> {\n-      val compressionInterceptor =\n-        (chain.call() as? RealCall)?.client?.interceptors?.find { it is CompressionInterceptor } as? CompressionInterceptor\n-\n-      return compressionInterceptor?.algorithms?.toList() ?: listOf(Gzip)\n-    }\n-\n-    private fun logRequest(\n-      request: Request,\n-      level: Level,\n-      decompressionAlgorithms: List<DecompressionAlgorithm>,\n-    ): Request {\n-      val requestBody = request.body\n-\n-      if (level == Level.HEADERS || level == Level.BODY) {\n+      if (logHeaders) {\n         val headers = request.headers\n+\n         if (requestBody != null) {\n           // Request body headers are only present when installed as a network interceptor. When not\n           // already present, force them to be included (if available) so their values are known.\n@@ -302,34 +204,25 @@ class HttpLoggingInterceptor\n         for (i in 0 until headers.size) {\n           logHeader(headers, i)\n         }\n-      }\n \n-      if (level == Level.HEADERS || requestBody == null) {\n-        logger.log(\"--> END ${request.method}\")\n-      } else if (level == Level.STREAMING) {\n-        return streamRequestBody(request)\n-      } else if (level == Level.BODY) {\n-        if (requestBody.isDuplex()) {\n+        if (!logBody || requestBody == null) {\n+          logger.log(\"--> END ${request.method}\")\n+        } else if (bodyHasUnknownEncoding(request.headers)) {\n+          logger.log(\"--> END ${request.method} (encoded body omitted)\")\n+        } else if (requestBody.isDuplex()) {\n           logger.log(\"--> END ${request.method} (duplex request body omitted)\")\n         } else if (requestBody.isOneShot()) {\n           logger.log(\"--> END ${request.method} (one-shot body omitted)\")\n         } else {\n-          val decompressor = findCompressionAlgorithm(request.headers, decompressionAlgorithms)\n-\n-          if (decompressor == null) {\n-            logger.log(\"--> END ${request.method} (unknown encoded body omitted)\")\n-            return request\n-          }\n-\n           var buffer = Buffer()\n           requestBody.writeTo(buffer)\n \n-          var compressedLength: Long? = null\n-          if (decompressor != Identity) {\n-            compressedLength = buffer.size\n-            decompressor.decompress(buffer).use { uncompressedResponseBody ->\n+          var gzippedLength: Long? = null\n+          if (\"gzip\".equals(headers[\"Content-Encoding\"], ignoreCase = true)) {\n+            gzippedLength = buffer.size\n+            GzipSource(buffer).use { gzippedResponseBody ->\n               buffer = Buffer()\n-              buffer.writeAll(uncompressedResponseBody)\n+              buffer.writeAll(gzippedResponseBody)\n             }\n           }\n \n@@ -340,8 +233,8 @@ class HttpLoggingInterceptor\n             logger.log(\n               \"--> END ${request.method} (binary ${requestBody.contentLength()}-byte body omitted)\",\n             )\n-          } else if (compressedLength != null) {\n-            logger.log(\"--> END ${request.method} (${buffer.size}-byte, $compressedLength-${decompressor.encoding}-byte body)\")\n+          } else if (gzippedLength != null) {\n+            logger.log(\"--> END ${request.method} (${buffer.size}-byte, $gzippedLength-gzipped-byte body)\")\n           } else {\n             logger.log(buffer.readString(charset))\n             logger.log(\"--> END ${request.method} (${requestBody.contentLength()}-byte body)\")\n@@ -349,42 +242,49 @@ class HttpLoggingInterceptor\n         }\n       }\n \n-      return request\n-    }\n+      val startNs = System.nanoTime()\n+      val response: Response\n+      try {\n+        response = chain.proceed(request)\n+      } catch (e: Exception) {\n+        val tookMs = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startNs)\n+        logger.log(\n+          buildString {\n+            append(\"<-- HTTP FAILED: $e.\")\n+            append(\" ${redactUrl(request.url)} (${tookMs}ms)\")\n+          },\n+        )\n+        throw e\n+      }\n \n-    private fun logResponse(\n-      response: Response,\n-      decompressionAlgorithms: List<DecompressionAlgorithm>,\n-      startNs: Long,\n-      contentLength: Long,\n-    ): Response {\n-      val logBody = level == Level.BODY\n-      val logStreamed = level == Level.STREAMING\n-      val logHeaders = logBody || level == Level.HEADERS\n-      val responseBody = response.body\n+      val tookMs = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startNs)\n+\n+      val responseBody = response.body!!\n+      val contentLength = responseBody.contentLength()\n+      val bodySize = if (contentLength != -1L) \"$contentLength-byte\" else \"unknown-length\"\n+      logger.log(\n+        buildString {\n+          append(\"<-- ${response.code}\")\n+          if (response.message.isNotEmpty()) append(\" ${response.message}\")\n+          append(\" ${redactUrl(response.request.url)} (${tookMs}ms\")\n+          if (!logHeaders) append(\", $bodySize body\")\n+          append(\")\")\n+        },\n+      )\n \n       if (logHeaders) {\n         val headers = response.headers\n         for (i in 0 until headers.size) {\n           logHeader(headers, i)\n         }\n-      }\n \n-      if (level == Level.HEADERS || !response.promisesBody()) {\n-        logger.log(\"<-- END HTTP\")\n-      } else if (logStreamed) {\n-        return streamResponseBody(response, decompressionAlgorithms)\n-      } else if (logBody) {\n-        if (bodyIsEventStream(response)) {\n-          logger.log(\"<-- END HTTP (event-stream)\")\n+        if (!logBody || !response.promisesBody()) {\n+          logger.log(\"<-- END HTTP\")\n+        } else if (bodyHasUnknownEncoding(response.headers)) {\n+          logger.log(\"<-- END HTTP (encoded body omitted)\")\n+        } else if (bodyIsStreaming(response)) {\n+          logger.log(\"<-- END HTTP (streaming)\")\n         } else {\n-          val decompressor = findCompressionAlgorithm(response.headers, decompressionAlgorithms)\n-\n-          if (decompressor == null) {\n-            logger.log(\"<-- END HTTP (unknown encoded body omitted)\")\n-            return response\n-          }\n-\n           val source = responseBody.source()\n           source.request(Long.MAX_VALUE) // Buffer the entire body.\n \n@@ -392,9 +292,9 @@ class HttpLoggingInterceptor\n \n           var buffer = source.buffer\n \n-          var compressedLength: Long? = null\n-          if (decompressor != Identity) {\n-            compressedLength = buffer.size\n+          var gzippedLength: Long? = null\n+          if (\"gzip\".equals(headers[\"Content-Encoding\"], ignoreCase = true)) {\n+            gzippedLength = buffer.size\n             GzipSource(buffer.clone()).use { gzippedResponseBody ->\n               buffer = Buffer()\n               buffer.writeAll(gzippedResponseBody)\n@@ -417,38 +317,14 @@ class HttpLoggingInterceptor\n           logger.log(\n             buildString {\n               append(\"<-- END HTTP (${totalMs}ms, ${buffer.size}-byte\")\n-              if (compressedLength != null) append(\", $compressedLength-${decompressor.encoding}-byte\")\n+              if (gzippedLength != null) append(\", $gzippedLength-gzipped-byte\")\n               append(\" body)\")\n             },\n           )\n         }\n       }\n-      return response\n-    }\n-\n-    private fun streamRequestBody(request: Request): Request =\n-      request\n-        .newBuilder()\n-        .method(request.method, StreamingRequestBody(request, logger))\n-        .build()\n-\n-    private fun streamResponseBody(\n-      response: Response,\n-      decompressionAlgorithms: List<DecompressionAlgorithm>,\n-    ): Response {\n-      val decompressor = findCompressionAlgorithm(response.headers, decompressionAlgorithms)\n-\n-      if (decompressor == null) {\n-        logger.log(\"--> END HTTP (encoded streaming body omitted)\")\n-        return response\n-      }\n \n       return response\n-        .newBuilder()\n-        .body(StreamingResponseBody(response, decompressor, logger))\n-        .removeHeader(\"Content-Encoding\")\n-        .removeHeader(\"Content-Length\")\n-        .build()\n     }\n \n     internal fun redactUrl(url: HttpUrl): String {\n@@ -476,107 +352,16 @@ class HttpLoggingInterceptor\n       logger.log(headers.name(i) + \": \" + value)\n     }\n \n-    private fun findCompressionAlgorithm(\n-      headers: Headers,\n-      decompressionAlgorithms: List<DecompressionAlgorithm>,\n-    ): DecompressionAlgorithm? {\n-      val contentEncoding = headers[\"Content-Encoding\"] ?: return Identity\n-\n-      if (contentEncoding.equals(\"identity\", ignoreCase = true)) return Identity\n-\n-      return decompressionAlgorithms.find { contentEncoding.equals(it.encoding, ignoreCase = true) }\n+    private fun bodyHasUnknownEncoding(headers: Headers): Boolean {\n+      val contentEncoding = headers[\"Content-Encoding\"] ?: return false\n+      return !contentEncoding.equals(\"identity\", ignoreCase = true) &&\n+        !contentEncoding.equals(\"gzip\", ignoreCase = true)\n     }\n \n-    object Identity : DecompressionAlgorithm {\n-      override val encoding: String\n-        get() = \"identity\"\n-\n-      override fun decompress(compressedSource: BufferedSource): Source = compressedSource\n-    }\n-\n-    private fun bodyIsEventStream(response: Response): Boolean {\n+    private fun bodyIsStreaming(response: Response): Boolean {\n       val contentType = response.body.contentType()\n       return contentType != null && contentType.type == \"text\" && contentType.subtype == \"event-stream\"\n     }\n \n     companion object\n   }\n-\n-private class StreamingRequestBody(\n-  val request: Request,\n-  val logger: HttpLoggingInterceptor.Logger,\n-) : RequestBody() {\n-  val body = request.body!!\n-  val charset: Charset = body.contentType().charsetOrUtf8()\n-\n-  override fun contentType(): MediaType? = body.contentType()\n-\n-  override fun writeTo(sink: BufferedSink) {\n-    val sink =\n-      object : ForwardingSink(sink) {\n-        override fun write(\n-          source: Buffer,\n-          byteCount: Long,\n-        ) {\n-          logger.log(\"> \" + source.copy().readString(charset))\n-          super.write(source, byteCount)\n-        }\n-\n-        override fun close() {\n-          super.close()\n-          logger.log(\"--> END ${request.method} (streaming body)\")\n-        }\n-      }.buffer()\n-\n-    body.writeTo(sink)\n-  }\n-\n-  override fun contentLength(): Long = -1\n-\n-  override fun isDuplex(): Boolean = body.isDuplex()\n-\n-  override fun isOneShot(): Boolean = body.isOneShot()\n-}\n-\n-private class StreamingResponseBody(\n-  val response: Response,\n-  val decompressor: DecompressionAlgorithm,\n-  val logger: HttpLoggingInterceptor.Logger,\n-) : ResponseBody() {\n-  val buffer = Buffer()\n-  val charset: Charset = response.body.contentType().charsetOrUtf8()\n-\n-  override fun contentType(): MediaType? = response.body.contentType()\n-\n-  override fun contentLength(): Long = -1\n-\n-  override fun source(): BufferedSource {\n-    val decompressedSource = decompressor.decompress(response.body.source())\n-\n-    val source: Source =\n-      object : ForwardingSource(decompressedSource) {\n-        override fun read(\n-          sink: Buffer,\n-          byteCount: Long,\n-        ): Long {\n-          val count = super.read(buffer, byteCount)\n-\n-          if (count == -1L) {\n-            logger.log(\"<-- END HTTP (streaming body)\")\n-          } else {\n-            logger.log(\"< \" + buffer.copy().readString(charset))\n-            sink.write(buffer, count)\n-          }\n-\n-          return count\n-        }\n-      }\n-\n-    return source.buffer()\n-  }\n-\n-  override fun close() {\n-    response.body.close()\n-    buffer.clear()\n-  }\n-}\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/DuplexTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/DuplexTest.kt\nindex c046229dd0af..2fe2dd7b0cba 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/DuplexTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/DuplexTest.kt\n@@ -44,8 +44,6 @@ import okhttp3.TestUtil.assumeNotWindows\n import okhttp3.internal.RecordingOkAuthenticator\n import okhttp3.internal.duplex.AsyncRequestBody\n import okhttp3.internal.duplex.MockSocketHandler\n-import okhttp3.logging.HttpLoggingInterceptor\n-import okhttp3.logging.HttpLoggingInterceptor.Level\n import okhttp3.testing.PlatformRule\n import okio.BufferedSink\n import org.junit.jupiter.api.AfterEach\n@@ -53,10 +51,9 @@ import org.junit.jupiter.api.Assertions.assertTrue\n import org.junit.jupiter.api.BeforeEach\n import org.junit.jupiter.api.Disabled\n import org.junit.jupiter.api.Tag\n+import org.junit.jupiter.api.Test\n import org.junit.jupiter.api.Timeout\n import org.junit.jupiter.api.extension.RegisterExtension\n-import org.junit.jupiter.params.ParameterizedTest\n-import org.junit.jupiter.params.provider.ValueSource\n \n @Timeout(30)\n @Tag(\"Slowish\")\n@@ -72,17 +69,10 @@ class DuplexTest {\n \n   private var listener = RecordingEventListener()\n   private val handshakeCertificates = platform.localhostHandshakeCertificates()\n-  private val loggingInterceptor =\n-    HttpLoggingInterceptor({\n-      // Not testing output here, but making sure it doesn't fail\n-    }).apply {\n-      level = Level.NONE\n-    }\n   private var client =\n     clientTestRule\n       .newClientBuilder()\n       .eventListenerFactory(clientTestRule.wrap(listener))\n-      .addInterceptor(loggingInterceptor)\n       .build()\n   private val executorService = Executors.newScheduledThreadPool(1)\n \n@@ -97,17 +87,9 @@ class DuplexTest {\n     executorService.shutdown()\n   }\n \n-  fun setupLogging(logging: Boolean) {\n-    if (logging) {\n-      loggingInterceptor.level = Level.STREAMING\n-    }\n-  }\n-\n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n+  @Test\n   @Throws(IOException::class)\n-  fun http1DoesntSupportDuplex(logging: Boolean) {\n-    setupLogging(logging)\n+  fun http1DoesntSupportDuplex() {\n     val call =\n       client.newCall(\n         Request\n@@ -121,10 +103,8 @@ class DuplexTest {\n     }\n   }\n \n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun trueDuplexClientWritesFirst(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun trueDuplexClientWritesFirst() {\n     enableProtocol(Protocol.HTTP_2)\n     val body =\n       MockSocketHandler()\n@@ -172,10 +152,8 @@ class DuplexTest {\n     body.awaitSuccess()\n   }\n \n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun trueDuplexServerWritesFirst(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun trueDuplexServerWritesFirst() {\n     enableProtocol(Protocol.HTTP_2)\n     val body =\n       MockSocketHandler()\n@@ -223,10 +201,8 @@ class DuplexTest {\n     body.awaitSuccess()\n   }\n \n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun clientReadsHeadersDataTrailers(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun clientReadsHeadersDataTrailers() {\n     enableProtocol(Protocol.HTTP_2)\n     val body =\n       MockSocketHandler()\n@@ -260,10 +236,8 @@ class DuplexTest {\n     body.awaitSuccess()\n   }\n \n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun serverReadsHeadersData(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun serverReadsHeadersData() {\n     assumeNotWindows()\n     enableProtocol(Protocol.HTTP_2)\n     val body =\n@@ -297,10 +271,8 @@ class DuplexTest {\n     body.awaitSuccess()\n   }\n \n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun requestBodyEndsAfterResponseBody(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun requestBodyEndsAfterResponseBody() {\n     enableProtocol(Protocol.HTTP_2)\n     val body =\n       MockSocketHandler()\n@@ -355,10 +327,8 @@ class DuplexTest {\n     )\n   }\n \n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun duplexWith100Continue(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun duplexWith100Continue() {\n     enableProtocol(Protocol.HTTP_2)\n     val body =\n       MockSocketHandler()\n@@ -400,10 +370,8 @@ class DuplexTest {\n    * already split off another thread to stream the request body. Because we permit at most one\n    * exchange at a time we break the request stream out from under that writer.\n    */\n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun duplexWithRedirect(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun duplexWithRedirect() {\n     enableProtocol(Protocol.HTTP_2)\n     val duplexResponseSent = CountDownLatch(1)\n     listener =\n@@ -508,10 +476,8 @@ class DuplexTest {\n    * Auth requires follow-ups. Unlike redirects, the auth follow-up also has a request body. This\n    * test makes a single call with two duplex requests!\n    */\n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun duplexWithAuthChallenge(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun duplexWithAuthChallenge() {\n     enableProtocol(Protocol.HTTP_2)\n     val credential = basic(\"jesse\", \"secret\")\n     client =\n@@ -580,10 +546,8 @@ class DuplexTest {\n     (call.request().body as AsyncRequestBody?)!!.assertNoMoreSinks()\n   }\n \n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun fullCallTimeoutAppliesToSetup(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun fullCallTimeoutAppliesToSetup() {\n     enableProtocol(Protocol.HTTP_2)\n     server.enqueue(\n       MockResponse\n@@ -607,10 +571,8 @@ class DuplexTest {\n     }\n   }\n \n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun fullCallTimeoutDoesNotApplyOnceConnected(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun fullCallTimeoutDoesNotApplyOnceConnected() {\n     enableProtocol(Protocol.HTTP_2)\n     val body =\n       MockSocketHandler()\n@@ -651,10 +613,8 @@ class DuplexTest {\n     body.awaitSuccess()\n   }\n \n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun duplexWithRewriteInterceptors(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun duplexWithRewriteInterceptors() {\n     enableProtocol(Protocol.HTTP_2)\n     val body =\n       MockSocketHandler()\n@@ -705,10 +665,8 @@ class DuplexTest {\n    * be readable after the request stream is canceled.\n    */\n   @Disabled\n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun serverCancelsRequestBodyAndSendsResponseBody(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun serverCancelsRequestBodyAndSendsResponseBody() {\n     client =\n       client\n         .newBuilder()\n@@ -766,10 +724,8 @@ class DuplexTest {\n    * We delay sending the last byte of the request body 1500 ms. The 1000 ms read timeout should\n    * only elapse 1000 ms after the request body is sent.\n    */\n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun headersReadTimeoutDoesNotStartUntilLastRequestBodyByteFire(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun headersReadTimeoutDoesNotStartUntilLastRequestBodyByteFire() {\n     enableProtocol(Protocol.HTTP_2)\n     server.enqueue(\n       MockResponse\n@@ -797,10 +753,8 @@ class DuplexTest {\n   }\n \n   /** Same as the previous test, but the server stalls sending the response body.  */\n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun bodyReadTimeoutDoesNotStartUntilLastRequestBodyByteFire(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun bodyReadTimeoutDoesNotStartUntilLastRequestBodyByteFire() {\n     enableProtocol(Protocol.HTTP_2)\n     server.enqueue(\n       MockResponse\n@@ -833,10 +787,8 @@ class DuplexTest {\n    * We delay sending the last byte of the request body 1500 ms. The 1000 ms read timeout shouldn't\n    * elapse because it shouldn't start until the request body is sent.\n    */\n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun headersReadTimeoutDoesNotStartUntilLastRequestBodyByteNoFire(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun headersReadTimeoutDoesNotStartUntilLastRequestBodyByteNoFire() {\n     enableProtocol(Protocol.HTTP_2)\n     server.enqueue(\n       MockResponse\n@@ -864,10 +816,8 @@ class DuplexTest {\n    * We delay sending the last byte of the request body 1500 ms. The 1000 ms read timeout shouldn't\n    * elapse because it shouldn't start until the request body is sent.\n    */\n-  @ParameterizedTest(name = \"logging = {0}\")\n-  @ValueSource(booleans = [false, true])\n-  fun bodyReadTimeoutDoesNotStartUntilLastRequestBodyByteNoFire(logging: Boolean) {\n-    setupLogging(logging)\n+  @Test\n+  fun bodyReadTimeoutDoesNotStartUntilLastRequestBodyByteNoFire() {\n     enableProtocol(Protocol.HTTP_2)\n     server.enqueue(\n       MockResponse\n",
  "test_patch" : "diff --git a/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.kt b/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.kt\nindex ccf19dd1f1ad..ffacefb132c9 100644\n--- a/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.kt\n+++ b/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.kt\n@@ -19,7 +19,6 @@ import assertk.assertThat\n import assertk.assertions.isEqualTo\n import assertk.assertions.isLessThan\n import assertk.assertions.isLessThanOrEqualTo\n-import assertk.assertions.isNull\n import assertk.assertions.isSameInstanceAs\n import assertk.assertions.matches\n import java.net.UnknownHostException\n@@ -36,8 +35,6 @@ import okhttp3.RecordingHostnameVerifier\n import okhttp3.Request\n import okhttp3.RequestBody\n import okhttp3.RequestBody.Companion.toRequestBody\n-import okhttp3.internal.duplex.AsyncRequestBody\n-import okhttp3.internal.duplex.MockSocketHandler\n import okhttp3.logging.HttpLoggingInterceptor.Level\n import okhttp3.testing.PlatformRule\n import okio.Buffer\n@@ -605,7 +602,7 @@ class HttpLoggingInterceptorTest {\n       .assertLogEqual(\"Accept-Encoding: gzip\")\n       .assertLogMatch(Regex(\"\"\"User-Agent: okhttp/.+\"\"\"))\n       .assertLogEqual(\"\")\n-      .assertLogEqual(\"--> END POST (12-byte, 32-gzip-byte body)\")\n+      .assertLogEqual(\"--> END POST (12-byte, 32-gzipped-byte body)\")\n       .assertLogMatch(Regex(\"\"\"<-- 200 OK $url \\(\\d+ms\\)\"\"\"))\n       .assertLogEqual(\"Content-Type: text/plain; charset=utf-8\")\n       .assertLogMatch(Regex(\"\"\"Content-Length: \\d+\"\"\"))\n@@ -644,7 +641,7 @@ class HttpLoggingInterceptorTest {\n       .assertLogMatch(Regex(\"\"\"Content-Length: \\d+\"\"\"))\n       .assertLogEqual(\"\")\n       .assertLogEqual(\"Hello, Hello, Hello\")\n-      .assertLogMatch(Regex(\"\"\"<-- END HTTP \\(\\d+ms, 19-byte, 29-gzip-byte body\\)\"\"\"))\n+      .assertLogMatch(Regex(\"\"\"<-- END HTTP \\(\\d+ms, 19-byte, 29-gzipped-byte body\\)\"\"\"))\n       .assertNoMoreLogs()\n     applicationLogs\n       .assertLogEqual(\"--> GET $url\")\n@@ -681,7 +678,7 @@ class HttpLoggingInterceptorTest {\n       .assertLogEqual(\"Content-Encoding: br\")\n       .assertLogEqual(\"Content-Type: text/plain; charset=utf-8\")\n       .assertLogMatch(Regex(\"\"\"Content-Length: \\d+\"\"\"))\n-      .assertLogEqual(\"<-- END HTTP (unknown encoded body omitted)\")\n+      .assertLogEqual(\"<-- END HTTP (encoded body omitted)\")\n       .assertNoMoreLogs()\n     applicationLogs\n       .assertLogEqual(\"--> GET $url\")\n@@ -690,64 +687,12 @@ class HttpLoggingInterceptorTest {\n       .assertLogEqual(\"Content-Encoding: br\")\n       .assertLogEqual(\"Content-Type: text/plain; charset=utf-8\")\n       .assertLogMatch(Regex(\"\"\"Content-Length: \\d+\"\"\"))\n-      .assertLogEqual(\"<-- END HTTP (unknown encoded body omitted)\")\n+      .assertLogEqual(\"<-- END HTTP (encoded body omitted)\")\n       .assertNoMoreLogs()\n   }\n \n   @Test\n   fun bodyResponseIsStreaming() {\n-    setLevel(Level.STREAMING)\n-    server.enqueue(\n-      MockResponse\n-        .Builder()\n-        .setHeader(\"Content-Type\", \"text/event-stream\")\n-        .chunkedBody(\n-          \"\"\"\n-          |event: add\n-          |data: 73857293\n-          |\n-          |event: remove\n-          |data: 2153\n-          |\n-          |event: add\n-          |data: 113411\n-          |\n-          |\n-          \"\"\".trimMargin(),\n-          8,\n-        ).build(),\n-    )\n-    val parts = mutableListOf<String>()\n-    client.newCall(request().build()).execute().use {\n-      val source = it.body.source()\n-      while (!source.exhausted()) {\n-        parts.add(source.readUtf8(source.buffer.size))\n-      }\n-    }\n-    networkLogs\n-      .assertLogEqual(\"--> GET $url http/1.1\")\n-      .assertLogEqual(\"--> END GET\")\n-      .assertLogMatch(Regex(\"\"\"<-- 200 OK $url \\(\\d+ms, unknown-length body\\)\"\"\"))\n-      .apply {\n-        parts.forEach {\n-          assertLogEqual(\"< $it\")\n-        }\n-      }.assertLogEqual(\"<-- END HTTP (streaming body)\")\n-      .assertNoMoreLogs()\n-    applicationLogs\n-      .assertLogEqual(\"--> GET $url\")\n-      .assertLogEqual(\"--> END GET\")\n-      .assertLogMatch(Regex(\"\"\"<-- 200 OK $url \\(\\d+ms, unknown-length body\\)\"\"\"))\n-      .apply {\n-        parts.forEach {\n-          assertLogEqual(\"< $it\")\n-        }\n-      }.assertLogEqual(\"<-- END HTTP (streaming body)\")\n-      .assertNoMoreLogs()\n-  }\n-\n-  @Test\n-  fun bodyResponseIsEventStream() {\n     setLevel(Level.BODY)\n     server.enqueue(\n       MockResponse\n@@ -781,7 +726,7 @@ class HttpLoggingInterceptorTest {\n       .assertLogMatch(Regex(\"\"\"<-- 200 OK $url \\(\\d+ms\\)\"\"\"))\n       .assertLogEqual(\"Content-Type: text/event-stream\")\n       .assertLogMatch(Regex(\"\"\"Transfer-encoding: chunked\"\"\"))\n-      .assertLogEqual(\"<-- END HTTP (event-stream)\")\n+      .assertLogEqual(\"<-- END HTTP (streaming)\")\n       .assertNoMoreLogs()\n     applicationLogs\n       .assertLogEqual(\"--> GET $url\")\n@@ -789,7 +734,7 @@ class HttpLoggingInterceptorTest {\n       .assertLogMatch(Regex(\"\"\"<-- 200 OK $url \\(\\d+ms\\)\"\"\"))\n       .assertLogEqual(\"Content-Type: text/event-stream\")\n       .assertLogMatch(Regex(\"\"\"Transfer-encoding: chunked\"\"\"))\n-      .assertLogEqual(\"<-- END HTTP (event-stream)\")\n+      .assertLogEqual(\"<-- END HTTP (streaming)\")\n       .assertNoMoreLogs()\n   }\n \n@@ -1115,72 +1060,6 @@ class HttpLoggingInterceptorTest {\n       .assertNoMoreLogs()\n   }\n \n-  @Test\n-  fun duplexRequestsAreStreamable() {\n-    platform.assumeHttp2Support()\n-    server.useHttps(handshakeCertificates.sslSocketFactory()) // HTTP/2\n-    url = server.url(\"/\")\n-    setLevel(Level.STREAMING)\n-\n-    val body =\n-      MockSocketHandler()\n-        .receiveRequest(\"request A\\n\")\n-        .sendResponse(\"response B\\n\")\n-        .receiveRequest(\"request C\\n\")\n-        .sendResponse(\"response D\\n\")\n-        .receiveRequest(\"request E\\n\")\n-        .sendResponse(\"response F\\n\")\n-        .exhaustRequest()\n-        .exhaustResponse()\n-    server.enqueue(\n-      MockResponse\n-        .Builder()\n-        .clearHeaders()\n-        .socketHandler(body)\n-        .build(),\n-    )\n-    val call =\n-      client.newCall(\n-        Request\n-          .Builder()\n-          .url(server.url(\"/\"))\n-          .post(AsyncRequestBody())\n-          .build(),\n-      )\n-    call.execute().use { response ->\n-      val requestBody = (call.request().body as AsyncRequestBody?)!!.takeSink()\n-      requestBody.writeUtf8(\"request A\\n\")\n-      requestBody.flush()\n-      val responseBody = response.body.source()\n-      assertThat(responseBody.readUtf8Line())\n-        .isEqualTo(\"response B\")\n-      requestBody.writeUtf8(\"request C\\n\")\n-      requestBody.flush()\n-      assertThat(responseBody.readUtf8Line())\n-        .isEqualTo(\"response D\")\n-      requestBody.writeUtf8(\"request E\\n\")\n-      requestBody.flush()\n-      assertThat(responseBody.readUtf8Line())\n-        .isEqualTo(\"response F\")\n-      requestBody.close()\n-      assertThat(responseBody.readUtf8Line()).isNull()\n-    }\n-    body.awaitSuccess()\n-\n-    applicationLogs\n-      .assertLogEqual(\"--> POST $url\")\n-      .assertLogMatch(Regex(\"\"\"<-- 200 $url \\(\\d+ms, unknown-length body\\)\"\"\"))\n-      .assertLogEqual(\"> request A\\n\")\n-      .assertLogEqual(\"< response B\\n\")\n-      .assertLogEqual(\"> request C\\n\")\n-      .assertLogEqual(\"< response D\\n\")\n-      .assertLogEqual(\"> request E\\n\")\n-      .assertLogEqual(\"< response F\\n\")\n-      .assertLogEqual(\"--> END POST (streaming body)\")\n-      .assertLogEqual(\"<-- END HTTP (streaming body)\")\n-      .assertNoMoreLogs()\n-  }\n-\n   @Test\n   fun oneShotRequestsAreNotLogged() {\n     url = server.url(\"/\")\n@@ -1228,7 +1107,7 @@ class HttpLoggingInterceptorTest {\n   internal class LogRecorder(\n     val prefix: Regex = Regex(\"\"),\n   ) : HttpLoggingInterceptor.Logger {\n-    val logs = mutableListOf<String>()\n+    private val logs = mutableListOf<String>()\n     private var index = 0\n \n     fun assertLogEqual(expected: String) =\n",
  "problem_statement" : "Revert \"Add minimal HttpLoggingInterceptor support for streaming request and responses. (#8993)\"\n\nTheres a bunch of new features in here and Id prefer to land them as individually-considered parts.",
  "hints_text" : null,
  "created_at" : "Tue Oct 07 16:24:23 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 9115,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-9112",
  "repo" : "square/okhttp",
  "base_commit" : "fa84a6e0d7e38fbf9d77e106d5de6a87fa32d8a7",
  "patch" : "diff --git a/okhttp-logging-interceptor/src/main/kotlin/okhttp3/logging/HttpLoggingInterceptor.kt b/okhttp-logging-interceptor/src/main/kotlin/okhttp3/logging/HttpLoggingInterceptor.kt\nindex 29b937459acb..ed4d5c618650 100644\n--- a/okhttp-logging-interceptor/src/main/kotlin/okhttp3/logging/HttpLoggingInterceptor.kt\n+++ b/okhttp-logging-interceptor/src/main/kotlin/okhttp3/logging/HttpLoggingInterceptor.kt\n@@ -35,8 +35,8 @@ import okhttp3.ResponseBody\n import okhttp3.internal.charsetOrUtf8\n import okhttp3.internal.connection.RealCall\n import okhttp3.internal.http.promisesBody\n+import okhttp3.internal.isProbablyUtf8\n import okhttp3.internal.platform.Platform\n-import okhttp3.logging.internal.isProbablyUtf8\n import okio.Buffer\n import okio.BufferedSink\n import okio.BufferedSource\n@@ -336,7 +336,7 @@ class HttpLoggingInterceptor\n           val charset: Charset = requestBody.contentType().charsetOrUtf8()\n \n           logger.log(\"\")\n-          if (!buffer.isProbablyUtf8()) {\n+          if (!buffer.isProbablyUtf8(16L)) {\n             logger.log(\n               \"--> END ${request.method} (binary ${requestBody.contentLength()}-byte body omitted)\",\n             )\n@@ -403,7 +403,7 @@ class HttpLoggingInterceptor\n \n           val charset: Charset = responseBody.contentType().charsetOrUtf8()\n \n-          if (!buffer.isProbablyUtf8()) {\n+          if (!buffer.isProbablyUtf8(16L)) {\n             logger.log(\"\")\n             logger.log(\"<-- END HTTP (${totalMs}ms, binary ${buffer.size}-byte body omitted)\")\n             return response\ndiff --git a/okhttp/api/android/okhttp.api b/okhttp/api/android/okhttp.api\nindex afe561643172..5eac24e235c8 100644\n--- a/okhttp/api/android/okhttp.api\n+++ b/okhttp/api/android/okhttp.api\n@@ -37,16 +37,6 @@ public abstract interface class okhttp3/Authenticator {\n public final class okhttp3/Authenticator$Companion {\n }\n \n-public final class okhttp3/BinaryMode : java/lang/Enum {\n-\tpublic static final field FILE Lokhttp3/BinaryMode;\n-\tpublic static final field HEX Lokhttp3/BinaryMode;\n-\tpublic static final field OMIT Lokhttp3/BinaryMode;\n-\tpublic static final field STDIN Lokhttp3/BinaryMode;\n-\tpublic static fun getEntries ()Lkotlin/enums/EnumEntries;\n-\tpublic static fun valueOf (Ljava/lang/String;)Lokhttp3/BinaryMode;\n-\tpublic static fun values ()[Lokhttp3/BinaryMode;\n-}\n-\n public final class okhttp3/Cache : java/io/Closeable, java/io/Flushable {\n \tpublic static final field Companion Lokhttp3/Cache$Companion;\n \tpublic final fun -deprecated_directory ()Ljava/io/File;\n@@ -1030,10 +1020,9 @@ public final class okhttp3/Request {\n \tpublic final fun tag ()Ljava/lang/Object;\n \tpublic final fun tag (Ljava/lang/Class;)Ljava/lang/Object;\n \tpublic final fun tag (Lkotlin/reflect/KClass;)Ljava/lang/Object;\n-  public final fun toCurl ()Ljava/lang/String;\n-  public final fun toCurl (Lokhttp3/BinaryMode;)Ljava/lang/String;\n-  public final fun toCurl (Lokhttp3/BinaryMode;Ljava/lang/String;)Ljava/lang/String;\n-  public static synthetic fun toCurl$default (Lokhttp3/Request;Lokhttp3/BinaryMode;Ljava/lang/String;ILjava/lang/Object;)Ljava/lang/String;\n+\tpublic final fun toCurl ()Ljava/lang/String;\n+\tpublic final fun toCurl (Z)Ljava/lang/String;\n+\tpublic static synthetic fun toCurl$default (Lokhttp3/Request;ZILjava/lang/Object;)Ljava/lang/String;\n \tpublic fun toString ()Ljava/lang/String;\n \tpublic final fun url ()Lokhttp3/HttpUrl;\n }\ndiff --git a/okhttp/api/jvm/okhttp.api b/okhttp/api/jvm/okhttp.api\nindex 9f882b0621e1..f627f4de13f6 100644\n--- a/okhttp/api/jvm/okhttp.api\n+++ b/okhttp/api/jvm/okhttp.api\n@@ -37,16 +37,6 @@ public abstract interface class okhttp3/Authenticator {\n public final class okhttp3/Authenticator$Companion {\n }\n \n-public final class okhttp3/BinaryMode : java/lang/Enum {\n-\tpublic static final field FILE Lokhttp3/BinaryMode;\n-\tpublic static final field HEX Lokhttp3/BinaryMode;\n-\tpublic static final field OMIT Lokhttp3/BinaryMode;\n-\tpublic static final field STDIN Lokhttp3/BinaryMode;\n-\tpublic static fun getEntries ()Lkotlin/enums/EnumEntries;\n-\tpublic static fun valueOf (Ljava/lang/String;)Lokhttp3/BinaryMode;\n-\tpublic static fun values ()[Lokhttp3/BinaryMode;\n-}\n-\n public final class okhttp3/Cache : java/io/Closeable, java/io/Flushable {\n \tpublic static final field Companion Lokhttp3/Cache$Companion;\n \tpublic final fun -deprecated_directory ()Ljava/io/File;\n@@ -1030,9 +1020,8 @@ public final class okhttp3/Request {\n \tpublic final fun tag (Ljava/lang/Class;)Ljava/lang/Object;\n \tpublic final fun tag (Lkotlin/reflect/KClass;)Ljava/lang/Object;\n \tpublic final fun toCurl ()Ljava/lang/String;\n-\tpublic final fun toCurl (Lokhttp3/BinaryMode;)Ljava/lang/String;\n-\tpublic final fun toCurl (Lokhttp3/BinaryMode;Ljava/lang/String;)Ljava/lang/String;\n-\tpublic static synthetic fun toCurl$default (Lokhttp3/Request;Lokhttp3/BinaryMode;Ljava/lang/String;ILjava/lang/Object;)Ljava/lang/String;\n+\tpublic final fun toCurl (Z)Ljava/lang/String;\n+\tpublic static synthetic fun toCurl$default (Lokhttp3/Request;ZILjava/lang/Object;)Ljava/lang/String;\n \tpublic fun toString ()Ljava/lang/String;\n \tpublic final fun url ()Lokhttp3/HttpUrl;\n }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/BinaryMode.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/BinaryMode.kt\ndeleted file mode 100644\nindex e2115f1ffec7..000000000000\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/BinaryMode.kt\n+++ /dev/null\n@@ -1,8 +0,0 @@\n-package okhttp3\n-\n-enum class BinaryMode {\n-  HEX, // hex encode\n-  OMIT, // \"[binary body omitted]\"\n-  FILE, // --data-binary @filename\n-  STDIN, // --data-binary @-\n-}\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Request.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Request.kt\nindex a7c603f53261..cc5e073c3dbe 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Request.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/Request.kt\n@@ -16,13 +16,13 @@\n package okhttp3\n \n import java.net.URL\n-import java.nio.charset.StandardCharsets\n import kotlin.reflect.KClass\n import kotlin.reflect.cast\n import okhttp3.Headers.Companion.headersOf\n import okhttp3.HttpUrl.Companion.toHttpUrl\n import okhttp3.internal.http.GzipRequestBody\n import okhttp3.internal.http.HttpMethod\n+import okhttp3.internal.isProbablyUtf8\n import okhttp3.internal.isSensitiveHeader\n import okio.Buffer\n \n@@ -462,104 +462,55 @@ class Request internal constructor(\n   }\n \n   /**\n-   * Returns a cURL command equivalent to this request, useful for debugging and reproducing requests.\n+   * Returns a cURL command equivalent to this request, useful for debugging and reproducing\n+   * requests.\n    *\n    * This includes the HTTP method, headers, request body (if present), and URL.\n    *\n    * Example:\n+   *\n    * ```\n-   * curl -X POST -H \"Authorization: Bearer token\" --data \"{\\\"key\\\":\\\"value\\\"}\" \"https://example.com/api\"\n+   * curl 'https://example.com/api' \\\n+   *   -X PUT \\\n+   *   -H 'Authorization: Bearer token' \\\n+   *   --data '{\\\"key\\\":\\\"value\\\"}'\n    * ```\n    *\n-   * **Note:** This method will write the body\n-   * to a temporary [okio.Buffer] in memory. This may have side effects if the [RequestBody] is streaming\n-   * or can be consumed only once. Calling this method might prevent re-sending the request body later.\n-   *\n-   * @param binaryFileName default file name to use when dumping binary body data to a file (default: `\"request_body.bin\"`)\n-   * @param binaryMode default mode to use when writing binary body data (default: `\"BinaryMode.STDIN\"`)\n-   * @return a cURL command string representing this request.\n+   * **Note:** This will consume the request body. This may have side effects if the [RequestBody]\n+   * is streaming or can be consumed only once.\n    */\n   @JvmOverloads\n-  fun toCurl(\n-    binaryMode: BinaryMode = BinaryMode.STDIN,\n-    binaryFileName: String? = \"request_body.bin\",\n-  ): String {\n-    val curl = StringBuilder(\"curl\")\n-\n-    // Add method if not GET\n-    if (method != \"GET\") {\n-      curl.append(\" -X \").append(method)\n-    }\n+  fun toCurl(includeBody: Boolean = true): String =\n+    buildString {\n+      append(\"curl ${url.toString().shellEscape()}\")\n \n-    // Append headers\n-    for ((name, value) in headers) {\n-      curl\n-        .append(\" -H \\\"\")\n-        .append(name)\n-        .append(\": \")\n-        .append(value)\n-        .append(\"\\\"\")\n-    }\n-\n-    // Append body if present\n-    body?.let { requestBody ->\n-      val buffer = Buffer()\n-      requestBody.writeTo(buffer)\n-\n-      // Clone so we can read multiple times without consuming\n-      val peekBuffer = buffer.clone()\n-      val isBinary = isBinaryData(peekBuffer)\n-\n-      if (isBinary) {\n-        when (binaryMode) {\n-          BinaryMode.HEX -> {\n-            curl.append(\" --data-binary \\\"\")\n-            val hexBuffer = buffer.clone()\n-            while (!hexBuffer.exhausted()) {\n-              val b = hexBuffer.readByte().toInt() and 0xFF\n-              curl.append(\"%02x\".format(b))\n-            }\n-            curl.append(\"\\\"\")\n-          }\n-          BinaryMode.FILE -> {\n-            curl.append(\" --data-binary @\").append(binaryFileName)\n-          }\n-          BinaryMode.STDIN -> {\n-            curl.append(\" --data-binary @-\")\n-          }\n-          BinaryMode.OMIT -> {\n-            curl.append(\" --data-binary \\\"[binary body omitted]\\\"\")\n-          }\n+      // Add method if not the default.\n+      val defaultMethod =\n+        when {\n+          includeBody && body != null -> \"POST\"\n+          else -> \"GET\"\n         }\n-      } else {\n-        val bodyString = buffer.readString(StandardCharsets.UTF_8)\n-        curl\n-          .append(\" --data \\\"\")\n-          .append(bodyString.replace(\"\\\"\", \"\\\\\\\"\"))\n-          .append(\"\\\"\")\n+      if (method != defaultMethod) {\n+        append(\" \\\\\\n  -X ${method.shellEscape()}\")\n       }\n-    }\n \n-    curl.append(\" \\\"\").append(url).append(\"\\\"\")\n-    return curl.toString()\n-  }\n+      // Append headers.\n+      for ((name, value) in headers) {\n+        append(\" \\\\\\n  -H ${\"$name: $value\".shellEscape()}\")\n+      }\n \n-  /**\n-   * Detects binary data by checking for non-printable characters in a buffer.\n-   */\n-  private fun isBinaryData(peekBuffer: Buffer): Boolean {\n-    var totalBytes = 0\n-    var binaryCount = 0\n-    val textSafeBytes = intArrayOf(0x09, 0x0A, 0x0D) // tab, LF, CR\n-\n-    while (!peekBuffer.exhausted() && totalBytes < 4096) { // limit to first 4KB for performance\n-      val b = peekBuffer.readByte().toInt() and 0xFF\n-      if ((b < 0x20 && b !in textSafeBytes) || b > 0x7E) {\n-        binaryCount++\n+      // Append body if present.\n+      if (includeBody && body != null) {\n+        val bodyBuffer = Buffer()\n+        body.writeTo(bodyBuffer)\n+\n+        if (bodyBuffer.isProbablyUtf8()) {\n+          append(\" \\\\\\n  --data ${bodyBuffer.readUtf8().shellEscape()}\")\n+        } else {\n+          append(\" \\\\\\n  --data-binary ${bodyBuffer.readByteString().hex().shellEscape()}\")\n+        }\n       }\n-      totalBytes++\n     }\n \n-    return totalBytes > 0 && binaryCount > totalBytes * 0.1\n-  }\n+  private fun String.shellEscape(): String = \"'${replace(\"'\", \"'\\\\''\")}'\"\n }\ndiff --git a/okhttp-logging-interceptor/src/main/kotlin/okhttp3/logging/internal/IsProbablyUtf8.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/IsProbablyUtf8.kt\nsimilarity index 65%\nrename from okhttp-logging-interceptor/src/main/kotlin/okhttp3/logging/internal/IsProbablyUtf8.kt\nrename to okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/IsProbablyUtf8.kt\nindex dbe831473167..76894e6154f2 100644\n--- a/okhttp-logging-interceptor/src/main/kotlin/okhttp3/logging/internal/IsProbablyUtf8.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/IsProbablyUtf8.kt\n@@ -13,26 +13,26 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n-package okhttp3.logging.internal\n+package okhttp3.internal\n \n import java.io.EOFException\n-import okio.Buffer\n+import okio.BufferedSource\n \n /**\n- * Returns true if the body in question probably contains human readable text. Uses a small\n- * sample of code points to detect unicode control characters commonly used in binary file\n+ * Returns true if the body in question probably contains human-readable text. Uses a small\n+ * sample of code points to detect Unicode control characters commonly used in binary file\n  * signatures.\n+ *\n+ * @param codePointLimit the number of code points to read in order to make a decision.\n  */\n-fun Buffer.isProbablyUtf8(): Boolean {\n+internal fun BufferedSource.isProbablyUtf8(codePointLimit: Long = Long.MAX_VALUE): Boolean {\n   try {\n-    val prefix = Buffer()\n-    val byteCount = size.coerceAtMost(64)\n-    copyTo(prefix, 0, byteCount)\n-    for (i in 0 until 16) {\n-      if (prefix.exhausted()) {\n+    val peek = peek()\n+    for (i in 0 until codePointLimit) {\n+      if (peek.exhausted()) {\n         break\n       }\n-      val codePoint = prefix.readUtf8CodePoint()\n+      val codePoint = peek.readUtf8CodePoint()\n       if (Character.isISOControl(codePoint) && !Character.isWhitespace(codePoint)) {\n         return false\n       }\ndiff --git a/okhttp/src/commonTest/kotlin/okhttp3/internal/IsProbablyUtf8Test.kt b/okhttp/src/commonTest/kotlin/okhttp3/internal/IsProbablyUtf8Test.kt\nnew file mode 100644\nindex 000000000000..7cf67bf57fc4\n--- /dev/null\n+++ b/okhttp/src/commonTest/kotlin/okhttp3/internal/IsProbablyUtf8Test.kt\n@@ -0,0 +1,69 @@\n+/*\n+ * Copyright (C) 2015 Square, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package okhttp3.internal\n+\n+import assertk.assertThat\n+import assertk.assertions.isEqualTo\n+import assertk.assertions.isFalse\n+import assertk.assertions.isTrue\n+import okio.Buffer\n+import okio.Source\n+import okio.Timeout\n+import okio.buffer\n+import org.junit.jupiter.api.Test\n+\n+class IsProbablyUtf8Test {\n+  @Test fun isProbablyUtf8() {\n+    assertThat(Buffer().isProbablyUtf8(16L)).isTrue()\n+    assertThat(Buffer().writeUtf8(\"abc\").isProbablyUtf8(16L)).isTrue()\n+    assertThat(Buffer().writeUtf8(\"new\\r\\nlines\").isProbablyUtf8(16L)).isTrue()\n+    assertThat(Buffer().writeUtf8(\"white\\t space\").isProbablyUtf8(16L)).isTrue()\n+    assertThat(Buffer().writeUtf8(\" !\").isProbablyUtf8(16L)).isTrue()\n+    assertThat(Buffer().writeByte(0x80).isProbablyUtf8(16L)).isTrue()\n+    assertThat(Buffer().writeByte(0x00).isProbablyUtf8(16L)).isFalse()\n+    assertThat(Buffer().writeByte(0xc0).isProbablyUtf8(16L)).isFalse()\n+  }\n+\n+  @Test fun doesNotConsumeBuffer() {\n+    val buffer = Buffer()\n+    buffer.writeUtf8(\"hello \".repeat(1024))\n+    assertThat(buffer.isProbablyUtf8(100L)).isTrue()\n+    assertThat(buffer.readUtf8()).isEqualTo(\"hello \".repeat(1024))\n+  }\n+\n+  /** Confirm [isProbablyUtf8] doesn't attempt to read the entire stream. */\n+  @Test fun doesNotReadEntireSource() {\n+    val unlimitedSource =\n+      object : Source {\n+        override fun read(\n+          sink: Buffer,\n+          byteCount: Long,\n+        ): Long {\n+          sink.writeUtf8(\"a\".repeat(byteCount.toInt()))\n+          return byteCount\n+        }\n+\n+        override fun close() {\n+        }\n+\n+        override fun timeout() = Timeout.NONE\n+      }\n+\n+    assertThat(unlimitedSource.buffer().isProbablyUtf8(1L)).isTrue()\n+    assertThat(unlimitedSource.buffer().isProbablyUtf8(1024L)).isTrue()\n+    assertThat(unlimitedSource.buffer().isProbablyUtf8(1024L * 1024L)).isTrue()\n+  }\n+}\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/RequestTest.kt b/okhttp/src/jvmTest/kotlin/okhttp3/RequestTest.kt\nindex 91ad40576aa6..8564e1174092 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/RequestTest.kt\n+++ b/okhttp/src/jvmTest/kotlin/okhttp3/RequestTest.kt\n@@ -663,7 +663,12 @@ class RequestTest {\n \n     val curl = request.toCurl()\n     assertThat(curl)\n-      .isEqualTo(\"curl -H \\\"Authorization: Bearer abc123\\\" \\\"https://example.com/\\\"\")\n+      .isEqualTo(\n+        \"\"\"\n+        |curl 'https://example.com/' \\\n+        |  -H 'Authorization: Bearer abc123'\n+        \"\"\".trimMargin(),\n+      )\n   }\n \n   @Test\n@@ -680,77 +685,92 @@ class RequestTest {\n         .addHeader(\"Authorization\", \"Bearer abc123\")\n         .build()\n \n-    val curl = request.toCurl()\n-    assertThat(curl)\n+    assertThat(request.toCurl())\n       .isEqualTo(\n-        \"curl -X POST -H \\\"Content-Type: application/json\\\" -H \\\"Authorization: Bearer abc123\\\" --data \\\"{\\\\\\\"key\\\\\\\":\\\\\\\"value\\\\\\\"}\\\" \\\"https://api.example.com/data\\\"\",\n+        \"\"\"\n+        |curl 'https://api.example.com/data' \\\n+        |  -H 'Content-Type: application/json' \\\n+        |  -H 'Authorization: Bearer abc123' \\\n+        |  --data '{\"key\":\"value\"}'\n+        \"\"\".trimMargin(),\n       )\n   }\n \n+  /** Put is not the default method so `-X 'PUT'` is included. */\n   @Test\n-  fun curlPostWithComplexBody() {\n+  fun curlPutWithBody() {\n     val mediaType = \"application/json\".toMediaType()\n-    val jsonBody =\n-      \"\"\"\n-      {\n-        \"user\": {\n-          \"id\": 123,\n-          \"name\": \"John Doe\"\n-        },\n-        \"roles\": [\"admin\", \"editor\"],\n-        \"active\": true\n-      }\n-      \"\"\".trimIndent()\n-\n-    val body = jsonBody.toRequestBody(mediaType)\n+    val body = \"{\\\"key\\\":\\\"value\\\"}\".toRequestBody(mediaType)\n \n     val request =\n       Request\n         .Builder()\n-        .url(\"https://api.example.com/users\")\n-        .post(body)\n+        .url(\"https://api.example.com/data\")\n+        .put(body)\n         .addHeader(\"Content-Type\", \"application/json\")\n-        .addHeader(\"Authorization\", \"Bearer xyz789\")\n+        .addHeader(\"Authorization\", \"Bearer abc123\")\n         .build()\n \n-    val curl = request.toCurl()\n-    assertThat(curl)\n+    assertThat(request.toCurl())\n       .isEqualTo(\n-        \"curl -X POST -H \\\"Content-Type: application/json\\\" -H \\\"Authorization: Bearer xyz789\\\" --data \\\"{\\n\" +\n-          \"  \\\\\\\"user\\\\\\\": {\\n\" +\n-          \"    \\\\\\\"id\\\\\\\": 123,\\n\" +\n-          \"    \\\\\\\"name\\\\\\\": \\\\\\\"John Doe\\\\\\\"\\n\" +\n-          \"  },\\n\" +\n-          \"  \\\\\\\"roles\\\\\\\": [\\\\\\\"admin\\\\\\\", \\\\\\\"editor\\\\\\\"],\\n\" +\n-          \"  \\\\\\\"active\\\\\\\": true\\n\" +\n-          \"}\\\" \\\"https://api.example.com/users\\\"\",\n+        \"\"\"\n+        |curl 'https://api.example.com/data' \\\n+        |  -X 'PUT' \\\n+        |  -H 'Content-Type: application/json' \\\n+        |  -H 'Authorization: Bearer abc123' \\\n+        |  --data '{\"key\":\"value\"}'\n+        \"\"\".trimMargin(),\n       )\n   }\n \n   @Test\n-  fun curlPostWithBinaryBody_DefaultSTDIN() {\n-    val mediaType = \"application/octet-stream\".toMediaType()\n-    val binaryData = byteArrayOf(0x00, 0x01, 0x02, 0x03)\n+  fun curlPostWithComplexBody() {\n+    val mediaType = \"application/json\".toMediaType()\n+    val jsonBody =\n+      \"\"\"\n+      |{\n+      |  \"user\": {\n+      |    \"id\": 123,\n+      |    \"name\": \"Tim O'Reilly\"\n+      |  },\n+      |  \"roles\": [\"admin\", \"editor\"],\n+      |  \"active\": true\n+      |}\n+      |\n+      \"\"\".trimMargin()\n \n-    val body = binaryData.toRequestBody(mediaType)\n+    val body = jsonBody.toRequestBody(mediaType)\n \n     val request =\n       Request\n         .Builder()\n-        .url(\"https://api.example.com/upload\")\n+        .url(\"https://api.example.com/users\")\n         .post(body)\n-        .addHeader(\"Content-Type\", \"application/octet-stream\")\n+        .addHeader(\"Content-Type\", \"application/json\")\n+        .addHeader(\"Authorization\", \"Bearer xyz789\")\n         .build()\n \n-    val curl = request.toCurl() // default is BinaryMode.STDIN\n-    assertThat(curl)\n+    assertThat(request.toCurl())\n       .isEqualTo(\n-        \"curl -X POST -H \\\"Content-Type: application/octet-stream\\\" --data-binary @- \\\"https://api.example.com/upload\\\"\",\n+        \"\"\"\n+        |curl 'https://api.example.com/users' \\\n+        |  -H 'Content-Type: application/json' \\\n+        |  -H 'Authorization: Bearer xyz789' \\\n+        |  --data '{\n+        |  \"user\": {\n+        |    \"id\": 123,\n+        |    \"name\": \"Tim O'\\''Reilly\"\n+        |  },\n+        |  \"roles\": [\"admin\", \"editor\"],\n+        |  \"active\": true\n+        |}\n+        |'\n+        \"\"\".trimMargin(),\n       )\n   }\n \n   @Test\n-  fun curlPostWithBinaryBody_HexMode() {\n+  fun curlPostWithBinaryBody() {\n     val mediaType = \"application/octet-stream\".toMediaType()\n     val binaryData = byteArrayOf(0x00, 0x01, 0x02, 0x03)\n \n@@ -764,37 +784,19 @@ class RequestTest {\n         .addHeader(\"Content-Type\", \"application/octet-stream\")\n         .build()\n \n-    val curl = request.toCurl(BinaryMode.HEX)\n-    assertThat(curl)\n-      .isEqualTo(\n-        \"curl -X POST -H \\\"Content-Type: application/octet-stream\\\" --data-binary \\\"00010203\\\" \\\"https://api.example.com/upload\\\"\",\n-      )\n-  }\n-\n-  @Test\n-  fun curlPostWithBinaryBody_FileMode() {\n-    val mediaType = \"application/octet-stream\".toMediaType()\n-    val binaryData = byteArrayOf(0xAA.toByte(), 0xBB.toByte())\n-\n-    val body = binaryData.toRequestBody(mediaType)\n-\n-    val request =\n-      Request\n-        .Builder()\n-        .url(\"https://api.example.com/upload\")\n-        .post(body)\n-        .addHeader(\"Content-Type\", \"application/octet-stream\")\n-        .build()\n-\n-    val curl = request.toCurl(BinaryMode.FILE, \"mydata.bin\")\n+    val curl = request.toCurl()\n     assertThat(curl)\n       .isEqualTo(\n-        \"curl -X POST -H \\\"Content-Type: application/octet-stream\\\" --data-binary @mydata.bin \\\"https://api.example.com/upload\\\"\",\n+        \"\"\"\n+        |curl 'https://api.example.com/upload' \\\n+        |  -H 'Content-Type: application/octet-stream' \\\n+        |  --data-binary '00010203'\n+        \"\"\".trimMargin(),\n       )\n   }\n \n   @Test\n-  fun curlPostWithBinaryBody_OmitMode() {\n+  fun curlPostWithBinaryBodyOmitted() {\n     val mediaType = \"application/octet-stream\".toMediaType()\n     val binaryData = byteArrayOf(0x10, 0x20)\n \n@@ -808,10 +810,14 @@ class RequestTest {\n         .addHeader(\"Content-Type\", \"application/octet-stream\")\n         .build()\n \n-    val curl = request.toCurl(BinaryMode.OMIT)\n+    val curl = request.toCurl(includeBody = false)\n     assertThat(curl)\n       .isEqualTo(\n-        \"curl -X POST -H \\\"Content-Type: application/octet-stream\\\" --data-binary \\\"[binary body omitted]\\\" \\\"https://api.example.com/upload\\\"\",\n+        \"\"\"\n+        |curl 'https://api.example.com/upload' \\\n+        |  -X 'POST' \\\n+        |  -H 'Content-Type: application/octet-stream'\n+        \"\"\".trimMargin(),\n       )\n   }\n \n",
  "test_patch" : "diff --git a/okhttp-logging-interceptor/src/test/java/okhttp3/logging/IsProbablyUtf8Test.kt b/okhttp-logging-interceptor/src/test/java/okhttp3/logging/IsProbablyUtf8Test.kt\ndeleted file mode 100644\nindex f965ff6c03be..000000000000\n--- a/okhttp-logging-interceptor/src/test/java/okhttp3/logging/IsProbablyUtf8Test.kt\n+++ /dev/null\n@@ -1,35 +0,0 @@\n-/*\n- * Copyright (C) 2015 Square, Inc.\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package okhttp3.logging\n-\n-import assertk.assertThat\n-import assertk.assertions.isFalse\n-import assertk.assertions.isTrue\n-import okhttp3.logging.internal.isProbablyUtf8\n-import okio.Buffer\n-import org.junit.jupiter.api.Test\n-\n-class IsProbablyUtf8Test {\n-  @Test fun isProbablyUtf8() {\n-    assertThat(Buffer().isProbablyUtf8()).isTrue()\n-    assertThat(Buffer().writeUtf8(\"abc\").isProbablyUtf8()).isTrue()\n-    assertThat(Buffer().writeUtf8(\"new\\r\\nlines\").isProbablyUtf8()).isTrue()\n-    assertThat(Buffer().writeUtf8(\"white\\t space\").isProbablyUtf8()).isTrue()\n-    assertThat(Buffer().writeByte(0x80).isProbablyUtf8()).isTrue()\n-    assertThat(Buffer().writeByte(0x00).isProbablyUtf8()).isFalse()\n-    assertThat(Buffer().writeByte(0xc0).isProbablyUtf8()).isFalse()\n-  }\n-}\n",
  "problem_statement" : "Make Request.toCurl work more like Chrome's 'copy as cURL'\n\nChanges:\r\n - single quotes\r\n - URL first\r\n - omit the default method\r\n\r\nAlso change binary detection to use isProbablyUtf8 instead, which is promoted to the main okhttp module.\r\n\r\nAlso replace the BinaryMode enum with a boolean to optionally not include the body.",
  "hints_text" : null,
  "created_at" : "Mon Oct 06 23:55:39 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 9112,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-9098",
  "repo" : "square/okhttp",
  "base_commit" : "fa783c3dda8580f27b26d96641db2ca09cf59adf",
  "patch" : "diff --git a/okhttp-sse/api/okhttp-sse.api b/okhttp-sse/api/okhttp-sse.api\nindex dbe1dae6fdee..d1baa0735188 100644\n--- a/okhttp-sse/api/okhttp-sse.api\n+++ b/okhttp-sse/api/okhttp-sse.api\n@@ -1,26 +1,12 @@\n public abstract interface class okhttp3/sse/EventSource {\n-\tpublic static final field Companion Lokhttp3/sse/EventSource$Companion;\n \tpublic abstract fun cancel ()V\n-\tpublic static fun enqueue (Lokhttp3/Call;Lokhttp3/sse/EventSourceListener;)Lokhttp3/sse/EventSource;\n-\tpublic static fun process (Lokhttp3/Response;Lokhttp3/sse/EventSourceListener;)V\n \tpublic abstract fun request ()Lokhttp3/Request;\n }\n \n-public final class okhttp3/sse/EventSource$Companion {\n-\tpublic final fun enqueue (Lokhttp3/Call;Lokhttp3/sse/EventSourceListener;)Lokhttp3/sse/EventSource;\n-\tpublic final fun process (Lokhttp3/Response;Lokhttp3/sse/EventSourceListener;)V\n-}\n-\n public abstract interface class okhttp3/sse/EventSource$Factory {\n-\tpublic static final field Companion Lokhttp3/sse/EventSource$Factory$Companion;\n-\tpublic static fun create (Lokhttp3/Call$Factory;)Lokhttp3/sse/EventSource$Factory;\n \tpublic abstract fun newEventSource (Lokhttp3/Request;Lokhttp3/sse/EventSourceListener;)Lokhttp3/sse/EventSource;\n }\n \n-public final class okhttp3/sse/EventSource$Factory$Companion {\n-\tpublic final fun create (Lokhttp3/Call$Factory;)Lokhttp3/sse/EventSource$Factory;\n-}\n-\n public abstract class okhttp3/sse/EventSourceListener {\n \tpublic fun <init> ()V\n \tpublic fun onClosed (Lokhttp3/sse/EventSource;)V\ndiff --git a/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSource.kt b/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSource.kt\nindex 06ddc37abf81..8235f17b0843 100644\n--- a/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSource.kt\n+++ b/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSource.kt\n@@ -15,10 +15,7 @@\n  */\n package okhttp3.sse\n \n-import okhttp3.Call\n import okhttp3.Request\n-import okhttp3.Response\n-import okhttp3.sse.internal.RealEventSource\n \n interface EventSource {\n   /** Returns the original request that initiated this event source. */\n@@ -40,40 +37,5 @@ interface EventSource {\n       request: Request,\n       listener: EventSourceListener,\n     ): EventSource\n-\n-    companion object {\n-      /**\n-       * Wraps a [Call.Factory] into [EventSource.Factory].\n-       */\n-      @JvmStatic\n-      @JvmName(\"create\")\n-      fun Call.Factory.asEventSourceFactory(): Factory =\n-        Factory { request, listener ->\n-          val actualRequest =\n-            if (request.header(\"Accept\") == null) {\n-              request.newBuilder().addHeader(\"Accept\", \"text/event-stream\").build()\n-            } else {\n-              request\n-            }\n-\n-          this.newCall(actualRequest).enqueueEventSource(listener)\n-        }\n-    }\n-  }\n-\n-  companion object {\n-    /**\n-     * Enqueues a [Call] and process it as [EventSource] with [listener].\n-     */\n-    @JvmStatic\n-    @JvmName(\"enqueue\")\n-    fun Call.enqueueEventSource(listener: EventSourceListener): EventSource = RealEventSource(this, listener).also(this::enqueue)\n-\n-    /**\n-     * Processes the existing response with [listener].\n-     */\n-    @JvmStatic\n-    @JvmName(\"process\")\n-    fun Response.processEventSource(listener: EventSourceListener) = RealEventSource(this, listener).processResponse(this)\n   }\n }\ndiff --git a/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSourceListener.kt b/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSourceListener.kt\nindex 1693a3bfe94d..e178adf8662d 100644\n--- a/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSourceListener.kt\n+++ b/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSourceListener.kt\n@@ -28,13 +28,6 @@ abstract class EventSourceListener {\n   ) {\n   }\n \n-  /**\n-   * Invoked when a new event has been sent to the client.\n-   *\n-   * @param id The `id` line of the event, might be null.\n-   * @param type The `event` line of the event, might be null.\n-   * @param data The `data` line of the event.\n-   */\n   open fun onEvent(\n     eventSource: EventSource,\n     id: String?,\n@@ -44,8 +37,6 @@ abstract class EventSourceListener {\n   }\n \n   /**\n-   * Invoked when the HTTP connection has been closed normally.\n-   *\n    * No further calls to this listener will be made.\n    */\n   open fun onClosed(eventSource: EventSource) {\ndiff --git a/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSources.kt b/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSources.kt\nindex 90c01842806c..0725aab820ff 100644\n--- a/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSources.kt\n+++ b/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSources.kt\n@@ -18,8 +18,7 @@ package okhttp3.sse\n import okhttp3.Call\n import okhttp3.OkHttpClient\n import okhttp3.Response\n-import okhttp3.sse.EventSource.Companion.processEventSource\n-import okhttp3.sse.EventSource.Factory.Companion.asEventSourceFactory\n+import okhttp3.sse.internal.RealEventSource\n \n object EventSources {\n   @Deprecated(\n@@ -27,32 +26,29 @@ object EventSources {\n     level = DeprecationLevel.HIDDEN,\n   )\n   @JvmStatic\n-  fun createFactory(client: OkHttpClient) = client.asEventSourceFactory()\n+  fun createFactory(client: OkHttpClient) = createFactory(client as Call.Factory)\n \n-  @Deprecated(\n-    message = \"Moved to extension function.\",\n-    replaceWith =\n-      ReplaceWith(\n-        expression = \"callFactory.asEventSourceFactory()\",\n-        imports = [\"okhttp3.sse.EventSource.Factory.Companion.asEventSourceFactory\"],\n-      ),\n-    level = DeprecationLevel.WARNING,\n-  )\n   @JvmStatic\n-  fun createFactory(callFactory: Call.Factory): EventSource.Factory = callFactory.asEventSourceFactory()\n+  fun createFactory(callFactory: Call.Factory): EventSource.Factory =\n+    EventSource.Factory { request, listener ->\n+      val actualRequest =\n+        if (request.header(\"Accept\") == null) {\n+          request.newBuilder().addHeader(\"Accept\", \"text/event-stream\").build()\n+        } else {\n+          request\n+        }\n+\n+      RealEventSource(actualRequest, listener).apply {\n+        connect(callFactory)\n+      }\n+    }\n \n-  @Deprecated(\n-    message = \"Moved to extension function.\",\n-    replaceWith =\n-      ReplaceWith(\n-        expression = \"response.processEventSource(listener)\",\n-        imports = [\"okhttp3.sse.EventSource.Companion.processEventSource\"],\n-      ),\n-    level = DeprecationLevel.WARNING,\n-  )\n   @JvmStatic\n   fun processResponse(\n     response: Response,\n     listener: EventSourceListener,\n-  ): Unit = response.processEventSource(listener)\n+  ) {\n+    val eventSource = RealEventSource(response.request, listener)\n+    eventSource.processResponse(response)\n+  }\n }\ndiff --git a/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/RealEventSource.kt b/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/RealEventSource.kt\nindex 3611fed83e7f..864eb19b66da 100644\n--- a/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/RealEventSource.kt\n+++ b/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/RealEventSource.kt\n@@ -25,19 +25,23 @@ import okhttp3.internal.stripBody\n import okhttp3.sse.EventSource\n import okhttp3.sse.EventSourceListener\n \n-internal class RealEventSource private constructor(\n-  private val call: Call?,\n+internal class RealEventSource(\n   private val request: Request,\n   private val listener: EventSourceListener,\n ) : EventSource,\n   ServerSentEventReader.Callback,\n   Callback {\n-  constructor(call: Call, listener: EventSourceListener) : this(call, call.request(), listener)\n-\n-  constructor(response: Response, listener: EventSourceListener) : this(null, response.request, listener)\n+  private var call: Call? = null\n \n   @Volatile private var canceled = false\n \n+  fun connect(callFactory: Call.Factory) {\n+    call =\n+      callFactory.newCall(request).apply {\n+        enqueue(this@RealEventSource)\n+      }\n+  }\n+\n   override fun onResponse(\n     call: Call,\n     response: Response,\n@@ -45,7 +49,7 @@ internal class RealEventSource private constructor(\n     processResponse(response)\n   }\n \n-  internal fun processResponse(response: Response) {\n+  fun processResponse(response: Response) {\n     response.use {\n       if (!response.isSuccessful) {\n         listener.onFailure(this, null, response)\ndiff --git a/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/ServerSentEventReader.kt b/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/ServerSentEventReader.kt\nindex a2a3fbb03540..c4933eb23378 100644\n--- a/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/ServerSentEventReader.kt\n+++ b/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/ServerSentEventReader.kt\n@@ -22,7 +22,7 @@ import okio.BufferedSource\n import okio.ByteString.Companion.encodeUtf8\n import okio.Options\n \n-internal class ServerSentEventReader(\n+class ServerSentEventReader(\n   private val source: BufferedSource,\n   private val callback: Callback,\n ) {\n@@ -119,7 +119,7 @@ internal class ServerSentEventReader(\n   }\n \n   companion object {\n-    private val options =\n+    val options =\n       Options.of(\n         // 0\n         \"\\r\\n\".encodeUtf8(),\n",
  "test_patch" : "diff --git a/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceFactoryTest.java b/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceFactoryTest.java\ndeleted file mode 100644\nindex 7fd51be47d06..000000000000\n--- a/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceFactoryTest.java\n+++ /dev/null\n@@ -1,84 +0,0 @@\n-/*\n- * Copyright (C) 2018 Square, Inc.\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package okhttp3.sse.internal;\n-\n-import mockwebserver3.MockResponse;\n-import mockwebserver3.MockWebServer;\n-import mockwebserver3.junit5.StartStop;\n-import okhttp3.OkHttpClient;\n-import okhttp3.Request;\n-import okhttp3.Response;\n-import okhttp3.sse.EventSource;\n-import okhttp3.sse.EventSourceListener;\n-import org.jetbrains.annotations.NotNull;\n-import org.jetbrains.annotations.Nullable;\n-import org.junit.jupiter.api.Test;\n-\n-import java.util.concurrent.CompletableFuture;\n-\n-import static org.junit.jupiter.api.Assertions.assertEquals;\n-\n-public class EventSourceFactoryTest {\n-\n-  @StartStop\n-  private final MockWebServer server = new MockWebServer();\n-\n-  @Test\n-  public void testEventSourceFactory() throws Exception {\n-    OkHttpClient client = new OkHttpClient();\n-    EventSource.Factory factory = EventSource.Factory.create(client);\n-    server.enqueue(\n-      new MockResponse.Builder()\n-        .body(\"data: hello\\n\\n\")\n-        .setHeader(\"content-type\", \"text/event-stream\")\n-        .build()\n-    );\n-    Request request = new Request.Builder().url(server.url(\"/\")).build();\n-    CompletableFuture<Void> future = new CompletableFuture<>();\n-    factory.newEventSource(request, new EventSourceListener() {\n-      @Override\n-      public void onOpen(@NotNull EventSource eventSource, @NotNull Response response) {\n-        try {\n-          assertEquals(\"text/event-stream\", response.request().header(\"Accept\"));\n-        } catch (Exception e) {\n-          future.completeExceptionally(e);\n-        }\n-      }\n-\n-      @Override\n-      public void onEvent(@NotNull EventSource eventSource, @Nullable String id, @Nullable String type, @NotNull String data) {\n-        try {\n-          assertEquals(\"hello\", data);\n-          future.complete(null);\n-        } catch (Exception e) {\n-          future.completeExceptionally(e);\n-        }\n-      }\n-\n-      @Override\n-      public void onClosed(@NotNull EventSource eventSource) {\n-        future.completeExceptionally(new IllegalStateException(\"closed\"));\n-      }\n-\n-      @Override\n-      public void onFailure(@NotNull EventSource eventSource, @Nullable Throwable t, @Nullable Response response) {\n-        future.completeExceptionally(t == null ? new NullPointerException() : t);\n-      }\n-    });\n-    future.get();\n-  }\n-\n-}\ndiff --git a/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceHttpTest.kt b/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceHttpTest.kt\nindex ed1304ad6577..4e714dae0968 100644\n--- a/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceHttpTest.kt\n+++ b/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceHttpTest.kt\n@@ -27,7 +27,7 @@ import okhttp3.OkHttpClientTestRule\n import okhttp3.RecordingEventListener\n import okhttp3.Request\n import okhttp3.sse.EventSource\n-import okhttp3.sse.EventSource.Factory.Companion.asEventSourceFactory\n+import okhttp3.sse.EventSources.createFactory\n import okhttp3.testing.PlatformRule\n import org.junit.jupiter.api.AfterEach\n import org.junit.jupiter.api.Tag\n@@ -319,7 +319,7 @@ class EventSourceHttpTest {\n       builder.header(\"Accept\", accept)\n     }\n     val request = builder.build()\n-    val factory = client.asEventSourceFactory()\n+    val factory = createFactory(client)\n     return factory.newEventSource(request, listener)\n   }\n }\ndiff --git a/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourcesHttpTest.kt b/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourcesHttpTest.kt\nindex 5e8c5a600250..5d50f8dbe8f3 100644\n--- a/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourcesHttpTest.kt\n+++ b/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourcesHttpTest.kt\n@@ -23,7 +23,7 @@ import mockwebserver3.junit5.StartStop\n import okhttp3.Headers\n import okhttp3.OkHttpClientTestRule\n import okhttp3.Request\n-import okhttp3.sse.EventSource.Companion.processEventSource\n+import okhttp3.sse.EventSources.processResponse\n import okhttp3.testing.PlatformRule\n import org.junit.jupiter.api.AfterEach\n import org.junit.jupiter.api.Tag\n@@ -65,7 +65,7 @@ class EventSourcesHttpTest {\n     )\n     val request = Request.Builder().url(server.url(\"/\")).build()\n     val response = client.newCall(request).execute()\n-    response.processEventSource(listener)\n+    processResponse(response, listener)\n     listener.assertOpen()\n     listener.assertEvent(null, null, \"hey\")\n     listener.assertClose()\n@@ -88,7 +88,7 @@ class EventSourcesHttpTest {\n     listener.enqueueCancel() // Will cancel in onOpen().\n     val request = Request.Builder().url(server.url(\"/\")).build()\n     val response = client.newCall(request).execute()\n-    response.processEventSource(listener)\n+    processResponse(response, listener)\n     listener.assertOpen()\n     listener.assertFailure(\"canceled\")\n   }\n@@ -113,19 +113,18 @@ class EventSourcesHttpTest {\n         headers = Headers.headersOf(\"content-type\", \"text/event-stream\"),\n       ),\n     )\n-    var request = Request.Builder().url(server.url(\"/\")).build()\n-    repeat(2) {\n-      val response = client.newCall(request).execute()\n \n-      if (response.code == 401) {\n-        assertThat(response.body.string()).isEqualTo(\"{\\\"error\\\":{\\\"message\\\":\\\"No auth credentials found\\\",\\\"code\\\":401}}\")\n-        request = request.newBuilder().header(\"Authorization\", \"XYZ\").build()\n-      } else {\n-        response.processEventSource(listener)\n-        listener.assertOpen()\n-        listener.assertEvent(null, null, \"hey\")\n-        listener.assertClose()\n-      }\n-    }\n+    val request1 = Request.Builder().url(server.url(\"/\")).build()\n+    val response1 = client.newCall(request1).execute()\n+    assertThat(response1.code).isEqualTo(401)\n+    assertThat(response1.body.string())\n+      .isEqualTo(\"{\\\"error\\\":{\\\"message\\\":\\\"No auth credentials found\\\",\\\"code\\\":401}}\")\n+\n+    val request2 = request1.newBuilder().header(\"Authorization\", \"XYZ\").build()\n+    val response2 = client.newCall(request2).execute()\n+    processResponse(response2, listener)\n+    listener.assertOpen()\n+    listener.assertEvent(null, null, \"hey\")\n+    listener.assertClose()\n   }\n }\n",
  "problem_statement" : "Revert \"refactor(SSE): move static functions to extensions (#9010)\"\n\nThis reverts commit 09fb9a448acf8b89dcffd1c36a1f012d258e7990.",
  "hints_text" : null,
  "created_at" : "Thu Oct 02 22:54:20 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "EventSourceFactoryTest" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew :okhttp-sse:test --tests \"EventSourceFactoryTest\"",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 9098,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-9044",
  "repo" : "square/okhttp",
  "base_commit" : "8fde16d0b7c04673d0b359db541227ba231e03be",
  "patch" : "diff --git a/gradle/libs.versions.toml b/gradle/libs.versions.toml\nindex bef7229997a1..f421addba583 100644\n--- a/gradle/libs.versions.toml\n+++ b/gradle/libs.versions.toml\n@@ -100,7 +100,7 @@ openjsse = \"org.openjsse:openjsse:1.1.14\"\n playservices-safetynet = \"com.google.android.gms:play-services-safetynet:18.1.0\"\n retrofit = { module = \"com.squareup.retrofit2:retrofit\", version.ref = \"retrofit\" }\n robolectric-android = \"org.robolectric:android-all:16-robolectric-13921718\"\n-robolectric = \"org.robolectric:robolectric:4.15.1\"\n+robolectric = \"org.robolectric:robolectric:4.16\"\n #noinspection UnusedVersionCatalogEntry\n signature-android-apilevel21 = \"net.sf.androidscents.signature:android-api-level-21:5.0.1_r2\"\n #noinspection UnusedVersionCatalogEntry\n",
  "test_patch" : "diff --git a/android-test/src/test/kotlin/okhttp/android/test/DisabledInitialiserTest.kt b/android-test/src/test/kotlin/okhttp/android/test/DisabledInitialiserTest.kt\nindex 844d119e66e9..09a08b8ab938 100644\n--- a/android-test/src/test/kotlin/okhttp/android/test/DisabledInitialiserTest.kt\n+++ b/android-test/src/test/kotlin/okhttp/android/test/DisabledInitialiserTest.kt\n@@ -35,7 +35,7 @@ import org.robolectric.annotation.Config\n \n @RunWith(RobolectricTestRunner::class)\n @Config(\n-  sdk = [21, 26, 30, 33, 35],\n+  sdk = [23, 26, 30, 33, 35],\n )\n class DisabledInitialiserTest {\n   @Before\ndiff --git a/android-test/src/test/kotlin/okhttp/android/test/RobolectricOkHttpClientTest.kt b/android-test/src/test/kotlin/okhttp/android/test/RobolectricOkHttpClientTest.kt\nindex bb48725f9bab..0bedf927cc34 100644\n--- a/android-test/src/test/kotlin/okhttp/android/test/RobolectricOkHttpClientTest.kt\n+++ b/android-test/src/test/kotlin/okhttp/android/test/RobolectricOkHttpClientTest.kt\n@@ -25,7 +25,7 @@ import org.robolectric.annotation.Config\n \n @RunWith(RobolectricTestRunner::class)\n @Config(\n-  sdk = [21, 26, 30, 33, 35],\n+  sdk = [23, 26, 30, 33, 35],\n )\n class RobolectricOkHttpClientTest : BaseOkHttpClientUnitTest() {\n   @Before\n",
  "problem_statement" : "Bump robolectric to 4.16",
  "hints_text" : null,
  "created_at" : "Sat Aug 30 15:36:47 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 9044,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-9031",
  "repo" : "square/okhttp",
  "base_commit" : "929a41c01cc6fb54628653a82fb70db95578bd99",
  "patch" : "diff --git a/android-test/README.md b/android-test/src/androidTest/README.md\nsimilarity index 100%\nrename from android-test/README.md\nrename to android-test/src/androidTest/README.md\n",
  "test_patch" : "diff --git a/okhttp-brotli/src/test/java/okhttp3/brotli/BrotliInterceptorTest.kt b/okhttp-brotli/src/test/java/okhttp3/brotli/BrotliInterceptorTest.kt\nindex 76cd2dc4a419..3a4d1e614ef8 100644\n--- a/okhttp-brotli/src/test/java/okhttp3/brotli/BrotliInterceptorTest.kt\n+++ b/okhttp-brotli/src/test/java/okhttp3/brotli/BrotliInterceptorTest.kt\n@@ -13,6 +13,10 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n+@file:Suppress(\n+  \"INVISIBLE_REFERENCE\",\n+)\n+\n package okhttp3.brotli\n \n import assertk.assertThat\n",
  "problem_statement" : "Move the Android test README under the androidTest directory\n\nAnd opt-in to compile without errors",
  "hints_text" : null,
  "created_at" : "Thu Aug 21 18:00:49 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 9031,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-9030",
  "repo" : "square/okhttp",
  "base_commit" : "d7851dedc0c66f46854da5d2838c803c6ba67a25",
  "patch" : "diff --git a/okhttp-logging-interceptor/src/main/kotlin/okhttp3/logging/HttpLoggingInterceptor.kt b/okhttp-logging-interceptor/src/main/kotlin/okhttp3/logging/HttpLoggingInterceptor.kt\nindex e290d475e6db..8fdb38a06f74 100644\n--- a/okhttp-logging-interceptor/src/main/kotlin/okhttp3/logging/HttpLoggingInterceptor.kt\n+++ b/okhttp-logging-interceptor/src/main/kotlin/okhttp3/logging/HttpLoggingInterceptor.kt\n@@ -247,7 +247,13 @@ class HttpLoggingInterceptor\n       try {\n         response = chain.proceed(request)\n       } catch (e: Exception) {\n-        logger.log(\"<-- HTTP FAILED: $e\")\n+        val tookMs = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startNs)\n+        logger.log(\n+          buildString {\n+            append(\"<-- HTTP FAILED: $e.\")\n+            append(\" ${redactUrl(request.url)} (${tookMs}ms)\")\n+          },\n+        )\n         throw e\n       }\n \n",
  "test_patch" : "diff --git a/android-test/src/test/kotlin/okhttp/android/test/AndroidLoggingTest.kt b/android-test/src/test/kotlin/okhttp/android/test/AndroidLoggingTest.kt\nindex 7ff13ae9a1f7..f08b3cd0ee9e 100644\n--- a/android-test/src/test/kotlin/okhttp/android/test/AndroidLoggingTest.kt\n+++ b/android-test/src/test/kotlin/okhttp/android/test/AndroidLoggingTest.kt\n@@ -60,9 +60,16 @@ class AndroidLoggingTest {\n \n     val logs = ShadowLog.getLogsForTag(AndroidPlatform.Tag)\n     assertThat(logs.map { it.type }).containsOnly(Log.INFO)\n-    assertThat(logs.map { it.msg }).containsExactly(\n+    assertThat(\n+      logs.map {\n+        it.msg.replace(\n+          \"\\\\d+\".toRegex(),\n+          \"\",\n+        )\n+      },\n+    ).containsExactly(\n       \"--> GET http://google.com/robots.txt\",\n-      \"<-- HTTP FAILED: java.net.UnknownHostException: shortcircuit\",\n+      \"<-- HTTP FAILED: java.net.UnknownHostException: shortcircuit. ${request.url} (ms)\",\n     )\n     // We should consider if these logs should retain Exceptions\n     assertThat(logs.last().throwable).isNull()\ndiff --git a/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.kt b/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.kt\nindex d5fb28163121..ffacefb132c9 100644\n--- a/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.kt\n+++ b/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.kt\n@@ -837,7 +837,7 @@ class HttpLoggingInterceptorTest {\n     }\n     applicationLogs\n       .assertLogEqual(\"--> GET $url\")\n-      .assertLogEqual(\"<-- HTTP FAILED: java.net.UnknownHostException: reason\")\n+      .assertLogMatch(Regex(\"\"\"<-- HTTP FAILED: java.net.UnknownHostException: reason. $url \\(\\d+ms\\)\"\"\"))\n       .assertNoMoreLogs()\n   }\n \n",
  "problem_statement" : "Print URLs in HttpLoggingInterceptor when the call fails\n\nWhen there's lots of messages, it is difficult to map the failure messages to the start messages without the url.",
  "hints_text" : null,
  "created_at" : "Thu Aug 21 15:25:42 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 9030,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-9010",
  "repo" : "square/okhttp",
  "base_commit" : "8b74eb4508853d0f8042258d8de9f714d7adc3c0",
  "patch" : "diff --git a/okhttp-sse/api/okhttp-sse.api b/okhttp-sse/api/okhttp-sse.api\nindex d1baa0735188..dbe1dae6fdee 100644\n--- a/okhttp-sse/api/okhttp-sse.api\n+++ b/okhttp-sse/api/okhttp-sse.api\n@@ -1,12 +1,26 @@\n public abstract interface class okhttp3/sse/EventSource {\n+\tpublic static final field Companion Lokhttp3/sse/EventSource$Companion;\n \tpublic abstract fun cancel ()V\n+\tpublic static fun enqueue (Lokhttp3/Call;Lokhttp3/sse/EventSourceListener;)Lokhttp3/sse/EventSource;\n+\tpublic static fun process (Lokhttp3/Response;Lokhttp3/sse/EventSourceListener;)V\n \tpublic abstract fun request ()Lokhttp3/Request;\n }\n \n+public final class okhttp3/sse/EventSource$Companion {\n+\tpublic final fun enqueue (Lokhttp3/Call;Lokhttp3/sse/EventSourceListener;)Lokhttp3/sse/EventSource;\n+\tpublic final fun process (Lokhttp3/Response;Lokhttp3/sse/EventSourceListener;)V\n+}\n+\n public abstract interface class okhttp3/sse/EventSource$Factory {\n+\tpublic static final field Companion Lokhttp3/sse/EventSource$Factory$Companion;\n+\tpublic static fun create (Lokhttp3/Call$Factory;)Lokhttp3/sse/EventSource$Factory;\n \tpublic abstract fun newEventSource (Lokhttp3/Request;Lokhttp3/sse/EventSourceListener;)Lokhttp3/sse/EventSource;\n }\n \n+public final class okhttp3/sse/EventSource$Factory$Companion {\n+\tpublic final fun create (Lokhttp3/Call$Factory;)Lokhttp3/sse/EventSource$Factory;\n+}\n+\n public abstract class okhttp3/sse/EventSourceListener {\n \tpublic fun <init> ()V\n \tpublic fun onClosed (Lokhttp3/sse/EventSource;)V\ndiff --git a/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSource.kt b/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSource.kt\nindex 8235f17b0843..06ddc37abf81 100644\n--- a/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSource.kt\n+++ b/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSource.kt\n@@ -15,7 +15,10 @@\n  */\n package okhttp3.sse\n \n+import okhttp3.Call\n import okhttp3.Request\n+import okhttp3.Response\n+import okhttp3.sse.internal.RealEventSource\n \n interface EventSource {\n   /** Returns the original request that initiated this event source. */\n@@ -37,5 +40,40 @@ interface EventSource {\n       request: Request,\n       listener: EventSourceListener,\n     ): EventSource\n+\n+    companion object {\n+      /**\n+       * Wraps a [Call.Factory] into [EventSource.Factory].\n+       */\n+      @JvmStatic\n+      @JvmName(\"create\")\n+      fun Call.Factory.asEventSourceFactory(): Factory =\n+        Factory { request, listener ->\n+          val actualRequest =\n+            if (request.header(\"Accept\") == null) {\n+              request.newBuilder().addHeader(\"Accept\", \"text/event-stream\").build()\n+            } else {\n+              request\n+            }\n+\n+          this.newCall(actualRequest).enqueueEventSource(listener)\n+        }\n+    }\n+  }\n+\n+  companion object {\n+    /**\n+     * Enqueues a [Call] and process it as [EventSource] with [listener].\n+     */\n+    @JvmStatic\n+    @JvmName(\"enqueue\")\n+    fun Call.enqueueEventSource(listener: EventSourceListener): EventSource = RealEventSource(this, listener).also(this::enqueue)\n+\n+    /**\n+     * Processes the existing response with [listener].\n+     */\n+    @JvmStatic\n+    @JvmName(\"process\")\n+    fun Response.processEventSource(listener: EventSourceListener) = RealEventSource(this, listener).processResponse(this)\n   }\n }\ndiff --git a/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSourceListener.kt b/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSourceListener.kt\nindex 8c595b178f4f..1693a3bfe94d 100644\n--- a/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSourceListener.kt\n+++ b/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSourceListener.kt\n@@ -29,7 +29,11 @@ abstract class EventSourceListener {\n   }\n \n   /**\n-   * TODO description.\n+   * Invoked when a new event has been sent to the client.\n+   *\n+   * @param id The `id` line of the event, might be null.\n+   * @param type The `event` line of the event, might be null.\n+   * @param data The `data` line of the event.\n    */\n   open fun onEvent(\n     eventSource: EventSource,\n@@ -40,7 +44,7 @@ abstract class EventSourceListener {\n   }\n \n   /**\n-   * TODO description.\n+   * Invoked when the HTTP connection has been closed normally.\n    *\n    * No further calls to this listener will be made.\n    */\ndiff --git a/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSources.kt b/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSources.kt\nindex 0725aab820ff..90c01842806c 100644\n--- a/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSources.kt\n+++ b/okhttp-sse/src/main/kotlin/okhttp3/sse/EventSources.kt\n@@ -18,7 +18,8 @@ package okhttp3.sse\n import okhttp3.Call\n import okhttp3.OkHttpClient\n import okhttp3.Response\n-import okhttp3.sse.internal.RealEventSource\n+import okhttp3.sse.EventSource.Companion.processEventSource\n+import okhttp3.sse.EventSource.Factory.Companion.asEventSourceFactory\n \n object EventSources {\n   @Deprecated(\n@@ -26,29 +27,32 @@ object EventSources {\n     level = DeprecationLevel.HIDDEN,\n   )\n   @JvmStatic\n-  fun createFactory(client: OkHttpClient) = createFactory(client as Call.Factory)\n+  fun createFactory(client: OkHttpClient) = client.asEventSourceFactory()\n \n+  @Deprecated(\n+    message = \"Moved to extension function.\",\n+    replaceWith =\n+      ReplaceWith(\n+        expression = \"callFactory.asEventSourceFactory()\",\n+        imports = [\"okhttp3.sse.EventSource.Factory.Companion.asEventSourceFactory\"],\n+      ),\n+    level = DeprecationLevel.WARNING,\n+  )\n   @JvmStatic\n-  fun createFactory(callFactory: Call.Factory): EventSource.Factory =\n-    EventSource.Factory { request, listener ->\n-      val actualRequest =\n-        if (request.header(\"Accept\") == null) {\n-          request.newBuilder().addHeader(\"Accept\", \"text/event-stream\").build()\n-        } else {\n-          request\n-        }\n-\n-      RealEventSource(actualRequest, listener).apply {\n-        connect(callFactory)\n-      }\n-    }\n+  fun createFactory(callFactory: Call.Factory): EventSource.Factory = callFactory.asEventSourceFactory()\n \n+  @Deprecated(\n+    message = \"Moved to extension function.\",\n+    replaceWith =\n+      ReplaceWith(\n+        expression = \"response.processEventSource(listener)\",\n+        imports = [\"okhttp3.sse.EventSource.Companion.processEventSource\"],\n+      ),\n+    level = DeprecationLevel.WARNING,\n+  )\n   @JvmStatic\n   fun processResponse(\n     response: Response,\n     listener: EventSourceListener,\n-  ) {\n-    val eventSource = RealEventSource(response.request, listener)\n-    eventSource.processResponse(response)\n-  }\n+  ): Unit = response.processEventSource(listener)\n }\ndiff --git a/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/RealEventSource.kt b/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/RealEventSource.kt\nindex 864eb19b66da..3611fed83e7f 100644\n--- a/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/RealEventSource.kt\n+++ b/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/RealEventSource.kt\n@@ -25,22 +25,18 @@ import okhttp3.internal.stripBody\n import okhttp3.sse.EventSource\n import okhttp3.sse.EventSourceListener\n \n-internal class RealEventSource(\n+internal class RealEventSource private constructor(\n+  private val call: Call?,\n   private val request: Request,\n   private val listener: EventSourceListener,\n ) : EventSource,\n   ServerSentEventReader.Callback,\n   Callback {\n-  private var call: Call? = null\n+  constructor(call: Call, listener: EventSourceListener) : this(call, call.request(), listener)\n \n-  @Volatile private var canceled = false\n+  constructor(response: Response, listener: EventSourceListener) : this(null, response.request, listener)\n \n-  fun connect(callFactory: Call.Factory) {\n-    call =\n-      callFactory.newCall(request).apply {\n-        enqueue(this@RealEventSource)\n-      }\n-  }\n+  @Volatile private var canceled = false\n \n   override fun onResponse(\n     call: Call,\n@@ -49,7 +45,7 @@ internal class RealEventSource(\n     processResponse(response)\n   }\n \n-  fun processResponse(response: Response) {\n+  internal fun processResponse(response: Response) {\n     response.use {\n       if (!response.isSuccessful) {\n         listener.onFailure(this, null, response)\ndiff --git a/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/ServerSentEventReader.kt b/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/ServerSentEventReader.kt\nindex c4933eb23378..a2a3fbb03540 100644\n--- a/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/ServerSentEventReader.kt\n+++ b/okhttp-sse/src/main/kotlin/okhttp3/sse/internal/ServerSentEventReader.kt\n@@ -22,7 +22,7 @@ import okio.BufferedSource\n import okio.ByteString.Companion.encodeUtf8\n import okio.Options\n \n-class ServerSentEventReader(\n+internal class ServerSentEventReader(\n   private val source: BufferedSource,\n   private val callback: Callback,\n ) {\n@@ -119,7 +119,7 @@ class ServerSentEventReader(\n   }\n \n   companion object {\n-    val options =\n+    private val options =\n       Options.of(\n         // 0\n         \"\\r\\n\".encodeUtf8(),\n",
  "test_patch" : "diff --git a/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceFactoryTest.java b/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceFactoryTest.java\nnew file mode 100644\nindex 000000000000..7fd51be47d06\n--- /dev/null\n+++ b/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceFactoryTest.java\n@@ -0,0 +1,84 @@\n+/*\n+ * Copyright (C) 2018 Square, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package okhttp3.sse.internal;\n+\n+import mockwebserver3.MockResponse;\n+import mockwebserver3.MockWebServer;\n+import mockwebserver3.junit5.StartStop;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Request;\n+import okhttp3.Response;\n+import okhttp3.sse.EventSource;\n+import okhttp3.sse.EventSourceListener;\n+import org.jetbrains.annotations.NotNull;\n+import org.jetbrains.annotations.Nullable;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class EventSourceFactoryTest {\n+\n+  @StartStop\n+  private final MockWebServer server = new MockWebServer();\n+\n+  @Test\n+  public void testEventSourceFactory() throws Exception {\n+    OkHttpClient client = new OkHttpClient();\n+    EventSource.Factory factory = EventSource.Factory.create(client);\n+    server.enqueue(\n+      new MockResponse.Builder()\n+        .body(\"data: hello\\n\\n\")\n+        .setHeader(\"content-type\", \"text/event-stream\")\n+        .build()\n+    );\n+    Request request = new Request.Builder().url(server.url(\"/\")).build();\n+    CompletableFuture<Void> future = new CompletableFuture<>();\n+    factory.newEventSource(request, new EventSourceListener() {\n+      @Override\n+      public void onOpen(@NotNull EventSource eventSource, @NotNull Response response) {\n+        try {\n+          assertEquals(\"text/event-stream\", response.request().header(\"Accept\"));\n+        } catch (Exception e) {\n+          future.completeExceptionally(e);\n+        }\n+      }\n+\n+      @Override\n+      public void onEvent(@NotNull EventSource eventSource, @Nullable String id, @Nullable String type, @NotNull String data) {\n+        try {\n+          assertEquals(\"hello\", data);\n+          future.complete(null);\n+        } catch (Exception e) {\n+          future.completeExceptionally(e);\n+        }\n+      }\n+\n+      @Override\n+      public void onClosed(@NotNull EventSource eventSource) {\n+        future.completeExceptionally(new IllegalStateException(\"closed\"));\n+      }\n+\n+      @Override\n+      public void onFailure(@NotNull EventSource eventSource, @Nullable Throwable t, @Nullable Response response) {\n+        future.completeExceptionally(t == null ? new NullPointerException() : t);\n+      }\n+    });\n+    future.get();\n+  }\n+\n+}\ndiff --git a/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceHttpTest.kt b/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceHttpTest.kt\nindex 75d2e67753e8..57499fc7a584 100644\n--- a/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceHttpTest.kt\n+++ b/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourceHttpTest.kt\n@@ -26,7 +26,7 @@ import okhttp3.OkHttpClientTestRule\n import okhttp3.RecordingEventListener\n import okhttp3.Request\n import okhttp3.sse.EventSource\n-import okhttp3.sse.EventSources.createFactory\n+import okhttp3.sse.EventSource.Factory.Companion.asEventSourceFactory\n import okhttp3.testing.PlatformRule\n import org.junit.jupiter.api.AfterEach\n import org.junit.jupiter.api.Tag\n@@ -268,7 +268,7 @@ class EventSourceHttpTest {\n       builder.header(\"Accept\", accept)\n     }\n     val request = builder.build()\n-    val factory = createFactory(client)\n+    val factory = client.asEventSourceFactory()\n     return factory.newEventSource(request, listener)\n   }\n }\ndiff --git a/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourcesHttpTest.kt b/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourcesHttpTest.kt\nindex 22573aed1711..fe85623590f4 100644\n--- a/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourcesHttpTest.kt\n+++ b/okhttp-sse/src/test/java/okhttp3/sse/internal/EventSourcesHttpTest.kt\n@@ -20,7 +20,7 @@ import mockwebserver3.MockWebServer\n import mockwebserver3.junit5.StartStop\n import okhttp3.OkHttpClientTestRule\n import okhttp3.Request\n-import okhttp3.sse.EventSources.processResponse\n+import okhttp3.sse.EventSource.Companion.processEventSource\n import okhttp3.testing.PlatformRule\n import org.junit.jupiter.api.AfterEach\n import org.junit.jupiter.api.Tag\n@@ -66,7 +66,7 @@ class EventSourcesHttpTest {\n         .url(server.url(\"/\"))\n         .build()\n     val response = client.newCall(request).execute()\n-    processResponse(response, listener)\n+    response.processEventSource(listener)\n     listener.assertOpen()\n     listener.assertEvent(null, null, \"hey\")\n     listener.assertClose()\n@@ -93,7 +93,7 @@ class EventSourcesHttpTest {\n         .url(server.url(\"/\"))\n         .build()\n     val response = client.newCall(request).execute()\n-    processResponse(response, listener)\n+    response.processEventSource(listener)\n     listener.assertOpen()\n     listener.assertFailure(\"canceled\")\n   }\n",
  "problem_statement" : "refactor(SSE): move static functions to extensions\n\nAlso added some comments for `TODO` blocks.\r\n\r\nfor https://github.com/square/retrofit/pull/4462",
  "hints_text" : null,
  "created_at" : "Mon Aug 11 17:51:37 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "EventSourceFactoryTest" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew :okhttp-sse:test --tests \"EventSourceFactoryTest\"",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 9010,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-8972",
  "repo" : "square/okhttp",
  "base_commit" : "7c7d404e3cde9b59294da427824ba2cea8f310e5",
  "patch" : "diff --git a/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt b/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt\nindex ece98492d3ee..46556c4f9577 100644\n--- a/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt\n+++ b/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt\n@@ -56,12 +56,12 @@ import mockwebserver3.SocketEffect.ShutdownConnection\n import mockwebserver3.SocketEffect.Stall\n import mockwebserver3.internal.DEFAULT_REQUEST_LINE_HTTP_1\n import mockwebserver3.internal.DEFAULT_REQUEST_LINE_HTTP_2\n+import mockwebserver3.internal.MockWebServerSocket\n import mockwebserver3.internal.RecordedRequest\n import mockwebserver3.internal.RequestLine\n import mockwebserver3.internal.ThrottledSink\n import mockwebserver3.internal.TriggerSink\n import mockwebserver3.internal.decodeRequestLine\n-import mockwebserver3.internal.sleepWhileOpen\n import okhttp3.Headers\n import okhttp3.Headers.Companion.headersOf\n import okhttp3.HttpUrl\n@@ -89,10 +89,7 @@ import okio.BufferedSource\n import okio.ByteString\n import okio.Sink\n import okio.Timeout\n-import okio.asOkioSocket\n import okio.buffer\n-import okio.sink\n-import okio.source\n \n /**\n  * A scriptable web server. Callers supply canned responses and the server replays them upon request\n@@ -392,7 +389,7 @@ public class MockWebServer : Closeable {\n         dispatchBookkeepingRequest(\n           connectionIndex = nextConnectionIndex++,\n           exchangeIndex = 0,\n-          socket = socket,\n+          socket = MockWebServerSocket(socket),\n         )\n         socket.close()\n       } else {\n@@ -449,33 +446,33 @@ public class MockWebServer : Closeable {\n       if (!processTunnelRequests()) return\n \n       val protocol: Protocol\n-      val socket: Socket\n+      val socket: MockWebServerSocket\n       when {\n         sslSocketFactory != null -> {\n           if (firstExchangePeek.failHandshake) {\n             dispatchBookkeepingRequest(\n               connectionIndex = connectionIndex,\n               exchangeIndex = nextExchangeIndex++,\n-              socket = raw,\n+              socket = MockWebServerSocket(raw),\n             )\n             processHandshakeFailure(raw)\n             return\n           }\n-          socket =\n+          val sslSocket =\n             sslSocketFactory!!.createSocket(\n               raw,\n               raw.inetAddress.hostAddress,\n               raw.port,\n               true,\n-            )\n-          val sslSocket = socket as SSLSocket\n+            ) as SSLSocket\n+          socket = MockWebServerSocket(sslSocket)\n           sslSocket.useClientMode = false\n           if (clientAuth == CLIENT_AUTH_REQUIRED) {\n             sslSocket.needClientAuth = true\n           } else if (clientAuth == CLIENT_AUTH_REQUESTED) {\n             sslSocket.wantClientAuth = true\n           }\n-          openClientSockets.add(socket)\n+          openClientSockets.add(sslSocket)\n \n           if (protocolNegotiationEnabled) {\n             Platform.get().configureTlsExtensions(sslSocket, null, protocols)\n@@ -502,7 +499,7 @@ public class MockWebServer : Closeable {\n               Protocol.H2_PRIOR_KNOWLEDGE in protocols -> Protocol.H2_PRIOR_KNOWLEDGE\n               else -> Protocol.HTTP_1_1\n             }\n-          socket = raw\n+          socket = MockWebServerSocket(raw)\n         }\n       }\n \n@@ -520,21 +517,18 @@ public class MockWebServer : Closeable {\n         val connection =\n           Http2Connection\n             .Builder(false, taskRunner)\n-            .socket(socket)\n+            .socket(socket.javaNetSocket)\n             .listener(http2SocketHandler)\n             .build()\n         connection.start()\n         openConnections.add(connection)\n-        openClientSockets.remove(socket)\n+        openClientSockets.remove(socket.javaNetSocket)\n         return\n       } else if (protocol !== Protocol.HTTP_1_1) {\n         throw AssertionError()\n       }\n \n-      val source = socket.source().buffer()\n-      val sink = socket.sink().buffer()\n-\n-      while (processOneRequest(socket, source, sink)) {\n+      while (processOneRequest(socket)) {\n       }\n \n       if (nextExchangeIndex == 0) {\n@@ -544,7 +538,7 @@ public class MockWebServer : Closeable {\n       }\n \n       socket.close()\n-      openClientSockets.remove(socket)\n+      openClientSockets.remove(socket.javaNetSocket)\n     }\n \n     /**\n@@ -555,10 +549,9 @@ public class MockWebServer : Closeable {\n     private fun processTunnelRequests(): Boolean {\n       if (!dispatcher.peek().inTunnel) return true // No tunnel requests.\n \n-      val source = raw.source().buffer()\n-      val sink = raw.sink().buffer()\n+      val socket = MockWebServerSocket(raw)\n       while (true) {\n-        val socketStillGood = processOneRequest(raw, source, sink)\n+        val socketStillGood = processOneRequest(socket)\n \n         // Clean up after the last exchange on a socket.\n         if (!socketStillGood) {\n@@ -576,16 +569,17 @@ public class MockWebServer : Closeable {\n      * on the socket.\n      */\n     @Throws(IOException::class, InterruptedException::class)\n-    private fun processOneRequest(\n-      socket: Socket,\n-      source: BufferedSource,\n-      sink: BufferedSink,\n-    ): Boolean {\n-      if (source.exhausted()) {\n+    private fun processOneRequest(socket: MockWebServerSocket): Boolean {\n+      if (socket.source.exhausted()) {\n         return false // No more requests on this socket.\n       }\n \n-      val request = readRequest(socket, source, sink, connectionIndex, nextExchangeIndex++)\n+      val request =\n+        readRequest(\n+          socket = socket,\n+          connectionIndex = connectionIndex,\n+          exchangeIndex = nextExchangeIndex++,\n+        )\n       atomicRequestCount.incrementAndGet()\n       requestQueue.add(request)\n \n@@ -608,13 +602,13 @@ public class MockWebServer : Closeable {\n         val responseWantsSocket = response.socketHandler != null\n         val responseWantsWebSocket = response.webSocketListener != null\n         if (requestWantsWebSocket && responseWantsWebSocket) {\n-          handleWebSocketUpgrade(socket, source, sink, request, response)\n+          handleWebSocketUpgrade(socket, request, response)\n           reuseSocket = false\n         } else if (requestWantsSocket && responseWantsSocket) {\n-          writeHttpResponse(socket, sink, response)\n+          writeHttpResponse(socket, response)\n           reuseSocket = false\n         } else {\n-          writeHttpResponse(socket, sink, response)\n+          writeHttpResponse(socket, response)\n         }\n \n         if (logger.isLoggable(Level.FINE)) {\n@@ -661,7 +655,7 @@ public class MockWebServer : Closeable {\n   private fun dispatchBookkeepingRequest(\n     connectionIndex: Int,\n     exchangeIndex: Int,\n-    socket: Socket,\n+    socket: MockWebServerSocket,\n     requestLine: RequestLine = DEFAULT_REQUEST_LINE_HTTP_1,\n   ) {\n     val request =\n@@ -683,9 +677,7 @@ public class MockWebServer : Closeable {\n   /** @param exchangeIndex the index of this request on this connection.*/\n   @Throws(IOException::class)\n   private fun readRequest(\n-    socket: Socket,\n-    source: BufferedSource,\n-    sink: BufferedSink,\n+    socket: MockWebServerSocket,\n     connectionIndex: Int,\n     exchangeIndex: Int,\n   ): RecordedRequest {\n@@ -699,14 +691,14 @@ public class MockWebServer : Closeable {\n     var failure: IOException? = null\n \n     try {\n-      val requestLineString = source.readUtf8LineStrict()\n+      val requestLineString = socket.source.readUtf8LineStrict()\n       if (requestLineString.isEmpty()) {\n         throw ProtocolException(\"no request because the stream is exhausted\")\n       }\n       request = decodeRequestLine(requestLineString)\n \n       while (true) {\n-        val header = source.readUtf8LineStrict()\n+        val header = socket.source.readUtf8LineStrict()\n         if (header.isEmpty()) {\n           break\n         }\n@@ -724,7 +716,7 @@ public class MockWebServer : Closeable {\n \n       val peek = dispatcher.peek()\n       for (response in peek.informationalResponses) {\n-        writeHttpResponse(socket, sink, response)\n+        writeHttpResponse(socket, response)\n       }\n \n       val requestBodySink =\n@@ -743,21 +735,25 @@ public class MockWebServer : Closeable {\n \n           contentLength != -1L -> {\n             hasBody = contentLength > 0L || HttpMethod.permitsRequestBody(request.method)\n-            requestBodySink.write(source, contentLength)\n+            requestBodySink.write(socket.source, contentLength)\n           }\n \n           chunked -> {\n             chunkSizes = mutableListOf()\n             hasBody = true\n             while (true) {\n-              val chunkSize = source.readUtf8LineStrict().trim().toInt(16)\n+              val chunkSize =\n+                socket.source\n+                  .readUtf8LineStrict()\n+                  .trim()\n+                  .toInt(16)\n               if (chunkSize == 0) {\n-                readEmptyLine(source)\n+                readEmptyLine(socket.source)\n                 break\n               }\n               chunkSizes.add(chunkSize)\n-              requestBodySink.write(source, chunkSize.toLong())\n-              readEmptyLine(source)\n+              requestBodySink.write(socket.source, chunkSize.toLong())\n+              readEmptyLine(socket.source)\n             }\n           }\n \n@@ -793,9 +789,7 @@ public class MockWebServer : Closeable {\n \n   @Throws(IOException::class)\n   private fun handleWebSocketUpgrade(\n-    socket: Socket,\n-    source: BufferedSource,\n-    sink: BufferedSink,\n+    socket: MockWebServerSocket,\n     request: RecordedRequest,\n     response: MockResponse,\n   ) {\n@@ -805,7 +799,7 @@ public class MockWebServer : Closeable {\n         .newBuilder()\n         .setHeader(\"Sec-WebSocket-Accept\", WebSocketProtocol.acceptHeader(key!!))\n         .build()\n-    writeHttpResponse(socket, sink, webSocketResponse)\n+    writeHttpResponse(socket, webSocketResponse)\n \n     // Adapt the request and response into our Request and Response domain model.\n     val scheme = if (request.handshake != null) \"https\" else \"http\"\n@@ -828,7 +822,7 @@ public class MockWebServer : Closeable {\n \n     val connectionClose = CountDownLatch(1)\n     val streams =\n-      object : RealWebSocket.Streams(false, source, sink) {\n+      object : RealWebSocket.Streams(false, socket.source, socket.sink) {\n         override fun close() = connectionClose.countDown()\n \n         override fun cancel() {\n@@ -855,31 +849,30 @@ public class MockWebServer : Closeable {\n       // Even if messages are no longer being read we need to wait for the connection close signal.\n       connectionClose.await()\n     } finally {\n-      source.closeQuietly()\n+      socket.source.closeQuietly()\n     }\n   }\n \n   @Throws(IOException::class)\n   private fun writeHttpResponse(\n-    socket: Socket,\n-    sink: BufferedSink,\n+    socket: MockWebServerSocket,\n     response: MockResponse,\n   ) {\n     socket.sleepWhileOpen(response.headersDelayNanos)\n-    sink.writeUtf8(response.status)\n-    sink.writeUtf8(\"\\r\\n\")\n+    socket.sink.writeUtf8(response.status)\n+    socket.sink.writeUtf8(\"\\r\\n\")\n \n-    writeHeaders(sink, response.headers)\n+    writeHeaders(socket.sink, response.headers)\n \n     if (response.socketHandler != null) {\n-      response.socketHandler.handle(socket.asOkioSocket())\n+      response.socketHandler.handle(socket)\n       return\n     }\n \n     val body = response.body ?: return\n     socket.sleepWhileOpen(response.bodyDelayNanos)\n     val responseBodySink =\n-      sink\n+      socket.sink\n         .withThrottlingAndSocketEffect(\n           policy = response,\n           socketEffect = response.onResponseBody,\n@@ -891,7 +884,7 @@ public class MockWebServer : Closeable {\n \n     socket.sleepWhileOpen(response.trailersDelayNanos)\n     if (\"chunked\".equals(response.headers[\"Transfer-Encoding\"], ignoreCase = true)) {\n-      writeHeaders(sink, response.trailers)\n+      writeHeaders(socket.sink, response.trailers)\n     }\n   }\n \n@@ -915,7 +908,7 @@ public class MockWebServer : Closeable {\n     policy: MockResponse,\n     socketEffect: SocketEffect?,\n     expectedByteCount: Long,\n-    socket: Socket,\n+    socket: MockWebServerSocket,\n     stream: Http2Stream? = null,\n   ): Sink {\n     var result: Sink = this\n@@ -952,7 +945,7 @@ public class MockWebServer : Closeable {\n   /** Returns true if processing this exchange is complete. */\n   private fun handleSocketEffect(\n     effect: SocketEffect?,\n-    socket: Socket,\n+    socket: MockWebServerSocket,\n     stream: Http2Stream? = null,\n   ): Boolean {\n     if (effect == null) return false\n@@ -1043,7 +1036,7 @@ public class MockWebServer : Closeable {\n   /** Processes HTTP requests layered over HTTP/2. */\n   private inner class Http2SocketHandler(\n     private val connectionIndex: Int,\n-    private val socket: Socket,\n+    private val socket: MockWebServerSocket,\n     private val protocol: Protocol,\n   ) : Http2Connection.Listener() {\n     private val nextExchangeIndex = AtomicInteger()\ndiff --git a/mockwebserver/src/main/kotlin/mockwebserver3/internal/MockWebServerSocket.kt b/mockwebserver/src/main/kotlin/mockwebserver3/internal/MockWebServerSocket.kt\nnew file mode 100644\nindex 000000000000..3df964c7d3d6\n--- /dev/null\n+++ b/mockwebserver/src/main/kotlin/mockwebserver3/internal/MockWebServerSocket.kt\n@@ -0,0 +1,99 @@\n+/*\n+ * Copyright (C) 2025 Square, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package mockwebserver3.internal\n+\n+import java.io.Closeable\n+import java.io.InterruptedIOException\n+import java.net.InetAddress\n+import java.net.Socket\n+import javax.net.ssl.SSLSocket\n+import okhttp3.Handshake\n+import okhttp3.Handshake.Companion.handshake\n+import okhttp3.internal.platform.Platform\n+import okio.BufferedSink\n+import okio.BufferedSource\n+import okio.asOkioSocket\n+import okio.buffer\n+\n+/**\n+ * Adapts a [java.net.Socket] to MockWebServer's needs.\n+ *\n+ * Note that [asOkioSocket] returns a socket that closes the underlying [java.net.Socket] when both\n+ * of its component streams are closed. This class takes advantage of that.\n+ */\n+internal class MockWebServerSocket(\n+  val javaNetSocket: Socket,\n+) : Closeable,\n+  okio.Socket {\n+  private val delegate = javaNetSocket.asOkioSocket()\n+\n+  override val source: BufferedSource = delegate.source.buffer()\n+  override val sink: BufferedSink = delegate.sink.buffer()\n+\n+  val localAddress: InetAddress\n+    get() = javaNetSocket.localAddress\n+\n+  val localPort: Int\n+    get() = javaNetSocket.localPort\n+\n+  val scheme: String\n+    get() =\n+      when (javaNetSocket) {\n+        is SSLSocket -> \"https\"\n+        else -> \"http\"\n+      }\n+\n+  val handshake: Handshake?\n+    get() = (javaNetSocket as? SSLSocket)?.session?.handshake()\n+\n+  val handshakeServerNames: List<String>\n+    get() =\n+      (javaNetSocket as? SSLSocket)\n+        ?.let { Platform.Companion.get().getHandshakeServerNames(it) }\n+        ?: listOf()\n+\n+  fun shutdownInput() {\n+    javaNetSocket.shutdownInput()\n+  }\n+\n+  fun shutdownOutput() {\n+    javaNetSocket.shutdownOutput()\n+  }\n+\n+  /** Sleeps [nanos], throwing if the socket is closed before that period has elapsed. */\n+  fun sleepWhileOpen(nanos: Long) {\n+    var ms = nanos / 1_000_000L\n+    val ns = nanos - (ms * 1_000_000L)\n+\n+    while (ms > 100) {\n+      Thread.sleep(100)\n+      if (javaNetSocket.isClosed) throw InterruptedIOException(\"socket closed\")\n+      ms -= 100L\n+    }\n+\n+    if (ms > 0L || ns > 0) {\n+      Thread.sleep(ms, ns.toInt())\n+    }\n+  }\n+\n+  override fun cancel() {\n+    delegate.cancel()\n+  }\n+\n+  override fun close() {\n+    javaNetSocket.close()\n+  }\n+}\ndiff --git a/mockwebserver/src/main/kotlin/mockwebserver3/internal/RecordedRequestFactory.kt b/mockwebserver/src/main/kotlin/mockwebserver3/internal/RecordedRequestFactory.kt\nindex 578c1f054dbb..8ae6aefa4434 100644\n--- a/mockwebserver/src/main/kotlin/mockwebserver3/internal/RecordedRequestFactory.kt\n+++ b/mockwebserver/src/main/kotlin/mockwebserver3/internal/RecordedRequestFactory.kt\n@@ -18,16 +18,11 @@ package mockwebserver3.internal\n import java.io.IOException\n import java.net.Inet6Address\n import java.net.ProtocolException\n-import java.net.Socket\n-import javax.net.ssl.SSLSocket\n import mockwebserver3.RecordedRequest\n-import okhttp3.Handshake\n-import okhttp3.Handshake.Companion.handshake\n import okhttp3.Headers\n import okhttp3.HttpUrl\n import okhttp3.HttpUrl.Companion.toHttpUrl\n import okhttp3.HttpUrl.Companion.toHttpUrlOrNull\n-import okhttp3.internal.platform.Platform\n import okio.ByteString\n \n internal fun RecordedRequest(\n@@ -38,23 +33,9 @@ internal fun RecordedRequest(\n   body: ByteString?,\n   connectionIndex: Int,\n   exchangeIndex: Int,\n-  socket: Socket,\n+  socket: MockWebServerSocket,\n   failure: IOException? = null,\n ): RecordedRequest {\n-  val handshake: Handshake?\n-  val handshakeServerNames: List<String>\n-  if (socket is SSLSocket) {\n-    try {\n-      handshake = socket.session.handshake()\n-      handshakeServerNames = Platform.get().getHandshakeServerNames(socket)\n-    } catch (e: IOException) {\n-      throw IllegalArgumentException(e)\n-    }\n-  } else {\n-    handshake = null\n-    handshakeServerNames = listOf()\n-  }\n-\n   val requestUrl =\n     when (requestLine.method) {\n       \"CONNECT\" -> \"${socket.scheme}://${requestLine.target}/\".toHttpUrlOrNull()\n@@ -66,8 +47,8 @@ internal fun RecordedRequest(\n   return RecordedRequest(\n     connectionIndex = connectionIndex,\n     exchangeIndex = exchangeIndex,\n-    handshake = handshake,\n-    handshakeServerNames = handshakeServerNames,\n+    handshake = socket.handshake,\n+    handshakeServerNames = socket.handshakeServerNames,\n     method = requestLine.method,\n     target = requestLine.target,\n     version = requestLine.version,\n@@ -120,15 +101,8 @@ internal val DEFAULT_REQUEST_LINE_HTTP_2 =\n     version = \"HTTP/2\",\n   )\n \n-private val Socket.scheme: String\n-  get() =\n-    when (this) {\n-      is SSLSocket -> \"https\"\n-      else -> \"http\"\n-    }\n-\n private fun requestUrl(\n-  socket: Socket,\n+  socket: MockWebServerSocket,\n   requestLine: RequestLine,\n   headers: Headers,\n ): HttpUrl {\ndiff --git a/mockwebserver/src/main/kotlin/mockwebserver3/internal/SleepNanos.kt b/mockwebserver/src/main/kotlin/mockwebserver3/internal/SleepNanos.kt\ndeleted file mode 100644\nindex a68d11a50a96..000000000000\n--- a/mockwebserver/src/main/kotlin/mockwebserver3/internal/SleepNanos.kt\n+++ /dev/null\n@@ -1,36 +0,0 @@\n-/*\n- * Copyright (c) 2022 Block, Inc.\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- *\n- */\n-package mockwebserver3.internal\n-\n-import java.io.InterruptedIOException\n-import java.net.Socket\n-\n-/** Sleeps [nanos], throwing if the socket is closed before that period has elapsed. */\n-internal fun Socket.sleepWhileOpen(nanos: Long) {\n-  var ms = nanos / 1_000_000L\n-  val ns = nanos - (ms * 1_000_000L)\n-\n-  while (ms > 100) {\n-    Thread.sleep(100)\n-    if (isClosed) throw InterruptedIOException(\"socket closed\")\n-    ms -= 100L\n-  }\n-\n-  if (ms > 0L || ns > 0) {\n-    Thread.sleep(ms, ns.toInt())\n-  }\n-}\ndiff --git a/mockwebserver/src/main/kotlin/mockwebserver3/internal/ThrottledSink.kt b/mockwebserver/src/main/kotlin/mockwebserver3/internal/ThrottledSink.kt\nindex 5b55e3c56094..d19a4e8e0fcd 100644\n--- a/mockwebserver/src/main/kotlin/mockwebserver3/internal/ThrottledSink.kt\n+++ b/mockwebserver/src/main/kotlin/mockwebserver3/internal/ThrottledSink.kt\n@@ -16,7 +16,6 @@\n  */\n package mockwebserver3.internal\n \n-import java.net.Socket\n import okio.Buffer\n import okio.Sink\n \n@@ -25,7 +24,7 @@ import okio.Sink\n  * this permits any interval to be used.\n  */\n internal class ThrottledSink(\n-  private val socket: Socket,\n+  private val socket: MockWebServerSocket,\n   private val delegate: Sink,\n   private val bytesPerPeriod: Long,\n   private val periodDelayNanos: Long,\n",
  "test_patch" : "diff --git a/mockwebserver/src/test/java/mockwebserver3/RecordedRequestTest.kt b/mockwebserver/src/test/java/mockwebserver3/RecordedRequestTest.kt\nindex 71748e3d4481..961bc2110003 100644\n--- a/mockwebserver/src/test/java/mockwebserver3/RecordedRequestTest.kt\n+++ b/mockwebserver/src/test/java/mockwebserver3/RecordedRequestTest.kt\n@@ -21,6 +21,7 @@ import assertk.assertions.isEqualTo\n import java.net.InetAddress\n import java.net.Socket\n import mockwebserver3.internal.DEFAULT_REQUEST_LINE_HTTP_1\n+import mockwebserver3.internal.MockWebServerSocket\n import mockwebserver3.internal.RecordedRequest\n import mockwebserver3.internal.decodeRequestLine\n import okhttp3.Headers\n@@ -35,9 +36,11 @@ class RecordedRequestTest {\n \n   @Test fun testIPv4() {\n     val socket =\n-      FakeSocket(\n-        localAddress = InetAddress.getByAddress(\"127.0.0.1\", byteArrayOf(127, 0, 0, 1)),\n-        localPort = 80,\n+      MockWebServerSocket(\n+        FakeSocket(\n+          localAddress = InetAddress.getByAddress(\"127.0.0.1\", byteArrayOf(127, 0, 0, 1)),\n+          localPort = 80,\n+        ),\n       )\n     val request = RecordedRequest(DEFAULT_REQUEST_LINE_HTTP_1, headers, emptyList(), 0, ByteString.EMPTY, 0, 0, socket)\n     assertThat(request.url.toString()).isEqualTo(\"http://127.0.0.1/\")\n@@ -45,9 +48,11 @@ class RecordedRequestTest {\n \n   @Test fun testAuthorityForm() {\n     val socket =\n-      FakeSocket(\n-        localAddress = InetAddress.getByAddress(\"127.0.0.1\", byteArrayOf(127, 0, 0, 1)),\n-        localPort = 80,\n+      MockWebServerSocket(\n+        FakeSocket(\n+          localAddress = InetAddress.getByAddress(\"127.0.0.1\", byteArrayOf(127, 0, 0, 1)),\n+          localPort = 80,\n+        ),\n       )\n     val requestLine = decodeRequestLine(\"CONNECT example.com:8080 HTTP/1.1\")\n     val request = RecordedRequest(requestLine, headers, emptyList(), 0, ByteString.EMPTY, 0, 0, socket)\n@@ -57,9 +62,11 @@ class RecordedRequestTest {\n \n   @Test fun testAbsoluteForm() {\n     val socket =\n-      FakeSocket(\n-        localAddress = InetAddress.getByAddress(\"127.0.0.1\", byteArrayOf(127, 0, 0, 1)),\n-        localPort = 80,\n+      MockWebServerSocket(\n+        FakeSocket(\n+          localAddress = InetAddress.getByAddress(\"127.0.0.1\", byteArrayOf(127, 0, 0, 1)),\n+          localPort = 80,\n+        ),\n       )\n     val requestLine = decodeRequestLine(\"GET http://example.com:8080/index.html HTTP/1.1\")\n     val request = RecordedRequest(requestLine, headers, emptyList(), 0, ByteString.EMPTY, 0, 0, socket)\n@@ -69,9 +76,11 @@ class RecordedRequestTest {\n \n   @Test fun testAsteriskForm() {\n     val socket =\n-      FakeSocket(\n-        localAddress = InetAddress.getByAddress(\"127.0.0.1\", byteArrayOf(127, 0, 0, 1)),\n-        localPort = 80,\n+      MockWebServerSocket(\n+        FakeSocket(\n+          localAddress = InetAddress.getByAddress(\"127.0.0.1\", byteArrayOf(127, 0, 0, 1)),\n+          localPort = 80,\n+        ),\n       )\n     val requestLine = decodeRequestLine(\"OPTIONS * HTTP/1.1\")\n     val request =\n@@ -91,13 +100,15 @@ class RecordedRequestTest {\n \n   @Test fun testIpv6() {\n     val socket =\n-      FakeSocket(\n-        localAddress =\n-          InetAddress.getByAddress(\n-            \"::1\",\n-            byteArrayOf(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1),\n-          ),\n-        localPort = 80,\n+      MockWebServerSocket(\n+        FakeSocket(\n+          localAddress =\n+            InetAddress.getByAddress(\n+              \"::1\",\n+              byteArrayOf(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1),\n+            ),\n+          localPort = 80,\n+        ),\n       )\n     val request = RecordedRequest(DEFAULT_REQUEST_LINE_HTTP_1, headers, emptyList(), 0, ByteString.EMPTY, 0, 0, socket)\n     assertThat(request.url.toString()).isEqualTo(\"http://[::1]/\")\n@@ -105,9 +116,11 @@ class RecordedRequestTest {\n \n   @Test fun testUsesLocal() {\n     val socket =\n-      FakeSocket(\n-        localAddress = InetAddress.getByAddress(\"127.0.0.1\", byteArrayOf(127, 0, 0, 1)),\n-        localPort = 80,\n+      MockWebServerSocket(\n+        FakeSocket(\n+          localAddress = InetAddress.getByAddress(\"127.0.0.1\", byteArrayOf(127, 0, 0, 1)),\n+          localPort = 80,\n+        ),\n       )\n     val request = RecordedRequest(DEFAULT_REQUEST_LINE_HTTP_1, headers, emptyList(), 0, ByteString.EMPTY, 0, 0, socket)\n     assertThat(request.url.toString()).isEqualTo(\"http://127.0.0.1/\")\n@@ -116,13 +129,15 @@ class RecordedRequestTest {\n   @Test fun testHostname() {\n     val headers = headersOf(\"Host\", \"host-from-header.com\")\n     val socket =\n-      FakeSocket(\n-        localAddress =\n-          InetAddress.getByAddress(\n-            \"host-from-address.com\",\n-            byteArrayOf(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1),\n-          ),\n-        localPort = 80,\n+      MockWebServerSocket(\n+        FakeSocket(\n+          localAddress =\n+            InetAddress.getByAddress(\n+              \"host-from-address.com\",\n+              byteArrayOf(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1),\n+            ),\n+          localPort = 80,\n+        ),\n       )\n     val request = RecordedRequest(DEFAULT_REQUEST_LINE_HTTP_1, headers, emptyList(), 0, ByteString.EMPTY, 0, 0, socket)\n     assertThat(request.url.toString()).isEqualTo(\"http://host-from-header.com/\")\n",
  "problem_statement" : "New MockWebServerSocket helper class\n\nThis is work towards switching to use okio.Socket\r\nas the implementation of web sockets.",
  "hints_text" : null,
  "created_at" : "Mon Jul 28 22:48:38 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 8972,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-8967",
  "repo" : "square/okhttp",
  "base_commit" : "88593f8c283370cc1357c2ee7afb24b028cde014",
  "patch" : "diff --git a/android-test/build.gradle.kts b/android-test/build.gradle.kts\nindex a40dd0b95f4e..8b97915e931b 100644\n--- a/android-test/build.gradle.kts\n+++ b/android-test/build.gradle.kts\n@@ -91,6 +91,7 @@ dependencies {\n   androidTestImplementation(projects.mockwebserver3Junit4)\n   androidTestImplementation(projects.mockwebserver3Junit5)\n   androidTestImplementation(projects.okhttpBrotli)\n+  androidTestImplementation(projects.okhttpZstd)\n   androidTestImplementation(projects.okhttpDnsoverhttps)\n   androidTestImplementation(projects.loggingInterceptor)\n   androidTestImplementation(projects.okhttpSse)\ndiff --git a/okhttp-brotli/api/okhttp-brotli.api b/okhttp-brotli/api/okhttp-brotli.api\nindex df2454bd2220..ce1008f0008b 100644\n--- a/okhttp-brotli/api/okhttp-brotli.api\n+++ b/okhttp-brotli/api/okhttp-brotli.api\n@@ -1,5 +1,8 @@\n-public final class okhttp3/brotli/BrotliInterceptor : okhttp3/Interceptor {\n+public final class okhttp3/brotli/BrotliInterceptor : okhttp3/CompressionInterceptor {\n \tpublic static final field INSTANCE Lokhttp3/brotli/BrotliInterceptor;\n-\tpublic fun intercept (Lokhttp3/Interceptor$Chain;)Lokhttp3/Response;\n+}\n+\n+public final class okhttp3/brotli/BrotliInterceptorKt {\n+\tpublic static final fun getBrotli ()Lokhttp3/CompressionInterceptor$DecompressionAlgorithm;\n }\n \ndiff --git a/okhttp-brotli/build.gradle.kts b/okhttp-brotli/build.gradle.kts\nindex f36c0a546867..15ecef065fb7 100644\n--- a/okhttp-brotli/build.gradle.kts\n+++ b/okhttp-brotli/build.gradle.kts\n@@ -15,7 +15,7 @@ project.applyOsgi(\n )\n \n dependencies {\n-  api(projects.okhttp)\n+  \"friendsApi\"(projects.okhttp)\n   api(libs.brotli.dec)\n \n   testImplementation(projects.okhttpTestingSupport)\ndiff --git a/okhttp-brotli/src/main/kotlin/okhttp3/brotli/BrotliInterceptor.kt b/okhttp-brotli/src/main/kotlin/okhttp3/brotli/BrotliInterceptor.kt\nindex 7d94ecea6043..fb0d28d2f4bb 100644\n--- a/okhttp-brotli/src/main/kotlin/okhttp3/brotli/BrotliInterceptor.kt\n+++ b/okhttp-brotli/src/main/kotlin/okhttp3/brotli/BrotliInterceptor.kt\n@@ -15,9 +15,11 @@\n  */\n package okhttp3.brotli\n \n-import okhttp3.Interceptor\n-import okhttp3.Response\n-import okhttp3.brotli.internal.uncompress\n+import okhttp3.CompressionInterceptor\n+import okio.BufferedSource\n+import okio.Source\n+import okio.source\n+import org.brotli.dec.BrotliInputStream\n \n /**\n  * Transparent Brotli response support.\n@@ -25,20 +27,11 @@ import okhttp3.brotli.internal.uncompress\n  * Adds Accept-Encoding: br to request and checks (and strips) for Content-Encoding: br in\n  * responses.  n.b. this replaces the transparent gzip compression in BridgeInterceptor.\n  */\n-object BrotliInterceptor : Interceptor {\n-  override fun intercept(chain: Interceptor.Chain): Response =\n-    if (chain.request().header(\"Accept-Encoding\") == null) {\n-      val request =\n-        chain\n-          .request()\n-          .newBuilder()\n-          .header(\"Accept-Encoding\", \"br,gzip\")\n-          .build()\n+object BrotliInterceptor : CompressionInterceptor(Brotli, Gzip)\n \n-      val response = chain.proceed(request)\n+val Brotli =\n+  object : CompressionInterceptor.DecompressionAlgorithm {\n+    override val encoding: String = \"br\"\n \n-      uncompress(response)\n-    } else {\n-      chain.proceed(chain.request())\n-    }\n-}\n+    override fun decompress(compressedSource: BufferedSource): Source = BrotliInputStream(compressedSource.inputStream()).source()\n+  }\ndiff --git a/okhttp-brotli/src/main/kotlin/okhttp3/brotli/internal/Uncompress.kt b/okhttp-brotli/src/main/kotlin/okhttp3/brotli/internal/Uncompress.kt\ndeleted file mode 100644\nindex c79d199b8eb3..000000000000\n--- a/okhttp-brotli/src/main/kotlin/okhttp3/brotli/internal/Uncompress.kt\n+++ /dev/null\n@@ -1,48 +0,0 @@\n-/*\n- * Copyright (C) 2020 Square, Inc.\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package okhttp3.brotli.internal\n-\n-import okhttp3.Response\n-import okhttp3.ResponseBody.Companion.asResponseBody\n-import okhttp3.internal.http.promisesBody\n-import okio.GzipSource\n-import okio.buffer\n-import okio.source\n-import org.brotli.dec.BrotliInputStream\n-\n-fun uncompress(response: Response): Response {\n-  if (!response.promisesBody()) {\n-    return response\n-  }\n-  val body = response.body\n-  val encoding = response.header(\"Content-Encoding\") ?: return response\n-\n-  val decompressedSource =\n-    when {\n-      encoding.equals(\"br\", ignoreCase = true) ->\n-        BrotliInputStream(body.source().inputStream()).source().buffer()\n-      encoding.equals(\"gzip\", ignoreCase = true) ->\n-        GzipSource(body.source()).buffer()\n-      else -> return response\n-    }\n-\n-  return response\n-    .newBuilder()\n-    .removeHeader(\"Content-Encoding\")\n-    .removeHeader(\"Content-Length\")\n-    .body(decompressedSource.asResponseBody(body.contentType(), -1))\n-    .build()\n-}\ndiff --git a/okhttp-zstd/api/okhttp-zstd.api b/okhttp-zstd/api/okhttp-zstd.api\nindex af53dcaff292..ca137ca540dd 100644\n--- a/okhttp-zstd/api/okhttp-zstd.api\n+++ b/okhttp-zstd/api/okhttp-zstd.api\n@@ -1,5 +1,4 @@\n-public final class okhttp3/zstd/ZstdInterceptor : okhttp3/Interceptor {\n-\tpublic static final field INSTANCE Lokhttp3/zstd/ZstdInterceptor;\n-\tpublic fun intercept (Lokhttp3/Interceptor$Chain;)Lokhttp3/Response;\n+public final class okhttp3/zstd/ZstdInterceptorKt {\n+\tpublic static final fun getZstd ()Lokhttp3/CompressionInterceptor$DecompressionAlgorithm;\n }\n \ndiff --git a/okhttp-zstd/build.gradle.kts b/okhttp-zstd/build.gradle.kts\nindex 359eb646affc..6f1fe7bd2897 100644\n--- a/okhttp-zstd/build.gradle.kts\n+++ b/okhttp-zstd/build.gradle.kts\n@@ -15,7 +15,7 @@ project.applyOsgi(\n )\n \n dependencies {\n-  api(projects.okhttp)\n+  \"friendsApi\"(projects.okhttp)\n   implementation(libs.zstd.kmp.okio)\n \n   testImplementation(projects.okhttpTestingSupport)\ndiff --git a/okhttp-zstd/src/main/kotlin/okhttp3/zstd/ZstdInterceptor.kt b/okhttp-zstd/src/main/kotlin/okhttp3/zstd/ZstdInterceptor.kt\nindex 82d3dd41ecb2..a9a8b1044f74 100644\n--- a/okhttp-zstd/src/main/kotlin/okhttp3/zstd/ZstdInterceptor.kt\n+++ b/okhttp-zstd/src/main/kotlin/okhttp3/zstd/ZstdInterceptor.kt\n@@ -16,60 +16,16 @@\n package okhttp3.zstd\n \n import com.squareup.zstd.okio.zstdDecompress\n-import okhttp3.Interceptor\n-import okhttp3.Response\n-import okhttp3.ResponseBody.Companion.asResponseBody\n-import okhttp3.internal.http.promisesBody\n-import okio.buffer\n-import okio.gzip\n+import okhttp3.CompressionInterceptor\n+import okio.BufferedSource\n+import okio.Source\n \n /**\n- * Transparent Zstandard response support.\n- *\n- * This must be installed as an application interceptor.\n- *\n- * Adds `Accept-Encoding: zstd,gzip` to request and checks (and strips) for `Content-Encoding: zstd`\n- * in responses.\n- *\n- * This replaces the transparent gzip compression in OkHttp.\n+ * Support for Zstandard encoding. Use via the [CompressionInterceptor].\n  */\n-object ZstdInterceptor : Interceptor {\n-  override fun intercept(chain: Interceptor.Chain): Response {\n-    val originalRequest = chain.request()\n-\n-    if (originalRequest.header(\"Accept-Encoding\") != null) {\n-      return chain.proceed(originalRequest)\n-    }\n-\n-    val request =\n-      originalRequest\n-        .newBuilder()\n-        .header(\"Accept-Encoding\", \"zstd,gzip\")\n-        .build()\n-\n-    return decompress(chain.proceed(request))\n-  }\n-\n-  internal fun decompress(response: Response): Response {\n-    if (!response.promisesBody()) {\n-      return response\n-    }\n-\n-    val body = response.body\n-    val encoding = response.header(\"Content-Encoding\") ?: return response\n-\n-    val decompressedSource =\n-      when {\n-        encoding.equals(\"zstd\", ignoreCase = true) -> body.source().zstdDecompress()\n-        encoding.equals(\"gzip\", ignoreCase = true) -> body.source().gzip()\n-        else -> return response\n-      }\n+val Zstd =\n+  object : CompressionInterceptor.DecompressionAlgorithm {\n+    override val encoding: String = \"zstd\"\n \n-    return response\n-      .newBuilder()\n-      .removeHeader(\"Content-Encoding\")\n-      .removeHeader(\"Content-Length\")\n-      .body(decompressedSource.buffer().asResponseBody(body.contentType(), -1L))\n-      .build()\n+    override fun decompress(compressedSource: BufferedSource): Source = compressedSource.zstdDecompress()\n   }\n-}\ndiff --git a/okhttp/api/android/okhttp.api b/okhttp/api/android/okhttp.api\nindex 7dccfa7f1e24..792bbbdd89c5 100644\n--- a/okhttp/api/android/okhttp.api\n+++ b/okhttp/api/android/okhttp.api\n@@ -326,6 +326,22 @@ public final class okhttp3/CipherSuite$Companion {\n \tpublic final fun forJavaName (Ljava/lang/String;)Lokhttp3/CipherSuite;\n }\n \n+public class okhttp3/CompressionInterceptor : okhttp3/Interceptor {\n+\tpublic static final field Companion Lokhttp3/CompressionInterceptor$Companion;\n+\tpublic fun <init> ([Lokhttp3/CompressionInterceptor$DecompressionAlgorithm;)V\n+\tpublic final fun getAlgorithms ()[Lokhttp3/CompressionInterceptor$DecompressionAlgorithm;\n+\tpublic fun intercept (Lokhttp3/Interceptor$Chain;)Lokhttp3/Response;\n+}\n+\n+public final class okhttp3/CompressionInterceptor$Companion {\n+\tpublic final fun getGzip ()Lokhttp3/CompressionInterceptor$DecompressionAlgorithm;\n+}\n+\n+public abstract interface class okhttp3/CompressionInterceptor$DecompressionAlgorithm {\n+\tpublic abstract fun decompress (Lokio/BufferedSource;)Lokio/Source;\n+\tpublic abstract fun getEncoding ()Ljava/lang/String;\n+}\n+\n public abstract interface class okhttp3/Connection {\n \tpublic abstract fun handshake ()Lokhttp3/Handshake;\n \tpublic abstract fun protocol ()Lokhttp3/Protocol;\ndiff --git a/okhttp/api/jvm/okhttp.api b/okhttp/api/jvm/okhttp.api\nindex e0c2d0e41b89..fbfd15aac4cc 100644\n--- a/okhttp/api/jvm/okhttp.api\n+++ b/okhttp/api/jvm/okhttp.api\n@@ -326,6 +326,22 @@ public final class okhttp3/CipherSuite$Companion {\n \tpublic final fun forJavaName (Ljava/lang/String;)Lokhttp3/CipherSuite;\n }\n \n+public class okhttp3/CompressionInterceptor : okhttp3/Interceptor {\n+\tpublic static final field Companion Lokhttp3/CompressionInterceptor$Companion;\n+\tpublic fun <init> ([Lokhttp3/CompressionInterceptor$DecompressionAlgorithm;)V\n+\tpublic final fun getAlgorithms ()[Lokhttp3/CompressionInterceptor$DecompressionAlgorithm;\n+\tpublic fun intercept (Lokhttp3/Interceptor$Chain;)Lokhttp3/Response;\n+}\n+\n+public final class okhttp3/CompressionInterceptor$Companion {\n+\tpublic final fun getGzip ()Lokhttp3/CompressionInterceptor$DecompressionAlgorithm;\n+}\n+\n+public abstract interface class okhttp3/CompressionInterceptor$DecompressionAlgorithm {\n+\tpublic abstract fun decompress (Lokio/BufferedSource;)Lokio/Source;\n+\tpublic abstract fun getEncoding ()Ljava/lang/String;\n+}\n+\n public abstract interface class okhttp3/Connection {\n \tpublic abstract fun handshake ()Lokhttp3/Handshake;\n \tpublic abstract fun protocol ()Lokhttp3/Protocol;\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/CompressionInterceptor.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/CompressionInterceptor.kt\nnew file mode 100644\nindex 000000000000..d52eb6124b0b\n--- /dev/null\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/CompressionInterceptor.kt\n@@ -0,0 +1,108 @@\n+/*\n+ * Copyright (c) 2025 Block, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package okhttp3\n+\n+import okhttp3.ResponseBody.Companion.asResponseBody\n+import okhttp3.internal.http.promisesBody\n+import okio.BufferedSource\n+import okio.GzipSource\n+import okio.Source\n+import okio.buffer\n+\n+/**\n+ * Transparent Compressed response support.\n+ *\n+ * The algorithm map will be turned into a heading such as \"Accept-Encoding: br, gzip\"\n+ *\n+ * If [algorithms] is empty this interceptor has no effect. To disable compression set\n+ * a specific \"Accept-Encoding: identity\" or similar.\n+ *\n+ * See https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Accept-Encoding\n+ */\n+open class CompressionInterceptor(\n+  vararg val algorithms: DecompressionAlgorithm,\n+) : Interceptor {\n+  internal val acceptEncoding =\n+    algorithms\n+      .map {\n+        it.encoding\n+      }.joinToString(separator = \", \")\n+\n+  override fun intercept(chain: Interceptor.Chain): Response =\n+    if (algorithms.isNotEmpty() && chain.request().header(\"Accept-Encoding\") == null) {\n+      val request =\n+        chain\n+          .request()\n+          .newBuilder()\n+          .header(\"Accept-Encoding\", acceptEncoding)\n+          .build()\n+\n+      val response = chain.proceed(request)\n+\n+      decompress(response)\n+    } else {\n+      chain.proceed(chain.request())\n+    }\n+\n+  /**\n+   * Returns a decompressed copy of the Response, typically via a streaming Source.\n+   * If no known decompression or the response is not compressed, returns the response unmodified.\n+   */\n+  internal fun decompress(response: Response): Response {\n+    if (!response.promisesBody()) {\n+      return response\n+    }\n+    val body = response.body\n+    val encoding = response.header(\"Content-Encoding\") ?: return response\n+\n+    val algorithm = lookupDecompressor(encoding) ?: return response\n+\n+    val decompressedSource = algorithm.decompress(body.source()).buffer()\n+\n+    return response\n+      .newBuilder()\n+      .removeHeader(\"Content-Encoding\")\n+      .removeHeader(\"Content-Length\")\n+      .body(decompressedSource.asResponseBody(body.contentType(), -1))\n+      .build()\n+  }\n+\n+  internal fun lookupDecompressor(encoding: String): DecompressionAlgorithm? =\n+    algorithms.find {\n+      it.encoding.equals(encoding, ignoreCase = true)\n+    }\n+\n+  /**\n+   * A decompression algorithm such as Gzip. Must provide the Accept-Encoding value and decompress a Source.\n+   */\n+  interface DecompressionAlgorithm {\n+    val encoding: String\n+\n+    fun decompress(compressedSource: BufferedSource): Source\n+  }\n+\n+  companion object {\n+    /**\n+     * Request \"gzip\" compression.\n+     */\n+    val Gzip =\n+      object : DecompressionAlgorithm {\n+        override val encoding: String = \"gzip\"\n+\n+        override fun decompress(compressedSource: BufferedSource): Source = GzipSource(compressedSource)\n+      }\n+  }\n+}\ndiff --git a/okhttp/src/commonTest/kotlin/okhttp3/CompressionInterceptorTest.kt b/okhttp/src/commonTest/kotlin/okhttp3/CompressionInterceptorTest.kt\nnew file mode 100644\nindex 000000000000..040bf35f4c81\n--- /dev/null\n+++ b/okhttp/src/commonTest/kotlin/okhttp3/CompressionInterceptorTest.kt\n@@ -0,0 +1,102 @@\n+/*\n+ * Copyright (c) 2025 Block, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package okhttp3\n+\n+import assertk.assertThat\n+import assertk.assertions.isEqualTo\n+import assertk.assertions.isNull\n+import okhttp3.CompressionInterceptor.Companion.Gzip\n+import okhttp3.HttpUrl.Companion.toHttpUrl\n+import okhttp3.ResponseBody.Companion.asResponseBody\n+import okhttp3.ResponseBody.Companion.toResponseBody\n+import okio.Buffer\n+import okio.ByteString.Companion.encodeUtf8\n+import okio.GzipSink\n+import okio.Source\n+import okio.buffer\n+import org.junit.jupiter.api.Test\n+import org.junit.jupiter.api.extension.RegisterExtension\n+\n+class CompressionInterceptorTest {\n+  @RegisterExtension\n+  val clientTestRule = OkHttpClientTestRule()\n+\n+  val source =\n+    Buffer().apply {\n+      write(\"Hello World\".encodeUtf8())\n+    } as Source\n+\n+  @Test\n+  fun emptyDoesntChangeRequestOrResponse() {\n+    val empty = CompressionInterceptor()\n+    val client =\n+      clientTestRule\n+        .newClientBuilder()\n+        .addInterceptor(empty)\n+        .addInterceptor { chain ->\n+          assertThat(chain.request().header(\"Accept-Encoding\")).isNull()\n+          Response\n+            .Builder()\n+            .request(chain.request())\n+            .protocol(Protocol.HTTP_1_1)\n+            .code(200)\n+            .message(\"OK\")\n+            .body(\"Hello\".toResponseBody())\n+            .header(\"Content-Encoding\", \"piedpiper\")\n+            .build()\n+        }.build()\n+\n+    val response = client.newCall(Request(\"https://google.com/robots.txt\".toHttpUrl())).execute()\n+\n+    assertThat(response.header(\"Content-Encoding\")).isEqualTo(\"piedpiper\")\n+    assertThat(response.body.string()).isEqualTo(\"Hello\")\n+  }\n+\n+  @Test\n+  fun gzipThroughCall() {\n+    val gzip = CompressionInterceptor(Gzip)\n+    val client =\n+      clientTestRule\n+        .newClientBuilder()\n+        .addInterceptor(gzip)\n+        .addInterceptor { chain ->\n+          assertThat(chain.request().header(\"Accept-Encoding\")).isEqualTo(\"gzip\")\n+\n+          Response\n+            .Builder()\n+            .request(chain.request())\n+            .protocol(Protocol.HTTP_1_1)\n+            .code(200)\n+            .message(\"OK\")\n+            .body(gzip(\"Hello\").asResponseBody())\n+            .header(\"Content-Encoding\", \"gzip\")\n+            .build()\n+        }.build()\n+\n+    val response = client.newCall(Request(\"https://google.com/robots.txt\".toHttpUrl())).execute()\n+\n+    assertThat(response.header(\"Content-Encoding\")).isNull()\n+    assertThat(response.body.string()).isEqualTo(\"Hello\")\n+  }\n+\n+  private fun gzip(data: String): Buffer {\n+    val result = Buffer()\n+    val sink = GzipSink(result).buffer()\n+    sink.writeUtf8(data)\n+    sink.close()\n+    return result\n+  }\n+}\n",
  "test_patch" : "diff --git a/android-test/src/androidTest/java/okhttp/android/test/OkHttpTest.kt b/android-test/src/androidTest/java/okhttp/android/test/OkHttpTest.kt\nindex 28702a41faaa..079532c93c90 100644\n--- a/android-test/src/androidTest/java/okhttp/android/test/OkHttpTest.kt\n+++ b/android-test/src/androidTest/java/okhttp/android/test/OkHttpTest.kt\n@@ -48,6 +48,8 @@ import mockwebserver3.junit5.StartStop\n import okhttp3.Cache\n import okhttp3.Call\n import okhttp3.CertificatePinner\n+import okhttp3.CompressionInterceptor\n+import okhttp3.CompressionInterceptor.Companion.Gzip\n import okhttp3.Connection\n import okhttp3.DelegatingSSLSocket\n import okhttp3.DelegatingSSLSocketFactory\n@@ -60,6 +62,7 @@ import okhttp3.Protocol\n import okhttp3.RecordingEventListener\n import okhttp3.Request\n import okhttp3.TlsVersion\n+import okhttp3.brotli.Brotli\n import okhttp3.dnsoverhttps.DnsOverHttps\n import okhttp3.internal.concurrent.TaskRunner\n import okhttp3.internal.http2.Http2\n@@ -71,6 +74,7 @@ import okhttp3.logging.LoggingEventListener\n import okhttp3.testing.PlatformRule\n import okhttp3.tls.HandshakeCertificates\n import okhttp3.tls.internal.TlsUtil.localhost\n+import okhttp3.zstd.Zstd\n import okio.ByteString.Companion.toByteString\n import org.bouncycastle.jce.provider.BouncyCastleProvider\n import org.bouncycastle.jsse.provider.BouncyCastleJsseProvider\n@@ -108,7 +112,11 @@ class OkHttpTest {\n       logger = Logger.getLogger(OkHttpTest::class.java.name)\n     }\n \n-  private var client: OkHttpClient = clientTestRule.newClient()\n+  private var client: OkHttpClient =\n+    clientTestRule\n+      .newClientBuilder()\n+      .addInterceptor(CompressionInterceptor(Zstd, Brotli, Gzip))\n+      .build()\n \n   private val moshi =\n     Moshi\ndiff --git a/okhttp-brotli/src/test/java/okhttp3/brotli/BrotliInterceptorTest.kt b/okhttp-brotli/src/test/java/okhttp3/brotli/BrotliInterceptorTest.kt\nindex b0338ed7303c..e3bc79086c32 100644\n--- a/okhttp-brotli/src/test/java/okhttp3/brotli/BrotliInterceptorTest.kt\n+++ b/okhttp-brotli/src/test/java/okhttp3/brotli/BrotliInterceptorTest.kt\n@@ -27,7 +27,6 @@ import okhttp3.Protocol\n import okhttp3.Request\n import okhttp3.Response\n import okhttp3.ResponseBody.Companion.toResponseBody\n-import okhttp3.brotli.internal.uncompress\n import okio.ByteString\n import okio.ByteString.Companion.EMPTY\n import okio.ByteString.Companion.decodeHex\n@@ -48,7 +47,7 @@ class BrotliInterceptorTest {\n         header(\"Content-Encoding\", \"br\")\n       }\n \n-    val uncompressed = uncompress(response)\n+    val uncompressed = BrotliInterceptor.decompress(response)\n \n     val responseString = uncompressed.body.string()\n     assertThat(responseString).contains(\"\\\"brotli\\\": true,\")\n@@ -69,7 +68,7 @@ class BrotliInterceptorTest {\n         header(\"Content-Encoding\", \"gzip\")\n       }\n \n-    val uncompressed = uncompress(response)\n+    val uncompressed = BrotliInterceptor.decompress(response)\n \n     val responseString = uncompressed.body.string()\n     assertThat(responseString).contains(\"\\\"gzipped\\\": true,\")\n@@ -80,7 +79,7 @@ class BrotliInterceptorTest {\n   fun testNoUncompress() {\n     val response = response(\"https://httpbin.org/brotli\", \"XXXX\".encodeUtf8())\n \n-    val same = uncompress(response)\n+    val same = BrotliInterceptor.decompress(response)\n \n     val responseString = same.body.string()\n     assertThat(responseString).isEqualTo(\"XXXX\")\n@@ -94,7 +93,7 @@ class BrotliInterceptorTest {\n       }\n \n     assertFailsWith<IOException> {\n-      val failingResponse = uncompress(response)\n+      val failingResponse = BrotliInterceptor.decompress(response)\n       failingResponse.body.string()\n     }.also { ioe ->\n       assertThat(ioe).hasMessage(\"Brotli stream decoding failed\")\n@@ -111,7 +110,7 @@ class BrotliInterceptorTest {\n         message(\"NO CONTENT\")\n       }\n \n-    val same = uncompress(response)\n+    val same = BrotliInterceptor.decompress(response)\n \n     val responseString = same.body.string()\n     assertThat(responseString).isEmpty()\ndiff --git a/okhttp-zstd/src/test/java/okhttp3/zstd/ZstdInterceptorTest.kt b/okhttp-zstd/src/test/java/okhttp3/zstd/ZstdInterceptorTest.kt\nindex 52092bc1c6d4..8da4ab79148d 100644\n--- a/okhttp-zstd/src/test/java/okhttp3/zstd/ZstdInterceptorTest.kt\n+++ b/okhttp-zstd/src/test/java/okhttp3/zstd/ZstdInterceptorTest.kt\n@@ -23,12 +23,12 @@ import assertk.assertions.isNull\n import com.squareup.zstd.okio.zstdCompress\n import java.io.IOException\n import kotlin.test.assertFailsWith\n+import okhttp3.CompressionInterceptor\n import okhttp3.MediaType.Companion.toMediaType\n import okhttp3.Protocol\n import okhttp3.Request\n import okhttp3.Response\n import okhttp3.ResponseBody.Companion.toResponseBody\n-import okhttp3.zstd.ZstdInterceptor.decompress\n import okio.Buffer\n import okio.ByteString\n import okio.ByteString.Companion.EMPTY\n@@ -39,6 +39,8 @@ import okio.gzip\n import org.junit.jupiter.api.Test\n \n class ZstdInterceptorTest {\n+  val zstdInterceptor = CompressionInterceptor(Zstd, CompressionInterceptor.Gzip)\n+\n   @Test\n   fun testDecompressZstd() {\n     val s = \"hello zstd world\".encodeUtf8().zstdCompress()\n@@ -48,7 +50,7 @@ class ZstdInterceptorTest {\n         header(\"Content-Encoding\", \"zstd\")\n       }\n \n-    val decompressed = decompress(response)\n+    val decompressed = zstdInterceptor.decompress(response)\n     assertThat(decompressed.header(\"Content-Encoding\")).isNull()\n \n     val responseString = decompressed.body.string()\n@@ -64,7 +66,7 @@ class ZstdInterceptorTest {\n         header(\"Content-Encoding\", \"gzip\")\n       }\n \n-    val decompressed = decompress(response)\n+    val decompressed = zstdInterceptor.decompress(response)\n     assertThat(decompressed.header(\"Content-Encoding\")).isNull()\n \n     val responseString = decompressed.body.string()\n@@ -77,7 +79,7 @@ class ZstdInterceptorTest {\n \n     val response = response(\"https://example.com/\", s)\n \n-    val decompressed = decompress(response)\n+    val decompressed = zstdInterceptor.decompress(response)\n     assertThat(decompressed.header(\"Content-Encoding\")).isNull()\n \n     val responseString = decompressed.body.string()\n@@ -93,7 +95,7 @@ class ZstdInterceptorTest {\n         header(\"Content-Encoding\", \"deflate\")\n       }\n \n-    val decompressed = decompress(response)\n+    val decompressed = zstdInterceptor.decompress(response)\n     assertThat(decompressed.header(\"Content-Encoding\")).isEqualTo(\"deflate\")\n \n     val responseString = decompressed.body.string()\n@@ -109,7 +111,7 @@ class ZstdInterceptorTest {\n         header(\"Content-Encoding\", \"zstd\")\n       }\n \n-    val decompressed = decompress(response)\n+    val decompressed = zstdInterceptor.decompress(response)\n     assertThat(decompressed.header(\"Content-Encoding\")).isNull()\n \n     assertFailsWith<IOException> {\n@@ -128,7 +130,7 @@ class ZstdInterceptorTest {\n         message(\"NO CONTENT\")\n       }\n \n-    val same = decompress(response)\n+    val same = zstdInterceptor.decompress(response)\n \n     val responseString = same.body.string()\n     assertThat(responseString).isEmpty()\ndiff --git a/okhttp-zstd/src/test/java/okhttp3/zstd/ZstdTestMain.kt b/okhttp-zstd/src/test/java/okhttp3/zstd/ZstdTestMain.kt\nindex 4d7388f0c85e..c8c3a351ecf3 100644\n--- a/okhttp-zstd/src/test/java/okhttp3/zstd/ZstdTestMain.kt\n+++ b/okhttp-zstd/src/test/java/okhttp3/zstd/ZstdTestMain.kt\n@@ -15,6 +15,7 @@\n  */\n package okhttp3.zstd\n \n+import okhttp3.CompressionInterceptor\n import okhttp3.OkHttpClient\n import okhttp3.Request\n \n@@ -22,7 +23,7 @@ fun main() {\n   val client =\n     OkHttpClient\n       .Builder()\n-      .addInterceptor(ZstdInterceptor)\n+      .addInterceptor(CompressionInterceptor(Zstd))\n       .build()\n \n   sendRequest(\"https://developers.facebook.com/docs/\", client)\n",
  "problem_statement" : "Add reusable CompressionInterceptor\n\nRefactor Brotli and Zstd to use this, but also\r\nallow trivial configuration of zstd,br,gzip.\r\n\r\n",
  "hints_text" : null,
  "created_at" : "Sun Jul 27 14:49:06 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 8967,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-8965",
  "repo" : "square/okhttp",
  "base_commit" : "0984bc3fc5d41c4814b953194d10e5ee77361f7d",
  "patch" : "diff --git a/README.md b/README.md\nindex 19227d71a059..a39b2272aed9 100644\n--- a/README.md\n+++ b/README.md\n@@ -96,6 +96,9 @@ Requirements\n \n OkHttp works on Android 5.0+ (API level 21+) and Java 8+.\n \n+On Android, OkHttp uses [AndroidX Startup][androidx_startup]. If you disable the initializer in the manifest,\n+then apps are responsible for calling `OkHttp.initialize(applicationContext)` in `Application.onCreate`.\n+\n OkHttp depends on [Okio][okio] for high-performance I/O and the [Kotlin standard library][kotlin]. Both are small libraries with strong backward-compatibility.\n \n We highly recommend you keep OkHttp up-to-date. As with auto-updating web browsers, staying current\n@@ -231,6 +234,7 @@ limitations under the License.\n ```\n \n  [GraalVM]: https://www.graalvm.org/\n+ [androidx_startup]: https://developer.android.com/jetpack/androidx/releases/startup\n  [bom]: https://docs.gradle.org/6.2/userguide/platforms.html#sub:bom_import\n  [changelog]: https://square.github.io/okhttp/changelog/\n  [conscrypt]: https://github.com/google/conscrypt/\ndiff --git a/okhttp/api/android/okhttp.api b/okhttp/api/android/okhttp.api\nindex b1ee782b62ac..95d5a033b322 100644\n--- a/okhttp/api/android/okhttp.api\n+++ b/okhttp/api/android/okhttp.api\n@@ -837,6 +837,7 @@ public final class okhttp3/MultipartReader$Part : java/io/Closeable {\n public final class okhttp3/OkHttp {\n \tpublic static final field INSTANCE Lokhttp3/OkHttp;\n \tpublic static final field VERSION Ljava/lang/String;\n+\tpublic final fun initialize (Landroid/content/Context;)V\n }\n \n public class okhttp3/OkHttpClient : okhttp3/Call$Factory, okhttp3/WebSocket$Factory {\ndiff --git a/okhttp/src/androidMain/kotlin/okhttp3/OkHttp.android.kt b/okhttp/src/androidMain/kotlin/okhttp3/OkHttp.android.kt\nnew file mode 100644\nindex 000000000000..7e4e2c147e55\n--- /dev/null\n+++ b/okhttp/src/androidMain/kotlin/okhttp3/OkHttp.android.kt\n@@ -0,0 +1,39 @@\n+/*\n+ * Copyright (C) 2025 Block, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package okhttp3\n+\n+import android.content.Context\n+import okhttp3.internal.CONST_VERSION\n+import okhttp3.internal.platform.PlatformRegistry\n+\n+actual object OkHttp {\n+  @JvmField\n+  actual val VERSION: String = CONST_VERSION\n+\n+  /**\n+   * Configure the ApplicationContext. Not needed unless the AndroidX Startup [Initializer] is disabled, or running\n+   * a robolectric test.\n+   *\n+   * The functionality that will fail without a valid Context is primarily Cookies and URL Domain handling, but\n+   * may expand in the future.\n+   */\n+  fun initialize(applicationContext: Context) {\n+    if (PlatformRegistry.applicationContext == null) {\n+      // Make sure we aren't using an Activity or Service Context\n+      PlatformRegistry.applicationContext = applicationContext.applicationContext\n+    }\n+  }\n+}\ndiff --git a/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/PlatformRegistry.kt b/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/PlatformRegistry.kt\nindex 0ce20d2e6e1e..4c912f5e61c1 100644\n--- a/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/PlatformRegistry.kt\n+++ b/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/PlatformRegistry.kt\n@@ -29,8 +29,7 @@ actual object PlatformRegistry {\n         ?: AndroidPlatform.buildIfSupported()\n     if (androidPlatform != null) return androidPlatform\n \n-    // If the API version is 0, assume this is the Android artifact, but running on the JVM.\n-    // Robolectric?\n+    // If the API version is 0, assume this is the Android artifact, but running on the JVM without Robolectric.\n     if (Build.VERSION.SDK_INT == 0) {\n       return Jdk9Platform.buildIfSupported()\n         ?: Platform()\ndiff --git a/okhttp/src/androidMain/kotlin/okhttp3/internal/publicsuffix/AssetPublicSuffixList.kt b/okhttp/src/androidMain/kotlin/okhttp3/internal/publicsuffix/AssetPublicSuffixList.kt\nindex 8fa98c914e16..8fb06bda3f0d 100644\n--- a/okhttp/src/androidMain/kotlin/okhttp3/internal/publicsuffix/AssetPublicSuffixList.kt\n+++ b/okhttp/src/androidMain/kotlin/okhttp3/internal/publicsuffix/AssetPublicSuffixList.kt\n@@ -15,6 +15,7 @@\n  */\n package okhttp3.internal.publicsuffix\n \n+import android.os.Build\n import java.io.IOException\n import okhttp3.internal.platform.PlatformRegistry\n import okio.Source\n@@ -24,8 +25,24 @@ internal class AssetPublicSuffixList(\n   override val path: String = PUBLIC_SUFFIX_RESOURCE,\n ) : BasePublicSuffixList() {\n   override fun listSource(): Source {\n-    val assets =\n-      PlatformRegistry.applicationContext?.assets ?: throw IOException(\"Platform applicationContext not initialized\")\n+    val assets = PlatformRegistry.applicationContext?.assets\n+\n+    if (assets == null) {\n+      if (Build.FINGERPRINT == null) {\n+        throw IOException(\n+          \"Platform applicationContext not initialized. \" +\n+            \"Possibly running Android unit test without Robolectric. \" +\n+            \"Android tests should run with Robolectric \" +\n+            \"and call OkHttp.initialize before test\",\n+        )\n+      } else {\n+        throw IOException(\n+          \"Platform applicationContext not initialized. \" +\n+            \"Startup Initializer possibly disabled, \" +\n+            \"call OkHttp.initialize before test.\",\n+        )\n+      }\n+    }\n \n     return assets.open(path).source()\n   }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/OkHttp.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/OkHttp.kt\nindex ee1ebde864f6..4d6c96cda796 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/OkHttp.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/OkHttp.kt\n@@ -15,12 +15,9 @@\n  */\n package okhttp3\n \n-import kotlin.jvm.JvmField\n-import okhttp3.internal.CONST_VERSION\n-\n-object OkHttp {\n+expect object OkHttp {\n   /**\n-   * This is a string like \"4.5.0-RC1\", \"4.5.0\", or \"4.6.0-SNAPSHOT\" indicating the version of\n+   * This is a string like \"5.0.0\", \"5.0.0-alpha.762\", or \"5.3.0-SNAPSHOT\" indicating the version of\n    * OkHttp in the current runtime. Use this to include the OkHttp version in custom `User-Agent`\n    * headers.\n    *\n@@ -34,7 +31,6 @@ object OkHttp {\n    *\n    * [semver]: https://semver.org\n    */\n-  @Suppress(\"MayBeConstant\") // Non-const so external callers get the runtime version.\n-  @JvmField\n-  val VERSION = CONST_VERSION\n+  @JvmStatic\n+  val VERSION: String\n }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/platform/Platform.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/platform/Platform.kt\nindex 3687728c7f3e..564640d1c995 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/platform/Platform.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/platform/Platform.kt\n@@ -33,6 +33,7 @@ import javax.net.ssl.TrustManagerFactory\n import javax.net.ssl.X509TrustManager\n import okhttp3.OkHttpClient\n import okhttp3.Protocol\n+import okhttp3.internal.publicsuffix.PublicSuffixDatabase\n import okhttp3.internal.readFieldOrNull\n import okhttp3.internal.tls.BasicCertificateChainCleaner\n import okhttp3.internal.tls.BasicTrustRootIndex\n@@ -212,6 +213,7 @@ open class Platform {\n \n     fun resetForTests(platform: Platform = findPlatform()) {\n       this.platform = platform\n+      PublicSuffixDatabase.resetForTests()\n     }\n \n     fun alpnProtocolNames(protocols: List<Protocol>) = protocols.filter { it != Protocol.HTTP_1_0 }.map { it.toString() }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/publicsuffix/BasePublicSuffixList.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/publicsuffix/BasePublicSuffixList.kt\nindex 6410af966c64..2927ced9df1b 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/publicsuffix/BasePublicSuffixList.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/publicsuffix/BasePublicSuffixList.kt\n@@ -19,7 +19,6 @@ import java.io.IOException\n import java.io.InterruptedIOException\n import java.util.concurrent.CountDownLatch\n import java.util.concurrent.atomic.AtomicBoolean\n-import okhttp3.internal.platform.Platform\n import okio.ByteString\n import okio.Source\n import okio.buffer\n@@ -38,6 +37,8 @@ internal abstract class BasePublicSuffixList : PublicSuffixList {\n   override lateinit var bytes: ByteString\n   override lateinit var exceptionBytes: ByteString\n \n+  private var readFailure: IOException? = null\n+\n   @Throws(IOException::class)\n   private fun readTheList() {\n     var publicSuffixListBytes: ByteString?\n@@ -74,9 +75,11 @@ internal abstract class BasePublicSuffixList : PublicSuffixList {\n       }\n     }\n \n-    check(::bytes.isInitialized) {\n+    if (!::bytes.isInitialized) {\n       // May have failed with an IOException\n-      \"Unable to load $path resource.\"\n+      throw IllegalStateException(\"Unable to load $path resource.\").apply {\n+        initCause(readFailure)\n+      }\n     }\n   }\n \n@@ -98,7 +101,7 @@ internal abstract class BasePublicSuffixList : PublicSuffixList {\n           Thread.interrupted() // Temporarily clear the interrupted state.\n           interrupted = true\n         } catch (e: IOException) {\n-          Platform.get().log(\"Failed to read public suffix list\", Platform.Companion.WARN, e)\n+          readFailure = e\n           return\n         }\n       }\ndiff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/publicsuffix/PublicSuffixDatabase.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/publicsuffix/PublicSuffixDatabase.kt\nindex 9afe84be997f..878509234ae7 100644\n--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/publicsuffix/PublicSuffixDatabase.kt\n+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/publicsuffix/PublicSuffixDatabase.kt\n@@ -153,7 +153,7 @@ class PublicSuffixDatabase internal constructor(\n \n     private const val EXCEPTION_MARKER = '!'\n \n-    private val instance = PublicSuffixDatabase(PublicSuffixList.Default)\n+    private var instance = PublicSuffixDatabase(PublicSuffixList.Default)\n \n     fun get(): PublicSuffixDatabase = instance\n \n@@ -244,5 +244,9 @@ class PublicSuffixDatabase internal constructor(\n       }\n       return match\n     }\n+\n+    internal fun resetForTests() {\n+      instance = PublicSuffixDatabase(PublicSuffixList.Default)\n+    }\n   }\n }\ndiff --git a/okhttp/src/commonTest/kotlin/okhttp3/OkHttpTest.kt b/okhttp/src/commonTest/kotlin/okhttp3/OkHttpTest.kt\nnew file mode 100644\nindex 000000000000..4ee51b500100\n--- /dev/null\n+++ b/okhttp/src/commonTest/kotlin/okhttp3/OkHttpTest.kt\n@@ -0,0 +1,12 @@\n+package okhttp3\n+\n+import assertk.assertThat\n+import assertk.assertions.matches\n+import org.junit.jupiter.api.Test\n+\n+class OkHttpTest {\n+  @Test\n+  fun testVersion() {\n+    assertThat(OkHttp.VERSION).matches(Regex(\"[0-9]+\\\\.[0-9]+\\\\.[0-9]+(-.+)?\"))\n+  }\n+}\ndiff --git a/okhttp/src/jvmTest/kotlin/okhttp3/OkHttpTest.kt b/okhttp/src/jvmMain/kotlin/okhttp3/OkHttp.jvm.kt\nsimilarity index 69%\nrename from okhttp/src/jvmTest/kotlin/okhttp3/OkHttpTest.kt\nrename to okhttp/src/jvmMain/kotlin/okhttp3/OkHttp.jvm.kt\nindex 066991c94949..f6becc1badc9 100644\n--- a/okhttp/src/jvmTest/kotlin/okhttp3/OkHttpTest.kt\n+++ b/okhttp/src/jvmMain/kotlin/okhttp3/OkHttp.jvm.kt\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (C) 2020 Square, Inc.\n+ * Copyright (C) 2025 Block, Inc.\n  *\n  * Licensed under the Apache License, Version 2.0 (the \"License\");\n  * you may not use this file except in compliance with the License.\n@@ -15,13 +15,9 @@\n  */\n package okhttp3\n \n-import assertk.assertThat\n-import assertk.assertions.matches\n-import org.junit.jupiter.api.Test\n+import okhttp3.internal.CONST_VERSION\n \n-class OkHttpTest {\n-  @Test\n-  fun testVersion() {\n-    assertThat(OkHttp.VERSION).matches(Regex(\"[0-9]+\\\\.[0-9]+\\\\.[0-9]+(-.+)?\"))\n-  }\n+actual object OkHttp {\n+  @JvmField\n+  actual val VERSION: String = CONST_VERSION\n }\n",
  "test_patch" : "diff --git a/android-test/src/test/kotlin/okhttp/android/test/DisabledInitialiserTest.kt b/android-test/src/test/kotlin/okhttp/android/test/DisabledInitialiserTest.kt\nnew file mode 100644\nindex 000000000000..844d119e66e9\n--- /dev/null\n+++ b/android-test/src/test/kotlin/okhttp/android/test/DisabledInitialiserTest.kt\n@@ -0,0 +1,72 @@\n+/*\n+ * Copyright (c) 2025 Block, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package okhttp.android.test\n+\n+import assertk.all\n+import assertk.assertFailure\n+import assertk.assertions.cause\n+import assertk.assertions.hasClass\n+import assertk.assertions.hasMessage\n+import assertk.assertions.isNotNull\n+import java.io.IOException\n+import okhttp3.HttpUrl.Companion.toHttpUrl\n+import okhttp3.internal.platform.Platform\n+import okhttp3.internal.platform.PlatformRegistry\n+import org.junit.AfterClass\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+import org.robolectric.RobolectricTestRunner\n+import org.robolectric.annotation.Config\n+\n+@RunWith(RobolectricTestRunner::class)\n+@Config(\n+  sdk = [21, 26, 30, 33, 35],\n+)\n+class DisabledInitialiserTest {\n+  @Before\n+  fun setContext() {\n+    // Ensure we aren't succeeding because of another test\n+    Platform.resetForTests()\n+    PlatformRegistry.applicationContext = null\n+  }\n+\n+  @Test\n+  fun testWithoutContext() {\n+    val httpUrl = \"https://www.google.co.uk\".toHttpUrl()\n+    assertFailure { httpUrl.topPrivateDomain() }.all {\n+      hasMessage(\"Unable to load PublicSuffixDatabase.list resource.\")\n+      cause().isNotNull().all {\n+        hasMessage(\n+          \"Platform applicationContext not initialized. \" +\n+            \"Startup Initializer possibly disabled, \" +\n+            \"call OkHttp.initialize before test.\",\n+        )\n+        hasClass<IOException>()\n+      }\n+    }\n+  }\n+\n+  companion object {\n+    @AfterClass\n+    @JvmStatic\n+    fun resetContext() {\n+      // Ensure we don't make other tests fail\n+      Platform.resetForTests()\n+    }\n+  }\n+}\ndiff --git a/android-test/src/test/kotlin/okhttp/android/test/NonRobolectricOkHttpClientTest.kt b/android-test/src/test/kotlin/okhttp/android/test/NonRobolectricOkHttpClientTest.kt\nindex 8a70cdf94d90..2a41f79da8c1 100644\n--- a/android-test/src/test/kotlin/okhttp/android/test/NonRobolectricOkHttpClientTest.kt\n+++ b/android-test/src/test/kotlin/okhttp/android/test/NonRobolectricOkHttpClientTest.kt\n@@ -16,7 +16,13 @@\n  */\n package okhttp.android.test\n \n-import org.junit.Ignore\n+import assertk.all\n+import assertk.assertFailure\n+import assertk.assertions.cause\n+import assertk.assertions.hasClass\n+import assertk.assertions.hasMessage\n+import assertk.assertions.isNotNull\n+import java.io.IOException\n import org.junit.Test\n import org.junit.runner.RunWith\n import org.junit.runners.JUnit4\n@@ -26,9 +32,19 @@ import org.junit.runners.JUnit4\n  */\n @RunWith(JUnit4::class)\n class NonRobolectricOkHttpClientTest : BaseOkHttpClientUnitTest() {\n-  @Ignore(\"Requires an Asset\")\n   @Test\n   override fun testPublicSuffixDb() {\n-    super.testPublicSuffixDb()\n+    assertFailure { super.testPublicSuffixDb() }.all {\n+      hasMessage(\"Unable to load PublicSuffixDatabase.list resource.\")\n+      cause().isNotNull().all {\n+        hasMessage(\n+          \"Platform applicationContext not initialized. \" +\n+            \"Possibly running Android unit test without Robolectric. \" +\n+            \"Android tests should run with Robolectric \" +\n+            \"and call OkHttp.initialize before test\",\n+        )\n+        hasClass<IOException>()\n+      }\n+    }\n   }\n }\ndiff --git a/android-test/src/test/kotlin/okhttp/android/test/RobolectricOkHttpClientTest.kt b/android-test/src/test/kotlin/okhttp/android/test/RobolectricOkHttpClientTest.kt\nindex f871d1bf1d9a..bb48725f9bab 100644\n--- a/android-test/src/test/kotlin/okhttp/android/test/RobolectricOkHttpClientTest.kt\n+++ b/android-test/src/test/kotlin/okhttp/android/test/RobolectricOkHttpClientTest.kt\n@@ -17,7 +17,7 @@\n package okhttp.android.test\n \n import androidx.test.core.app.ApplicationProvider\n-import okhttp3.internal.platform.PlatformRegistry\n+import okhttp3.OkHttp\n import org.junit.Before\n import org.junit.runner.RunWith\n import org.robolectric.RobolectricTestRunner\n@@ -32,6 +32,6 @@ class RobolectricOkHttpClientTest : BaseOkHttpClientUnitTest() {\n   fun setContext() {\n     // This is awkward because Robolectric won't run our initializers and we don't want test deps\n     // https://github.com/robolectric/robolectric/issues/8461\n-    PlatformRegistry.applicationContext = ApplicationProvider.getApplicationContext()\n+    OkHttp.initialize(ApplicationProvider.getApplicationContext())\n   }\n }\n",
  "problem_statement" : "Add Android OkHttp.initialize(Context)\n\nA fallback for apps Disabling ze AndroidX Startup Initializer.",
  "hints_text" : null,
  "created_at" : "Tue Jul 22 23:11:59 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 8965,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-8954",
  "repo" : "square/okhttp",
  "base_commit" : "0ef99d67c4701834f91467f00f26123494c33366",
  "patch" : "diff --git a/android-test/build.gradle.kts b/android-test/build.gradle.kts\nindex 93d3737fbc82..a40dd0b95f4e 100644\n--- a/android-test/build.gradle.kts\n+++ b/android-test/build.gradle.kts\n@@ -41,6 +41,7 @@ android {\n \n   testOptions {\n     targetSdk = 34\n+    unitTests.isIncludeAndroidResources = true\n   }\n \n   kotlinOptions {\ndiff --git a/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/android/AndroidLog.kt b/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/android/AndroidLog.kt\nindex 3fa95ec04538..64c530096ce8 100644\n--- a/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/android/AndroidLog.kt\n+++ b/okhttp/src/androidMain/kotlin/okhttp3/internal/platform/android/AndroidLog.kt\n@@ -109,7 +109,7 @@ object AndroidLog {\n         enableLogging(logger, tag)\n       }\n     } catch (re: RuntimeException) {\n-      // Possibly running android unit test without robolectric\n+      System.err.println(\"Possibly running android unit test without robolectric\")\n       re.printStackTrace()\n     }\n   }\n",
  "test_patch" : "diff --git a/android-test/src/test/kotlin/okhttp/android/test/BaseOkHttpClientUnitTest.kt b/android-test/src/test/kotlin/okhttp/android/test/BaseOkHttpClientUnitTest.kt\nindex e26c3a431b8a..f8fe7a28aa4b 100644\n--- a/android-test/src/test/kotlin/okhttp/android/test/BaseOkHttpClientUnitTest.kt\n+++ b/android-test/src/test/kotlin/okhttp/android/test/BaseOkHttpClientUnitTest.kt\n@@ -70,6 +70,12 @@ abstract class BaseOkHttpClientUnitTest {\n     }\n   }\n \n+  @Test\n+  open fun testPublicSuffixDb() {\n+    val httpUrl = \"https://www.google.co.uk\".toHttpUrl()\n+    assertThat(httpUrl.topPrivateDomain()).isEqualTo(\"google.co.uk\")\n+  }\n+\n   private fun assumeNetwork() {\n     try {\n       InetAddress.getByName(\"www.google.com\")\ndiff --git a/android-test/src/test/kotlin/okhttp/android/test/NonRobolectricOkHttpClientTest.kt b/android-test/src/test/kotlin/okhttp/android/test/NonRobolectricOkHttpClientTest.kt\nindex 4e9771a6e6e5..8a70cdf94d90 100644\n--- a/android-test/src/test/kotlin/okhttp/android/test/NonRobolectricOkHttpClientTest.kt\n+++ b/android-test/src/test/kotlin/okhttp/android/test/NonRobolectricOkHttpClientTest.kt\n@@ -16,6 +16,8 @@\n  */\n package okhttp.android.test\n \n+import org.junit.Ignore\n+import org.junit.Test\n import org.junit.runner.RunWith\n import org.junit.runners.JUnit4\n \n@@ -23,4 +25,10 @@ import org.junit.runners.JUnit4\n  * Android test running with only stubs.\n  */\n @RunWith(JUnit4::class)\n-class NonRobolectricOkHttpClientTest : BaseOkHttpClientUnitTest()\n+class NonRobolectricOkHttpClientTest : BaseOkHttpClientUnitTest() {\n+  @Ignore(\"Requires an Asset\")\n+  @Test\n+  override fun testPublicSuffixDb() {\n+    super.testPublicSuffixDb()\n+  }\n+}\ndiff --git a/android-test/src/test/kotlin/okhttp/android/test/RobolectricOkHttpClientTest.kt b/android-test/src/test/kotlin/okhttp/android/test/RobolectricOkHttpClientTest.kt\nindex cbd3c8ee10be..f871d1bf1d9a 100644\n--- a/android-test/src/test/kotlin/okhttp/android/test/RobolectricOkHttpClientTest.kt\n+++ b/android-test/src/test/kotlin/okhttp/android/test/RobolectricOkHttpClientTest.kt\n@@ -16,6 +16,9 @@\n  */\n package okhttp.android.test\n \n+import androidx.test.core.app.ApplicationProvider\n+import okhttp3.internal.platform.PlatformRegistry\n+import org.junit.Before\n import org.junit.runner.RunWith\n import org.robolectric.RobolectricTestRunner\n import org.robolectric.annotation.Config\n@@ -24,4 +27,11 @@ import org.robolectric.annotation.Config\n @Config(\n   sdk = [21, 26, 30, 33, 35],\n )\n-class RobolectricOkHttpClientTest : BaseOkHttpClientUnitTest()\n+class RobolectricOkHttpClientTest : BaseOkHttpClientUnitTest() {\n+  @Before\n+  fun setContext() {\n+    // This is awkward because Robolectric won't run our initializers and we don't want test deps\n+    // https://github.com/robolectric/robolectric/issues/8461\n+    PlatformRegistry.applicationContext = ApplicationProvider.getApplicationContext()\n+  }\n+}\n",
  "problem_statement" : "Add test demonstrating topPrivateDomain on Robolectric\n\nPart of an analysis of https://github.com/square/okhttp/issues/8927\r\n\r\nWorking with includeTestResources and use of an internal method `PlatformRegistry.applicationContext`",
  "hints_text" : null,
  "created_at" : "Sat Jul 19 20:43:37 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 8954,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-8947",
  "repo" : "square/okhttp",
  "base_commit" : "d51c17721071eca8cb49f351fd98d49d80837bd1",
  "patch" : "diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml\nindex 1f5371e0b93b..0c7a711b7d82 100644\n--- a/.github/workflows/build.yml\n+++ b/.github/workflows/build.yml\n@@ -475,7 +475,7 @@ jobs:\n       - uses: graalvm/setup-graalvm@v1\n         with:\n           distribution: 'graalvm'\n-          java-version: 21\n+          java-version: 24\n           github-token: ${{ secrets.GITHUB_TOKEN }}\n           cache: 'gradle'\n           native-image-job-reports: true\ndiff --git a/build.gradle.kts b/build.gradle.kts\nindex e00b81e380c4..4475baabeb2f 100644\n--- a/build.gradle.kts\n+++ b/build.gradle.kts\n@@ -175,8 +175,8 @@ subprojects {\n \n   val javaVersionSetting =\n     if (testJavaVersion > 8 && (project.name == \"okcurl\" || project.name == \"native-image-tests\")) {\n-      // Depends on native-image-tools which is 11+, but avoids on Java 8 tests\n-      \"11\"\n+      // Depends on native-image-tools which is 17+, but avoids on Java 8 tests\n+      \"17\"\n     } else {\n       \"1.8\"\n     }\ndiff --git a/gradle/libs.versions.toml b/gradle/libs.versions.toml\nindex c6c9fd12900e..8a1bab927272 100644\n--- a/gradle/libs.versions.toml\n+++ b/gradle/libs.versions.toml\n@@ -51,7 +51,7 @@ gradlePlugin-binaryCompatibilityValidator = \"org.jetbrains.kotlinx.binary-compat\n gradlePlugin-bnd = { module = \"biz.aQute.bnd:biz.aQute.bnd.gradle\", version.ref = \"biz-aQute-bnd\" }\n gradlePlugin-dokka = \"org.jetbrains.dokka:dokka-gradle-plugin:2.0.0\"\n gradlePlugin-errorprone = \"net.ltgt.gradle:gradle-errorprone-plugin:4.3.0\"\n-gradlePlugin-graalvmBuildTools = \"org.graalvm.buildtools.native:org.graalvm.buildtools.native.gradle.plugin:0.10.6\"\n+gradlePlugin-graalvmBuildTools = \"org.graalvm.buildtools.native:org.graalvm.buildtools.native.gradle.plugin:0.11.0\"\n gradlePlugin-kotlin = { module = \"org.jetbrains.kotlin:kotlin-gradle-plugin\", version.ref = \"org-jetbrains-kotlin\" }\n gradlePlugin-kotlinSerialization = { module = \"org.jetbrains.kotlin:kotlin-serialization\", version.ref = \"org-jetbrains-kotlin\" }\n gradlePlugin-ksp = { module = \"com.google.devtools.ksp:symbol-processing-gradle-plugin\", version.ref = \"ksp\" }\ndiff --git a/native-image-tests/build.gradle.kts b/native-image-tests/build.gradle.kts\nindex a0cb2ec19cee..a252297f8da3 100644\n--- a/native-image-tests/build.gradle.kts\n+++ b/native-image-tests/build.gradle.kts\n@@ -25,7 +25,9 @@ dependencies {\n \n   testImplementation(projects.mockwebserver3Junit5)\n   testImplementation(libs.assertk)\n-  testImplementation(kotlin(\"test\"))\n+  testRuntimeOnly(libs.junit.jupiter.engine)\n+  testImplementation(libs.kotlin.junit5)\n+  testImplementation(libs.junit.jupiter.params)\n }\n \n graalvmNative {\n@@ -35,30 +37,6 @@ graalvmNative {\n     named(\"test\") {\n       buildArgs.add(\"--strict-image-heap\")\n \n-      // see https://github.com/junit-team/junit5/wiki/Upgrading-to-JUnit-5.13\n-      // should not be needed after updating native build tools to 0.11.0\n-      val initializeAtBuildTime = listOf(\n-        \"kotlin.coroutines.intrinsics.CoroutineSingletons\",\n-        \"org.junit.jupiter.api.DisplayNameGenerator\\$IndicativeSentences\",\n-        \"org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor\\$ClassInfo\",\n-        \"org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor\\$LifecycleMethods\",\n-        \"org.junit.jupiter.engine.descriptor.ClassTemplateInvocationTestDescriptor\",\n-        \"org.junit.jupiter.engine.descriptor.ClassTemplateTestDescriptor\",\n-        \"org.junit.jupiter.engine.descriptor.DynamicDescendantFilter\\$Mode\",\n-        \"org.junit.jupiter.engine.descriptor.ExclusiveResourceCollector\\$1\",\n-        \"org.junit.jupiter.engine.descriptor.MethodBasedTestDescriptor\\$MethodInfo\",\n-        \"org.junit.jupiter.engine.config.InstantiatingConfigurationParameterConverter\",\n-        \"org.junit.jupiter.engine.discovery.ClassSelectorResolver\\$DummyClassTemplateInvocationContext\",\n-        \"org.junit.platform.engine.support.store.NamespacedHierarchicalStore\\$EvaluatedValue\",\n-        \"org.junit.platform.launcher.core.DiscoveryIssueNotifier\",\n-        \"org.junit.platform.launcher.core.HierarchicalOutputDirectoryProvider\",\n-        \"org.junit.platform.launcher.core.LauncherConfig\",\n-        \"org.junit.platform.launcher.core.LauncherPhase\",\n-        \"org.junit.platform.launcher.core.LauncherDiscoveryResult\\$EngineResultInfo\",\n-        \"org.junit.platform.suite.engine.SuiteTestDescriptor\\$LifecycleMethods\"\n-      )\n-      buildArgs.add(\"--initialize-at-build-time=${initializeAtBuildTime.joinToString(\",\")}\")\n-\n       // speed up development testing\n       buildArgs.add(\"-Ob\")\n     }\ndiff --git a/okcurl/build.gradle.kts b/okcurl/build.gradle.kts\nindex 9bfce470dfc1..a2e879421d8f 100644\n--- a/okcurl/build.gradle.kts\n+++ b/okcurl/build.gradle.kts\n@@ -28,13 +28,11 @@ kotlin {\n }\n \n dependencies {\n-  api(libs.kotlin.stdlib)\n   api(projects.okhttp)\n   api(projects.loggingInterceptor)\n   api(libs.squareup.okio)\n   implementation(libs.clikt)\n \n-  testImplementation(projects.okhttpTestingSupport)\n   testApi(libs.assertk)\n   testImplementation(kotlin(\"test\"))\n }\n@@ -54,15 +52,19 @@ tasks.shadowJar {\n   mergeServiceFiles()\n }\n \n-if (testJavaVersion >= 11) {\n-  apply(plugin = \"org.graalvm.buildtools.native\")\n+tasks.withType<Test> {\n+  onlyIf(\"native build requires Java 17\") {\n+    testJavaVersion > 17\n+  }\n+}\n+\n+apply(plugin = \"org.graalvm.buildtools.native\")\n \n-  configure<GraalVMExtension> {\n-    binaries {\n-      named(\"main\") {\n-        imageName = \"okcurl\"\n-        mainClass = \"okhttp3.curl.MainCommandLineKt\"\n-      }\n+configure<GraalVMExtension> {\n+  binaries {\n+    named(\"main\") {\n+      imageName = \"okcurl\"\n+      mainClass = \"okhttp3.curl.MainCommandLineKt\"\n     }\n   }\n }\n",
  "test_patch" : "diff --git a/native-image-tests/src/test/kotlin/okhttp3/nativeimage/SampleTest.kt b/native-image-tests/src/test/kotlin/okhttp3/nativeimage/SampleTest.kt\nindex efc958811bca..dcd51df41a1e 100644\n--- a/native-image-tests/src/test/kotlin/okhttp3/nativeimage/SampleTest.kt\n+++ b/native-image-tests/src/test/kotlin/okhttp3/nativeimage/SampleTest.kt\n@@ -17,12 +17,12 @@ package okhttp3.nativeimage\n \n import assertk.assertThat\n import assertk.assertions.isEqualTo\n-import kotlin.test.Test\n import mockwebserver3.MockResponse\n import mockwebserver3.MockWebServer\n import okhttp3.HttpUrl.Companion.toHttpUrl\n import okhttp3.OkHttpClient\n import okhttp3.Request\n+import org.junit.jupiter.api.Test\n \n class SampleTest {\n   private val server = MockWebServer()\n@@ -37,7 +37,6 @@ class SampleTest {\n   @Test\n   fun testMockWebServer() {\n     server.enqueue(MockResponse(body = \"abc\"))\n-\n     server.start()\n \n     client.newCall(Request(url = server.url(\"/\"))).execute().use {\ndiff --git a/native-image-tests/src/test/kotlin/okhttp3/nativeimage/WithArgumentSourceTest.kt b/native-image-tests/src/test/kotlin/okhttp3/nativeimage/WithArgumentSourceTest.kt\nnew file mode 100644\nindex 000000000000..e0106c6d9264\n--- /dev/null\n+++ b/native-image-tests/src/test/kotlin/okhttp3/nativeimage/WithArgumentSourceTest.kt\n@@ -0,0 +1,45 @@\n+/*\n+ * Copyright (C) 2020 Square, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package okhttp3.nativeimage\n+\n+import assertk.assertThat\n+import assertk.assertions.isGreaterThan\n+import java.util.stream.Stream\n+import org.junit.jupiter.api.extension.ExtensionContext\n+import org.junit.jupiter.params.ParameterizedTest\n+import org.junit.jupiter.params.provider.Arguments\n+import org.junit.jupiter.params.provider.ArgumentsProvider\n+import org.junit.jupiter.params.provider.ArgumentsSource\n+import org.junit.jupiter.params.support.ParameterDeclarations\n+\n+/**\n+ * This enforces us having the params classes on the classpath to workaround\n+ * https://github.com/graalvm/native-build-tools/issues/745\n+ */\n+class WithArgumentSourceTest {\n+  @ParameterizedTest\n+  @ArgumentsSource(FakeArgumentsProvider::class)\n+  fun passingTest(value: Int) {\n+    assertThat(value).isGreaterThan(0)\n+  }\n+}\n+\n+internal class FakeArgumentsProvider : ArgumentsProvider {\n+  override fun provideArguments(\n+    parameters: ParameterDeclarations?,\n+    context: ExtensionContext?,\n+  ): Stream<out Arguments> = listOf(Arguments.of(1), Arguments.of(2)).stream()\n+}\n",
  "problem_statement" : "Update dependency org.graalvm.buildtools.native:org.graalvm.buildtools.native.gradle.plugin to v0.11.0\n\nThis PR contains the following updates:\n\n| Package | Change | Age | Confidence |\n|---|---|---|---|\n| [org.graalvm.buildtools.native:org.graalvm.buildtools.native.gradle.plugin](https://redirect.github.com/graalvm/native-build-tools) | `0.10.6` -> `0.11.0` | [![age](https://developer.mend.io/api/mc/badges/age/maven/org.graalvm.buildtools.native:org.graalvm.buildtools.native.gradle.plugin/0.11.0?slim=true)](https://docs.renovatebot.com/merge-confidence/) | [![confidence](https://developer.mend.io/api/mc/badges/confidence/maven/org.graalvm.buildtools.native:org.graalvm.buildtools.native.gradle.plugin/0.10.6/0.11.0?slim=true)](https://docs.renovatebot.com/merge-confidence/) |\n\n---\n\n### Configuration\n\n\uD83D\uDCC5 **Schedule**: Branch creation - At any time (no schedule defined), Automerge - At any time (no schedule defined).\n\n\uD83D\uDEA6 **Automerge**: Disabled by config. Please merge this manually once you are satisfied.\n\n **Rebasing**: Whenever PR becomes conflicted, or you tick the rebase/retry checkbox.\n\n\uD83D\uDD15 **Ignore**: Close this PR and you won't be reminded about this update again.\n\n---\n\n - [ ] <!-- rebase-check -->If you want to rebase/retry this PR, check this box\n\n---\n\nThis PR was generated by [Mend Renovate](https://mend.io/renovate/). View the [repository job log](https://developer.mend.io/github/square/okhttp).\n<!--renovate-debug:eyJjcmVhdGVkSW5WZXIiOiI0MS4yMy4yIiwidXBkYXRlZEluVmVyIjoiNDEuMjMuMiIsInRhcmdldEJyYW5jaCI6Im1hc3RlciIsImxhYmVscyI6WyJyZW5vdmF0ZSJdfQ==-->\n",
  "hints_text" : null,
  "created_at" : "Fri Jul 18 18:55:10 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 8947,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-8943",
  "repo" : "square/okhttp",
  "base_commit" : "add175beea0467b13cb975f3c240b1bc16a17170",
  "patch" : "diff --git a/buildSrc/build.gradle.kts b/buildSrc/build.gradle.kts\nindex 90a3bde87bea..16dcc6831fd1 100644\n--- a/buildSrc/build.gradle.kts\n+++ b/buildSrc/build.gradle.kts\n@@ -15,11 +15,11 @@\n  */\n \n plugins {\n-    `kotlin-dsl`\n+  `kotlin-dsl`\n }\n \n repositories {\n-    mavenCentral()\n+  mavenCentral()\n }\n \n dependencies {\ndiff --git a/gradle/libs.versions.toml b/gradle/libs.versions.toml\nindex 7fbf9f8ee6b0..c6c9fd12900e 100644\n--- a/gradle/libs.versions.toml\n+++ b/gradle/libs.versions.toml\n@@ -106,3 +106,4 @@ squareup-okio-fakefilesystem = { module = \"com.squareup.okio:okio-fakefilesystem\n squareup-okio-nodefilesystem = { module = \"com.squareup.okio:okio-nodefilesystem\", version.ref = \"com-squareup-okio\" }\n testcontainers = { module = \"org.testcontainers:testcontainers\", version.ref = \"testcontainers\" }\n testcontainers-junit5 = { module = \"org.testcontainers:junit-jupiter\", version.ref = \"testcontainers\" }\n+zstd-kmp-okio = { module = \"com.squareup.zstd:zstd-kmp-okio\", version = \"0.3.0\" }\ndiff --git a/okhttp-zstd/README.md b/okhttp-zstd/README.md\nnew file mode 100644\nindex 000000000000..4dabca5ea629\n--- /dev/null\n+++ b/okhttp-zstd/README.md\n@@ -0,0 +1,20 @@\n+OkHttp Zstandard (zstd) Integration\n+===================================\n+\n+This module enables [Zstandard (zstd)][1] response compression in addition to Gzip, as long as\n+the `Accept-Encoding` header is not otherwise set. Web servers must be configured to return zstd\n+responses.\n+\n+Note that zstd is not used for sending requests.\n+\n+```java\n+OkHttpClient client = new OkHttpClient.Builder()\n+  .addInterceptor(ZstdInterceptor.INSTANCE)\n+  .build();\n+```\n+\n+```kotlin\n+implementation(\"com.squareup.okhttp3:okhttp-zstd:0.0.0\")\n+```\n+\n+ [1]: https://github.com/facebook/zstd\ndiff --git a/okhttp-zstd/api/okhttp-zstd.api b/okhttp-zstd/api/okhttp-zstd.api\nnew file mode 100644\nindex 000000000000..af53dcaff292\n--- /dev/null\n+++ b/okhttp-zstd/api/okhttp-zstd.api\n@@ -0,0 +1,5 @@\n+public final class okhttp3/zstd/ZstdInterceptor : okhttp3/Interceptor {\n+\tpublic static final field INSTANCE Lokhttp3/zstd/ZstdInterceptor;\n+\tpublic fun intercept (Lokhttp3/Interceptor$Chain;)Lokhttp3/Response;\n+}\n+\ndiff --git a/okhttp-zstd/build.gradle.kts b/okhttp-zstd/build.gradle.kts\nnew file mode 100644\nindex 000000000000..359eb646affc\n--- /dev/null\n+++ b/okhttp-zstd/build.gradle.kts\n@@ -0,0 +1,29 @@\n+import com.vanniktech.maven.publish.JavadocJar\n+import com.vanniktech.maven.publish.KotlinJvm\n+\n+plugins {\n+  kotlin(\"jvm\")\n+  id(\"org.jetbrains.dokka\")\n+  id(\"com.vanniktech.maven.publish.base\")\n+  id(\"binary-compatibility-validator\")\n+}\n+\n+project.applyOsgi(\n+  \"Export-Package: okhttp3.zstd\",\n+  \"Automatic-Module-Name: okhttp3.zstd\",\n+  \"Bundle-SymbolicName: com.squareup.okhttp3.zstd\"\n+)\n+\n+dependencies {\n+  api(projects.okhttp)\n+  implementation(libs.zstd.kmp.okio)\n+\n+  testImplementation(projects.okhttpTestingSupport)\n+  testImplementation(libs.kotlin.test.common)\n+  testImplementation(libs.kotlin.test.junit)\n+  testImplementation(libs.assertk)\n+}\n+\n+mavenPublishing {\n+  configure(KotlinJvm(javadocJar = JavadocJar.Empty()))\n+}\ndiff --git a/okhttp-zstd/src/main/kotlin/okhttp3/zstd/ZstdInterceptor.kt b/okhttp-zstd/src/main/kotlin/okhttp3/zstd/ZstdInterceptor.kt\nnew file mode 100644\nindex 000000000000..82d3dd41ecb2\n--- /dev/null\n+++ b/okhttp-zstd/src/main/kotlin/okhttp3/zstd/ZstdInterceptor.kt\n@@ -0,0 +1,75 @@\n+/*\n+ * Copyright (C) 2025 Square, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package okhttp3.zstd\n+\n+import com.squareup.zstd.okio.zstdDecompress\n+import okhttp3.Interceptor\n+import okhttp3.Response\n+import okhttp3.ResponseBody.Companion.asResponseBody\n+import okhttp3.internal.http.promisesBody\n+import okio.buffer\n+import okio.gzip\n+\n+/**\n+ * Transparent Zstandard response support.\n+ *\n+ * This must be installed as an application interceptor.\n+ *\n+ * Adds `Accept-Encoding: zstd,gzip` to request and checks (and strips) for `Content-Encoding: zstd`\n+ * in responses.\n+ *\n+ * This replaces the transparent gzip compression in OkHttp.\n+ */\n+object ZstdInterceptor : Interceptor {\n+  override fun intercept(chain: Interceptor.Chain): Response {\n+    val originalRequest = chain.request()\n+\n+    if (originalRequest.header(\"Accept-Encoding\") != null) {\n+      return chain.proceed(originalRequest)\n+    }\n+\n+    val request =\n+      originalRequest\n+        .newBuilder()\n+        .header(\"Accept-Encoding\", \"zstd,gzip\")\n+        .build()\n+\n+    return decompress(chain.proceed(request))\n+  }\n+\n+  internal fun decompress(response: Response): Response {\n+    if (!response.promisesBody()) {\n+      return response\n+    }\n+\n+    val body = response.body\n+    val encoding = response.header(\"Content-Encoding\") ?: return response\n+\n+    val decompressedSource =\n+      when {\n+        encoding.equals(\"zstd\", ignoreCase = true) -> body.source().zstdDecompress()\n+        encoding.equals(\"gzip\", ignoreCase = true) -> body.source().gzip()\n+        else -> return response\n+      }\n+\n+    return response\n+      .newBuilder()\n+      .removeHeader(\"Content-Encoding\")\n+      .removeHeader(\"Content-Length\")\n+      .body(decompressedSource.buffer().asResponseBody(body.contentType(), -1L))\n+      .build()\n+  }\n+}\ndiff --git a/settings.gradle.kts b/settings.gradle.kts\nindex 41b6eb1b15b8..c478b91586c5 100644\n--- a/settings.gradle.kts\n+++ b/settings.gradle.kts\n@@ -42,6 +42,7 @@ include(\":okhttp-sse\")\n include(\":okhttp-testing-support\")\n include(\":okhttp-tls\")\n include(\":okhttp-urlconnection\")\n+include(\":okhttp-zstd\")\n include(\":samples:compare\")\n include(\":samples:crawler\")\n include(\":samples:guide\")\n",
  "test_patch" : "diff --git a/okhttp-zstd/src/test/java/okhttp3/zstd/ZstdInterceptorTest.kt b/okhttp-zstd/src/test/java/okhttp3/zstd/ZstdInterceptorTest.kt\nnew file mode 100644\nindex 000000000000..52092bc1c6d4\n--- /dev/null\n+++ b/okhttp-zstd/src/test/java/okhttp3/zstd/ZstdInterceptorTest.kt\n@@ -0,0 +1,167 @@\n+/*\n+ * Copyright (C) 2025 Square, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package okhttp3.zstd\n+\n+import assertk.assertThat\n+import assertk.assertions.hasMessage\n+import assertk.assertions.isEmpty\n+import assertk.assertions.isEqualTo\n+import assertk.assertions.isNull\n+import com.squareup.zstd.okio.zstdCompress\n+import java.io.IOException\n+import kotlin.test.assertFailsWith\n+import okhttp3.MediaType.Companion.toMediaType\n+import okhttp3.Protocol\n+import okhttp3.Request\n+import okhttp3.Response\n+import okhttp3.ResponseBody.Companion.toResponseBody\n+import okhttp3.zstd.ZstdInterceptor.decompress\n+import okio.Buffer\n+import okio.ByteString\n+import okio.ByteString.Companion.EMPTY\n+import okio.ByteString.Companion.encodeUtf8\n+import okio.Sink\n+import okio.buffer\n+import okio.gzip\n+import org.junit.jupiter.api.Test\n+\n+class ZstdInterceptorTest {\n+  @Test\n+  fun testDecompressZstd() {\n+    val s = \"hello zstd world\".encodeUtf8().zstdCompress()\n+\n+    val response =\n+      response(\"https://example.com/\", s) {\n+        header(\"Content-Encoding\", \"zstd\")\n+      }\n+\n+    val decompressed = decompress(response)\n+    assertThat(decompressed.header(\"Content-Encoding\")).isNull()\n+\n+    val responseString = decompressed.body.string()\n+    assertThat(responseString).isEqualTo(\"hello zstd world\")\n+  }\n+\n+  @Test\n+  fun testDecompressGzip() {\n+    val s = \"hello gzip world\".encodeUtf8().gzipCompress()\n+\n+    val response =\n+      response(\"https://example.com/\", s) {\n+        header(\"Content-Encoding\", \"gzip\")\n+      }\n+\n+    val decompressed = decompress(response)\n+    assertThat(decompressed.header(\"Content-Encoding\")).isNull()\n+\n+    val responseString = decompressed.body.string()\n+    assertThat(responseString).isEqualTo(\"hello gzip world\")\n+  }\n+\n+  @Test\n+  fun testNoDecompress() {\n+    val s = \"hello not compressed world\".encodeUtf8()\n+\n+    val response = response(\"https://example.com/\", s)\n+\n+    val decompressed = decompress(response)\n+    assertThat(decompressed.header(\"Content-Encoding\")).isNull()\n+\n+    val responseString = decompressed.body.string()\n+    assertThat(responseString).isEqualTo(\"hello not compressed world\")\n+  }\n+\n+  @Test\n+  fun testUnknownAlgorithm() {\n+    val s = \"hello unknown algorithm world\".encodeUtf8()\n+\n+    val response =\n+      response(\"https://example.com/\", s) {\n+        header(\"Content-Encoding\", \"deflate\")\n+      }\n+\n+    val decompressed = decompress(response)\n+    assertThat(decompressed.header(\"Content-Encoding\")).isEqualTo(\"deflate\")\n+\n+    val responseString = decompressed.body.string()\n+    assertThat(responseString).isEqualTo(\"hello unknown algorithm world\")\n+  }\n+\n+  @Test\n+  fun testFailsDecompress() {\n+    val s = \"this is not valid zstd\".encodeUtf8()\n+\n+    val response =\n+      response(\"https://example.com/\", s) {\n+        header(\"Content-Encoding\", \"zstd\")\n+      }\n+\n+    val decompressed = decompress(response)\n+    assertThat(decompressed.header(\"Content-Encoding\")).isNull()\n+\n+    assertFailsWith<IOException> {\n+      decompressed.body.string()\n+    }.also { ioe ->\n+      assertThat(ioe).hasMessage(\"zstd decompress failed: Unknown frame descriptor\")\n+    }\n+  }\n+\n+  @Test\n+  fun testSkipDecompressNoContentResponse() {\n+    val response =\n+      response(\"https://example.com/\", EMPTY) {\n+        header(\"Content-Encoding\", \"zstd\")\n+        code(204)\n+        message(\"NO CONTENT\")\n+      }\n+\n+    val same = decompress(response)\n+\n+    val responseString = same.body.string()\n+    assertThat(responseString).isEmpty()\n+  }\n+\n+  private fun ByteString.zstdCompress(): ByteString {\n+    val result = Buffer()\n+    result.zstdCompress().buffer().use {\n+      it.write(this@zstdCompress)\n+    }\n+    return result.readByteString()\n+  }\n+\n+  private fun ByteString.gzipCompress(): ByteString {\n+    val result = Buffer()\n+    (result as Sink).gzip().buffer().use {\n+      it.write(this@gzipCompress)\n+    }\n+    return result.readByteString()\n+  }\n+\n+  private fun response(\n+    url: String,\n+    body: ByteString,\n+    fn: Response.Builder.() -> Unit = {},\n+  ): Response =\n+    Response\n+      .Builder()\n+      .body(body.toResponseBody(\"text/plain\".toMediaType()))\n+      .code(200)\n+      .message(\"OK\")\n+      .request(Request.Builder().url(url).build())\n+      .protocol(Protocol.HTTP_2)\n+      .apply(fn)\n+      .build()\n+}\ndiff --git a/okhttp-zstd/src/test/java/okhttp3/zstd/ZstdTestMain.kt b/okhttp-zstd/src/test/java/okhttp3/zstd/ZstdTestMain.kt\nnew file mode 100644\nindex 000000000000..4d7388f0c85e\n--- /dev/null\n+++ b/okhttp-zstd/src/test/java/okhttp3/zstd/ZstdTestMain.kt\n@@ -0,0 +1,44 @@\n+/*\n+ * Copyright (C) 2025 Square, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package okhttp3.zstd\n+\n+import okhttp3.OkHttpClient\n+import okhttp3.Request\n+\n+fun main() {\n+  val client =\n+    OkHttpClient\n+      .Builder()\n+      .addInterceptor(ZstdInterceptor)\n+      .build()\n+\n+  sendRequest(\"https://developers.facebook.com/docs/\", client)\n+  sendRequest(\"https://www.facebook.com/robots.txt\", client)\n+  sendRequest(\"https://www.instagram.com/robots.txt\", client)\n+}\n+\n+private fun sendRequest(\n+  url: String,\n+  client: OkHttpClient,\n+) {\n+  val req = Request.Builder().url(url).build()\n+\n+  client.newCall(req).execute().use {\n+    println(url)\n+    println(\"\"\"Content-Encoding: ${it.networkResponse?.header(\"Content-Encoding\")}\"\"\")\n+    println(\"| ${it.body.string().replace(\"\\n\", \"\\n| \")}\")\n+  }\n+}\n",
  "problem_statement" : "New zstd interceptor",
  "hints_text" : null,
  "created_at" : "Wed Jul 16 00:12:37 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 8943,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-8939",
  "repo" : "square/okhttp",
  "base_commit" : "9eb967f8d4228636f99c78a15194a37c6d0d3f8e",
  "patch" : "diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml\nindex f1f4b4c05474..ad6e41d8d922 100644\n--- a/.github/workflows/build.yml\n+++ b/.github/workflows/build.yml\n@@ -134,7 +134,6 @@ jobs:\n \n   testzulu11:\n     runs-on: ubuntu-latest\n-    if: contains(github.event.pull_request.labels.*.name, 'zulu')\n \n     steps:\n       - name: Checkout\n@@ -160,7 +159,6 @@ jobs:\n \n   testopenjdk8:\n     runs-on: ubuntu-latest\n-    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name, 'jdkversions') || contains(github.event.pull_request.labels.*.name, 'renovate')\n \n     steps:\n       - name: Checkout\n@@ -323,7 +321,6 @@ jobs:\n \n   testopenjdk17:\n     runs-on: ubuntu-latest\n-    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name, 'jdkversions') || contains(github.event.pull_request.labels.*.name, 'renovate')\n \n     steps:\n       - name: Checkout\n@@ -349,7 +346,6 @@ jobs:\n \n   testopenjdk21:\n     runs-on: ubuntu-latest\n-    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name, 'jdkversions') || contains(github.event.pull_request.labels.*.name, 'renovate')\n \n     steps:\n       - name: Checkout\n@@ -381,7 +377,6 @@ jobs:\n \n   testopenjdklatest:\n     runs-on: ubuntu-latest\n-    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name, 'jdkversions') || contains(github.event.pull_request.labels.*.name, 'renovate')\n \n     steps:\n       - name: Checkout\n@@ -408,7 +403,6 @@ jobs:\n \n   testopenjdkearlyaccess:\n     runs-on: ubuntu-latest\n-#    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name, 'jdkversions') || contains(github.event.pull_request.labels.*.name, 'renovate')\n     if: false # https://youtrack.jetbrains.com/issue/KTOR-8489\n \n     steps:\n@@ -436,8 +430,6 @@ jobs:\n \n   testwindows:\n     runs-on: windows-latest\n-    # TODO add master build after fixing all tests in CI\n-    if: contains(github.event.pull_request.labels.*.name, 'windows')\n \n     steps:\n       - name: Checkout\n@@ -463,7 +455,6 @@ jobs:\n \n   testgraal:\n     runs-on: ubuntu-latest\n-    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name, 'graal')\n \n     steps:\n       - name: Checkout\n@@ -504,7 +495,6 @@ jobs:\n   testandroid:\n     runs-on: ubuntu-latest\n     timeout-minutes: 30\n-    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name, 'android') || contains(github.event.pull_request.labels.*.name, 'renovate')\n \n     strategy:\n       fail-fast: false\n@@ -583,7 +573,6 @@ jobs:\n \n   testloom:\n     runs-on: ubuntu-latest\n-    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name, 'loom')\n \n     steps:\n       - name: Checkout\n",
  "test_patch" : "diff --git a/okcurl/src/test/kotlin/okhttp3/curl/OkcurlTest.kt b/okcurl/src/test/kotlin/okhttp3/curl/OkcurlTest.kt\nindex f7a68dbcbc0a..cefc19b27d09 100644\n--- a/okcurl/src/test/kotlin/okhttp3/curl/OkcurlTest.kt\n+++ b/okcurl/src/test/kotlin/okhttp3/curl/OkcurlTest.kt\n@@ -16,9 +16,18 @@\n package okhttp3.curl\n \n import com.github.ajalt.clikt.core.main\n+import kotlin.test.BeforeTest\n import kotlin.test.Test\n+import okhttp3.TestUtil.assumeNotWindows\n \n class OkcurlTest {\n+  @BeforeTest\n+  fun skipWindows() {\n+    // Failing with\n+    // org.gradle.internal.remote.internal.MessageIOException: Could not write '/127.0.0.1:16225'.\n+    assumeNotWindows()\n+  }\n+\n   @Test\n   fun simple() {\n     Main().main(listOf(\"--help\"))\n",
  "problem_statement" : "Run most builds on PRs\n\nSeems that the filtered set is not a popular approach. Assuming we have mostly non flaky builds, run more things on all builds (main, branches, prs).",
  "hints_text" : null,
  "created_at" : "Sat Jul 12 18:13:27 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "__ALL_TESTS__" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew test",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 8939,
  "metadata" : null
}, {
  "instance_id" : "square-okhttp-PR-8917",
  "repo" : "square/okhttp",
  "base_commit" : "f65e3e2159536b5a49ff0dff573b8d86ca18b19d",
  "patch" : "diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml\nindex 0437a07f530c..c12cc75cb4b3 100644\n--- a/.github/workflows/build.yml\n+++ b/.github/workflows/build.yml\n@@ -716,3 +716,26 @@ jobs:\n           script: ./gradlew -PandroidBuild=true :regression-test:connectedCheck\n         env:\n           API_LEVEL: ${{ matrix.api-level }}\n+\n+  test_maven:\n+    runs-on: ubuntu-latest\n+\n+    steps:\n+      - name: Checkout\n+        uses: actions/checkout@v4\n+\n+      - name: Configure JDK\n+        uses: actions/setup-java@v4\n+        with:\n+          distribution: 'zulu'\n+          java-version: 17\n+\n+      - name: Setup Gradle\n+        uses: gradle/actions/setup-gradle@v4\n+\n+      - name: Publish local snapshot\n+        run: ./gradlew publishToMavenLocal\n+\n+      - name: Run maven test\n+        working-directory: ./maven-tests\n+        run: ./mvnw -q verify\ndiff --git a/maven-tests/.gitignore b/maven-tests/.gitignore\nnew file mode 100644\nindex 000000000000..eb5a316cbd19\n--- /dev/null\n+++ b/maven-tests/.gitignore\n@@ -0,0 +1 @@\n+target\ndiff --git a/maven-tests/.mvn/jvm.config b/maven-tests/.mvn/jvm.config\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/maven-tests/.mvn/maven.config b/maven-tests/.mvn/maven.config\nnew file mode 100644\nindex 000000000000..e69de29bb2d1\ndiff --git a/maven-tests/.mvn/wrapper/maven-wrapper.properties b/maven-tests/.mvn/wrapper/maven-wrapper.properties\nnew file mode 100644\nindex 000000000000..2f94e6169877\n--- /dev/null\n+++ b/maven-tests/.mvn/wrapper/maven-wrapper.properties\n@@ -0,0 +1,19 @@\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#   http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+wrapperVersion=3.3.2\n+distributionType=only-script\n+distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.10/apache-maven-3.9.10-bin.zip\ndiff --git a/maven-tests/mvnw b/maven-tests/mvnw\nnew file mode 100755\nindex 000000000000..19529ddf8c6e\n--- /dev/null\n+++ b/maven-tests/mvnw\n@@ -0,0 +1,259 @@\n+#!/bin/sh\n+# ----------------------------------------------------------------------------\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+# ----------------------------------------------------------------------------\n+\n+# ----------------------------------------------------------------------------\n+# Apache Maven Wrapper startup batch script, version 3.3.2\n+#\n+# Optional ENV vars\n+# -----------------\n+#   JAVA_HOME - location of a JDK home dir, required when download maven via java source\n+#   MVNW_REPOURL - repo url base for downloading maven distribution\n+#   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven\n+#   MVNW_VERBOSE - true: enable verbose log; debug: trace the mvnw script; others: silence the output\n+# ----------------------------------------------------------------------------\n+\n+set -euf\n+[ \"${MVNW_VERBOSE-}\" != debug ] || set -x\n+\n+# OS specific support.\n+native_path() { printf %s\\\\n \"$1\"; }\n+case \"$(uname)\" in\n+CYGWIN* | MINGW*)\n+  [ -z \"${JAVA_HOME-}\" ] || JAVA_HOME=\"$(cygpath --unix \"$JAVA_HOME\")\"\n+  native_path() { cygpath --path --windows \"$1\"; }\n+  ;;\n+esac\n+\n+# set JAVACMD and JAVACCMD\n+set_java_home() {\n+  # For Cygwin and MinGW, ensure paths are in Unix format before anything is touched\n+  if [ -n \"${JAVA_HOME-}\" ]; then\n+    if [ -x \"$JAVA_HOME/jre/sh/java\" ]; then\n+      # IBM's JDK on AIX uses strange locations for the executables\n+      JAVACMD=\"$JAVA_HOME/jre/sh/java\"\n+      JAVACCMD=\"$JAVA_HOME/jre/sh/javac\"\n+    else\n+      JAVACMD=\"$JAVA_HOME/bin/java\"\n+      JAVACCMD=\"$JAVA_HOME/bin/javac\"\n+\n+      if [ ! -x \"$JAVACMD\" ] || [ ! -x \"$JAVACCMD\" ]; then\n+        echo \"The JAVA_HOME environment variable is not defined correctly, so mvnw cannot run.\" >&2\n+        echo \"JAVA_HOME is set to \\\"$JAVA_HOME\\\", but \\\"\\$JAVA_HOME/bin/java\\\" or \\\"\\$JAVA_HOME/bin/javac\\\" does not exist.\" >&2\n+        return 1\n+      fi\n+    fi\n+  else\n+    JAVACMD=\"$(\n+      'set' +e\n+      'unset' -f command 2>/dev/null\n+      'command' -v java\n+    )\" || :\n+    JAVACCMD=\"$(\n+      'set' +e\n+      'unset' -f command 2>/dev/null\n+      'command' -v javac\n+    )\" || :\n+\n+    if [ ! -x \"${JAVACMD-}\" ] || [ ! -x \"${JAVACCMD-}\" ]; then\n+      echo \"The java/javac command does not exist in PATH nor is JAVA_HOME set, so mvnw cannot run.\" >&2\n+      return 1\n+    fi\n+  fi\n+}\n+\n+# hash string like Java String::hashCode\n+hash_string() {\n+  str=\"${1:-}\" h=0\n+  while [ -n \"$str\" ]; do\n+    char=\"${str%\"${str#?}\"}\"\n+    h=$(((h * 31 + $(LC_CTYPE=C printf %d \"'$char\")) % 4294967296))\n+    str=\"${str#?}\"\n+  done\n+  printf %x\\\\n $h\n+}\n+\n+verbose() { :; }\n+[ \"${MVNW_VERBOSE-}\" != true ] || verbose() { printf %s\\\\n \"${1-}\"; }\n+\n+die() {\n+  printf %s\\\\n \"$1\" >&2\n+  exit 1\n+}\n+\n+trim() {\n+  # MWRAPPER-139:\n+  #   Trims trailing and leading whitespace, carriage returns, tabs, and linefeeds.\n+  #   Needed for removing poorly interpreted newline sequences when running in more\n+  #   exotic environments such as mingw bash on Windows.\n+  printf \"%s\" \"${1}\" | tr -d '[:space:]'\n+}\n+\n+# parse distributionUrl and optional distributionSha256Sum, requires .mvn/wrapper/maven-wrapper.properties\n+while IFS=\"=\" read -r key value; do\n+  case \"${key-}\" in\n+  distributionUrl) distributionUrl=$(trim \"${value-}\") ;;\n+  distributionSha256Sum) distributionSha256Sum=$(trim \"${value-}\") ;;\n+  esac\n+done <\"${0%/*}/.mvn/wrapper/maven-wrapper.properties\"\n+[ -n \"${distributionUrl-}\" ] || die \"cannot read distributionUrl property in ${0%/*}/.mvn/wrapper/maven-wrapper.properties\"\n+\n+case \"${distributionUrl##*/}\" in\n+maven-mvnd-*bin.*)\n+  MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/\n+  case \"${PROCESSOR_ARCHITECTURE-}${PROCESSOR_ARCHITEW6432-}:$(uname -a)\" in\n+  *AMD64:CYGWIN* | *AMD64:MINGW*) distributionPlatform=windows-amd64 ;;\n+  :Darwin*x86_64) distributionPlatform=darwin-amd64 ;;\n+  :Darwin*arm64) distributionPlatform=darwin-aarch64 ;;\n+  :Linux*x86_64*) distributionPlatform=linux-amd64 ;;\n+  *)\n+    echo \"Cannot detect native platform for mvnd on $(uname)-$(uname -m), use pure java version\" >&2\n+    distributionPlatform=linux-amd64\n+    ;;\n+  esac\n+  distributionUrl=\"${distributionUrl%-bin.*}-$distributionPlatform.zip\"\n+  ;;\n+maven-mvnd-*) MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/ ;;\n+*) MVN_CMD=\"mvn${0##*/mvnw}\" _MVNW_REPO_PATTERN=/org/apache/maven/ ;;\n+esac\n+\n+# apply MVNW_REPOURL and calculate MAVEN_HOME\n+# maven home pattern: ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>\n+[ -z \"${MVNW_REPOURL-}\" ] || distributionUrl=\"$MVNW_REPOURL$_MVNW_REPO_PATTERN${distributionUrl#*\"$_MVNW_REPO_PATTERN\"}\"\n+distributionUrlName=\"${distributionUrl##*/}\"\n+distributionUrlNameMain=\"${distributionUrlName%.*}\"\n+distributionUrlNameMain=\"${distributionUrlNameMain%-bin}\"\n+MAVEN_USER_HOME=\"${MAVEN_USER_HOME:-${HOME}/.m2}\"\n+MAVEN_HOME=\"${MAVEN_USER_HOME}/wrapper/dists/${distributionUrlNameMain-}/$(hash_string \"$distributionUrl\")\"\n+\n+exec_maven() {\n+  unset MVNW_VERBOSE MVNW_USERNAME MVNW_PASSWORD MVNW_REPOURL || :\n+  exec \"$MAVEN_HOME/bin/$MVN_CMD\" \"$@\" || die \"cannot exec $MAVEN_HOME/bin/$MVN_CMD\"\n+}\n+\n+if [ -d \"$MAVEN_HOME\" ]; then\n+  verbose \"found existing MAVEN_HOME at $MAVEN_HOME\"\n+  exec_maven \"$@\"\n+fi\n+\n+case \"${distributionUrl-}\" in\n+*?-bin.zip | *?maven-mvnd-?*-?*.zip) ;;\n+*) die \"distributionUrl is not valid, must match *-bin.zip or maven-mvnd-*.zip, but found '${distributionUrl-}'\" ;;\n+esac\n+\n+# prepare tmp dir\n+if TMP_DOWNLOAD_DIR=\"$(mktemp -d)\" && [ -d \"$TMP_DOWNLOAD_DIR\" ]; then\n+  clean() { rm -rf -- \"$TMP_DOWNLOAD_DIR\"; }\n+  trap clean HUP INT TERM EXIT\n+else\n+  die \"cannot create temp dir\"\n+fi\n+\n+mkdir -p -- \"${MAVEN_HOME%/*}\"\n+\n+# Download and Install Apache Maven\n+verbose \"Couldn't find MAVEN_HOME, downloading and installing it ...\"\n+verbose \"Downloading from: $distributionUrl\"\n+verbose \"Downloading to: $TMP_DOWNLOAD_DIR/$distributionUrlName\"\n+\n+# select .zip or .tar.gz\n+if ! command -v unzip >/dev/null; then\n+  distributionUrl=\"${distributionUrl%.zip}.tar.gz\"\n+  distributionUrlName=\"${distributionUrl##*/}\"\n+fi\n+\n+# verbose opt\n+__MVNW_QUIET_WGET=--quiet __MVNW_QUIET_CURL=--silent __MVNW_QUIET_UNZIP=-q __MVNW_QUIET_TAR=''\n+[ \"${MVNW_VERBOSE-}\" != true ] || __MVNW_QUIET_WGET='' __MVNW_QUIET_CURL='' __MVNW_QUIET_UNZIP='' __MVNW_QUIET_TAR=v\n+\n+# normalize http auth\n+case \"${MVNW_PASSWORD:+has-password}\" in\n+'') MVNW_USERNAME='' MVNW_PASSWORD='' ;;\n+has-password) [ -n \"${MVNW_USERNAME-}\" ] || MVNW_USERNAME='' MVNW_PASSWORD='' ;;\n+esac\n+\n+if [ -z \"${MVNW_USERNAME-}\" ] && command -v wget >/dev/null; then\n+  verbose \"Found wget ... using wget\"\n+  wget ${__MVNW_QUIET_WGET:+\"$__MVNW_QUIET_WGET\"} \"$distributionUrl\" -O \"$TMP_DOWNLOAD_DIR/$distributionUrlName\" || die \"wget: Failed to fetch $distributionUrl\"\n+elif [ -z \"${MVNW_USERNAME-}\" ] && command -v curl >/dev/null; then\n+  verbose \"Found curl ... using curl\"\n+  curl ${__MVNW_QUIET_CURL:+\"$__MVNW_QUIET_CURL\"} -f -L -o \"$TMP_DOWNLOAD_DIR/$distributionUrlName\" \"$distributionUrl\" || die \"curl: Failed to fetch $distributionUrl\"\n+elif set_java_home; then\n+  verbose \"Falling back to use Java to download\"\n+  javaSource=\"$TMP_DOWNLOAD_DIR/Downloader.java\"\n+  targetZip=\"$TMP_DOWNLOAD_DIR/$distributionUrlName\"\n+  cat >\"$javaSource\" <<-END\n+\tpublic class Downloader extends java.net.Authenticator\n+\t{\n+\t  protected java.net.PasswordAuthentication getPasswordAuthentication()\n+\t  {\n+\t    return new java.net.PasswordAuthentication( System.getenv( \"MVNW_USERNAME\" ), System.getenv( \"MVNW_PASSWORD\" ).toCharArray() );\n+\t  }\n+\t  public static void main( String[] args ) throws Exception\n+\t  {\n+\t    setDefault( new Downloader() );\n+\t    java.nio.file.Files.copy( java.net.URI.create( args[0] ).toURL().openStream(), java.nio.file.Paths.get( args[1] ).toAbsolutePath().normalize() );\n+\t  }\n+\t}\n+\tEND\n+  # For Cygwin/MinGW, switch paths to Windows format before running javac and java\n+  verbose \" - Compiling Downloader.java ...\"\n+  \"$(native_path \"$JAVACCMD\")\" \"$(native_path \"$javaSource\")\" || die \"Failed to compile Downloader.java\"\n+  verbose \" - Running Downloader.java ...\"\n+  \"$(native_path \"$JAVACMD\")\" -cp \"$(native_path \"$TMP_DOWNLOAD_DIR\")\" Downloader \"$distributionUrl\" \"$(native_path \"$targetZip\")\"\n+fi\n+\n+# If specified, validate the SHA-256 sum of the Maven distribution zip file\n+if [ -n \"${distributionSha256Sum-}\" ]; then\n+  distributionSha256Result=false\n+  if [ \"$MVN_CMD\" = mvnd.sh ]; then\n+    echo \"Checksum validation is not supported for maven-mvnd.\" >&2\n+    echo \"Please disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties.\" >&2\n+    exit 1\n+  elif command -v sha256sum >/dev/null; then\n+    if echo \"$distributionSha256Sum  $TMP_DOWNLOAD_DIR/$distributionUrlName\" | sha256sum -c >/dev/null 2>&1; then\n+      distributionSha256Result=true\n+    fi\n+  elif command -v shasum >/dev/null; then\n+    if echo \"$distributionSha256Sum  $TMP_DOWNLOAD_DIR/$distributionUrlName\" | shasum -a 256 -c >/dev/null 2>&1; then\n+      distributionSha256Result=true\n+    fi\n+  else\n+    echo \"Checksum validation was requested but neither 'sha256sum' or 'shasum' are available.\" >&2\n+    echo \"Please install either command, or disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties.\" >&2\n+    exit 1\n+  fi\n+  if [ $distributionSha256Result = false ]; then\n+    echo \"Error: Failed to validate Maven distribution SHA-256, your Maven distribution might be compromised.\" >&2\n+    echo \"If you updated your Maven version, you need to update the specified distributionSha256Sum property.\" >&2\n+    exit 1\n+  fi\n+fi\n+\n+# unzip and move\n+if command -v unzip >/dev/null; then\n+  unzip ${__MVNW_QUIET_UNZIP:+\"$__MVNW_QUIET_UNZIP\"} \"$TMP_DOWNLOAD_DIR/$distributionUrlName\" -d \"$TMP_DOWNLOAD_DIR\" || die \"failed to unzip\"\n+else\n+  tar xzf${__MVNW_QUIET_TAR:+\"$__MVNW_QUIET_TAR\"} \"$TMP_DOWNLOAD_DIR/$distributionUrlName\" -C \"$TMP_DOWNLOAD_DIR\" || die \"failed to untar\"\n+fi\n+printf %s\\\\n \"$distributionUrl\" >\"$TMP_DOWNLOAD_DIR/$distributionUrlNameMain/mvnw.url\"\n+mv -- \"$TMP_DOWNLOAD_DIR/$distributionUrlNameMain\" \"$MAVEN_HOME\" || [ -d \"$MAVEN_HOME\" ] || die \"fail to move MAVEN_HOME\"\n+\n+clean || :\n+exec_maven \"$@\"\ndiff --git a/maven-tests/mvnw.cmd b/maven-tests/mvnw.cmd\nnew file mode 100644\nindex 000000000000..249bdf382222\n--- /dev/null\n+++ b/maven-tests/mvnw.cmd\n@@ -0,0 +1,149 @@\n+<# : batch portion\n+@REM ----------------------------------------------------------------------------\n+@REM Licensed to the Apache Software Foundation (ASF) under one\n+@REM or more contributor license agreements.  See the NOTICE file\n+@REM distributed with this work for additional information\n+@REM regarding copyright ownership.  The ASF licenses this file\n+@REM to you under the Apache License, Version 2.0 (the\n+@REM \"License\"); you may not use this file except in compliance\n+@REM with the License.  You may obtain a copy of the License at\n+@REM\n+@REM    http://www.apache.org/licenses/LICENSE-2.0\n+@REM\n+@REM Unless required by applicable law or agreed to in writing,\n+@REM software distributed under the License is distributed on an\n+@REM \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+@REM KIND, either express or implied.  See the License for the\n+@REM specific language governing permissions and limitations\n+@REM under the License.\n+@REM ----------------------------------------------------------------------------\n+\n+@REM ----------------------------------------------------------------------------\n+@REM Apache Maven Wrapper startup batch script, version 3.3.2\n+@REM\n+@REM Optional ENV vars\n+@REM   MVNW_REPOURL - repo url base for downloading maven distribution\n+@REM   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven\n+@REM   MVNW_VERBOSE - true: enable verbose log; others: silence the output\n+@REM ----------------------------------------------------------------------------\n+\n+@IF \"%__MVNW_ARG0_NAME__%\"==\"\" (SET __MVNW_ARG0_NAME__=%~nx0)\n+@SET __MVNW_CMD__=\n+@SET __MVNW_ERROR__=\n+@SET __MVNW_PSMODULEP_SAVE=%PSModulePath%\n+@SET PSModulePath=\n+@FOR /F \"usebackq tokens=1* delims==\" %%A IN (`powershell -noprofile \"& {$scriptDir='%~dp0'; $script='%__MVNW_ARG0_NAME__%'; icm -ScriptBlock ([Scriptblock]::Create((Get-Content -Raw '%~f0'))) -NoNewScope}\"`) DO @(\n+  IF \"%%A\"==\"MVN_CMD\" (set __MVNW_CMD__=%%B) ELSE IF \"%%B\"==\"\" (echo %%A) ELSE (echo %%A=%%B)\n+)\n+@SET PSModulePath=%__MVNW_PSMODULEP_SAVE%\n+@SET __MVNW_PSMODULEP_SAVE=\n+@SET __MVNW_ARG0_NAME__=\n+@SET MVNW_USERNAME=\n+@SET MVNW_PASSWORD=\n+@IF NOT \"%__MVNW_CMD__%\"==\"\" (%__MVNW_CMD__% %*)\n+@echo Cannot start maven from wrapper >&2 && exit /b 1\n+@GOTO :EOF\n+: end batch / begin powershell #>\n+\n+$ErrorActionPreference = \"Stop\"\n+if ($env:MVNW_VERBOSE -eq \"true\") {\n+  $VerbosePreference = \"Continue\"\n+}\n+\n+# calculate distributionUrl, requires .mvn/wrapper/maven-wrapper.properties\n+$distributionUrl = (Get-Content -Raw \"$scriptDir/.mvn/wrapper/maven-wrapper.properties\" | ConvertFrom-StringData).distributionUrl\n+if (!$distributionUrl) {\n+  Write-Error \"cannot read distributionUrl property in $scriptDir/.mvn/wrapper/maven-wrapper.properties\"\n+}\n+\n+switch -wildcard -casesensitive ( $($distributionUrl -replace '^.*/','') ) {\n+  \"maven-mvnd-*\" {\n+    $USE_MVND = $true\n+    $distributionUrl = $distributionUrl -replace '-bin\\.[^.]*$',\"-windows-amd64.zip\"\n+    $MVN_CMD = \"mvnd.cmd\"\n+    break\n+  }\n+  default {\n+    $USE_MVND = $false\n+    $MVN_CMD = $script -replace '^mvnw','mvn'\n+    break\n+  }\n+}\n+\n+# apply MVNW_REPOURL and calculate MAVEN_HOME\n+# maven home pattern: ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>\n+if ($env:MVNW_REPOURL) {\n+  $MVNW_REPO_PATTERN = if ($USE_MVND) { \"/org/apache/maven/\" } else { \"/maven/mvnd/\" }\n+  $distributionUrl = \"$env:MVNW_REPOURL$MVNW_REPO_PATTERN$($distributionUrl -replace '^.*'+$MVNW_REPO_PATTERN,'')\"\n+}\n+$distributionUrlName = $distributionUrl -replace '^.*/',''\n+$distributionUrlNameMain = $distributionUrlName -replace '\\.[^.]*$','' -replace '-bin$',''\n+$MAVEN_HOME_PARENT = \"$HOME/.m2/wrapper/dists/$distributionUrlNameMain\"\n+if ($env:MAVEN_USER_HOME) {\n+  $MAVEN_HOME_PARENT = \"$env:MAVEN_USER_HOME/wrapper/dists/$distributionUrlNameMain\"\n+}\n+$MAVEN_HOME_NAME = ([System.Security.Cryptography.MD5]::Create().ComputeHash([byte[]][char[]]$distributionUrl) | ForEach-Object {$_.ToString(\"x2\")}) -join ''\n+$MAVEN_HOME = \"$MAVEN_HOME_PARENT/$MAVEN_HOME_NAME\"\n+\n+if (Test-Path -Path \"$MAVEN_HOME\" -PathType Container) {\n+  Write-Verbose \"found existing MAVEN_HOME at $MAVEN_HOME\"\n+  Write-Output \"MVN_CMD=$MAVEN_HOME/bin/$MVN_CMD\"\n+  exit $?\n+}\n+\n+if (! $distributionUrlNameMain -or ($distributionUrlName -eq $distributionUrlNameMain)) {\n+  Write-Error \"distributionUrl is not valid, must end with *-bin.zip, but found $distributionUrl\"\n+}\n+\n+# prepare tmp dir\n+$TMP_DOWNLOAD_DIR_HOLDER = New-TemporaryFile\n+$TMP_DOWNLOAD_DIR = New-Item -Itemtype Directory -Path \"$TMP_DOWNLOAD_DIR_HOLDER.dir\"\n+$TMP_DOWNLOAD_DIR_HOLDER.Delete() | Out-Null\n+trap {\n+  if ($TMP_DOWNLOAD_DIR.Exists) {\n+    try { Remove-Item $TMP_DOWNLOAD_DIR -Recurse -Force | Out-Null }\n+    catch { Write-Warning \"Cannot remove $TMP_DOWNLOAD_DIR\" }\n+  }\n+}\n+\n+New-Item -Itemtype Directory -Path \"$MAVEN_HOME_PARENT\" -Force | Out-Null\n+\n+# Download and Install Apache Maven\n+Write-Verbose \"Couldn't find MAVEN_HOME, downloading and installing it ...\"\n+Write-Verbose \"Downloading from: $distributionUrl\"\n+Write-Verbose \"Downloading to: $TMP_DOWNLOAD_DIR/$distributionUrlName\"\n+\n+$webclient = New-Object System.Net.WebClient\n+if ($env:MVNW_USERNAME -and $env:MVNW_PASSWORD) {\n+  $webclient.Credentials = New-Object System.Net.NetworkCredential($env:MVNW_USERNAME, $env:MVNW_PASSWORD)\n+}\n+[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12\n+$webclient.DownloadFile($distributionUrl, \"$TMP_DOWNLOAD_DIR/$distributionUrlName\") | Out-Null\n+\n+# If specified, validate the SHA-256 sum of the Maven distribution zip file\n+$distributionSha256Sum = (Get-Content -Raw \"$scriptDir/.mvn/wrapper/maven-wrapper.properties\" | ConvertFrom-StringData).distributionSha256Sum\n+if ($distributionSha256Sum) {\n+  if ($USE_MVND) {\n+    Write-Error \"Checksum validation is not supported for maven-mvnd. `nPlease disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties.\"\n+  }\n+  Import-Module $PSHOME\\Modules\\Microsoft.PowerShell.Utility -Function Get-FileHash\n+  if ((Get-FileHash \"$TMP_DOWNLOAD_DIR/$distributionUrlName\" -Algorithm SHA256).Hash.ToLower() -ne $distributionSha256Sum) {\n+    Write-Error \"Error: Failed to validate Maven distribution SHA-256, your Maven distribution might be compromised. If you updated your Maven version, you need to update the specified distributionSha256Sum property.\"\n+  }\n+}\n+\n+# unzip and move\n+Expand-Archive \"$TMP_DOWNLOAD_DIR/$distributionUrlName\" -DestinationPath \"$TMP_DOWNLOAD_DIR\" | Out-Null\n+Rename-Item -Path \"$TMP_DOWNLOAD_DIR/$distributionUrlNameMain\" -NewName $MAVEN_HOME_NAME | Out-Null\n+try {\n+  Move-Item -Path \"$TMP_DOWNLOAD_DIR/$MAVEN_HOME_NAME\" -Destination $MAVEN_HOME_PARENT | Out-Null\n+} catch {\n+  if (! (Test-Path -Path \"$MAVEN_HOME\" -PathType Container)) {\n+    Write-Error \"fail to move MAVEN_HOME\"\n+  }\n+} finally {\n+  try { Remove-Item $TMP_DOWNLOAD_DIR -Recurse -Force | Out-Null }\n+  catch { Write-Warning \"Cannot remove $TMP_DOWNLOAD_DIR\" }\n+}\n+\n+Write-Output \"MVN_CMD=$MAVEN_HOME/bin/$MVN_CMD\"\ndiff --git a/maven-tests/pom.xml b/maven-tests/pom.xml\nnew file mode 100644\nindex 000000000000..8070b97e252b\n--- /dev/null\n+++ b/maven-tests/pom.xml\n@@ -0,0 +1,99 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+  xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+  <modelVersion>4.0.0</modelVersion>\n+\n+  <groupId>com.squareup.okhttp3</groupId>\n+  <artifactId>maven-tests</artifactId>\n+  <version>1.0.0-SNAPSHOT</version>\n+\n+  <name>maven-tests</name>\n+  <description>A simple maven-test.</description>\n+\n+  <properties>\n+    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n+    <maven.compiler.source>17</maven.compiler.source>\n+    <maven.compiler.target>17</maven.compiler.target>\n+  </properties>\n+\n+  <dependencies>\n+    <dependency>\n+      <groupId>junit</groupId>\n+      <artifactId>junit</artifactId>\n+      <version>4.13.2</version>\n+      <scope>test</scope>\n+    </dependency>\n+\n+    <dependency>\n+      <groupId>com.squareup.okhttp3</groupId>\n+<!--      <artifactId>okhttp</artifactId>-->\n+      <artifactId>okhttp-jvm</artifactId>\n+      <version>[5.0.0-SNAPSHOT,6.0.0-SNAPSHOT)</version>\n+    </dependency>\n+\n+    <dependency>\n+      <groupId>com.squareup.okhttp3</groupId>\n+      <artifactId>mockwebserver3</artifactId>\n+      <version>[5.0.0-SNAPSHOT,6.0.0-SNAPSHOT)</version>\n+    </dependency>\n+\n+    <dependency>\n+      <groupId>com.squareup.okhttp3</groupId>\n+      <artifactId>logging-interceptor</artifactId>\n+      <version>[5.0.0-SNAPSHOT,6.0.0-SNAPSHOT)</version>\n+    </dependency>\n+  </dependencies>\n+\n+  <build>\n+    <pluginManagement><!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) -->\n+      <plugins>\n+        <plugin>\n+          <artifactId>maven-clean-plugin</artifactId>\n+          <version>3.4.0</version>\n+        </plugin>\n+        <plugin>\n+          <artifactId>maven-site-plugin</artifactId>\n+          <version>3.12.1</version>\n+        </plugin>\n+        <plugin>\n+          <artifactId>maven-project-info-reports-plugin</artifactId>\n+          <version>3.6.1</version>\n+        </plugin>\n+        <!-- see http://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_jar_packaging -->\n+        <plugin>\n+          <artifactId>maven-resources-plugin</artifactId>\n+          <version>3.3.1</version>\n+        </plugin>\n+        <plugin>\n+          <artifactId>maven-compiler-plugin</artifactId>\n+          <version>3.13.0</version>\n+        </plugin>\n+        <plugin>\n+          <artifactId>maven-surefire-plugin</artifactId>\n+          <version>3.3.0</version>\n+        </plugin>\n+        <plugin>\n+          <artifactId>maven-jar-plugin</artifactId>\n+          <version>3.4.2</version>\n+        </plugin>\n+        <plugin>\n+          <artifactId>maven-install-plugin</artifactId>\n+          <version>3.1.2</version>\n+        </plugin>\n+        <plugin>\n+          <artifactId>maven-deploy-plugin</artifactId>\n+          <version>3.1.2</version>\n+        </plugin>\n+      </plugins>\n+    </pluginManagement>\n+  </build>\n+\n+  <reporting>\n+    <plugins>\n+      <plugin>\n+        <artifactId>maven-project-info-reports-plugin</artifactId>\n+      </plugin>\n+    </plugins>\n+  </reporting>\n+</project>\ndiff --git a/maven-tests/src/main/java/com/squareup/okhttp3/maventest/SampleHttpClient.java b/maven-tests/src/main/java/com/squareup/okhttp3/maventest/SampleHttpClient.java\nnew file mode 100644\nindex 000000000000..76666d9814f6\n--- /dev/null\n+++ b/maven-tests/src/main/java/com/squareup/okhttp3/maventest/SampleHttpClient.java\n@@ -0,0 +1,39 @@\n+/*\n+ * Copyright (C) 2025 Block, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.squareup.okhttp3.maventest;\n+\n+import java.io.IOException;\n+\n+import okhttp3.Headers;\n+import okhttp3.HttpUrl;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Request;\n+import okhttp3.Response;\n+\n+public class SampleHttpClient {\n+  private final OkHttpClient client;\n+\n+  public SampleHttpClient() {\n+    client = new OkHttpClient.Builder().build();\n+  }\n+\n+  public void makeCall(HttpUrl url) throws IOException {\n+    try (Response response = client.newCall(new Request(url, Headers.EMPTY, \"GET\", null)).execute()) {\n+      System.out.println(response.body().string());\n+    }\n+  }\n+}\n",
  "test_patch" : "diff --git a/maven-tests/src/test/java/com/squareup/okhttp3/maventest/AppTest.java b/maven-tests/src/test/java/com/squareup/okhttp3/maventest/AppTest.java\nnew file mode 100644\nindex 000000000000..071358a49c3c\n--- /dev/null\n+++ b/maven-tests/src/test/java/com/squareup/okhttp3/maventest/AppTest.java\n@@ -0,0 +1,38 @@\n+/*\n+ * Copyright (C) 2025 Block, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.squareup.okhttp3.maventest;\n+\n+import mockwebserver3.MockResponse;\n+import mockwebserver3.MockWebServer;\n+import okhttp3.Headers;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+/**\n+ * Unit test for simple App.\n+ */\n+public class AppTest {\n+  private final MockWebServer mockWebServer = new MockWebServer();\n+\n+  @Test\n+  public void testApp() throws IOException {\n+    mockWebServer.enqueue(new MockResponse(200, Headers.of(), \"Hello, Maven!\"));\n+    mockWebServer.start();\n+\n+    new SampleHttpClient().makeCall(mockWebServer.url(\"/\"));\n+  }\n+}\n",
  "problem_statement" : "Add a test of maven dependencies",
  "hints_text" : null,
  "created_at" : "Sat Jul 05 15:36:33 CEST 2025",
  "version" : null,
  "FAIL_TO_PASS" : [ "AppTest" ],
  "PASS_TO_PASS" : null,
  "environment_setup_commit" : null,
  "test_command" : "./gradlew :maven-tests:test --tests \"AppTest\"",
  "build_tool" : "gradle",
  "java_version" : null,
  "modules" : null,
  "issue_number" : null,
  "pull_number" : 8917,
  "metadata" : null
} ]